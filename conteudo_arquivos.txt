C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\gerar.py

import os
import fnmatch


def analisar_e_escrever_arquivos(
    ignorar_nomes_pastas=None,
    ignorar_padroes_glob=None,
    ignorar_caminhos_relativos=None,
):
    """
    Percorre o diretório atual e suas subpastas em busca de arquivos
    com extensões específicas (.py, .html, .css, .js) e escreve seus
    caminhos e conteúdos em um arquivo de texto.

    Permite ignorar pastas:
      - por nome exato (ex.: {'node_modules', '.git', 'venv'})
      - por padrão glob (ex.: {'*.venv*', 'build*'})
      - por caminho relativo a partir da pasta raiz (ex.: {'projetos/arquivos/grandes'})
    """
    pasta_raiz = os.getcwd()

    # Normaliza parâmetros
    ignorar_nomes_pastas = set(ignorar_nomes_pastas or [])
    ignorar_padroes_glob = set(ignorar_padroes_glob or [])
    # Normaliza separadores e resolve caminhos relativos em relação à pasta raiz
    ignorar_caminhos_relativos = {
        os.path.normpath(os.path.join(pasta_raiz, p))
        for p in (ignorar_caminhos_relativos or set())
    }

    extensoes_desejadas = ('.py', '.html', '.css', '.js')
    arquivo_saida = 'conteudo_arquivos.txt'

    try:
        with open(arquivo_saida, 'w', encoding='utf-8') as saida:
            print(f"Analisando a partir de: {pasta_raiz}")
            print(f"Os resultados serão salvos em: {arquivo_saida}\n")

            for diretorio_atual, dirnames, arquivos in os.walk(pasta_raiz):
                # --- FILTRO DE PASTAS A SEREM IGNORADAS ---
                # Vamos modificar dirnames in-place para evitar descer nessas pastas.
                dirnames[:] = [
                    d for d in dirnames
                    if not deve_ignorar_pasta(
                        dir_nome=d,
                        dir_absoluto=os.path.join(diretorio_atual, d),
                        pasta_raiz=pasta_raiz,
                        ignorar_nomes_pastas=ignorar_nomes_pastas,
                        ignorar_padroes_glob=ignorar_padroes_glob,
                        ignorar_caminhos_absolutos=ignorar_caminhos_relativos
                    )
                ]

                for nome_arquivo in arquivos:
                    if nome_arquivo.endswith(extensoes_desejadas):
                        caminho_completo = os.path.join(
                            diretorio_atual, nome_arquivo)

                        saida.write(f"{caminho_completo}\n\n")

                        try:
                            with open(caminho_completo, 'r', encoding='utf-8', errors='ignore') as entrada:
                                conteudo = entrada.read()
                                saida.write(f"{conteudo}\n")
                        except Exception as e:
                            saida.write(
                                f"--- Erro ao ler o arquivo: {e} ---\n")

                        saida.write(
                            "_____________________________________\n\n")
                        print(f"Processado: {caminho_completo}")

        print(
            f"\nAnálise concluída com sucesso! Verifique o arquivo '{arquivo_saida}'.")

    except IOError as e:
        print(f"Erro ao escrever no arquivo de saída: {e}")
    except Exception as e:
        print(f"Ocorreu um erro inesperado: {e}")


def deve_ignorar_pasta(
    dir_nome: str,
    dir_absoluto: str,
    pasta_raiz: str,
    ignorar_nomes_pastas: set,
    ignorar_padroes_glob: set,
    ignorar_caminhos_absolutos: set,
) -> bool:
    """
    Retorna True se a pasta deve ser ignorada, com base em:
      - nome exato
      - padrões glob
      - caminho absoluto correspondente a caminhos relativos ignorados
    """
    # 1) Nome exato (case-sensitive; ajuste se quiser case-insensitive)
    if dir_nome in ignorar_nomes_pastas:
        return True

    # 2) Padrões glob (ex.: '*.venv*', 'build*')
    for padrao in ignorar_padroes_glob:
        if fnmatch.fnmatch(dir_nome, padrao):
            return True

    # 3) Caminhos absolutos específicos (derivados dos caminhos relativos)
    dir_absoluto_norm = os.path.normpath(dir_absoluto)

    # Ignora se a pasta atual é exatamente uma das listadas
    if dir_absoluto_norm in ignorar_caminhos_absolutos:
        return True

    # Ignora se a pasta atual está dentro de um caminho ignorado (subdiretório)
    for caminho_ignorado in ignorar_caminhos_absolutos:
        # Ex.: /raiz/projetos/arquivos/grandes é prefixo de /raiz/projetos/arquivos/grandes/imagens
        if dir_absoluto_norm.startswith(caminho_ignorado + os.sep):
            return True

    return False


if __name__ == '__main__':
    # EXEMPLO DE USO: ajuste conforme sua necessidade
    analisar_e_escrever_arquivos(
        ignorar_nomes_pastas={
            '__pycache__', 'migrations', '.git', 'venv', 'antigos', 'media',
        },
        ignorar_padroes_glob={
            '*.venv*', 'build*', '.gitattributes', '.txt'
        },
        ignorar_caminhos_relativos={
            # caminhos relativos a partir da pasta raiz
            # 'projetos/arquivos/grandes',
        }
    )

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\manage.py

#!/usr/bin/env python
"""Django's command-line utility for administrative tasks."""
import os
import sys


def main():
    """Run administrative tasks."""
    os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bella_designer.settings')
    try:
        from django.core.management import execute_from_command_line
    except ImportError as exc:
        raise ImportError(
            "Couldn't import Django. Are you sure it's installed and "
            "available on your PYTHONPATH environment variable? Did you "
            "forget to activate a virtual environment?"
        ) from exc
    execute_from_command_line(sys.argv)


if __name__ == '__main__':
    main()

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\admin.py

# agendamentos/admin.py
from django.contrib import admin
from django import forms
from .models import (Negocio, EmpreendedorProfile, Cliente, Servico, Agendamento, Despesa, HorarioTrabalho, Aviso, DiaBloqueado,
                     Categoria, PrecoManutencao
                     )

# -----------------------------------------------------------
# Configuração personalizada para o modelo "Negocio"
# Isso nos permite ver o 'slug' e o nome na lista
# -----------------------------------------------------------


@admin.register(Negocio)
class NegocioAdmin(admin.ModelAdmin):
    list_display = ('nome_negocio', 'slug', 'cor_primaria')
    search_fields = ('nome_negocio', 'slug')
    prepopulated_fields = {'slug': ('nome_negocio',)}

# -----------------------------------------------------------
# Configuração para o "Perfil do Empreendedor" (Funcionário)
# -----------------------------------------------------------


@admin.register(EmpreendedorProfile)
class EmpreendedorProfileAdmin(admin.ModelAdmin):
    list_display = ('user', 'get_user_email', 'negocio', 'telefone')
    search_fields = ('user__username', 'user__email', 'negocio__nome_negocio')
    list_filter = ('negocio',)

    @admin.display(description='Email')
    def get_user_email(self, obj):
        return obj.user.email

# -----------------------------------------------------------
# Configuração para o "Cliente"
# -----------------------------------------------------------


@admin.register(Cliente)
class ClienteAdmin(admin.ModelAdmin):
    list_display = ('user', 'get_user_email', 'negocio', 'telefone')
    search_fields = ('user__username', 'user__email', 'negocio__nome_negocio')
    list_filter = ('negocio',)

    @admin.display(description='Email')
    def get_user_email(self, obj):
        return obj.user.email

# =================================================================
# NOVA ADIÇÃO: ADMIN DE CATEGORIA
# =================================================================


@admin.register(Categoria)
class CategoriaAdmin(admin.ModelAdmin):
    list_display = ('nome', 'negocio')
    list_filter = ('negocio',)
    search_fields = ('nome',)

# =================================================================
# NOVA ADIÇÃO: ADMIN DE PREÇOS DE MANUTENÇÃO (para usar 'inline')
# =================================================================

class PrecoManutencaoInline(admin.TabularInline):
    """
    Isso permite editar os preços de manutenção DENTRO da página de 
    edição do Serviço, o que é muito mais prático.
    """
    model = PrecoManutencao
    formset = forms.models.BaseInlineFormSet  # Usado para validação
    extra = 1  # Começa com 1 campo de manutenção em branco
    
    # --- NOVA ADIÇÃO ---
    # Define os campos que aparecem no inline
    fields = ('nome_tier', 'dias_min', 'dias_max', 'preco', 'duracao_minutos', 'percentual_adiantamento')
    # --- FIM DA ADIÇÃO ---


    def get_formset(self, request, obj=None, **kwargs):
        # Validação para garantir que os ranges não se sobreponham
        FormSet = super().get_formset(request, obj, **kwargs)

        class ValidatedFormSet(FormSet):
            def clean(self):
                super().clean()
                if not hasattr(self, 'forms'):
                    return  # Sai se não houver forms

                tiers = []
                for form in self.forms:
                    if not form.is_valid() or form.cleaned_data.get('DELETE'):
                        continue

                    data = form.cleaned_data
                    if not data:
                        continue

                    dias_min = data.get('dias_min')
                    dias_max = data.get('dias_max')

                    if dias_min is None or dias_max is None:
                        # Deixa a validação do modelo (required=True) tratar
                        continue

                    tiers.append((dias_min, dias_max))

                # Ordena pelos dias de início
                tiers.sort()

                # Verifica sobreposição
                for i in range(len(tiers) - 1):
                    if tiers[i][1] >= tiers[i+1][0]:
                        raise forms.ValidationError(
                            f"Sobreposição de ranges: ({tiers[i][0]}-{tiers[i][1]} dias) "
                            f"conflita com ({tiers[i+1][0]}-{tiers[i+1][1]} dias)."
                        )

        return ValidatedFormSet

class ServicoAdminForm(forms.ModelForm):
    class Meta:
        model = Servico
        fields = '__all__'  # Usar todos os campos do modelo

    def __init__(self, *args, **kwargs):
        """
        Isso personaliza o formulário DEPOIS que ele é criado.
        """
        super().__init__(*args, **kwargs)

        # 'self.instance' é o objeto 'Servico' que está sendo editado.
        # Se for um serviço que já existe (tem PK) e já tem um negócio...
        if self.instance.pk and self.instance.negocio:
            # ...nós filtramos a lista 'profissionais_que_executam'
            # para mostrar APENAS os profissionais daquele negócio.
            # Isso melhora a UI da página de EDIÇÃO.
            self.fields['profissionais_que_executam'].queryset = EmpreendedorProfile.objects.filter(
                negocio=self.instance.negocio
            )
        else:
            # Se for um *novo* serviço (página de Adicionar),
            # o usuário ainda não selecionou um 'Negocio'.
            # A validação (clean) abaixo vai garantir a integridade.
            # Mostramos uma lista vazia para forçar o usuário a salvar primeiro.
            self.fields['profissionais_que_executam'].queryset = EmpreendedorProfile.objects.none()
            self.fields['profissionais_que_executam'].help_text = "Salve o serviço com um 'Negócio' primeiro para poder adicionar profissionais."

    # --- NOVA ADIÇÃO (Dentro da ServicoAdminForm) ---
    def clean_categoria(self):
        """
        Validação para garantir que a Categoria pertença ao mesmo Negocio do Serviço.
        """
        negocio = self.cleaned_data.get('negocio')
        categoria = self.cleaned_data.get('categoria')

        if not negocio or not categoria:
            return categoria  # Deixa o Django tratar a falta de 'negocio'

        if categoria.negocio != negocio:
            raise forms.ValidationError(
                f"A categoria '{categoria.nome}' não pertence ao negócio '{negocio}'."
            )

        return categoria
    # --- FIM DA ADIÇÃO ---

    def clean_profissionais_que_executam(self):
        """
        Este é o "BLOQUEIO" (validação) que você pediu.
        Ele roda quando você clica em "Salvar".
        """
        # Pega os dados que o usuário preencheu no formulário
        negocio = self.cleaned_data.get('negocio')
        profissionais = self.cleaned_data.get('profissionais_que_executam')

        # Se o usuário não selecionou um Negócio, não podemos validar.
        if not negocio:
            return profissionais  # O Django já vai reclamar que 'negocio' é obrigatório

        if not profissionais:
            return profissionais  # Não selecionar nenhum profissional é válido

        # Verifica CADA profissional que o usuário selecionou
        for prof in profissionais:
            if prof.negocio != negocio:
                # Se o profissional não for do mesmo negócio do serviço,
                # gera um erro de validação que aparece no topo da página.
                raise forms.ValidationError(
                    f"O profissional '{prof.user.get_full_name()}' não pertence ao negócio '{negocio}'. "
                    "Por favor, selecione apenas profissionais que fazem parte do mesmo negócio."
                )

        # Se passou por tudo, os dados são válidos.
        return profissionais


# -----------------------------------------------------------
# Configuração para "Servico"
# -----------------------------------------------------------


@admin.register(Servico)
class ServicoAdmin(admin.ModelAdmin):
    form = ServicoAdminForm
    # --- MODIFICADO ---
    list_display = ('nome', 'negocio', 'categoria', 'preco',
                    'duracao_minutos', 'percentual_adiantamento', 'get_profissionais') # <-- ADICIONADO
    # Adicionado 'categoria__nome'
    search_fields = ('nome', 'negocio__nome_negocio', 'categoria__nome')
    list_filter = ('negocio', 'categoria')  # Adicionado 'categoria'
    # --- FIM DA MODIFICAÇÃO ---
    list_editable = ('preco', 'duracao_minutos', 'percentual_adiantamento') # <-- ADICIONADO
    filter_horizontal = ('profissionais_que_executam',)

    # --- NOVA ADIÇÃO ---
    # Adiciona os 'PrecoManutencao' inline na página do Serviço
    inlines = [PrecoManutencaoInline]
    # --- FIM DA ADIÇÃO ---

    @admin.display(description='Profissionais')
    def get_profissionais(self, obj):
        nomes = [p.user.get_full_name(
        ) or p.user.username for p in obj.profissionais_que_executam.all()]
        return ", ".join(nomes)
    
# -----------------------------------------------------------
# Configuração para "Agendamento"
# -----------------------------------------------------------

@admin.register(Agendamento)
class AgendamentoAdmin(admin.ModelAdmin):
    # --- MODIFICADO ---
    list_display = (
        '__str__',  # Usa o __str__ customizado do modelo
        'get_cliente_nome',
        'get_negocio',
        'data',
        'horario',
        'status',
        'status_pagamento', # <-- ADICIONADO
        'preco_final', 
        'valor_adiantamento', # <-- ADICIONADO
        'duracao_final'
    )
    list_filter = ('data', 'status', 'status_pagamento', 'servico__negocio', # <-- ADICIONADO
                   'servico__categoria')  
    search_fields = (
        'servico__nome',
        'cliente__user__username',
        'empreendedor_executor__user__username',
        'tier_manutencao__nome_tier',
        'payment_id_mp' # <-- ADICIONADO
    )

    # --- NOVA ADIÇÃO ---
    # Campos que não devem ser editados no admin após a criação
    readonly_fields = ('preco_final', 'duracao_final', 'valor_adiantamento', 
                       'payment_id_mp', 'payment_qrcode', 'payment_qrcode_image', 'payment_expires') # <-- ADICIONADO
    # --- FIM DA ADIÇÃO ---

    @admin.display(description='Cliente')
    def get_cliente_nome(self, obj):
        return obj.cliente.user.get_full_name()

    @admin.display(description='Negócio')
    def get_negocio(self, obj):
        return obj.servico.negocio
    
# -----------------------------------------------------------
# Configuração para "Despesa"
# -----------------------------------------------------------


@admin.register(Despesa)
class DespesaAdmin(admin.ModelAdmin):
    list_display = ('descricao', 'negocio', 'valor',
                    'data', 'categoria', 'pago')
    search_fields = ('descricao', 'negocio__nome_negocio')
    list_filter = ('data', 'categoria', 'pago', 'negocio')
    list_editable = ('valor', 'pago')


@admin.register(HorarioTrabalho)
class HorarioTrabalhoAdmin(admin.ModelAdmin):
    list_display = ('empreendedor', 'get_negocio',
                    'dia_da_semana', 'hora_inicio', 'hora_fim')
    list_filter = ('empreendedor__negocio', 'dia_da_semana')

    @admin.display(description='Negócio')
    def get_negocio(self, obj):
        return obj.empreendedor.negocio


@admin.register(Aviso)
class AvisoAdmin(admin.ModelAdmin):
    list_display = ('titulo', 'negocio', 'ordem')
    list_filter = ('negocio',)
    search_fields = ('titulo', 'conteudo')


@admin.register(DiaBloqueado)
class DiaBloqueadoAdmin(admin.ModelAdmin):
    list_display = ('empreendedor', 'data', 'descricao')
    list_filter = ('empreendedor__negocio', 'data')
    search_fields = ('descricao',)

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\apps.py

from django.apps import AppConfig


class AgendamentosConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'agendamentos'

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\context_processors.py


_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\forms.py


_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\mercadopago_service.py

import os
import mercadopago
import uuid
from django.conf import settings
from django.urls import reverse
from django.utils import timezone
from datetime import timedelta
import logging

logger = logging.getLogger(__name__)


class MercadoPagoService:
    def __init__(self):
        self.access_token = settings.MERCADO_PAGO_ACCESS_TOKEN
        if not self.access_token:
            logger.critical("MERCADO_PAGO_ACCESS_TOKEN não configurado.")
            raise ValueError("MERCADO_PAGO_ACCESS_TOKEN não encontrado.")

        self.sdk = mercadopago.SDK(self.access_token)
        logger.warning("SDK do Mercado Pago INICIALIZADO.")

    def criar_pagamento_pix(self, agendamento):
        if not agendamento or not agendamento.valor_adiantamento or agendamento.valor_adiantamento <= 0:
            logger.warning(
                f"Tentativa de criar pagamento sem valor para Agendamento ID: {agendamento.id}")
            return None

        # --- A data de expiração NÃO será enviada para a API neste teste ---
        minutos_expiracao = settings.MINUTOS_EXPIRACAO_PIX
        data_expiracao = timezone.now() + timedelta(minutes=minutos_expiracao)
        # data_expiracao_iso = data_expiracao.isoformat(timespec='milliseconds')
        # ... (cálculo de fuso removido por ser desnecessário para o teste)

        # --- A URL do Webhook NÃO será enviada para a API neste teste ---
        # webhook_url = f"{settings.BASE_URL.rstrip('/')}/webhook/mercado-pago/"

        logger.warning(
            f"CRIANDO PAGAMENTO PIX (MODO TESTE SÍNCRONO) para Agendamento ID: {agendamento.id}")

        # --- Lógica do Pagador Anônimo (está correta) ---
        email_pagador_anonimo = f"cliente.{agendamento.id}@jrtech.sistemas.com"
        first_name = "Cliente"
        last_name = f"Pedido-{agendamento.id}"

        logger.warning(
            f"Usando pagador anônimo: {first_name} {last_name} <{email_pagador_anonimo}>")

        payment_data = {
            "transaction_amount": float(agendamento.valor_adiantamento),
            "description": f"Adiantamento: {agendamento.servico.nome} (Pedido: {agendamento.id})",
            "payment_method_id": "pix",
            "external_reference": str(agendamento.id),

            # --- CAMPOS REMOVIDOS PARA O TESTE ---
            # "notification_url": webhook_url,
            # "date_of_expiration": data_expiracao_iso,

            "payer": {
                "email": email_pagador_anonimo,
                "first_name": first_name,
                "last_name": last_name,
            }
        }

        logger.critical(f"--- PAYLOAD PIX (Agendamento {agendamento.id}) ---")
        logger.critical(payment_data)

        try:
            idempotency_key = str(uuid.uuid4())
            request_options = mercadopago.config.RequestOptions(
                custom_headers={'X-Idempotency-Key': idempotency_key}
            )

            result = self.sdk.payment().create(payment_data, request_options)

            if result.get("status") == 201:
                payment = result["response"]
                logger.warning(
                    f"Pagamento criado com sucesso! Payment ID: {payment['id']} para Agendamento ID: {agendamento.id}")

                pix_data = payment.get("point_of_interaction", {}).get(
                    "transaction_data", {})
                qr_code_base64 = pix_data.get("qr_code_base64")
                qr_code_copy = pix_data.get("qr_code")

                if not qr_code_base64 or not qr_code_copy:
                    logger.critical(
                        "API do Mercado Pago não retornou os dados do PIX.")
                    return None

                return {
                    "payment_id": payment["id"],
                    "qr_code_base64": qr_code_base64,
                    "qr_code": qr_code_copy,
                    # Precisamos retornar a expiração para o frontend, mesmo que o MP não saiba dela
                    "expires_at": data_expiracao
                }
            else:
                logger.critical(f"--- ERRO API (CRIAR) ---")
                logger.critical(
                    f"Erro ao criar pagamento (Status {result.get('status')}) para Agendamento {agendamento.id}.")
                logger.critical(f"Resposta completa da API: {result}")
                return None
        except Exception as e:
            logger.critical(f"--- EXCEÇÃO API (CRIAR) ---")
            logger.critical(
                f"Exceção na API do Mercado Pago ao criar pagamento para Agendamento {agendamento.id}: {str(e)}", exc_info=True)
            if hasattr(e, 'response'):
                logger.critical(
                    f"Detalhes da exceção (response): {e.response}")
            return None

    def verificar_status_pagamento(self, payment_id_mp):
        # Esta função continuará funcionando normalmente para o polling
        if not payment_id_mp:
            return None

        logger.warning(f"Verificando status do Payment ID: {payment_id_mp}")
        try:
            result = self.sdk.payment().get(int(payment_id_mp))

            if result.get("status") == 200:
                payment_response = result.get("response", {})
                status = payment_response.get("status")
                logger.warning(
                    f"Status retornado pela API: {status} para Payment ID: {payment_id_mp}")
                return status
            else:
                logger.critical(f"--- ERRO API (VERIFICAR) ---")
                logger.critical(
                    f"Erro ao VERIFICAR status no Mercado Pago (Status {result.get('status')}) para Payment ID: {payment_id_mp}.")
                logger.critical(f"Resposta completa da API: {result}")
                return None
        except Exception as e:
            logger.critical(
                f"Exceção ao verificar status: {str(e)}", exc_info=True)
            return None

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\models.py

# agendamentos/models.py

from django.db import models
from django.contrib.auth.models import User
from django.utils.text import slugify
from django.core.exceptions import ValidationError  # << ADICIONE ESTA IMPORTAÇÃO
import datetime

import uuid

# -----------------------------------------------------------------
# MODELO 1: O "DONO" DO LINK (O TENANT)
# -----------------------------------------------------------------


class Negocio(models.Model):
    """
    Representa o "Studio" ou "Salão" - a entidade que possui o link (slug).
    Ex: "Salão da Maria", "Barbearia do João".
    """
    nome_negocio = models.CharField(max_length=100, unique=True)
    slug = models.SlugField(max_length=100, unique=True, blank=True,
                            help_text="Identificador único para a URL. Ex: nome-do-salao")
    cor_primaria = models.CharField(max_length=7, default='#5CCFAC',
                                    help_text="Cor principal do tema (formato hexadecimal, ex: #FF5733)")

    cor_secundaria = models.CharField(max_length=7, default="#FFFFFF",
                                      help_text="Cor secundária (ex: rosa claro #FFD1DC)")

    tagline = models.CharField(max_length=150, blank=True,
                               default="Espaço dedicado à beleza e bem-estar")

    logo = models.ImageField(
        upload_to='negocios_logos/', null=True, blank=True)

    dias_antecedencia_maxima = models.IntegerField(
        default=60,  # Padrão de 60 dias (2 meses)
        help_text="Número máximo de dias no futuro que um cliente pode agendar."
    )

    # --- INÍCIO DA ADIÇÃO ---
    portfolio_url = models.URLField(
        max_length=1024,
        blank=True,
        null=True,
        help_text="Link do seu portfólio externo (Canva, site próprio, etc.)"
    )

    pagamento_online_habilitado = models.BooleanField(
        default=False,
        help_text="Marque esta opção para habilitar pagamentos via Pix (adiantamento)."
    )

    # --- INÍCIO DA NOVA ADIÇÃO ---
    api_token = models.UUIDField(
        default=uuid.uuid4,
        editable=False,
        unique=True,
        help_text="Token único para integração com n8n/Evolution API"
    )

    def save(self, *args, **kwargs):
        # Garante que o slug seja sempre atualizado com base no nome
        self.slug = slugify(self.nome_negocio)
        super().save(*args, **kwargs)

    def __str__(self):
        return self.nome_negocio

# -----------------------------------------------------------------
# MODELO 2: OS FUNCIONÁRIOS (ADMINS) DAQUELE NEGÓCIO
# -----------------------------------------------------------------


class EmpreendedorProfile(models.Model):
    """
    Representa o perfil de um usuário que é funcionário ou dono
    de um Negocio. É quem vai acessar o /dashboard/.
    """
    user = models.OneToOneField(
        User, on_delete=models.CASCADE, related_name='empreendedor_profile')
    negocio = models.ForeignKey(
        Negocio, on_delete=models.CASCADE, related_name='membros')
    telefone = models.CharField(max_length=20, blank=True)
    # Futuramente, você pode adicionar 'is_admin_do_negocio' etc.

    foto = models.ImageField(
        upload_to='profissionais_fotos/', null=True, blank=True)

    def __str__(self):
        return f"{self.user.get_full_name()} @ {self.negocio.nome_negocio}"

# -----------------------------------------------------------------
# MODELO 3: OS CLIENTES DAQUELE NEGÓCIO
# -----------------------------------------------------------------


class Cliente(models.Model):
    """
    Representa o cliente final. O Cliente pertence a um Negocio.
    """
    negocio = models.ForeignKey(
        Negocio, on_delete=models.CASCADE)  # <-- MUDANÇA
    user = models.OneToOneField(User, on_delete=models.CASCADE)
    telefone = models.CharField(max_length=20)

    data_nascimento = models.DateField(null=True, blank=True)

    class Meta:
        # Garante que um telefone não possa ser usado duas vezes no MESMO negócio
        unique_together = ('negocio', 'telefone')

    def __str__(self):
        return f"{self.user.get_full_name()} (Cliente de {self.negocio.nome_negocio})"

# =================================================================
# NOVA ADIÇÃO: MODELO DE CATEGORIA
# =================================================================


class Categoria(models.Model):
    """
    Categorias de serviços para agrupar manutenções.
    Ex: Cílios, Unhas, Cabelo.
    """
    negocio = models.ForeignKey(
        Negocio, on_delete=models.CASCADE, related_name='categorias')
    nome = models.CharField(max_length=100)

    class Meta:
        # Garante que o negócio não tenha categorias duplicadas
        unique_together = ('negocio', 'nome')

    def __str__(self):
        return self.nome

# -----------------------------------------------------------------
# MODELO 4: OS SERVIÇOS DAQUELE NEGÓCIO
# -----------------------------------------------------------------


class Servico(models.Model):
    """
    Serviços que um Negocio oferece. (MODIFICADO)
    """
    negocio = models.ForeignKey(Negocio, on_delete=models.CASCADE)

    # --- CAMPO EXISTENTE ---
    profissionais_que_executam = models.ManyToManyField(
        'EmpreendedorProfile',
        related_name='servicos_oferecidos',
        blank=True
    )

    # --- CAMPO EXISTENTE ---
    categoria = models.ForeignKey(
        Categoria,
        on_delete=models.SET_NULL,  # Se a categoria for deletada, não deleta o serviço
        null=True,
        blank=True,  # Permite serviços sem categoria
        related_name='servicos'
    )

    # --- INÍCIO DA NOVA ADIÇÃO ---
    percentual_adiantamento = models.PositiveIntegerField(
        default=0,
        help_text="Porcentagem (0 a 100) a ser cobrada como adiantamento no agendamento."
    )
    # --- FIM DA NOVA ADIÇÃO ---

    nome = models.CharField(max_length=100)
    descricao = models.TextField()
    duracao_minutos = models.PositiveIntegerField(
        help_text="Duração do serviço em minutos (para 1ª vez ou troca)")
    preco = models.DecimalField(
        max_digits=10,
        decimal_places=2,
        help_text="Preço do serviço 'cheio' (para 1ª vez ou troca)")
    imagem = models.ImageField(upload_to='servicos/', null=True, blank=True)

    @property
    def duracao_formatada(self):
        horas = self.duracao_minutos // 60
        minutos = self.duracao_minutos % 60
        if horas > 0:
            return f"{horas}h {minutos}min" if minutos > 0 else f"{horas}h"
        return f"{minutos} min"

    def __str__(self):
        return self.nome

# =================================================================
# NOVA ADIÇÃO: MODELO DE PREÇOS DE MANUTENÇÃO
# =================================================================


class PrecoManutencao(models.Model):
    """
    Define os 'tiers' de manutenção para um serviço principal. (MODIFICADO)
    """
    servico_pai = models.ForeignKey(
        Servico,
        on_delete=models.CASCADE,
        related_name='precos_manutencao'
    )
    nome_tier = models.CharField(
        max_length=100,
        help_text="Ex: Manutenção de 5 a 10 dias"
    )

    # Range de dias desde o último serviço
    dias_min = models.PositiveIntegerField(
        help_text="Ex: 5 (para 'de 5 a 10 dias')")
    dias_max = models.PositiveIntegerField(
        help_text="Ex: 10 (para 'de 5 a 10 dias')")

    # Preço e Duração específicos desta manutenção
    preco = models.DecimalField(max_digits=10, decimal_places=2)
    duracao_minutos = models.PositiveIntegerField()

    # --- INÍCIO DA NOVA ADIÇÃO ---
    percentual_adiantamento = models.PositiveIntegerField(
        default=0,
        help_text="Porcentagem (0 a 100) a ser cobrada como adiantamento no agendamento."
    )
    # --- FIM DA NOVA ADIÇÃO ---

    class Meta:
        ordering = ['dias_min']

    def clean(self):
        # Validação para garantir que min < max
        if self.dias_min is not None and self.dias_max is not None and self.dias_min >= self.dias_max:
            raise ValidationError(
                "O 'dias_min' deve ser menor que o 'dias_max'.")

    @property
    def duracao_formatada(self):
        horas = self.duracao_minutos // 60
        minutos = self.duracao_minutos % 60
        if horas > 0:
            return f"{horas}h {minutos}min" if minutos > 0 else f"{horas}h"
        return f"{minutos} min"

    def __str__(self):
        return f"{self.servico_pai.nome} - {self.nome_tier}"

# -----------------------------------------------------------------
# MODELO 5: AGENDAMENTOS (CONECTA TUDO)
# -----------------------------------------------------------------


class Agendamento(models.Model):
    STATUS_CHOICES = [
        ('Pendente', 'Pendente'),
        ('Confirmado', 'Confirmado'),
        ('Cancelado', 'Cancelado'),
        ('Concluído', 'Concluído'),
    ]

    PAGAMENTO_STATUS = [
        ('Aguardando Pagamento', 'Aguardando Pagamento'),
        ('Pendente', 'Pendente'),
        ('Adiantamento Realizado', 'Adiantamento Realizado'),
        ('Pago', 'Pago'),
        ('Cancelado', 'Cancelado'),
    ]

    # Cliente e Serviço já estão ligados ao Negocio
    cliente = models.ForeignKey(Cliente, on_delete=models.CASCADE)

    # --- CAMPO EXISTENTE ---
    servico = models.ForeignKey(Servico, on_delete=models.CASCADE)

    # --- CAMPO EXISTENTE ---
    tier_manutencao = models.ForeignKey(
        PrecoManutencao,
        on_delete=models.SET_NULL,  # Se o tier for deletado, mantemos o agendamento
        null=True,
        blank=True
    )

    # --- CAMPOS EXISTENTES ---
    preco_final = models.DecimalField(
        max_digits=10, decimal_places=2, null=True, blank=True)
    duracao_final = models.PositiveIntegerField(null=True, blank=True)

    # --- INÍCIO DA NOVA ADIÇÃO (Campos de Pagamento) ---
    valor_adiantamento = models.DecimalField(
        max_digits=10, decimal_places=2, null=True, blank=True,
        help_text="Valor calculado do adiantamento (se houver)"
    )
    payment_id_mp = models.CharField(
        max_length=100, null=True, blank=True,
        help_text="ID do pagamento gerado pelo Mercado Pago"
    )
    payment_qrcode = models.TextField(
        null=True, blank=True,
        help_text="Código PIX Copia e Cola"
    )
    payment_qrcode_image = models.TextField(
        null=True, blank=True,
        help_text="Imagem Base64 do QR Code PIX"
    )
    payment_expires = models.DateTimeField(
        null=True, blank=True,
        help_text="Data e hora que o PIX expira"
    )
    # --- FIM DA NOVA ADIÇÃO ---

    empreendedor_executor = models.ForeignKey(
        'EmpreendedorProfile',
        on_delete=models.PROTECT,
        related_name='agendamentos_executados',
        null=True,
        blank=True
    )

    data = models.DateField()
    horario = models.TimeField()
    status = models.CharField(
        max_length=50, choices=STATUS_CHOICES, default='Pendente')

    # --- MUDANÇA AQUI ---
    status_pagamento = models.CharField(
        max_length=30,
        choices=PAGAMENTO_STATUS,
        default='Pendente'
    )
    observacoes = models.TextField(blank=True, null=True)

    # --- LÓGICA DE save() MODIFICADA ---
    def save(self, *args, **kwargs):
        # Define o preço, duração e adiantamento APENAS se não estiverem definidos
        if self.preco_final is None or self.duracao_final is None or self.valor_adiantamento is None:
            percentual_adiantamento = 0

            if self.tier_manutencao:
                self.preco_final = self.tier_manutencao.preco
                self.duracao_final = self.tier_manutencao.duracao_minutos
                percentual_adiantamento = self.tier_manutencao.percentual_adiantamento
            else:
                self.preco_final = self.servico.preco
                self.duracao_final = self.servico.duracao_minutos
                percentual_adiantamento = self.servico.percentual_adiantamento

            # Calcula o valor do adiantamento
            if percentual_adiantamento > 0:
                self.valor_adiantamento = (
                    self.preco_final * percentual_adiantamento) / 100
            else:
                self.valor_adiantamento = 0

        # --- Bloco de auto-confirmação REMOVIDO ---
        # if self.valor_adiantamento == 0 and self.status == 'Aguardando Pagamento':
        #     self.status = 'Confirmado'
        #     self.status_pagamento = 'Pago'
        # --- FIM DA REMOÇÃO ---

        super().save(*args, **kwargs)
    # --- FIM DA MODIFICAÇÃO ---

    def __str__(self):
        # --- LÓGICA MODIFICADA ---
        nome_servico = ""
        if self.tier_manutencao:
            nome_servico = self.tier_manutencao.nome_tier
        else:
            nome_servico = self.servico.nome

        cliente_nome = "Cliente"
        if self.cliente and self.cliente.user:
            cliente_nome = self.cliente.user.get_full_name()

        return f"{nome_servico} para {cliente_nome} em {self.data} às {self.horario}"
        # --- FIM DA MODIFICAÇÃO ---

# Novos modelos para controle financeiro


class Despesa(models.Model):
    CATEGORIA_CHOICES = [
        ('Aluguel', 'Aluguel'),
        ('Materiais', 'Materiais'),
        ('Serviços', 'Serviços'),
        ('Impostos', 'Impostos'),
        ('Salários', 'Salários'),
        ('Outros', 'Outros'),
    ]
    negocio = models.ForeignKey(
        Negocio, on_delete=models.CASCADE)  # <-- MUDANÇA
    descricao = models.CharField(max_length=200)
    valor = models.DecimalField(max_digits=10, decimal_places=2)
    data = models.DateField()
    categoria = models.CharField(max_length=20, choices=CATEGORIA_CHOICES)
    pago = models.BooleanField(default=False)
    comprovante = models.FileField(
        upload_to='comprovantes/', null=True, blank=True)

    def __str__(self):
        return f"{self.descricao} - R${self.valor} ({self.data})"

# -----------------------------------------------------------------
# MODELO 7: HORÁRIOS DE TRABALHO DO PROFISSIONAL
# -----------------------------------------------------------------


class HorarioTrabalho(models.Model):
    """
    Define um bloco de tempo em que um profissional está disponível.
    Um profissional pode ter vários blocos por dia (ex: manhã e tarde).
    """
    DIA_DA_SEMANA_CHOICES = [
        (0, 'Segunda-feira'),
        (1, 'Terça-feira'),
        (2, 'Quarta-feira'),
        (3, 'Quinta-feira'),
        (4, 'Sexta-feira'),
        (5, 'Sábado'),
        (6, 'Domingo'),
    ]

    empreendedor = models.ForeignKey(
        EmpreendedorProfile,
        on_delete=models.CASCADE,
        related_name='horarios_trabalho'
    )
    dia_da_semana = models.IntegerField(choices=DIA_DA_SEMANA_CHOICES)
    hora_inicio = models.TimeField()
    hora_fim = models.TimeField()

    class Meta:
        # Garante que um profissional não tenha horários sobrepostos
        unique_together = ('empreendedor', 'dia_da_semana', 'hora_inicio')
        ordering = ['dia_da_semana', 'hora_inicio']

    def __str__(self):
        return f"{self.empreendedor.user.username} - {self.get_dia_da_semana_display()}: {self.hora_inicio} - {self.hora_fim}"

# -----------------------------------------------------------------
# MODELO 8: MURAL DE AVISOS DINÂMICO
# -----------------------------------------------------------------


class Aviso(models.Model):
    """
    Um item individual no mural de avisos de um Negócio.
    Ex: "Política de Cancelamento", "Aviso de Feriado", etc.
    """
    negocio = models.ForeignKey(
        Negocio, on_delete=models.CASCADE, related_name='avisos')
    titulo = models.CharField(max_length=100)
    conteudo = models.TextField(
        help_text="Conteúdo do aviso. Use <li> para listas.")
    ordem = models.PositiveIntegerField(
        default=0, help_text="Para ordenar os avisos (0 primeiro)")

    class Meta:
        ordering = ['ordem', 'id']

    def __str__(self):
        return f"{self.negocio.nome_negocio} - {self.titulo}"

# -----------------------------------------------------------------
# MODELO 9: DIAS DE FOLGA / BLOQUEIOS DE AGENDA
# -----------------------------------------------------------------


class DiaBloqueado(models.Model):
    """
    Representa um dia específico em que um profissional não trabalhará,
    substituindo o HorarioTrabalho recorrente.
    """
    empreendedor = models.ForeignKey(
        EmpreendedorProfile,
        on_delete=models.CASCADE,
        related_name='dias_bloqueados'
    )
    data = models.DateField()
    descricao = models.CharField(
        max_length=100, blank=True, help_text="Ex: Feriado, Férias, Consulta Médica")

    class Meta:
        # Garante que um profissional só possa bloquear um dia uma vez
        unique_together = ('empreendedor', 'data')
        ordering = ['data']

    def __str__(self):
        return f"{self.empreendedor.user.username} - BLOQUEADO em {self.data}"

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\tests.py

from django.test import TestCase

# Create your tests here.

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\urls.py

# agendamentos/urls.py

from django.urls import path
from . import views

# O 'app_name' ajuda o Django a diferenciar as URLs se você tiver mais apps
app_name = 'agendamentos'

urlpatterns = [
    # A rota raiz AGORA aponta para a página principal do empreendedor
    # Ela será acessada via /slug-do-empreendedor/
    path('', views.index, name='empreendedor_home'),

    path('api/negocio-info/', views.api_negocio_info, name='api_negocio_info'),

    path('api/avisos/', views.api_get_avisos, name='api_get_avisos'),

    # --- ROTA DE LOGIN DE ADMIN RESTRITA (NOVA) ---
    # Captura o slug do negócio da URL principal
    path('api/admin/login/', views.scoped_admin_login,
         name='api_scoped_admin_login'),

    # Rotas da API para o JavaScript (agora relativas ao slug)
    path('api/servico/<int:servico_id>/profissionais/',
         views.get_profissionais_por_servico, name='api_get_profissionais_por_servico'),
    path('api/servicos/', views.lista_servicos, name='api_lista_servicos'),
    path('api/agendamentos/', views.lista_agendamentos,
         name='api_lista_agendamentos'),
    path('api/register/', views.register_user, name='api_register'),
    path('api/login/', views.login_user, name='api_login'),
    path('api/login-phone/', views.login_user_with_phone, name='api_login_phone'),
    path('api/logout/', views.logout_user, name='api_logout'),
    path('api/check_auth/', views.check_auth_status, name='api_check_auth'),
    path('api/meus_agendamentos/', views.lista_meus_agendamentos,
         name='api_lista_meus_agendamentos'),
    path('api/me/profile/', views.api_manage_profile, name='api_manage_profile'),
    path('api/agendar/', views.criar_agendamento, name='api_criar_agendamento'),
    path('api/horarios_disponiveis/', views.get_horarios_disponiveis,
         name='api_horarios_disponiveis'),
    path('api/dias_disponiveis/', views.dias_disponiveis,
         name='api_dias_disponiveis'),
    path('api/agendamentos/<int:agendamento_id>/cancelar/',
         views.cancelar_agendamento, name='api_cancelar_agendamento'),

    # --- INÍCIO DA NOVA ADIÇÃO ---
    path('api/check-booking-status/<int:agendamento_id>/',
         views.check_booking_status, name='api_check_booking_status'),
    # --- FIM DA NOVA ADIÇÃO ---

    # Rotas de Login Admin (não precisam de slug, pois são globais)
    # Elas serão movidas para o urls.py principal
]

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\views.py

# agendamentos/views.py

from django.shortcuts import render, get_object_or_404
from django.http import JsonResponse, HttpResponseForbidden
import json
from django.db import transaction
from django.contrib.auth.models import User
from django.contrib.auth import authenticate, login, logout
from django.views.decorators.csrf import csrf_exempt
from django.contrib.auth.decorators import login_required, user_passes_test
from django.utils import timezone
from datetime import datetime, time, timedelta
import calendar
from django.core.exceptions import ValidationError
import colorsys
from django.utils.text import slugify
from django.db.models import Sum, Count
from django.db.models import Sum, Count, OuterRef, Subquery, Q  # << ADICIONE Q
from datetime import datetime, time, timedelta  # << ADICIONE timedelta
import calendar  # << ADICIONE calendar
from django.conf import settings
from django.utils import timezone
from datetime import timedelta
from .mercadopago_service import MercadoPagoService
import logging
import re  # Para limpar o telefone
from django.db.models import Q

from django.contrib.auth.models import User
from django.utils.crypto import get_random_string

# --- IMPORTAÇÃO CORRIGIDA ---
# Adicionamos EmpreendedorProfile e removemos importações duplicadas
from .models import (
    Servico, Agendamento, Cliente, Negocio, EmpreendedorProfile, Despesa, HorarioTrabalho, Aviso, DiaBloqueado,
    Categoria, PrecoManutencao
)

from django.db import transaction  # Adicione esta importação
from django.utils.crypto import get_random_string  # Adicione esta importação

logger = logging.getLogger(__name__)

# ---
# Views do Cliente (A maior parte já estava correta!)
# ---


def index(request, empreendedor_slug):
    try:
        # 1. Tenta encontrar o negócio pelo slug
        negocio = Negocio.objects.get(slug=empreendedor_slug)

        # 2. Se encontrar, renderiza o SPA (index.html)
        return render(request, 'agendamentos/index.html')

    except Negocio.DoesNotExist:
        # 3. Se NÃO encontrar, renderiza uma página de erro personalizada
        context = {'slug_invalido': empreendedor_slug}
        return render(request, 'agendamentos/negocio_nao_encontrado.html', context, status=404)


def lista_servicos(request, empreendedor_slug):
    # --- LÓGICA INTEIRA MODIFICADA ---
    negocio = get_object_or_404(Negocio, slug=empreendedor_slug)

    # Busca todos os serviços principais (exclui os que são SÓ manutenção, se houver)
    # Por enquanto, nosso modelo assume que todo serviço "pai" é agendável
    servicos_principais = Servico.objects.filter(
        negocio=negocio
    ).prefetch_related(
        'precos_manutencao'  # Puxa os tiers de manutenção
    )

    cliente = None
    if request.user.is_authenticated:
        try:
            cliente = Cliente.objects.get(user=request.user, negocio=negocio)
        except Cliente.DoesNotExist:
            # Usuário logado mas não é cliente (ex: admin de outro negócio)
            cliente = None

    # Encontra o último agendamento CONCLUÍDO (ou Confirmado) do cliente
    ultimo_agendamento = None
    if cliente:
        # Subquery para encontrar a data mais recente
        # (Isso garante que estamos pegando o mais recente MESMO)
        data_recente = Agendamento.objects.filter(
            cliente=cliente,
            servico__categoria=OuterRef('servico__categoria'),
            status__in=['Concluído', 'Confirmado']
        ).order_by('-data', '-horario').values('data')[:1]

        # Agora busca o agendamento naquela data
        # (Necessário porque pode haver múltiplos no mesmo dia)
        ultimo_agendamento_por_categoria = Agendamento.objects.filter(
            cliente=cliente,
            servico__categoria=OuterRef('servico__categoria'),
            status__in=['Concluído', 'Confirmado'],
            data=Subquery(data_recente)
        ).order_by('-horario').values('id')[:1]

        # Pega o último agendamento geral do cliente
        ultimo_agendamento = Agendamento.objects.filter(
            cliente=cliente,
            status__in=['Concluído', 'Confirmado']
        ).order_by('-data', '-horario').first()

    data_final_servicos = []

    for servico in servicos_principais:
        # Dados base do serviço (preço cheio)
        servico_data = {
            'id': servico.id,
            'name': servico.nome,
            'description': servico.descricao,
            'duracao_minutos': servico.duracao_minutos,
            'duracao_formatada': servico.duracao_formatada,
            'price': float(servico.preco),
            'icon': '✨',
            'image_url': servico.imagem.url if servico.imagem else None,
            'categoria_id': servico.categoria_id,
            'tiers_manutencao': []  # Lista de manutenções disponíveis
        }

        # Se o cliente não está logado, ou o serviço não tem categoria,
        # ou não há um último agendamento, mostramos apenas o preço cheio.
        if not cliente or not servico.categoria or not ultimo_agendamento:
            data_final_servicos.append(servico_data)
            continue  # Próximo serviço

        # O cliente está logado e o serviço tem categoria.
        # Verificamos se o ÚLTIMO agendamento dele foi dessa categoria.
        if (ultimo_agendamento.servico.categoria_id != servico.categoria_id):
            # Cenário A: Categoria diferente (Ex: Unha -> Cílios).
            # Isso é uma "troca de serviço", mostra o preço cheio.
            data_final_servicos.append(servico_data)
            continue  # Próximo serviço

        # SE CHEGOU AQUI:
        # A CATEGORIA É A MESMA.
        # Agora, verificamos se é o *mesmo serviço* ou uma *troca* dentro da categoria.

        # Esta é a nova variável crucial:
        is_troca_servico = (ultimo_agendamento.servico.id != servico.id)

        # Calcula há quantos dias foi o último serviço
        dias_desde_ultimo_servico = (
            datetime.now().date() - ultimo_agendamento.data).days

        # --- INÍCIO DA NOVA LÓGICA ---
        # Decide qual texto será usado no pop-up do frontend
        motivo_preco_cheio = ""
        if is_troca_servico:
            motivo_preco_cheio = "Troca de serviço"
        else:
            # Se não é troca, o único outro motivo para o preço cheio é expiração
            motivo_preco_cheio = "Expiração das manutenções"

        # Adiciona o motivo ao dicionário que vai para o frontend
        servico_data['motivo_preco_cheio'] = motivo_preco_cheio
        # --- FIM DA NOVA LÓGICA ---

        tiers_disponiveis = []

        for tier in servico.precos_manutencao.all():

            # --- ESTA É A MUDANÇA PRINCIPAL ---
            # O tier SÓ pode estar ativo se:
            # 1. NÃO for uma troca de serviço E
            # 2. Estiver dentro do range de dias.
            is_active = (
                not is_troca_servico and  # <-- ADICIONADO
                (tier.dias_min <= dias_desde_ultimo_servico <= tier.dias_max)
            )
            # --- FIM DA MUDANÇA ---

            # --- INÍCIO DA NOVA LÓGICA ---
            inactivity_message = ""
            if not is_active:
                if is_troca_servico:
                    # Este é o motivo se for uma troca de serviço
                    inactivity_message = "Indisponível para troca de serviço."
                elif dias_desde_ultimo_servico < tier.dias_min:
                    # Este é o motivo se AINDA NÃO CHEGOU O TEMPO
                    inactivity_message = f"Este período de manutenção estará disponível em {tier.dias_min} dias."
                elif dias_desde_ultimo_servico > tier.dias_max:
                    # Este é o motivo se JÁ PASSOU O TEMPO
                    inactivity_message = "Este período de manutenção já passou."
                else:
                    # Fallback
                    inactivity_message = "Este período não está disponível."
            # --- FIM DA NOVA LÓGICA ---

            tiers_disponiveis.append({
                'id': tier.id,
                'nome_tier': tier.nome_tier,
                'preco': float(tier.preco),
                'duracao_minutos': tier.duracao_minutos,
                'duracao_formatada': tier.duracao_formatada,
                'dias_min': tier.dias_min,
                'dias_max': tier.dias_max,
                'is_active': is_active,  # Agora 'is_active' será false se for troca
                'inactivity_message': inactivity_message
            })

        servico_data['tiers_manutencao'] = tiers_disponiveis
        data_final_servicos.append(servico_data)

    # A resposta da API agora é padronizada
    data = {
        'cor_primaria': negocio.cor_primaria,
        'servicos': data_final_servicos
    }
    return JsonResponse(data)
    # --- FIM DA LÓGICA MODIFICADA ---


def get_profissionais_por_servico(request, empreendedor_slug, servico_id):
    try:
        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)
        servico = get_object_or_404(Servico, id=servico_id, negocio=negocio)

        profissionais = servico.profissionais_que_executam.all()

        data = [
            {
                'id': prof.id,
                'nome': prof.user.get_full_name() or prof.user.username,
                'foto_url': prof.foto.url if prof.foto else None,
                # Futuramente você pode adicionar foto_url, etc.
            } for prof in profissionais
        ]

        # Se não houver profissionais, mas o serviço existir, retorna lista vazia
        return JsonResponse(data, safe=False)

    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
def register_user(request, empreendedor_slug):
    if request.method == 'POST':
        data = json.loads(request.body)
        email = data.get('email')
        phone = data.get('phone')  # <-- Pega o telefone
        password = get_random_string(length=14)

        try:
            negocio = Negocio.objects.get(slug=empreendedor_slug)
        except Negocio.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Negócio não encontrado.'}, status=404)

        # 1. Verificação de Email (já existente)
        if User.objects.filter(username=email).exists():
            return JsonResponse({'status': 'error', 'message': 'Este e-mail já está em uso.'}, status=400)

        # --- ADICIONE ESTE BLOCO ---
        # 2. Verificação de Telefone
        if not phone:
            return JsonResponse({'status': 'error', 'message': 'O telefone é obrigatório.'}, status=400)

        telefone_limpo = re.sub(r'\D', '', phone)  # Este será o novo username

        # 1. Verificação de Telefone (que agora é o USERNAME)
        # Verifica se o telefone já existe GLOBALMENTE como um username
        if User.objects.filter(username=telefone_limpo).exists():
            return JsonResponse({'status': 'error', 'message': 'Este telefone já está em uso.'}, status=400)

        # 2. Verificação de Email (SÓ SE ele foi fornecido)
        if email:
            if User.objects.filter(email=email).exists():
                return JsonResponse({'status': 'error', 'message': 'Este e-mail já está em uso.'}, status=400)
        else:
            email = None  # Garante que seja None se for "" (vazio)

        # 3. Verificação de Telefone no Negócio (validação do Cliente)
        if Cliente.objects.filter(negocio=negocio, telefone=telefone_limpo).exists():
            return JsonResponse({'status': 'error', 'message': 'Este telefone já está cadastrado neste negócio.'}, status=400)
        # --- FIM DA ADIÇÃO ---

        user = User.objects.create_user(
            username=telefone_limpo,  # <-- CORREÇÃO (usando telefone)
            email=email,
            password=password,
            first_name=data.get('name'),
            last_name=data.get('lastname')
        )

        data_nascimento = data.get('nascimento')
        # --- MUDANÇA AQUI ---
        if not data_nascimento:
            # Se não houver data de nascimento, retorna um erro
            user.delete()  # Exclui o usuário que foi criado
            return JsonResponse({'status': 'error', 'message': 'A data de nascimento é obrigatória para o cadastro.'}, status=400)

        Cliente.objects.create(
            user=user,
            telefone=telefone_limpo,
            negocio=negocio,
            data_nascimento=data_nascimento
        )

        login(request, user)
        return JsonResponse({'status': 'success', 'message': 'Registro e login bem-sucedidos!'}, status=201)
    return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)


@csrf_exempt
def login_user(request, empreendedor_slug):
    if request.method == 'POST':
        data = json.loads(request.body)
        email = data.get('email')
        password = data.get('password')

        try:
            negocio = Negocio.objects.get(slug=empreendedor_slug)
        except Negocio.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Negócio não encontrado.'}, status=404)

        user = authenticate(request, username=email, password=password)

        if user is not None:
            try:
                cliente = Cliente.objects.get(user=user, negocio=negocio)
                login(request, user)
                return JsonResponse({'status': 'success', 'message': 'Login bem-sucedido!'})
            except Cliente.DoesNotExist:
                return JsonResponse({'status': 'error', 'message': 'E-mail ou senha inválidos.'}, status=401)
        else:
            return JsonResponse({'status': 'error', 'message': 'E-mail ou senha inválidos.'}, status=401)
    return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)


@csrf_exempt
def login_user_with_phone(request, empreendedor_slug):
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)

    try:
        data = json.loads(request.body)
        phone = data.get('phone')
        nascimento = data.get('nascimento')  # Espera YYYY-MM-DD

        if not phone or not nascimento:
            return JsonResponse({'status': 'error', 'message': 'Telefone e data de nascimento são obrigatórios.'}, status=400)

        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)

        # --- Lógica de Autenticação ---
        # 1. Limpa o telefone (caso o JS falhe)
        telefone_limpo = re.sub(r'\D', '', phone)

        # 2. Busca o cliente
        cliente = Cliente.objects.filter(
            negocio=negocio,
            telefone=telefone_limpo,
            data_nascimento=nascimento
        ).select_related('user').first()  # Traz o 'user' junto na query

        if cliente and cliente.user:
            # 3. Se encontrou, loga o usuário associado
            login(request, cliente.user)
            return JsonResponse({'status': 'success', 'message': 'Login bem-sucedido!'})
        else:
            # 4. Se não encontrou, retorna erro
            return JsonResponse({'status': 'error', 'message': 'Telefone ou data de nascimento inválidos.'}, status=401)

    except (Negocio.DoesNotExist):
        return JsonResponse({'status': 'error', 'message': 'Negócio não encontrado.'}, status=404)
    except Exception as e:
        # Pega outros erros (ex: data de nascimento em formato inválido)
        return JsonResponse({'status': 'error', 'message': f'Erro no servidor: {str(e)}'}, status=500)


@csrf_exempt
def logout_user(request, empreendedor_slug):
    logout(request)
    return JsonResponse({'status': 'success', 'message': 'Logout bem-sucedido!'})


def check_auth_status(request, empreendedor_slug):
    if request.user.is_authenticated:
        return JsonResponse({
            'isAuthenticated': True,
            'user': {
                'name': request.user.first_name,
                'lastname': request.user.last_name,
                'email': request.user.email
            }
        })
    else:
        return JsonResponse({'isAuthenticated': False})


# @login_required(login_url=None)
def lista_meus_agendamentos(request, empreendedor_slug):
    if not request.user.is_authenticated:
        return JsonResponse({'status': 'error', 'message': 'Autenticação necessária.'}, status=403)
    try:
        cliente = request.user.cliente
        agendamentos = Agendamento.objects.filter(cliente=cliente).select_related(
            'servico').order_by('-data', '-horario')

        data = []
        for agendamento in agendamentos:
            appointment_datetime = timezone.make_aware(
                datetime.combine(agendamento.data, agendamento.horario))
            now = timezone.now()
            time_difference = appointment_datetime - now

            # --- MUDANÇA AQUI ---
            # Verifica o tempo E o status
            can_reschedule = (time_difference > timedelta(hours=24)) and (
                agendamento.status in ['Confirmado', 'Pendente'])

            # --- MUDANÇA 1: Buscar a Imagem ---
            service_image_url = None
            if agendamento.servico.imagem:
                service_image_url = agendamento.servico.imagem.url

            # --- MUDANÇA 2: Buscar o Profissional ---
            profissional_nome = "Profissional não definido"  # Fallback
            if agendamento.empreendedor_executor:
                profissional_nome = agendamento.empreendedor_executor.user.get_full_name(
                ) or agendamento.empreendedor_executor.user.username

            data.append({
                'id': agendamento.id,
                'service': agendamento.servico.nome,
                'serviceId': agendamento.servico.id,
                'date': agendamento.data.strftime('%Y-%m-%d'),
                'time': agendamento.horario.strftime('%H:%M'),
                'status': agendamento.status,
                'can_reschedule': can_reschedule,

                # --- CAMPOS ADICIONADOS PARA O NOVO CARD ---
                'serviceImageUrl': service_image_url,
                'profissional': profissional_nome,
                # Usa o preço final salvo
                'preco': str(agendamento.preco_final)
            })
        return JsonResponse(data, safe=False)
    except Cliente.DoesNotExist:
        return JsonResponse([], safe=False)


@csrf_exempt
@login_required(login_url=None)
def cancelar_agendamento(request, agendamento_id, empreendedor_slug):
    if request.method == 'POST':
        try:
            agendamento = Agendamento.objects.get(
                id=agendamento_id, cliente=request.user.cliente)
            agendamento.delete()
            return JsonResponse({'status': 'success', 'message': 'Agendamento cancelado com sucesso.'})
        except Agendamento.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Agendamento não encontrado ou não pertence a você.'}, status=404)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)
    return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)


@csrf_exempt
@login_required(login_url=None)
def criar_agendamento(request, empreendedor_slug):
    """
    Cria um agendamento.
    Se o adiantamento > 0, status = 'Aguardando Pagamento' e gera PIX.
    Se o adiantamento == 0, status = 'Confirmado'.
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)

    try:
        data = json.loads(request.body)
        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)
        cliente = request.user.cliente
        servico = Servico.objects.get(id=data['serviceId'], negocio=negocio)
        profissional = EmpreendedorProfile.objects.get(
            id=data['empreendedorId'], negocio=negocio)

        if cliente.negocio != negocio:
            return JsonResponse({'status': 'error', 'message': 'Erro de permissão.'}, status=403)

        # 1. Verifica se o horário ainda está disponível (SEGURANÇA)
        # (Você deve implementar uma lógica de verificação de conflito aqui)
        # ... (Omissão para brevidade, mas é CRUCIAL) ...

        # 2. Lógica de Manutenção
        tier_manutencao = None
        tier_id = data.get('tierManutencaoId')
        if tier_id:
            tier_manutencao = PrecoManutencao.objects.get(
                id=tier_id, servico_pai=servico)

        # 3. Cria o Agendamento (mas não salva ainda)
        ag = Agendamento(
            cliente=cliente,
            servico=servico,
            data=data['date'],
            horario=data['time'],
            empreendedor_executor=profissional,
            tier_manutencao=tier_manutencao,
            status='Pendente'  # <-- NOVO STATUS INICIAL
        )

        # 4. Roda o .save() para calcular preco_final e valor_adiantamento
        # (O .save() também define o status para 'Confirmado' se valor_adiantamento == 0)
        ag.save()

        # --- INÍCIO DO NOVO BLOCO ---
        # 5. Define o status de pagamento ANTES de verificar o PIX
        if negocio.pagamento_online_habilitado and ag.valor_adiantamento > 0:
            # SIM, precisa de PIX
            ag.status_pagamento = 'Aguardando Pagamento'
        else:
            # NÃO, pagamento no local (interruptor desligado OU adiantamento = 0)
            ag.status_pagamento = 'Pendente'  # Cliente pagará no local

        ag.save()  # Salva o status_pagamento
        # --- FIM DO NOVO BLOCO ---

        # 6. Verifica se o pagamento (PIX) é necessário
        # Ou (ag.valor_adiantamento == 0)
        if ag.status_pagamento == 'Pendente':
            # Não precisa de pagamento PIX, agendamento está Pendente.
            logger.info(
                f"Agendamento {ag.id} criado como Pendente (sem adiantamento).")
            return JsonResponse({
                'status': 'success',
                'payment_required': False,
                'agendamento_id': ag.id
            }, status=201)

        # 7. Pagamento PIX é necessário (status_pagamento == 'Aguardando Pagamento')
        try:
            mp = MercadoPagoService()
            payment_data = mp.criar_pagamento_pix(ag)

            if not payment_data:
                raise Exception("Falha ao gerar PIX no Mercado Pago.")

            # Atualiza o agendamento com os dados do PIX
            ag.payment_id_mp = payment_data["payment_id"]
            ag.payment_qrcode = payment_data["qr_code"]
            ag.payment_qrcode_image = payment_data["qr_code_base64"]
            ag.payment_expires = payment_data["expires_at"]
            ag.save()

            logger.info(
                f"Agendamento {ag.id} aguardando pagamento (PIX gerado).")

            # Retorna os dados do PIX para o frontend
            return JsonResponse({
                'status': 'pending_payment',
                'payment_required': True,
                'agendamento_id': ag.id,
                'payment_id_mp': ag.payment_id_mp,
                'qr_code': ag.payment_qrcode,
                'qr_code_base64': ag.payment_qrcode_image,
                'expires_at': ag.payment_expires.isoformat()
            }, status=201)

        except Exception as e:
            # Se a API do MP falhar, cancela o agendamento que acabamos de criar
            logger.error(
                f"Falha na API do MP para Agendamento {ag.id}. Cancelando. Erro: {e}")
            ag.status = 'Cancelado'
            ag.observacoes = f'Falha ao gerar PIX: {e}'
            ag.save()
            return JsonResponse({'status': 'error', 'message': f'Erro ao processar pagamento: {e}'}, status=500)

    except (Servico.DoesNotExist, EmpreendedorProfile.DoesNotExist, Cliente.DoesNotExist, PrecoManutencao.DoesNotExist):
        return JsonResponse({'status': 'error', 'message': 'Dados inválidos.'}, status=404)
    except Exception as e:
        logger.error(
            f"Erro inesperado em criar_agendamento: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
def mercadopago_webhook(request):
    """
    Recebe notificações de pagamento do Mercado Pago.
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)

    try:
        data = json.loads(request.body)
        logger.info(f"Webhook Mercado Pago recebido: {data}")

        if data.get("type") == "payment":
            payment_id_mp = str(data.get("data", {}).get("id"))
            if not payment_id_mp:
                return JsonResponse({'status': 'ignorado', 'message': 'Sem ID de pagamento.'}, status=200)

            logger.info(
                f"Processando notificação para Payment ID: {payment_id_mp}")

            # 1. Tenta encontrar o agendamento pelo ID do Pagamento do MP
            try:
                agendamento = Agendamento.objects.get(
                    payment_id_mp=payment_id_mp)
            except Agendamento.DoesNotExist:
                logger.warning(
                    f"Webhook para Payment ID {payment_id_mp} não encontrado no banco de dados.")
                return JsonResponse({'status': 'nao_encontrado'}, status=200)

            # 2. Se o agendamento já foi processado, ignora
            # --- MUDANÇA NA VERIFICAÇÃO ---
            if agendamento.status_pagamento != 'Aguardando Pagamento':
                logger.info(
                    f"Agendamento {agendamento.id} já processado (Status Pag: {agendamento.status_pagamento}). Ignorando webhook.")
                return JsonResponse({'status': 'ja_processado'}, status=200)

            # 3. Verifica o status real do pagamento na API do MP
            mp = MercadoPagoService()
            status_real = mp.verificar_status_pagamento(payment_id_mp)

            if status_real == "approved":
                agendamento.status = 'Pendente'  # O status do agendamento continua Pendente

                # --- INÍCIO DA NOVA LÓGICA CONDICIONAL ---
                if agendamento.valor_adiantamento < agendamento.preco_final:
                    agendamento.status_pagamento = 'Adiantamento Realizado'
                    agendamento.observacoes = f"Adiantamento {payment_id_mp} aprovado via webhook. Aguardando confirmação manual."
                else:
                    # O adiantamento era 100% do valor, então foi integral
                    agendamento.status_pagamento = 'Pago'
                    agendamento.observacoes = f"Pagamento integral {payment_id_mp} aprovado via webhook. Aguardando confirmação manual."
                # --- FIM DA NOVA LÓGICA CONDICIONAL ---

                agendamento.save()
                logger.info(
                    # <-- Log alterado
                    f"PAGAMENTO APROVADO: Agendamento {agendamento.id} PAGO. Aguardando confirmação manual.")
                # (Aqui você pode disparar um e-mail de confirmação para o cliente)

            elif status_real in ["rejected", "cancelled", "expired"]:
                agendamento.status = 'Cancelado'  # <-- Correto
                agendamento.status_pagamento = 'Cancelado'  # <-- Correto
                agendamento.observacoes = f"Pagamento {payment_id_mp} falhou ou expirou (Status: {status_real})."
                agendamento.save()
                logger.warning(
                    f"PAGAMENTO FALHOU: Agendamento {agendamento.id} cancelado.")

            else:
                logger.info(
                    f"Status '{status_real}' recebido para Agendamento {agendamento.id}. Nenhuma ação tomada.")

    except json.JSONDecodeError:
        logger.error("Erro ao decodificar JSON do webhook.")
        return JsonResponse({'status': 'error', 'message': 'JSON inválido.'}, status=400)
    except Exception as e:
        logger.error(f"Erro inesperado no webhook: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': 'Erro interno.'}, status=500)

    return JsonResponse({"status": "recebido"}, status=200)


@login_required(login_url=None)
def check_booking_status(request, agendamento_id, empreendedor_slug):
    """
    Verifica o status de um agendamento no banco de dados.
    Usado pelo frontend (polling) para atualizar a UI após o pagamento.
    """
    try:
        agendamento = get_object_or_404(
            Agendamento,
            id=agendamento_id,
            cliente=request.user.cliente
        )

        # Retorna o status atual do agendamento
        return JsonResponse({
            # Ex: "Aguardando Pagamento", "Confirmado", "Cancelado"
            'status': agendamento.status,
            'agendamento_id': agendamento.id
        })

    except Agendamento.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Agendamento não encontrado.'}, status=404)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=500)


def get_horarios_disponiveis(request, empreendedor_slug):
    # --- LÓGICA MODIFICADA ---
    data_str = request.GET.get('data')
    servico_id = request.GET.get('servico_id')
    empreendedor_id = request.GET.get('empreendedor_id')
    # --- NOVA ADIÇÃO ---
    # O JS deve enviar a duração EXATA do que foi selecionado
    # (seja o serviço principal ou o tier de manutenção)
    duracao_selecionada = request.GET.get('duracao')
    # --- FIM DA ADIÇÃO ---

    if not data_str or not servico_id or not empreendedor_id or not duracao_selecionada:
        return JsonResponse({'status': 'error', 'message': 'Data, serviço, profissional e duração são obrigatórios.'}, status=400)

    try:
        data = datetime.strptime(data_str, '%Y-%m-%d').date()
        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)
        # Valida o serviço e o profissional
        servico = Servico.objects.get(id=servico_id, negocio=negocio)
        profissional = EmpreendedorProfile.objects.get(
            id=empreendedor_id, negocio=negocio)
        # --- NOVA ADIÇÃO ---
        duracao_novo_servico = timedelta(minutes=int(duracao_selecionada))
        # --- FIM DA ADIÇÃO ---

    except (ValueError, Servico.DoesNotExist, EmpreendedorProfile.DoesNotExist):
        return JsonResponse({'status': 'error', 'message': 'Data, serviço ou profissional inválido.'}, status=400)

    if DiaBloqueado.objects.filter(empreendedor=profissional, data=data).exists():
        return JsonResponse([], safe=False)

    # --- INÍCIO DA NOVA LÓGICA DE HORÁRIOS ---

    # 1. Obter o dia da semana (0=Segunda, 1=Terça, ..., 6=Domingo)
    dia_da_semana = data.weekday()

    # 2. Buscar os blocos de trabalho personalizados deste profissional para este dia
    blocos_de_trabalho = HorarioTrabalho.objects.filter(
        empreendedor=profissional,
        dia_da_semana=dia_da_semana
    ).order_by('hora_inicio')

    # 3. Definir o intervalo (ex: de 30 em 30 min)
    intervalo_minutos = 30  # (Isso deve ser configurável no futuro)

    # --- MODIFICADO ---
    # Não usamos mais servico.duracao_minutos
    # duracao_novo_servico = timedelta(minutes=servico.duracao_minutos)
    # --- FIM DA MODIFICAÇÃO ---

    # --- MODIFICADO ---
    # Busca agendamentos do dia E USA A DURAÇÃO FINAL
    agendamentos_do_dia = Agendamento.objects.filter(
        data=data,
        empreendedor_executor=profissional,
        status__in=['Confirmado', 'Pendente']  # Não conta cancelados
    )

    blocos_ocupados = []
    for agendamento in agendamentos_do_dia:
        inicio_naive = datetime.combine(data, agendamento.horario)
        inicio = timezone.make_aware(inicio_naive)
        # USA A DURAÇÃO REAL DO AGENDAMENTO
        duracao_agendamento = agendamento.duracao_final
        fim = inicio + timedelta(minutes=duracao_agendamento)
        blocos_ocupados.append((inicio, fim))
    # --- FIM DA MODIFICAÇÃO ---

    # --- LÓGICA DE VERIFICAÇÃO DE CONFLITO (existente) ---
    def verificar_conflito(inicio_potencial, fim_potencial):
        for inicio_ocupado, fim_ocupado in blocos_ocupados:
            if max(inicio_potencial, inicio_ocupado) < min(fim_potencial, fim_ocupado):
                return True  # Há conflito
        return False

    # 6. Gerar horários disponíveis
    horarios_disponiveis = []
    agora = timezone.now()

    # Itera sobre cada bloco de trabalho (ex: 09:00-12:00, 14:00-18:00)
    for bloco in blocos_de_trabalho:
        horario_atual = datetime.combine(data, bloco.hora_inicio)
        horario_fim_bloco = datetime.combine(data, bloco.hora_fim)

        # Itera dentro do bloco (ex: 09:00, 09:30, 10:00...)
        while horario_atual < horario_fim_bloco:
            inicio_potencial = timezone.make_aware(horario_atual)

            # Não mostra horários que já passaram
            if data == agora.date() and inicio_potencial < agora:
                horario_atual += timedelta(minutes=intervalo_minutos)
                continue

            fim_potencial = inicio_potencial + duracao_novo_servico

            # Verifica se o slot cabe DENTRO do bloco de trabalho
            # E se não tem conflito com agendamentos existentes
            if fim_potencial.time() <= bloco.hora_fim and not verificar_conflito(inicio_potencial, fim_potencial):
                horarios_disponiveis.append(inicio_potencial.strftime('%H:%M'))

            horario_atual += timedelta(minutes=intervalo_minutos)

    # --- FIM DA NOVA LÓGICA ---

    return JsonResponse(horarios_disponiveis, safe=False)


def dias_disponiveis(request, empreendedor_slug):
    # --- LÓGICA MODIFICADA ---
    mes_str = request.GET.get('mes')
    ano_str = request.GET.get('ano')
    servico_id = request.GET.get('servico_id')
    empreendedor_id = request.GET.get('empreendedor_id')
    # --- NOVA ADIÇÃO ---
    duracao_selecionada = request.GET.get('duracao')
    tier_id = request.GET.get('tier_id')  # ID do tier de manutenção
    # --- FIM DA ADIÇÃO ---

    if not mes_str or not ano_str or not servico_id or not empreendedor_id or not duracao_selecionada:
        return JsonResponse({'status': 'error', 'message': 'Mês, ano, serviço, profissional e duração são obrigatórios.'}, status=400)

    try:
        mes = int(mes_str)
        ano = int(ano_str)
        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)
        servico = Servico.objects.get(id=servico_id, negocio=negocio)
        profissional = EmpreendedorProfile.objects.get(
            id=empreendedor_id, negocio=negocio)

        if not servico.profissionais_que_executam.filter(id=profissional.id).exists():
            return JsonResponse({'status': 'error', 'message': 'Profissional não executa este serviço.'}, status=400)

        # 1. A duração correta (do tier ou principal) é definida AQUI
        duracao_novo_servico = timedelta(minutes=int(duracao_selecionada))
        tier_selecionado = None
        if tier_id:
            tier_selecionado = PrecoManutencao.objects.get(id=tier_id)
    except (ValueError, Servico.DoesNotExist, EmpreendedorProfile.DoesNotExist, PrecoManutencao.DoesNotExist):
        return JsonResponse({'status': 'error', 'message': 'Parâmetros inválidos.'}, status=400)

    # --- LÓGICA DE VALIDAÇÃO DE MANUTENÇÃO (REQUISIÇÃO DO USUÁRIO) ---
    cliente = None
    ultimo_agendamento_categoria = None
    if request.user.is_authenticated:
        try:
            cliente = Cliente.objects.get(user=request.user, negocio=negocio)
            # Pega o último agendamento CONCLUÍDO da MESMA categoria
            ultimo_agendamento_categoria = Agendamento.objects.filter(
                cliente=cliente,
                servico__categoria=servico.categoria,
                status__in=['Concluído', 'Confirmado']
            ).order_by('-data', '-horario').first()
        except Cliente.DoesNotExist:
            pass  # Não é cliente

    # --- INÍCIO DA NOVA LÓGICA DE HORÁRIOS ---

    dias_com_horarios = []
    num_dias = calendar.monthrange(ano, mes)[1]
    hoje = timezone.now().date()

    # --- ADICIONE ESTA LINHA ---
    # Define a data máxima que pode ser agendada
    data_limite = hoje + timedelta(days=negocio.dias_antecedencia_maxima)

    intervalo_minutos = 30  # O mesmo intervalo da outra função
    # duracao_novo_servico = timedelta(minutes=servico.duracao_minutos)

    # 1. Busca todos os blocos de trabalho do profissional
    blocos_de_trabalho_prof = HorarioTrabalho.objects.filter(
        empreendedor=profissional)

    # 2. Busca todos os agendamentos do profissional no mês
    agendamentos_prof_mes = Agendamento.objects.filter(
        empreendedor_executor=profissional,
        data__year=ano,
        data__month=mes
    )

    # Organiza em dicionários para acesso rápido
    mapa_horarios = {h.dia_da_semana: [] for h in blocos_de_trabalho_prof}
    for h in blocos_de_trabalho_prof:
        mapa_horarios[h.dia_da_semana].append(h)

    mapa_agendamentos = {d: [] for d in range(1, num_dias + 1)}
    for a in agendamentos_prof_mes:
        mapa_agendamentos[a.data.day].append(a)

    # 3. Busca todos os dias bloqueados do profissional
    dias_bloqueados_set = set(
        DiaBloqueado.objects.filter(
            empreendedor=profissional, data__year=ano, data__month=mes
        ).values_list('data', flat=True)
    )

    # --- LÓGICA DE VERIFICAÇÃO DE CONFLITO ---
    def verificar_conflito_dia(inicio_potencial, fim_potencial, agendamentos_do_dia):
        for ag in agendamentos_do_dia:
            inicio_ocupado_naive = datetime.combine(ag.data, ag.horario)
            fim_ocupado_naive = inicio_ocupado_naive + \
                timedelta(minutes=ag.duracao_final)  # <-- USA duracao_final

            if max(inicio_potencial, inicio_ocupado_naive) < min(fim_potencial, fim_ocupado_naive):
                return True
        return False
    # --- FIM DA MODIFICAÇÃO ---

    # Itera por cada dia do mês
    for dia in range(1, num_dias + 1):
        data_atual = datetime(ano, mes, dia).date()
        dia_da_semana = data_atual.weekday()

        # --- MODIFIQUE ESTE 'if' ---
        if (data_atual < hoje or
            data_atual > data_limite or
            dia_da_semana not in mapa_horarios or
                data_atual in dias_bloqueados_set):  # <-- ADICIONE ESTA VERIFICAÇÃO
            continue

        # =================================================================
        # NOVA VALIDAÇÃO (REQUISIÇÃO DO USUÁRIO)
        # "não adianta a cliente marcar o serviço de manutenção de 5 dias para uma data daqui a 15 dias"
        # =================================================================
        if tier_selecionado and ultimo_agendamento_categoria:
            # Calcula quantos dias se PASSARAM desde o último serviço ATÉ A DATA QUE ELA QUER AGENDAR
            dias_totais_desde_servico = (
                data_atual - ultimo_agendamento_categoria.data).days

            # Se os dias totais estiverem FORA do range do tier selecionado,
            # este dia é INVÁLIDO para este tier.
            if not (tier_selecionado.dias_min <= dias_totais_desde_servico <= tier_selecionado.dias_max):
                continue  # Pula este dia, ele não é válido para esta manutenção
        # --- FIM DA NOVA VALIDAÇÃO ---

        agendamentos_do_dia = mapa_agendamentos.get(dia, [])
        tem_horario_vago = False

        # Itera sobre os blocos de trabalho daquele dia (ex: manhã, tarde)
        for bloco in mapa_horarios[dia_da_semana]:
            if tem_horario_vago:  # Se já achamos um, podemos pular este bloco
                break

            horario_atual = datetime.combine(data_atual, bloco.hora_inicio)
            horario_fim_bloco = datetime.combine(data_atual, bloco.hora_fim)

            # Itera dentro do bloco (ex: 09:00, 09:30, 10:00...)
            while horario_atual < horario_fim_bloco:
                fim_potencial = horario_atual + duracao_novo_servico

                if fim_potencial.time() <= bloco.hora_fim and not verificar_conflito_dia(horario_atual, fim_potencial, agendamentos_do_dia):
                    tem_horario_vago = True
                    break  # Achamos um horário vago, podemos parar de procurar neste bloco

                horario_atual += timedelta(minutes=intervalo_minutos)

        if tem_horario_vago:
            dias_com_horarios.append(data_atual.strftime('%Y-%m-%d'))

    # --- FIM DA NOVA LÓGICA ---

    return JsonResponse(dias_com_horarios, safe=False)


# ---
# Views do Dashboard (Admin do Empreendedor)
# ---

def is_admin(user):
    return user.is_authenticated and user.is_staff


@csrf_exempt
def scoped_admin_login(request, empreendedor_slug):
    """
    Realiza o login de um administrador (empreendedor/staff)
    mas APENAS se ele pertencer ao Negócio especificado no 'empreendedor_slug'.
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)

    # 1. Encontra o Negócio que o usuário está TENTANDO acessar
    try:
        negocio_alvo = Negocio.objects.get(slug=empreendedor_slug)
    except Negocio.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Negócio não encontrado.'}, status=404)

    data = json.loads(request.body)
    email = data.get('email')
    password = data.get('password')

    # 2. Autentica o usuário (globalmente)
    try:
        user = User.objects.get(email=email)
    except User.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Credenciais inválidas ou sem permissão de acesso.'}, status=401)

    if user.check_password(password) and user.is_staff:
        # 3. VERIFICAÇÃO CRUCIAL
        try:
            # Verifica se o usuário tem um perfil
            perfil_usuario = user.empreendedor_profile

            # Verifica se o negócio do perfil é o MESMO do slug da URL
            if perfil_usuario.negocio == negocio_alvo:
                # SUCESSO! Ele pertence a este negócio.
                login(request, user)
                return JsonResponse({
                    'status': 'success',
                    'message': 'Login bem-sucedido!',
                })
            else:
                # Ele é um admin, mas de OUTRO negócio.
                # 403 Forbidden
                return JsonResponse({'status': 'error', 'message': 'Você não tem permissão para administrar este negócio.'}, status=403)

        except EmpreendedorProfile.DoesNotExist:
            # É staff (como um superadmin) mas não tem perfil de empreendedor
            # Opcional: permitir que o superadmin logue em qualquer lugar
            if user.is_superuser:
                login(request, user)
                return JsonResponse({
                    'status': 'success',
                    'message': 'Login de Superusuário bem-sucedido!',
                })
            # Se não for superadmin, ele é apenas um staff sem perfil.
            return JsonResponse({'status': 'error', 'message': 'Este usuário não possui um perfil de empreendedor.'}, status=401)
    else:
        # Senha errada ou não é staff
        return JsonResponse({'status': 'error', 'message': 'Credenciais inválidas ou sem permissão de acesso.'}, status=401)


@csrf_exempt
def global_admin_login(request):
    if request.method == 'POST':
        data = json.loads(request.body)
        email = data.get('email')
        password = data.get('password')
        try:
            user = User.objects.get(email=email)
        except User.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Credenciais inválidas ou sem permissão de acesso.'}, status=401)

        if user.check_password(password) and user.is_staff:
            try:
                # --- CORREÇÃO AQUI ---
                _ = user.empreendedor_profile
                login(request, user)
                return JsonResponse({
                    'status': 'success',
                    'message': 'Login de administrador bem-sucedido!',
                    'user': {
                        'name': user.first_name,
                        'email': user.email
                    }
                })
            # --- CORREÇÃO AQUI ---
            except EmpreendedorProfile.DoesNotExist:
                return JsonResponse({'status': 'error', 'message': 'Este usuário não possui um perfil de empreendedor associado.'}, status=401)
        else:
            return JsonResponse({'status': 'error', 'message': 'Credenciais inválidas ou sem permissão de acesso.'}, status=401)
    return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)


@user_passes_test(is_admin)
def admin_dashboard(request):
    try:
        # --- CORREÇÃO AQUI ---
        perfil = request.user.empreendedor_profile
        negocio = perfil.negocio
    except EmpreendedorProfile.DoesNotExist:
        return render(request, 'agendamentos/dashboard/index.html', {'error': 'Perfil de empreendedor não encontrado.'})

    hoje = timezone.now().date()
    base_agendamentos = Agendamento.objects.filter(servico__negocio=negocio)
    base_despesas = Despesa.objects.filter(negocio=negocio)
    agendamentos_hoje = base_agendamentos.filter(data=hoje).count()
    agendamentos_pendentes = base_agendamentos.filter(
        status='Confirmado', data__gte=hoje).count()
    pagamentos_pendentes = base_agendamentos.filter(
        status_pagamento='Pendente').count()
    inicio_mes = hoje.replace(day=1)
    ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
    fim_mes = hoje.replace(day=ultimo_dia)
    faturamento_mes = base_agendamentos.filter(
        data__range=[inicio_mes, fim_mes],
        status_pagamento='Pago'
    ).aggregate(total=Sum('servico__preco'))['total'] or 0
    despesas_mes = base_despesas.filter(
        data__range=[inicio_mes, fim_mes]
    ).aggregate(total=Sum('valor'))['total'] or 0
    context = {
        'agendamentos_hoje': agendamentos_hoje,
        'agendamentos_pendentes': agendamentos_pendentes,
        'pagamentos_pendentes': pagamentos_pendentes,
        'faturamento_mes': faturamento_mes,
        'despesas_mes': despesas_mes,
        'lucro_mes': faturamento_mes - despesas_mes,
        'hoje': hoje,
        'semana_passada': hoje - timedelta(days=7),
        'empreendedor_slug': negocio.slug
    }
    return render(request, 'agendamentos/dashboard/index.html', context)


@user_passes_test(is_admin)
def admin_calendario(request):
    try:
        # --- CORREÇÃO AQUI ---
        slug = request.user.empreendedor_profile.negocio.slug
        context = {'empreendedor_slug': slug}
        return render(request, 'agendamentos/dashboard/calendario.html', context)
    except EmpreendedorProfile.DoesNotExist:
        return render(request, 'agendamentos/dashboard/calendario.html', {'error': 'Perfil não encontrado.'})


@user_passes_test(is_admin)
def admin_financeiro(request):
    try:
        # --- CORREÇÃO AQUI ---
        slug = request.user.empreendedor_profile.negocio.slug
        context = {'empreendedor_slug': slug}
        return render(request, 'agendamentos/dashboard/financeiro.html', context)
    except EmpreendedorProfile.DoesNotExist:
        return render(request, 'agendamentos/dashboard/financeiro.html', {'error': 'Perfil não encontrado.'})


@user_passes_test(is_admin)
def admin_relatorios(request):
    try:
        # --- CORREÇÃO AQUI ---
        slug = request.user.empreendedor_profile.negocio.slug
        context = {'empreendedor_slug': slug}
        return render(request, 'agendamentos/dashboard/relatorios.html', context)
    except EmpreendedorProfile.DoesNotExist:
        return render(request, 'agendamentos/dashboard/relatorios.html', {'error': 'Perfil não encontrado.'})


# ---
# APIs do Dashboard (requerem login de admin)
# ---

@user_passes_test(is_admin)
def api_agendamentos_calendario(request):
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse([], safe=False)

    start_date = request.GET.get('start')
    end_date = request.GET.get('end')
    start = datetime.strptime(
        start_date[:10], '%Y-%m-%d').date() if start_date else timezone.now().date()
    end = datetime.strptime(
        end_date[:10], '%Y-%m-%d').date() if end_date else (start + timedelta(days=30))

    agendamentos = Agendamento.objects.filter(
        data__range=[start, end],
        servico__negocio=negocio
    ).select_related(
        'cliente__user',
        'servico',
        'tier_manutencao'  # Garante que estamos buscando o tier
    )

    eventos = []
    for agendamento in agendamentos:
        # --- LÓGICA DE COR (Correta da última etapa) ---
        cor = '#FF9500'  # Laranja (Padrão para Pendente)

        if agendamento.status == 'Confirmado':
            # cor = '#5CCFAC' # Verde (Antigo)
            cor = '#0D99FF'  # Azul (NOVO)
        elif agendamento.status == 'Concluído':
            # cor = '#0D99FF' # Azul (Antigo)
            cor = '#5CCFAC'  # Verde (NOVO)
        elif agendamento.status == 'Cancelado':
            cor = '#FF5A5F'  # Vermelho

        # --- INÍCIO DAS CORREÇÕES ---

        # 1. Define o NOME e o ID corretos
        nome_servico = ""
        servico_tier_id_str = ""
        if agendamento.tier_manutencao:
            # Lógica IDÊNTICA a 'api_admin_get_form_data'
            nome_servico = f"{agendamento.servico.nome} - {agendamento.tier_manutencao.nome_tier}"
            servico_tier_id_str = f"tier_{agendamento.tier_manutencao.id}"
        else:
            nome_servico = agendamento.servico.nome
            servico_tier_id_str = f"service_{agendamento.servico.id}"

        # 2. Define a DURAÇÃO correta (do campo 'duracao_final' salvo no .save())
        # Fallback de 15 min se algo der errado
        duracao_real = agendamento.duracao_final or 15

        # 3. Define o PREÇO correto (do campo 'preco_final' salvo no .save())
        preco_real = agendamento.preco_final or 0.0

        # --- FIM DAS CORREÇÕES ---

        eventos.append({
            'id': agendamento.id,
            # <-- CORRIGIDO
            'title': f"{agendamento.cliente.user.get_full_name()} - {nome_servico}",
            'start': f"{agendamento.data.isoformat()}T{agendamento.horario.isoformat()}",
            'end': (datetime.combine(agendamento.data, agendamento.horario) +
                    # <-- CORRIGIDO
                    timedelta(minutes=duracao_real)).isoformat(),
            'color': cor,
            'extendedProps': {
                'cliente': agendamento.cliente.user.get_full_name(),
                'email': agendamento.cliente.user.email,
                'telefone': agendamento.cliente.telefone,
                'servico': nome_servico,  # <-- CORRIGIDO (nome para exibição)
                # <-- NOVO (para pré-seleção)
                'servico_tier_id': servico_tier_id_str,
                'preco': float(preco_real),  # <-- CORRIGIDO
                'status': agendamento.status,
                'status_pagamento': agendamento.status_pagamento,
                'observacoes': agendamento.observacoes or ''
            }
        })
    return JsonResponse(eventos, safe=False)


@user_passes_test(is_admin)
def api_resumo_financeiro(request):
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    periodo = request.GET.get('periodo', 'mes')
    hoje = timezone.now().date()
    if periodo == 'semana':
        inicio = hoje - timedelta(days=hoje.weekday())
        fim = inicio + timedelta(days=6)
    elif periodo == 'mes':
        inicio = hoje.replace(day=1)
        ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
        fim = hoje.replace(day=ultimo_dia)
    elif periodo == 'ano':
        inicio = hoje.replace(month=1, day=1)
        fim = hoje.replace(month=12, day=31)
    else:
        data_inicio = request.GET.get('inicio')
        data_fim = request.GET.get('fim')
        if data_inicio and data_fim:
            inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
        else:
            inicio = hoje.replace(day=1)
            ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
            fim = hoje.replace(day=ultimo_dia)

    base_agendamentos = Agendamento.objects.filter(servico__negocio=negocio)
    base_despesas = Despesa.objects.filter(negocio=negocio)

    faturamento = base_agendamentos.filter(
        data__range=[inicio, fim],
        status_pagamento='Pago'
    ).aggregate(total=Sum('servico__preco'))['total'] or 0
    faturamento_pendente = base_agendamentos.filter(
        data__range=[inicio, fim],
        status_pagamento='Pendente',
        status__in=['Confirmado', 'Concluído']
    ).aggregate(total=Sum('servico__preco'))['total'] or 0
    despesas = base_despesas.filter(
        data__range=[inicio, fim]
    ).aggregate(total=Sum('valor'))['total'] or 0
    total_atendimentos = base_agendamentos.filter(
        data__range=[inicio, fim],
        status__in=['Confirmado', 'Concluído']
    ).count()
    atendimentos_concluidos = base_agendamentos.filter(
        data__range=[inicio, fim],
        status='Concluído'
    ).count()
    servicos_populares = base_agendamentos.filter(
        data__range=[inicio, fim],
        status__in=['Confirmado', 'Concluído']
    ).values('servico__nome').annotate(
        total=Count('id')
    ).order_by('-total')[:5]

    return JsonResponse({
        'periodo': {
            'inicio': inicio.isoformat(),
            'fim': fim.isoformat()
        },
        'financeiro': {
            'faturamento': float(faturamento),
            'faturamento_pendente': float(faturamento_pendente),
            'despesas': float(despesas),
            'lucro': float(faturamento - despesas)
        },
        'atendimentos': {
            'total': total_atendimentos,
            'concluidos': atendimentos_concluidos,
            'pagos': base_agendamentos.filter(
                data__range=[inicio, fim],
                status_pagamento='Pago'
            ).count()
        },
        'servicos_populares': list(servicos_populares)
    })


@user_passes_test(is_admin)
def api_faturamento(request):
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    periodo = request.GET.get('periodo', 'mes')
    tipo = request.GET.get('tipo', 'diario')
    hoje = timezone.now().date()
    if periodo == 'semana':
        inicio = hoje - timedelta(days=hoje.weekday())
        fim = inicio + timedelta(days=6)
    elif periodo == 'mes':
        inicio = hoje.replace(day=1)
        ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
        fim = hoje.replace(day=ultimo_dia)
    elif periodo == 'ano':
        inicio = hoje.replace(month=1, day=1)
        fim = hoje.replace(month=12, day=31)
    else:
        data_inicio = request.GET.get('inicio')
        data_fim = request.GET.get('fim')
        if data_inicio and data_fim:
            inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
        else:
            inicio = hoje.replace(day=1)
            ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
            fim = hoje.replace(day=ultimo_dia)

    base_agendamentos = Agendamento.objects.filter(servico__negocio=negocio)

    if tipo == 'diario':
        agendamentos = base_agendamentos.filter(
            data__range=[inicio, fim],
            status_pagamento='Pago'
        ).values('data').annotate(
            total=Sum('servico__preco'),
            quantidade=Count('id')
        ).order_by('data')
        dados = [
            {
                'data': item['data'].isoformat(),
                'total': float(item['total']),
                'quantidade': item['quantidade']
            }
            for item in agendamentos
        ]
    elif tipo == 'mensal':
        dados = []
        for mes in range(1, 13):
            if mes < inicio.month or mes > fim.month:
                continue
            inicio_mes = datetime(inicio.year, mes, 1).date()
            fim_mes = datetime(inicio.year, mes, calendar.monthrange(
                inicio.year, mes)[1]).date()
            total = base_agendamentos.filter(
                data__range=[inicio_mes, fim_mes],
                status_pagamento='Pago'
            ).aggregate(
                total=Sum('servico__preco'),
                quantidade=Count('id')
            )
            dados.append({
                'mes': mes,
                'nome_mes': calendar.month_name[mes],
                'total': float(total['total'] or 0),
                'quantidade': total['quantidade'] or 0
            })
    else:
        servicos = base_agendamentos.filter(
            data__range=[inicio, fim],
            status_pagamento='Pago'
        ).values('servico__nome').annotate(
            total=Sum('servico__preco'),
            quantidade=Count('id')
        ).order_by('-total')
        dados = [
            {
                'servico': item['servico__nome'],
                'total': float(item['total']),
                'quantidade': item['quantidade']
            }
            for item in servicos
        ]
    return JsonResponse({
        'periodo': {
            'inicio': inicio.isoformat(),
            'fim': fim.isoformat()
        },
        'tipo': tipo,
        'dados': dados
    })


@user_passes_test(is_admin)
def api_despesas(request):
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    periodo = request.GET.get('periodo', 'mes')
    categoria = request.GET.get('categoria', None)
    hoje = timezone.now().date()
    if periodo == 'semana':
        inicio = hoje - timedelta(days=hoje.weekday())
        fim = inicio + timedelta(days=6)
    elif periodo == 'mes':
        inicio = hoje.replace(day=1)
        ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
        fim = hoje.replace(day=ultimo_dia)
    elif periodo == 'ano':
        inicio = hoje.replace(month=1, day=1)
        fim = hoje.replace(month=12, day=31)
    else:
        data_inicio = request.GET.get('inicio')
        data_fim = request.GET.get('fim')
        if data_inicio and data_fim:
            inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
        else:
            inicio = hoje.replace(day=1)
            ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
            fim = hoje.replace(day=ultimo_dia)

    base_despesas = Despesa.objects.filter(negocio=negocio)
    filtros = {'data__range': [inicio, fim]}
    if categoria:
        filtros['categoria'] = categoria
    despesas = base_despesas.filter(**filtros).order_by('-data')
    resumo_categorias = base_despesas.filter(
        data__range=[inicio, fim]
    ).values('categoria').annotate(
        total=Sum('valor'),
        quantidade=Count('id')
    ).order_by('-total')

    return JsonResponse({
        'periodo': {
            'inicio': inicio.isoformat(),
            'fim': fim.isoformat()
        },
        'despesas': [
            {
                'id': despesa.id,
                'descricao': despesa.descricao,
                'valor': float(despesa.valor),
                'data': despesa.data.isoformat(),
                'categoria': despesa.categoria,
                'pago': despesa.pago,
                'comprovante': despesa.comprovante.url if despesa.comprovante else None
            }
            for despesa in despesas
        ],
        'resumo_categorias': [
            {
                'categoria': categoria['categoria'],
                'total': float(categoria['total']),
                'quantidade': categoria['quantidade']
            }
            for categoria in resumo_categorias
        ],
        'total': float(despesas.aggregate(total=Sum('valor'))['total'] or 0)
    })


@csrf_exempt
@user_passes_test(is_admin)
def api_atualizar_pagamento(request, agendamento_id):
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
        agendamento = get_object_or_404(
            Agendamento, id=agendamento_id, servico__negocio=negocio)
        dados = json.loads(request.body)
        if 'status_pagamento' in dados:
            agendamento.status_pagamento = dados['status_pagamento']
        if 'status' in dados:
            agendamento.status = dados['status']
        if 'observacoes' in dados:
            agendamento.observacoes = dados['observacoes']
        agendamento.save()
        return JsonResponse({
            'status': 'success',
            'message': 'Agendamento atualizado com sucesso',
            'agendamento': {
                'id': agendamento.id,
                'status': agendamento.status,
                'status_pagamento': agendamento.status_pagamento
            }
        })
    # --- CORREÇÃO AQUI ---
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Agendamento.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Agendamento não encontrado ou não pertence a você.'}, status=404)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_registrar_despesa(request):
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
        dados = json.loads(request.body)
        nova_despesa = Despesa(
            negocio=negocio,
            descricao=dados['descricao'],
            valor=dados['valor'],
            data=datetime.strptime(dados['data'], '%Y-%m-%d').date(),
            categoria=dados['categoria'],
            pago=dados.get('pago', False)
        )
        nova_despesa.save()
        return JsonResponse({
            'status': 'success',
            'message': 'Despesa registrada com sucesso',
            'despesa': {
                'id': nova_despesa.id,
                'descricao': nova_despesa.descricao,
                'valor': float(nova_despesa.valor),
                'data': nova_despesa.data.isoformat(),
                'categoria': nova_despesa.categoria,
                'pago': nova_despesa.pago
            }
        })
    # --- CORREÇÃO AQUI ---
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_atualizar_despesa(request, despesa_id):
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
        despesa = get_object_or_404(
            Despesa, id=despesa_id, negocio=negocio)
        dados = json.loads(request.body)
        if 'descricao' in dados:
            despesa.descricao = dados['descricao']
        if 'valor' in dados:
            despesa.valor = dados['valor']
        if 'data' in dados:
            despesa.data = datetime.strptime(dados['data'], '%Y-%m-%d').date()
        if 'categoria' in dados:
            despesa.categoria = dados['categoria']
        if 'pago' in dados:
            despesa.pago = dados['pago']
        despesa.save()
        return JsonResponse({
            'status': 'success',
            'message': 'Despesa atualizada com sucesso',
            'despesa': {
                'id': despesa.id,
                'descricao': despesa.descricao,
                'valor': float(despesa.valor),
                'data': despesa.data.isoformat(),
                'categoria': despesa.categoria,
                'pago': despesa.pago
            }
        })
    # --- CORREÇÃO AQUI ---
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Despesa.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Despesa não encontrada ou não pertence a você.'}, status=404)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_deletar_despesa(request, despesa_id):
    """
    Exclui uma despesa específica.
    """
    if request.method != 'DELETE':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)

    try:
        # Garante que o admin logado só possa deletar despesas do seu negócio
        negocio = request.user.empreendedor_profile.negocio
        despesa = get_object_or_404(
            Despesa, id=despesa_id, negocio=negocio)

        # Exclui o objeto do banco de dados
        despesa.delete()

        return JsonResponse({
            'status': 'success',
            'message': 'Despesa excluída com sucesso'
        })

    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Despesa.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Despesa não encontrada ou não pertence a você.'}, status=404)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@user_passes_test(is_admin)
def api_despesa(request, despesa_id):
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
        despesa = get_object_or_404(
            Despesa, id=despesa_id, negocio=negocio)
        return JsonResponse({
            'id': despesa.id,
            'descricao': despesa.descricao,
            'valor': float(despesa.valor),
            'data': despesa.data.isoformat(),
            'categoria': despesa.categoria,
            'pago': despesa.pago,
            'comprovante': despesa.comprovante.url if despesa.comprovante else None
        })
    # --- CORREÇÃO AQUI ---
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Despesa.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Despesa não encontrada ou não pertence a você.'}, status=404)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@user_passes_test(is_admin)
def api_agendamentos_pagamento(request):
    try:
        # --- CORREÇÃO AQUI ---
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    periodo = request.GET.get('periodo', 'mes')
    hoje = timezone.now().date()
    if periodo == 'semana':
        inicio = hoje - timedelta(days=hoje.weekday())
        fim = inicio + timedelta(days=6)
    elif periodo == 'mes':
        inicio = hoje.replace(day=1)
        ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
        fim = hoje.replace(day=ultimo_dia)
    elif periodo == 'ano':
        inicio = hoje.replace(month=1, day=1)
        fim = hoje.replace(month=12, day=31)
    else:
        data_inicio = request.GET.get('inicio')
        data_fim = request.GET.get('fim')
        if data_inicio and data_fim:
            inicio = datetime.strptime(data_inicio, '%Y-%m-%d').date()
            fim = datetime.strptime(data_fim, '%Y-%m-%d').date()
        else:
            inicio = hoje.replace(day=1)
            ultimo_dia = calendar.monthrange(hoje.year, hoje.month)[1]
            fim = hoje.replace(day=ultimo_dia)

    base_agendamentos = Agendamento.objects.filter(servico__negocio=negocio)

    pendentes = base_agendamentos.filter(
        data__range=[inicio, fim],
        status_pagamento='Pendente',
        status__in=['Confirmado', 'Concluído']
    ).select_related('cliente__user', 'servico')
    pagos = base_agendamentos.filter(
        data__range=[inicio, fim],
        status_pagamento='Pago'
    ).select_related('cliente__user', 'servico')

    return JsonResponse({
        'periodo': {
            'inicio': inicio.isoformat(),
            'fim': fim.isoformat()
        },
        'pendentes': [
            {
                'id': agendamento.id,
                'cliente': f"{agendamento.cliente.user.first_name} {agendamento.cliente.user.last_name}",
                'servico': agendamento.servico.nome,
                'data': agendamento.data.isoformat(),
                'horario': agendamento.horario.strftime('%H:%M'),
                'valor': float(agendamento.servico.preco),
                'status': agendamento.status,
                'status_pagamento': agendamento.status_pagamento
            }
            for agendamento in pendentes
        ],
        'pagos': [
            {
                'id': agendamento.id,
                'cliente': f"{agendamento.cliente.user.first_name} {agendamento.cliente.user.last_name}",
                'servico': agendamento.servico.nome,
                'data': agendamento.data.isoformat(),
                'horario': agendamento.horario.strftime('%H:%M'),
                'valor': float(agendamento.servico.preco),
                'status': agendamento.status,
                'status_pagamento': agendamento.status_pagamento
            }
            for agendamento in pagos
        ]
    })

# --- View de Lista de Agendamentos (Exemplo) ---
# Esta view é um exemplo de como você pode listar agendamentos.
# Ela não está sendo usada pelo seu SPA principal, mas é útil para depuração.


def lista_agendamentos(request, empreendedor_slug):
    negocio = get_object_or_404(Negocio, slug=empreendedor_slug)

    # Filtra agendamentos por negócio
    agendamentos = Agendamento.objects.filter(servico__negocio=negocio).select_related(
        'cliente__user', 'servico'
    ).order_by('-data', '-horario')

    data = [
        {
            'id': agendamento.id,
            'client': f"{agendamento.cliente.user.first_name} {agendamento.cliente.user.last_name}",
            'service': agendamento.servico.nome,
            'date': agendamento.data.strftime('%Y-%m-%d'),
            'time': agendamento.horario.strftime('%H:%M'),
            'status': agendamento.status
        } for agendamento in agendamentos
    ]
    return JsonResponse(data, safe=False)


# 1. VIEW DA PÁGINA DE GESTÃO (RENDERIZA O HTML)
# ---
@user_passes_test(is_admin)
def admin_gestao(request):
    try:
        # Passa o slug para o template (para o link "Voltar ao Site")
        slug = request.user.empreendedor_profile.negocio.slug
        context = {'empreendedor_slug': slug}
        return render(request, 'agendamentos/dashboard/gestao.html', context)
    except EmpreendedorProfile.DoesNotExist:
        return render(request, 'agendamentos/dashboard/gestao.html', {'error': 'Perfil não encontrado.'})

# ---
# 2. API PARA GERENCIAR A LISTA DE SERVIÇOS (LER E CRIAR)
# ---


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_servicos(request):
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        servicos = Servico.objects.filter(
            negocio=negocio).prefetch_related('profissionais_que_executam')
        data = [
            {
                'id': servico.id,
                'nome': servico.nome,
                'preco': float(servico.preco),
                'duracao_minutos': servico.duracao_minutos,
                'descricao': servico.descricao,
                'imagem_url': servico.imagem.url if servico.imagem else None,
                'profissionais_ids': [p.id for p in servico.profissionais_que_executam.all()],
                # --- NOVA ADIÇÃO ---
                'categoria_id': servico.categoria_id,
                'categoria_nome': servico.categoria.nome if servico.categoria else None
                # --- FIM DA ADIÇÃO ---
            } for servico in servicos
        ]
        return JsonResponse(data, safe=False)

    # --- MODIFIQUE O 'POST' para incluir a categoria ---
    if request.method == 'POST':
        # MUDANÇA: Lendo de request.POST (Form Data) em vez de JSON
        data = request.POST
        try:
            # --- NOVA ADIÇÃO ---
            categoria_id = data.get('categoria_id')
            categoria = None
            if categoria_id:
                categoria = Categoria.objects.get(
                    id=categoria_id, negocio=negocio)
            # --- FIM DA ADIÇÃO ---

            novo_servico = Servico.objects.create(
                negocio=negocio,
                nome=data['nome'],
                descricao=data.get('descricao', ''),
                preco=data['preco'],
                duracao_minutos=data['duracao_minutos'],
                percentual_adiantamento=data.get('percentual_adiantamento', 0),
                categoria=categoria  # <-- ADICIONADO
            )

            # ADICIONADO: Verifica se um arquivo de imagem foi enviado
            if 'imagem' in request.FILES:
                novo_servico.imagem = request.FILES['imagem']

            novo_servico.save()  # Salva a imagem

            # Associa os profissionais (lendo a string do form data)
            profissionais_ids_str = data.get('profissionais_ids', '')
            if profissionais_ids_str:
                profissionais_ids = [int(id)
                                     for id in profissionais_ids_str.split(',')]
                profissionais = EmpreendedorProfile.objects.filter(
                    negocio=negocio, id__in=profissionais_ids)
                novo_servico.profissionais_que_executam.set(profissionais)

            return JsonResponse({'status': 'success', 'message': 'Serviço criado com sucesso.'}, status=201)
        except Categoria.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Categoria não encontrada.'}, status=400)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

# ---
# 3. API PARA GERENCIAR UM SERVIÇO ESPECÍFICO (EDITAR, EXCLUIR, LER DETALHE)
# ---


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_servico_detalhe(request, servico_id):
    try:
        negocio = request.user.empreendedor_profile.negocio
        servico = get_object_or_404(Servico, id=servico_id, negocio=negocio)
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Servico.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Serviço não encontrado.'}, status=404)

    # --- LER DETALHE (GET) ---
    if request.method == 'GET':
        data = {
            'id': servico.id,
            'nome': servico.nome,
            'preco': float(servico.preco),
            'duracao_minutos': servico.duracao_minutos,
            'descricao': servico.descricao,
            'imagem_url': servico.imagem.url if servico.imagem else None,
            'profissionais_ids': [p.id for p in servico.profissionais_que_executam.all()],
            'percentual_adiantamento': servico.percentual_adiantamento,
            # --- NOVA ADIÇÃO ---
            'categoria_id': servico.categoria_id
            # --- FIM DA ADIÇÃO ---
        }
        return JsonResponse(data)

    # --- EDITAR (POST) ---
    if request.method == 'POST':
        # MUDANÇA: Lendo de request.POST (Form Data) em vez de JSON
        data = request.POST
        try:
            servico.nome = data['nome']
            servico.descricao = data.get('descricao', '')
            servico.preco = data['preco']
            servico.duracao_minutos = data['duracao_minutos']
            servico.percentual_adiantamento = data.get(
                'percentual_adiantamento', 0)

            # ADICIONADO: Verifica se um arquivo de imagem foi enviado
            if 'imagem' in request.FILES:
                servico.imagem = request.FILES['imagem']

            categoria_id = data.get('categoria_id')
            categoria = None
            if categoria_id:
                categoria = Categoria.objects.get(
                    id=categoria_id, negocio=negocio)
            servico.categoria = categoria  # <-- ADICIONADO

            servico.save()  # Salva o texto e a nova imagem

            # Atualiza os profissionais associados
            profissionais_ids_str = data.get('profissionais_ids', '')
            if profissionais_ids_str:
                profissionais_ids = [int(id)
                                     for id in profissionais_ids_str.split(',')]
                profissionais = EmpreendedorProfile.objects.filter(
                    negocio=negocio, id__in=profissionais_ids)
                servico.profissionais_que_executam.set(profissionais)
            else:
                # Se enviado vazio, remove todos
                servico.profissionais_que_executam.clear()

            return JsonResponse({'status': 'success', 'message': 'Serviço atualizado com sucesso.'})
        except Categoria.DoesNotExist:
            return JsonResponse({'status': 'error', 'message': 'Categoria não encontrada.'}, status=400)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    # --- EXCLUIR (DELETE) ---
    if request.method == 'DELETE':
        try:
            servico.delete()
            return JsonResponse({'status': 'success', 'message': 'Serviço excluído com sucesso.'}, status=204)
        except Exception as e:
            # Proteção contra deleção de serviço com agendamento
            if 'FOREIGN KEY constraint' in str(e):
                return JsonResponse({'status': 'error', 'message': 'Não é possível excluir este serviço, pois ele já possui agendamentos.'}, status=400)
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


# =================================================================
# NOVA ADIÇÃO: VIEWS DA API DE CATEGORIA
# =================================================================
@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_categorias(request):
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    if request.method == 'GET':
        categorias = Categoria.objects.filter(negocio=negocio)
        data = [{'id': c.id, 'nome': c.nome} for c in categorias]
        return JsonResponse(data, safe=False)

    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            nova_cat = Categoria.objects.create(
                negocio=negocio,
                nome=data['nome']
            )
            return JsonResponse({'status': 'success', 'message': 'Categoria criada!', 'id': nova_cat.id}, status=201)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_categoria_detalhe(request, categoria_id):
    try:
        negocio = request.user.empreendedor_profile.negocio
        categoria = get_object_or_404(
            Categoria, id=categoria_id, negocio=negocio)
    except Exception:
        return JsonResponse({'status': 'error', 'message': 'Categoria não encontrada.'}, status=404)

    if request.method == 'POST':  # Editar
        data = json.loads(request.body)
        categoria.nome = data.get('nome', categoria.nome)
        categoria.save()
        return JsonResponse({'status': 'success', 'message': 'Categoria atualizada.'})

    if request.method == 'DELETE':
        # A categoria está com on_delete=models.SET_NULL no Servico,
        # então apagar aqui é seguro e não deletará serviços.
        categoria.delete()
        return JsonResponse({'status': 'success', 'message': 'Categoria excluída.'}, status=204)

# =================================================================
# NOVA ADIÇÃO: VIEWS DA API DE PREÇOS DE MANUTENÇÃO
# =================================================================


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_precos_manutencao(request, servico_id):
    try:
        negocio = request.user.empreendedor_profile.negocio
        servico = get_object_or_404(Servico, id=servico_id, negocio=negocio)
    except Exception:
        return JsonResponse({'status': 'error', 'message': 'Serviço não encontrado.'}, status=404)

    if request.method == 'GET':
        precos = PrecoManutencao.objects.filter(servico_pai=servico)
        data = [{
            'id': p.id,
            'nome_tier': p.nome_tier,
            'dias_min': p.dias_min,
            'dias_max': p.dias_max,
            'preco': float(p.preco),
            'duracao_minutos': p.duracao_minutos
        } for p in precos]
        return JsonResponse(data, safe=False)

    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            novo_preco = PrecoManutencao(
                servico_pai=servico,
                nome_tier=data['nome_tier'],
                dias_min=data['dias_min'],
                dias_max=data['dias_max'],
                preco=data['preco'],
                duracao_minutos=data['duracao_minutos'],
                percentual_adiantamento=data.get('percentual_adiantamento', 0)
            )
            novo_preco.clean()  # Roda a validação do modelo
            novo_preco.save()
            return JsonResponse({'status': 'success', 'message': 'Preço de manutenção adicionado!'}, status=201)
        except ValidationError as e:
            return JsonResponse({'status': 'error', 'message': e.message}, status=400)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_preco_manutencao_detalhe(request, preco_id):
    try:
        negocio = request.user.empreendedor_profile.negocio
        preco = get_object_or_404(
            PrecoManutencao, id=preco_id, servico_pai__negocio=negocio)
    except Exception:
        return JsonResponse({'status': 'error', 'message': 'Preço não encontrado.'}, status=404)

    if request.method == 'POST':  # Editar
        data = json.loads(request.body)
        try:
            preco.nome_tier = data.get('nome_tier', preco.nome_tier)
            preco.dias_min = data.get('dias_min', preco.dias_min)
            preco.dias_max = data.get('dias_max', preco.dias_max)
            preco.preco = data.get('preco', preco.preco)
            preco.duracao_minutos = data.get(
                'duracao_minutos', preco.duracao_minutos)
            preco.percentual_adiantamento = data.get(
                'percentual_adiantamento', preco.percentual_adiantamento)
            preco.clean()
            preco.save()
            return JsonResponse({'status': 'success', 'message': 'Preço atualizado.'})
        except ValidationError as e:
            return JsonResponse({'status': 'error', 'message': e.message}, status=400)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    if request.method == 'DELETE':
        preco.delete()
        return JsonResponse({'status': 'success', 'message': 'Preço excluído.'}, status=204)

# ---
# 4. API PARA LER A EQUIPE (USADO NO MODAL DE SERVIÇOS)
# ---


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_equipe(request):
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        equipe = EmpreendedorProfile.objects.filter(
            negocio=negocio).select_related('user')
        data = [
            {
                'id': membro.id,
                'nome': membro.user.get_full_name() or membro.user.username,
                'email': membro.user.email,
                # --- ADICIONADO ---
                'foto_url': membro.foto.url if membro.foto else None
            } for membro in equipe
        ]
        return JsonResponse(data, safe=False)

    # --- CONVIDAR / CRIAR (POST) ---
    if request.method == 'POST':
        # MUDANÇA: Lendo de request.POST (Form Data)
        data = request.POST

        email = data.get('email')
        password = data.get('password')

        # --- Validações ---
        if not email or not password or not data.get('nome'):
            return JsonResponse({'status': 'error', 'message': 'Nome, email e senha inicial são obrigatórios.'}, status=400)
        if User.objects.filter(email=email).exists():
            return JsonResponse({'status': 'error', 'message': 'Já existe um usuário com este email no sistema.'}, status=400)

        try:
            # 1. Cria o User
            novo_usuario = User.objects.create_user(
                username=email,
                email=email,
                password=password,
                first_name=data.get('nome'),
                last_name=data.get('sobrenome', '')
            )
            novo_usuario.is_staff = True
            novo_usuario.save()

            # 3. Cria o Perfil de Empreendedor
            novo_perfil = EmpreendedorProfile.objects.create(
                user=novo_usuario,
                negocio=negocio,
                telefone=data.get('telefone', '')
            )

            # --- ADICIONADO: Salva a foto ---
            if 'foto' in request.FILES:
                novo_perfil.foto = request.FILES['foto']
                novo_perfil.save()
            # --- FIM DA ADIÇÃO ---

            return JsonResponse({'status': 'success', 'message': 'Novo membro da equipe adicionado com sucesso!'}, status=201)

        except Exception as e:
            # Se algo der errado (ex: username duplicado), desfaz a criação do usuário
            if 'novo_usuario' in locals() and novo_usuario:
                novo_usuario.delete()
            return JsonResponse({'status': 'error', 'message': f'Erro ao criar usuário: {str(e)}'}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_horarios(request):
    """
    API para LER todos os horários de um profissional e CRIAR um novo.
    """
    try:
        # A API de horários sempre se refere ao *profissional logado*
        profissional = request.user.empreendedor_profile
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        horarios = HorarioTrabalho.objects.filter(empreendedor=profissional)
        data = [
            {
                'id': h.id,
                'dia_da_semana': h.dia_da_semana,
                'dia_nome': h.get_dia_da_semana_display(),
                'hora_inicio': h.hora_inicio.strftime('%H:%M'),
                'hora_fim': h.hora_fim.strftime('%H:%M'),
            } for h in horarios
        ]
        return JsonResponse(data, safe=False)

    # --- CRIAR (POST) ---
    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            # Validação
            if data['hora_inicio'] >= data['hora_fim']:
                return JsonResponse({'status': 'error', 'message': 'A hora de início deve ser anterior à hora de fim.'}, status=400)

            novo_horario = HorarioTrabalho.objects.create(
                empreendedor=profissional,
                dia_da_semana=data['dia_da_semana'],
                hora_inicio=data['hora_inicio'],
                hora_fim=data['hora_fim']
            )
            return JsonResponse({
                'status': 'success',
                'message': 'Horário adicionado!',
                'id': novo_horario.id
            }, status=201)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': f'Erro ao salvar: {str(e)}'}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_horario_detalhe(request, horario_id):
    """
    API para EXCLUIR (ou futuramente editar) um horário específico.
    """
    try:
        profissional = request.user.empreendedor_profile
        horario = get_object_or_404(
            HorarioTrabalho, id=horario_id, empreendedor=profissional)
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except HorarioTrabalho.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Horário não encontrado.'}, status=404)

    # --- EXCLUIR (DELETE) ---
    if request.method == 'DELETE':
        try:
            horario.delete()
            return JsonResponse({'status': 'success', 'message': 'Horário removido.'}, status=204)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    return JsonResponse({'status': 'error', 'message': 'Método não permitido.'}, status=405)


def hex_to_hsl_string(hex_color):
    """Converte #RRGGBB para uma string HSL 'H, S%, L%'"""
    hex_color = hex_color.lstrip('#')
    try:
        r, g, b = tuple(int(hex_color[i:i+2], 16) for i in (0, 2, 4))
        r, g, b = [x / 255.0 for x in (r, g, b)]
        # O colorsys usa HLS, que é um pouco diferente de HSL
        h, l, s = colorsys.rgb_to_hls(r, g, b)
        # Converte para o formato HSL do CSS
        return f"{int(h * 360)}, {int(s * 100)}%, {int(l * 100)}%"
    except Exception:
        # Retorna o padrão (verde-menta) em caso de erro
        return "160, 41%, 58%"


def api_negocio_info(request, empreendedor_slug):
    """
    Retorna as informações públicas do negócio, incluindo as cores.
    """
    negocio = get_object_or_404(Negocio, slug=empreendedor_slug)

    # --- LÓGICA DA COR PRIMÁRIA (JÁ EXISTE) ---
    cor_primaria_hex = negocio.cor_primaria
    cor_primaria_hsl = hex_to_hsl_string(cor_primaria_hex)

    # --- ADICIONE ESTAS DUAS LINHAS ---
    cor_secundaria_hex = negocio.cor_secundaria
    cor_secundaria_hsl = hex_to_hsl_string(cor_secundaria_hex)
    # --- FIM DA ADIÇÃO ---

    data = {
        'nome_negocio': negocio.nome_negocio,
        'tagline': negocio.tagline,
        'cor_primaria_hex': cor_primaria_hex,
        'cor_primaria_hsl': cor_primaria_hsl,

        # --- ADICIONE ESTAS DUAS LINHAS ---
        'cor_secundaria_hex': cor_secundaria_hex,
        'cor_secundaria_hsl': cor_secundaria_hsl,
        'logo_url': negocio.logo.url if negocio.logo else None,
        'portfolio_url': negocio.portfolio_url,
    }
    return JsonResponse(data)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_configuracoes(request):
    """
    API para o empreendedor logado LER e ATUALIZAR
    as configurações do seu próprio Negócio via FormData.
    """
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        data = {
            'nome_negocio': negocio.nome_negocio,
            'tagline': negocio.tagline,
            'cor_primaria': negocio.cor_primaria,
            'cor_secundaria': negocio.cor_secundaria,
            'logo_url': negocio.logo.url if negocio.logo else None,  # <-- Adicionado
            'dias_antecedencia_maxima': negocio.dias_antecedencia_maxima,
            'portfolio_url': negocio.portfolio_url,
            'pagamento_online_habilitado': negocio.pagamento_online_habilitado
        }
        return JsonResponse(data)

    # --- ATUALIZAR (POST) ---
    if request.method == 'POST':
        # Dados de formulário (FormData) vêm em request.POST
        try:
            negocio.nome_negocio = request.POST.get(
                'nome_negocio', negocio.nome_negocio)
            negocio.tagline = request.POST.get('tagline', negocio.tagline)
            negocio.cor_primaria = request.POST.get(
                'cor_primaria', negocio.cor_primaria)
            negocio.cor_secundaria = request.POST.get(
                'cor_secundaria', negocio.cor_secundaria)

            # --- INÍCIO DA LÓGICA DE FORMATAÇÃO DO LINK ---

            # 1. Pega o link bruto que o usuário colou
            raw_url = request.POST.get('portfolio_url', '').strip()

            if not raw_url:
                # Se o campo estiver vazio, salva como vazio/nulo
                negocio.portfolio_url = None
            elif 'canva.com' in raw_url and '/view' in raw_url:
                # 2. É um link do Canva. Vamos garantir que termine com '?embed'.

                if '/view?embed' in raw_url:
                    # 2a. O link já está perfeito. Usa ele.
                    negocio.portfolio_url = raw_url
                else:
                    # 2b. O link é (.../view) ou (.../view?utm=...).
                    # Limpa qualquer parâmetro (como ?utm=) e força o ?embed.

                    # Pega a URL base antes de qualquer '?'
                    base_url = raw_url.split('?')[0]

                    # Garante que a URL base termine exatamente com '/view'
                    if not base_url.endswith('/view'):
                        # Lida com casos como .../view/pagina-2
                        base_url = base_url.split('/view')[0] + '/view'

                    # 3. Monta o link final e correto
                    negocio.portfolio_url = base_url + '?embed'
            else:
                # 4. Não é um link do Canva ou não é um link de "view". Salva como está.
                negocio.portfolio_url = raw_url

            # --- FIM DA LÓGICA DE FORMATAÇÃO DO LINK ---

            negocio.dias_antecedencia_maxima = request.POST.get(
                'dias_antecedencia_maxima', negocio.dias_antecedencia_maxima)

            # O 'request.POST.get' para um checkbox retorna 'true' ou 'false' como string
            pagamento_habilitado_str = request.POST.get(
                'pagamento_online_habilitado', 'false')
            negocio.pagamento_online_habilitado = (
                pagamento_habilitado_str == 'true')

            # O upload do arquivo vem em request.FILES
            if 'logo' in request.FILES:
                negocio.logo = request.FILES['logo']

            # O models.py cuida de atualizar o slug
            negocio.save()
            return JsonResponse({
                'status': 'success',
                'message': 'Configurações salvas com sucesso!',
                'new_logo_url': negocio.logo.url if negocio.logo else None
            })
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

# ---
# 1. API PÚBLICA (PARA O CLIENTE LER OS AVISOS)
# ---


def api_get_avisos(request, empreendedor_slug):
    negocio = get_object_or_404(Negocio, slug=empreendedor_slug)
    avisos = Aviso.objects.filter(negocio=negocio)
    data = [
        {
            'id': aviso.id,
            'titulo': aviso.titulo,
            'conteudo': aviso.conteudo
        } for aviso in avisos
    ]
    return JsonResponse(data, safe=False)

# ---
# 2. API DO DASHBOARD (LISTAR E CRIAR AVISOS)
# ---


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_avisos(request):
    try:
        negocio = request.user.empreendedor_profile.negocio
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        avisos = Aviso.objects.filter(negocio=negocio)
        data = [
            {
                'id': aviso.id,
                'titulo': aviso.titulo,
                'conteudo': aviso.conteudo,
                'ordem': aviso.ordem
            } for aviso in avisos
        ]
        return JsonResponse(data, safe=False)

    # --- CRIAR (POST) ---
    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            aviso = Aviso.objects.create(
                negocio=negocio,
                titulo=data['titulo'],
                conteudo=data['conteudo'],
                ordem=data.get('ordem', 0)
            )
            return JsonResponse({'status': 'success', 'message': 'Aviso criado!', 'id': aviso.id}, status=201)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

# ---
# 3. API DO DASHBOARD (EDITAR E EXCLUIR UM AVISO)
# ---


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_aviso_detalhe(request, aviso_id):
    try:
        negocio = request.user.empreendedor_profile.negocio
        aviso = get_object_or_404(Aviso, id=aviso_id, negocio=negocio)
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Aviso.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Aviso não encontrado.'}, status=404)

    # --- INÍCIO DA CORREÇÃO (BLOCO GET FALTANTE) ---
    # --- LER DETALHE (GET) ---
    if request.method == 'GET':
        data = {
            'id': aviso.id,
            'titulo': aviso.titulo,
            'conteudo': aviso.conteudo,
            'ordem': aviso.ordem
        }
        return JsonResponse(data)
    # --- FIM DA CORREÇÃO ---

    # --- EDITAR (POST) ---
    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            aviso.titulo = data.get('titulo', aviso.titulo)
            aviso.conteudo = data.get('conteudo', aviso.conteudo)
            aviso.ordem = data.get('ordem', aviso.ordem)
            aviso.save()
            return JsonResponse({'status': 'success', 'message': 'Aviso atualizado.'})
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    # --- EXCLUIR (DELETE) ---
    if request.method == 'DELETE':
        try:
            aviso.delete()
            return JsonResponse({'status': 'success', 'message': 'Aviso excluído.'}, status=204)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    # Retorno para outros métodos não permitidos
    return JsonResponse({'status': 'error', 'message': 'Método não permitido.'}, status=405)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_dias_bloqueados(request):
    """
    API para LER todos os dias bloqueados e CRIAR um novo.
    Refere-se sempre ao profissional LOGADO.
    """
    try:
        profissional = request.user.empreendedor_profile
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)

    # --- LER (GET) ---
    if request.method == 'GET':
        # Retorna apenas bloqueios futuros
        hoje = timezone.now().date()
        bloqueios = DiaBloqueado.objects.filter(
            empreendedor=profissional, data__gte=hoje)
        data = [
            {
                'id': b.id,
                'data': b.data.isoformat(),
                'descricao': b.descricao,
            } for b in bloqueios
        ]
        return JsonResponse(data, safe=False)

    # --- CRIAR (POST) ---
    if request.method == 'POST':
        data = json.loads(request.body)
        try:
            data_bloqueio_str = data['data']
            data_bloqueio = datetime.strptime(
                data_bloqueio_str, '%Y-%m-%d').date()

            # --- INÍCIO DA VALIDAÇÃO (A SUA SUGESTÃO) ---
            # 1. Verifica se já existem agendamentos para este profissional neste dia
            agendamentos_existentes = Agendamento.objects.filter(
                empreendedor_executor=profissional,
                data=data_bloqueio
            )

            if agendamentos_existentes.exists():
                # 2. Se existirem, impede o bloqueio e envia a notificação
                count = agendamentos_existentes.count()
                msg = f'Não é possível bloquear este dia. Você já tem {count} agendamento(s) marcados.'
                # 400 Bad Request
                return JsonResponse({'status': 'error', 'message': msg}, status=400)
            # --- FIM DA VALIDAÇÃO ---

            # 3. Se estiver livre, cria o bloqueio
            bloqueio = DiaBloqueado.objects.create(
                empreendedor=profissional,
                data=data_bloqueio,
                descricao=data.get('descricao', 'Dia bloqueado')
            )
            return JsonResponse({'status': 'success', 'message': 'Dia bloqueado!', 'id': bloqueio.id}, status=201)

        except Exception as e:
            if 'UNIQUE constraint' in str(e):
                return JsonResponse({'status': 'error', 'message': 'Este dia já está bloqueado.'}, status=400)
            return JsonResponse({'status': 'error', 'message': f'Erro ao salvar: {str(e)}'}, status=400)


@csrf_exempt
@user_passes_test(is_admin)
def api_gestao_dia_bloqueado_detalhe(request, bloqueio_id):
    """
    API para EXCLUIR um dia bloqueado.
    """
    try:
        profissional = request.user.empreendedor_profile
        bloqueio = get_object_or_404(
            DiaBloqueado, id=bloqueio_id, empreendedor=profissional)
    except Exception:
        return JsonResponse({'status': 'error', 'message': 'Bloqueio não encontrado.'}, status=404)

    # --- EXCLUIR (DELETE) ---
    if request.method == 'DELETE':
        bloqueio.delete()
        return JsonResponse({'status': 'success', 'message': 'Bloqueio removido.'}, status=204)


@csrf_exempt
@login_required(login_url=None)
@transaction.atomic  # Garante que as atualizações no User e Cliente ocorram juntas
def api_manage_profile(request, empreendedor_slug):
    """
    API para o cliente logado GERENCIAR seus próprios dados.
    """
    try:
        # Pega o usuário e o cliente logado
        user = request.user
        cliente = user.cliente
        negocio = get_object_or_404(Negocio, slug=empreendedor_slug)

        # Garante que o cliente pertence ao negócio que está acessando
        if cliente.negocio != negocio:
            return JsonResponse({'status': 'error', 'message': 'Permissão negada.'}, status=403)

    except Cliente.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Cliente não encontrado.'}, status=404)

    if request.method == 'GET':
        # --- LER DADOS ---
        return JsonResponse({
            'first_name': user.first_name,
            'last_name': user.last_name,
            'email': user.email,
            'phone': cliente.telefone,
            'nascimento': cliente.data_nascimento
        })

    if request.method == 'POST':
        # --- ATUALIZAR DADOS ---
        try:
            data = json.loads(request.body)

            new_email = data.get('email')
            new_phone = data.get('phone')

            # Validação 1: Email (que também é o username)
            if new_email and new_email != user.email:
                if User.objects.filter(username=new_email).exclude(pk=user.pk).exists():
                    raise ValidationError(
                        'Este email já está em uso por outra conta.')
                user.email = new_email
                user.username = new_email  # Atualiza o username junto

            # Validação 2: Telefone (deve ser único NO NEGÓCIO)
            if new_phone and new_phone != cliente.telefone:
                if Cliente.objects.filter(negocio=negocio, telefone=new_phone).exclude(pk=cliente.pk).exists():
                    raise ValidationError(
                        'Este telefone já está em uso por outro cliente neste negócio.')
                cliente.telefone = new_phone

            # Atualiza os outros campos
            user.first_name = data.get('first_name', user.first_name)
            user.last_name = data.get('last_name', user.last_name)
            cliente.data_nascimento = data.get(
                'nascimento', cliente.data_nascimento)

            user.save()
            cliente.save()

            return JsonResponse({'status': 'success', 'message': 'Perfil atualizado com sucesso!'})

        except ValidationError as e:
            return JsonResponse({'status': 'error', 'message': e.message}, status=400)
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': f'Ocorreu um erro: {str(e)}'}, status=500)

    return JsonResponse({'status': 'error', 'message': 'Método inválido.'}, status=405)


@csrf_exempt
@user_passes_test(is_admin)
@transaction.atomic
def api_gestao_equipe_detalhe(request, membro_id):
    """
    API para gerenciar um membro específico da equipe (Editar, Deletar, Ler).
    """
    try:
        negocio = request.user.empreendedor_profile.negocio
        membro = get_object_or_404(
            EmpreendedorProfile, id=membro_id, negocio=negocio)
        user = membro.user
    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Membro não encontrado.'}, status=404)

    # --- LER (GET) ---
    if request.method == 'GET':
        data = {
            'id': membro.id,
            'first_name': user.first_name,
            'last_name': user.last_name,
            'email': user.email,
            'telefone': membro.telefone,
            'foto_url': membro.foto.url if membro.foto else None,
        }
        return JsonResponse(data)

    # --- EDITAR (POST) ---
    if request.method == 'POST':
        try:
            # Dados vêm de FormData (request.POST)
            user.first_name = request.POST.get('nome', user.first_name)
            user.last_name = request.POST.get('sobrenome', user.last_name)
            user.save()

            membro.telefone = request.POST.get('telefone', membro.telefone)

            if 'foto' in request.FILES:
                membro.foto = request.FILES['foto']

            # Atualiza a senha (se uma nova foi enviada)
            nova_senha = request.POST.get('password', None)
            if nova_senha and nova_senha.strip():
                user.set_password(nova_senha)
                user.save()

            membro.save()

            return JsonResponse({
                'status': 'success',
                'message': 'Membro atualizado com sucesso!',
                'new_foto_url': membro.foto.url if membro.foto else None
            })
        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    # --- EXCLUIR (DELETE) ---
    if request.method == 'DELETE':
        try:
            # TRAVA DE SEGURANÇA: Verifica se há agendamentos futuros
            hoje = timezone.now().date()
            agendamentos_futuros = Agendamento.objects.filter(
                empreendedor_executor=membro,
                data__gte=hoje,
                status__in=['Confirmado', 'Pendente']
            ).exists()

            if agendamentos_futuros:
                return JsonResponse({'status': 'error', 'message': 'Não é possível excluir este membro, pois ele possui agendamentos futuros.'}, status=400)

            # Se não tiver, exclui o usuário (o Perfil é deletado em cascata)
            user.delete()
            return JsonResponse({'status': 'success', 'message': 'Membro excluído com sucesso.'}, status=200)

        except Exception as e:
            return JsonResponse({'status': 'error', 'message': str(e)}, status=400)

    return JsonResponse({'status': 'error', 'message': 'Método não permitido.'}, status=405)


@user_passes_test(is_admin)
def api_admin_get_form_data(request):
    """
    Busca todos os dados necessários (clientes, serviços, profissionais)
    para os modais de criação/edição no calendário do admin.
    """
    try:
        negocio = request.user.empreendedor_profile.negocio

        # 1. Buscar Clientes
        clientes = Cliente.objects.filter(
            negocio=negocio).select_related('user')
        clientes_data = [
            {
                'id': c.id,
                'nome': c.user.get_full_name() or c.user.username,
                'telefone': c.telefone
            } for c in clientes
        ]

        # 2. Buscar Profissionais (Equipe)
        profissionais = EmpreendedorProfile.objects.filter(
            negocio=negocio).select_related('user')
        profissionais_data = [
            {
                'id': p.id,
                'nome': p.user.get_full_name() or p.user.username
            } for p in profissionais
        ]

        # 3. Buscar Serviços e Tiers (Manutenções)
        servicos = Servico.objects.filter(
            negocio=negocio).prefetch_related('precos_manutencao')
        servicos_data = []
        for s in servicos:
            # Adiciona o serviço principal
            servicos_data.append({
                'id': f'service_{s.id}',  # ID único (ex: "service_1")
                'nome': s.nome,
                'duracao': s.duracao_minutos,
                'preco': s.preco,
                'profissionais_ids': [p.id for p in s.profissionais_que_executam.all()]
            })
            # Adiciona os tiers de manutenção
            for tier in s.precos_manutencao.all():
                servicos_data.append({
                    'id': f'tier_{tier.id}',  # ID único (ex: "tier_5")
                    'nome': f"{s.nome} - {tier.nome_tier}",
                    'duracao': tier.duracao_minutos,
                    'preco': tier.preco,
                    'profissionais_ids': [p.id for p in s.profissionais_que_executam.all()]
                })

        return JsonResponse({
            'clientes': clientes_data,
            'profissionais': profissionais_data,
            'servicos_e_tiers': servicos_data
        })

    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil não encontrado.'}, status=403)
    except Exception as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=500)


@csrf_exempt
@user_passes_test(is_admin)
@transaction.atomic
def api_admin_criar_agendamento(request):
    """
    Cria um novo agendamento (e opcionalmente um novo cliente) 
    pelo dashboard do admin.
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)

    try:
        negocio = request.user.empreendedor_profile.negocio
        data = json.loads(request.body)

        cliente_id = data.get('cliente_id')
        cliente = None

        if cliente_id == 'new':
            # --- Cria um NOVO Cliente ---
            novo_email = data.get('novo_cliente_email')
            novo_telefone = re.sub(
                r'\D', '', data.get('novo_cliente_telefone', ''))

            if not novo_email or not novo_telefone or not data.get('novo_cliente_nome') or not data.get('novo_cliente_nascimento'):
                raise ValidationError(
                    "Para novos clientes, todos os campos são obrigatórios.")

            if User.objects.filter(username=novo_email).exists():
                raise ValidationError(
                    f"O email '{novo_email}' já está em uso.")

            if Cliente.objects.filter(negocio=negocio, telefone=novo_telefone).exists():
                raise ValidationError(
                    f"O telefone '{novo_telefone}' já está em uso neste negócio.")

            # Cria o User
            novo_user = User.objects.create_user(
                username=novo_email,
                email=novo_email,
                password=get_random_string(length=14),  # Senha aleatória
                first_name=data.get('novo_cliente_nome'),
                last_name=data.get('novo_cliente_sobrenome', '')
            )
            # Cria o Cliente
            cliente = Cliente.objects.create(
                user=novo_user,
                negocio=negocio,
                telefone=novo_telefone,
                data_nascimento=data.get('novo_cliente_nascimento')
            )
        else:
            # --- Usa um Cliente Existente ---
            cliente = get_object_or_404(
                Cliente, id=int(cliente_id), negocio=negocio)

        # --- Lógica do Serviço/Tier ---
        servico_tier_id_str = data.get('servico_tier_id')
        servico = None
        tier = None

        if servico_tier_id_str.startswith('service_'):
            servico = get_object_or_404(Servico, id=int(
                servico_tier_id_str.split('_')[1]))
        elif servico_tier_id_str.startswith('tier_'):
            tier = get_object_or_404(PrecoManutencao, id=int(
                servico_tier_id_str.split('_')[1]))
            servico = tier.servico_pai

        if not servico:
            raise ValidationError("Serviço ou Manutenção inválido.")

        profissional = get_object_or_404(EmpreendedorProfile, id=int(
            data.get('profissional_id')), negocio=negocio)

        # --- Cria o Agendamento ---
        novo_agendamento = Agendamento(
            cliente=cliente,
            servico=servico,
            tier_manutencao=tier,
            empreendedor_executor=profissional,
            data=data.get('data'),
            horario=data.get('horario'),
            status='Pendente',  # <-- MUDANÇA (de 'Confirmado' para 'Pendente')
            status_pagamento='Pendente',  # Cliente paga no local
            observacoes=data.get('observacoes', '')
        )
        # O .save() vai calcular preco_final e duracao_final
        novo_agendamento.save()

        return JsonResponse({'status': 'success', 'message': 'Agendamento criado com sucesso!'}, status=201)

    except EmpreendedorProfile.DoesNotExist:
        return JsonResponse({'status': 'error', 'message': 'Perfil de admin não encontrado.'}, status=403)
    except (Cliente.DoesNotExist, Servico.DoesNotExist, PrecoManutencao.DoesNotExist, EmpreendedorProfile.DoesNotExist, ValidationError) as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=404)
    except Exception as e:
        logger.error(
            f"Erro inesperado em api_admin_criar_agendamento: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': f'Erro interno: {e}'}, status=500)


@csrf_exempt
@user_passes_test(is_admin)
@transaction.atomic
def api_admin_atualizar_agendamento(request, agendamento_id):
    """
    Atualiza TODOS os dados de um agendamento (serviço, data, hora, status, etc.)
    (Substitui e expande a antiga 'api_atualizar_pagamento')
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)

    try:
        negocio = request.user.empreendedor_profile.negocio
        agendamento = get_object_or_404(
            Agendamento, id=agendamento_id, servico__negocio=negocio)

        data = json.loads(request.body)

        # Atualiza campos simples (status, pagamento, observações)
        agendamento.status = data.get('status', agendamento.status)
        agendamento.status_pagamento = data.get(
            'status_pagamento', agendamento.status_pagamento)
        agendamento.observacoes = data.get(
            'observacoes', agendamento.observacoes)

        # Atualiza campos complexos (cliente, profissional, data, hora)
        if 'cliente_id' in data:
            agendamento.cliente = get_object_or_404(
                Cliente, id=int(data['cliente_id']), negocio=negocio)

        if 'profissional_id' in data:
            agendamento.empreendedor_executor = get_object_or_404(
                EmpreendedorProfile, id=int(data['profissional_id']), negocio=negocio)

        if 'data' in data:
            agendamento.data = data['data']

        if 'horario' in data:
            agendamento.horario = data['horario']

        # Lógica de atualização do Serviço/Tier (RECALCULA PREÇO/DURAÇÃO)
        if 'servico_tier_id' in data:
            servico_tier_id_str = data.get('servico_tier_id')
            servico_novo = None
            tier_novo = None

            if servico_tier_id_str.startswith('service_'):
                servico_novo = get_object_or_404(
                    Servico, id=int(servico_tier_id_str.split('_')[1]))
            elif servico_tier_id_str.startswith('tier_'):
                tier_novo = get_object_or_404(
                    PrecoManutencao, id=int(servico_tier_id_str.split('_')[1]))
                servico_novo = tier_novo.servico_pai

            agendamento.servico = servico_novo
            agendamento.tier_manutencao = tier_novo

            # Força o recálculo do preço e duração
            agendamento.preco_final = None
            agendamento.duracao_final = None
            # O .save() irá preenchê-los com os novos valores
            # (Não mexemos no 'valor_adiantamento' de um agendamento existente)

        agendamento.save()
        return JsonResponse({'status': 'success', 'message': 'Agendamento atualizado com sucesso'})

    except (EmpreendedorProfile.DoesNotExist, Cliente.DoesNotExist, Servico.DoesNotExist, PrecoManutencao.DoesNotExist, ValidationError) as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=404)
    except Exception as e:
        logger.error(
            f"Erro inesperado em api_admin_atualizar_agendamento: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': f'Erro interno: {e}'}, status=500)


@csrf_exempt
@user_passes_test(is_admin)
def api_admin_atualizar_horario_agendamento(request, agendamento_id):
    """
    Atualização rápida para o drag-and-drop (remanejamento).
    """
    if request.method != 'POST':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)

    try:
        negocio = request.user.empreendedor_profile.negocio
        agendamento = get_object_or_404(
            Agendamento, id=agendamento_id, servico__negocio=negocio)

        data = json.loads(request.body)

        nova_data_hora = data.get('start_iso')  # Espera "2025-11-20T14:30:00"
        if not nova_data_hora:
            raise ValidationError("Nova data/hora não fornecida.")

        dt_obj = datetime.fromisoformat(nova_data_hora)

        # (Idealmente, aqui você verificaria conflitos de horário antes de salvar)

        agendamento.data = dt_obj.date()
        agendamento.horario = dt_obj.time()
        agendamento.save()

        return JsonResponse({'status': 'success', 'message': 'Agendamento remanejado com sucesso'})

    except (EmpreendedorProfile.DoesNotExist, Agendamento.DoesNotExist, ValidationError) as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=404)
    except Exception as e:
        logger.error(
            f"Erro inesperado em api_admin_atualizar_horario: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': f'Erro interno: {e}'}, status=500)


@csrf_exempt
@user_passes_test(is_admin)
def api_admin_deletar_agendamento(request, agendamento_id):
    """
    Exclui um agendamento pelo dashboard do admin.
    """
    if request.method != 'DELETE':
        return JsonResponse({'status': 'error', 'message': 'Método não permitido'}, status=405)

    try:
        negocio = request.user.empreendedor_profile.negocio
        agendamento = get_object_or_404(
            Agendamento, id=agendamento_id, servico__negocio=negocio)

        agendamento.delete()

        return JsonResponse({'status': 'success', 'message': 'Agendamento excluído com sucesso'})

    except (EmpreendedorProfile.DoesNotExist, Agendamento.DoesNotExist) as e:
        return JsonResponse({'status': 'error', 'message': str(e)}, status=404)
    except Exception as e:
        logger.error(
            f"Erro inesperado em api_admin_deletar_agendamento: {e}", exc_info=True)
        return JsonResponse({'status': 'error', 'message': f'Erro interno: {e}'}, status=500)

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\management\commands\cleanup_pending_bookings.py

# agendamentos/management/commands/cleanup_pending_bookings.py

from django.core.management.base import BaseCommand
from django.utils import timezone
from agendamentos.models import Agendamento
from agendamentos.mercadopago_service import MercadoPagoService
import logging

logger = logging.getLogger(__name__)


class Command(BaseCommand):
    help = 'Cancela agendamentos pendentes cujo PIX expirou e não foi pago.'

    def handle(self, *args, **options):
        self.stdout.write(self.style.NOTICE(
            'Iniciando limpeza de agendamentos pendentes...'))

        # Pega a hora atual
        now = timezone.now()

        # --- MUDANÇA NA QUERY ---
        # Busca agendamentos PENDENTES, com pagamento AGUARDANDO, e EXPIRADOS
        expired_bookings = Agendamento.objects.filter(
            status='Pendente',
            # <-- MUDANÇA [cite: 383-384]
            status_pagamento='Aguardando Pagamento',
            payment_expires__lte=now
        )

        if not expired_bookings.exists():
            self.stdout.write(self.style.SUCCESS(
                'Nenhum agendamento expirado encontrado.'))
            return

        self.stdout.write(
            f'Encontrados {expired_bookings.count()} agendamentos expirados.')

        mp = MercadoPagoService()

        for ag in expired_bookings:
            self.stdout.write(
                f'Verificando Agendamento ID: {ag.id} (Payment ID: {ag.payment_id_mp})...')

            # Dupla checagem: Verifica o status na API do MP
            status_real = mp.verificar_status_pagamento(ag.payment_id_mp)

            if status_real == "approved":
                # Caso raro: Webhook atrasou, mas o pagamento foi feito.
                ag.status = 'Pendente'  # Status do agendamento fica Pendente

                # --- INÍCIO DA NOVA LÓGICA CONDICIONAL ---
                if ag.valor_adiantamento < ag.preco_final:
                    ag.status_pagamento = 'Adiantamento Realizado'
                    ag.observacoes = f"Adiantamento {ag.payment_id_mp} aprovado via cleanup job. Aguardando confirmação manual."
                else:
                    ag.status_pagamento = 'Pago'
                    ag.observacoes = f"Pagamento integral {ag.payment_id_mp} aprovado via cleanup job. Aguardando confirmação manual."
                # --- FIM DA NOVA LÓGICA CONDICIONAL ---

                ag.save()
                self.stdout.write(self.style.SUCCESS(
                    f'Agendamento {ag.id} PAGO ({ag.status_pagamento}).'))

            elif status_real in ["rejected", "cancelled", "expired", "pending"]:
                # Pagamento falhou, expirou ou ainda está pendente (mas nosso tempo acabou)
                ag.status = 'Cancelado'
                ag.status_pagamento = 'Cancelado'
                ag.observacoes = f"Pagamento {ag.payment_id_mp} expirado e cancelado pelo cleanup job (Status MP: {status_real})."
                ag.save()
                self.stdout.write(self.style.WARNING(
                    f'Agendamento {ag.id} CANCELADO (expirado).'))

            else:
                # Status desconhecido ou erro na API
                self.stdout.write(self.style.ERROR(
                    f'Status desconhecido ({status_real}) para Agendamento {ag.id}. Nenhuma ação tomada.'))

        self.stdout.write(self.style.SUCCESS('Limpeza concluída.'))

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\index.html

{% extends 'base.html' %}

{% block content %}
    {# As telas da sua aplicação de página única (SPA) devem estar aqui #}
    {% include 'agendamentos/partials/home.html' %}
    {% include 'agendamentos/partials/warnings.html' %}
    {% include 'agendamentos/partials/services.html' %}
    
    {% include 'agendamentos/partials/professional.html' %}
    
    {% include 'agendamentos/partials/calendar.html' %}
    {% include 'agendamentos/partials/login.html' %}

    {% include 'agendamentos/partials/payment.html' %}
    {% include 'agendamentos/partials/payment_failed.html' %}
    {% include 'agendamentos/partials/confirmation.html' %}
    {% include 'agendamentos/partials/client_area.html' %}
    {% include 'agendamentos/partials/profile.html' %}
    {% include 'agendamentos/partials/forced_login.html' %}
    {% include 'agendamentos/partials/admin_login.html' %}
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\negocio_nao_encontrado.html

{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container" style="text-align: center; padding-top: 5rem; min-height: 70vh; display: flex; align-items: center; justify-content: center;">
    
    <div class="empty-state" style="max-width: 500px; margin: 0 auto; padding: 2rem; background: var(--color-surface); border: 1px solid var(--color-border); border-radius: var(--radius-lg);">
        
        <div class="empty-icon" style="font-size: 3rem; color: var(--color-red);">🚫</div>
        
        <h2 style="margin-bottom: 1rem; color: var(--color-dark-gray);">Estabelecimento não encontrado</h2>
        
        <p class="text-secondary" style="font-size: 1.1rem; line-height: 1.6;">
            Desculpe, o link que você acessou (<strong>/{{ slug_invalido }}</strong>) não corresponde a nenhum estabelecimento cadastrado.
        </p>
        
        <p class="text-secondary" style="margin-top: 1rem; font-size: 0.9rem;">
            Por favor, verifique se o endereço foi digitado corretamente.
        </p>
    </div>

</div>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\base.html

<!-- templates/agendamentos/dashboard/base.html -->
{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.css">
<link rel="stylesheet" href="{% static 'css/dashboard-main.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-sidebar">
        <div class="sidebar-header">
            <h2>Dashboard</h2>
        </div>
        <ul class="sidebar-nav">
            <li><a href="{% url 'admin_dashboard' %}" class="{% if request.resolver_match.url_name == 'admin_dashboard' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>
                Visão Geral
            </a></li>
            <li><a href="{% url 'admin_calendario' %}" class="{% if request.resolver_match.url_name == 'admin_calendario' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
                Calendário
            </a></li>
            <li><a href="{% url 'admin_financeiro' %}" class="{% if request.resolver_match.url_name == 'admin_financeiro' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"></line><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path></svg>
                Financeiro
            </a></li>
            <li><a href="{% url 'admin_gestao' %}" class="{% if request.resolver_match.url_name == 'admin_gestao' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 16.5V9.75m0 0l3 3m-3-3l-3 3M6.75 19.5a4.5 4.5 0 01-1.41-8.775 5.25 5.25 0 0110.33-2.33 3 3 0 013.75 5.575m-3.75 2.33l-3 3m3-3l3 3"></path></svg>
                Gestão
            </a></li>
            <li><a href="{% url 'admin_relatorios' %}" class="{% if request.resolver_match.url_name == 'admin_relatorios' %}active{% endif %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Relatórios
            </a></li>
            {% if empreendedor_slug %}
            <li><a href="{% url 'agendamentos:empreendedor_home' empreendedor_slug=empreendedor_slug %}">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                Voltar ao Site
            </a></li>
            {% endif %}
        </ul>
    </div>
    <div class="dashboard-content">
        {% block dashboard_content %}{% endblock %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>

    <script src="{% static 'js/ui.js' %}"></script>

    {% block dashboard_js %}{% endblock %}
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\calendario.html

{% extends 'agendamentos/dashboard/base.html' %}

{% block dashboard_content %}
<style>
    /* Estilos para o novo modal de cliente */
    .form-toggle {
        display: flex;
        background: var(--color-gray-50);
        border-radius: var(--radius-base);
        padding: var(--space-4);
        margin-bottom: var(--space-24);
        position: relative;
    }
    .toggle-btn {
        flex: 1;
        padding: var(--space-12);
        border: none;
        background: transparent;
        border-radius: var(--radius-base);
        cursor: pointer;
        font-weight: 500;
        color: var(--color-gray-500);
        position: relative;
        z-index: 1;
        transition: color 0.3s ease;
    }
    .toggle-btn.active {
        color: var(--color-gray-900);
    }
    .form-toggle::before {
        content: '';
        position: absolute;
        height: calc(100% - var(--space-8));
        top: var(--space-4);
        left: var(--space-4);
        width: calc(50% - var(--space-4));
        background: var(--color-white);
        border-radius: var(--radius-base);
        box-shadow: var(--shadow-sm);
        transition: transform 0.3s ease-out;
        z-index: 0;
    }
    .form-toggle.toggle-right::before {
        transform: translateX(calc(100% + var(--space-8)));
    }

    /* --- INÍCIO DA NOVA ADIÇÃO (CSS da Legenda) --- */
    .calendar-legend {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 1rem;
        padding-left: 8px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        font-size: 0.875rem;
        color: var(--color-gray-700);
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        border: 1px solid rgba(0,0,0,0.1);
    }
</style>

<div class="dashboard-card">
    <div class="dashboard-card-title">
        Calendário de Agendamentos
        <div class="btn-group">
            <button class="btn btn--primary btn--sm" id="btn-new-appointment">Novo Agendamento</button>
            <button class="btn btn--outline btn--sm" id="btn-month">Mês</button>
            <button class="btn btn--outline btn--sm" id="btn-week">Semana</button>
            <button class="btn btn--outline btn--sm" id="btn-day">Dia</button>
        </div>
    </div>
    <div class="dashboard-card-body">
        <p class="text-secondary" style="margin-bottom: 1rem; font-size: 0.875rem;">
            Clique em um dia para agendar. Clique e arraste um evento para remanejar.
        </p>
        <div class="calendar-legend">
            <span class="legend-item"><span class="legend-dot" style="background-color: #FF9500;"></span> Pendente</span>
            <span class="legend-item"><span class="legend-dot" style="background-color: #0D99FF;"></span> Confirmado</span>
            <span class="legend-item"><span class="legend-dot" style="background-color: #5CCFAC;"></span> Concluído</span>
            <span class="legend-item"><span class="legend-dot" style="background-color: #FF5A5F;"></span> Cancelado</span>
        </div>
        <div id="calendar"></div>
    </div>
</div>

<div id="event-modal" class="modal-container hidden">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="event-modal-title">Editar Agendamento</h3>
            <button id="event-modal-close" class="modal-close">&times;</button>
        </div>
        <div id="event-modal-body" class="modal-body">
            <form id="event-edit-form">
                <input type="hidden" id="event-edit-id">

                <div class="form-group">
                    <label class="form-label" for="event-edit-client">Cliente</label>
                    <select id="event-edit-client" class="form-control" required>
                        <option value="">Carregando clientes...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="event-edit-service">Serviço / Manutenção</label>
                    <select id="event-edit-service" class="form-control" required>
                        <option value="">Carregando serviços...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="event-edit-professional">Profissional Executor</label>
                    <select id="event-edit-professional" class="form-control" required>
                        <option value="">Carregando profissionais...</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="event-edit-date">Data</label>
                        <input type="date" id="event-edit-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="event-edit-time">Hora</label>
                        <input type="time" id="event-edit-time" class="form-control" required step="900"> </div>
                </div>
                
                <hr style="border: none; border-top: 1px solid var(--color-gray-100); margin: 24px 0;">

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status do Agendamento</label>
                        <select id="event-edit-status" class="form-control">
                            <option value="Pendente">Pendente</option>
                            <option value="Confirmado">Confirmado</option>
                            <option value="Concluído">Concluído</option>
                            <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status do Pagamento</label>
                        <select id="event-edit-payment" class="form-control">
                            <option value="Aguardando Pagamento">Aguardando Pagamento</option>
                            <option value="Pendente">Pendente</option>
                            <option value="Adiantamento Realizado">Adiantamento Realizado</option>
                            <option value="Pago">Pago</option> <option value="Cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações (Internas)</label>
                    <textarea id="event-edit-notes" class="form-control" rows="3"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="event-modal-delete" class="btn btn--outline" style="color: var(--color-danger); border-color: var(--color-danger); margin-right: auto;">Excluir Agendamento</button>
            <button id="event-modal-cancel" class="btn btn--outline">Cancelar</button>
            <button id="event-modal-save" class="btn btn--primary">Salvar Alterações</button>
        </div>
    </div>
</div>


<div id="new-event-modal" class="modal-container hidden">
    <div class="modal-content" style="max-width: 700px;">
        <div class="modal-header">
            <h3 id="new-event-modal-title">Novo Agendamento</h3>
            <button id="new-event-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="new-event-form">
            <div class="modal-body">
                
                <div class="form-toggle">
                    <button type="button" class="toggle-btn active" data-tab="existing-client">Cliente Existente</button>
                    <button type="button" class="toggle-btn" data-tab="new-client">Novo Cliente</button>
                </div>

                <div id="panel-existing-client" class="form-tab-panel">
                    <div class="form-group">
                        <label class="form-label" for="new-event-client">Selecionar Cliente</label>
                        <select id="new-event-client" class="form-control" required>
                            <option value="">Carregando clientes...</option>
                        </select>
                    </div>
                </div>

                <div id="panel-new-client" class="form-tab-panel hidden">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="new-client-nome">Nome</label>
                            <input type="text" id="new-client-nome" class="form-control">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="new-client-sobrenome">Sobrenome</label>
                            <input type="text" id="new-client-sobrenome" class="form-control">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="new-client-telefone">Telefone (com DDD)</label>
                            <input type="tel" id="new-client-telefone" class="form-control" placeholder="(11) 9....">
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="new-client-nascimento">Data de Nascimento</label>
                            <input type="date" id="new-client-nascimento" class="form-control">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-client-email">Email</label>
                        <input type="email" id="new-client-email" class="form-control" placeholder="cliente@email.com">
                    </div>
                </div>

                <hr style="border: none; border-top: 1px solid var(--color-gray-100); margin: 24px 0;">

                <div class="form-group">
                    <label class="form-label" for="new-event-service">Serviço / Manutenção</label>
                    <select id="new-event-service" class="form-control" required>
                        <option value="">Selecione um serviço...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label" for="new-event-professional">Profissional Executor</label>
                    <select id="new-event-professional" class="form-control" required>
                        <option value="">Selecione um profissional...</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="new-event-date">Data</label>
                        <input type="date" id="new-event-date" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="new-event-time">Hora</label>
                        <input type="time" id="new-event-time" class="form-control" required step="900"> </div>
                </div>
                 <div class="form-group">
                    <label class="form-label">Observações (Internas)</label>
                    <textarea id="new-event-notes" class="form-control" rows="3"></textarea>
                </div>

            </div>
            <div class="modal-footer">
                <button type="button" id="new-event-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" id="new-event-modal-save" class="btn btn--primary">Salvar Agendamento</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script>
    document.addEventListener('DOMContentLoaded', async function() {
        
        // --- VARIÁVEIS GLOBAIS DO CALENDÁRIO ---
        let calendarEl = document.getElementById('calendar');
        let calendar;
        let adminDataCache = {
            clientes: [],
            profissionais: [],
            servicos_e_tiers: []
        };
        let currentEditingEventId = null;

        // --- MODAIS ---
        const eventModal = document.getElementById('event-modal');
        const newEventModal = document.getElementById('new-event-modal');

        // --- FUNÇÕES DE HELPERS (População de Selects) ---
        
        /**
         * Popula um <select> com dados
         * @param {HTMLElement} selectEl - O elemento <select>
         * @param {Array} data - A lista de objetos de dados
         * @param {string} valueField - O nome do campo para o 'value' (ex: 'id')
         * @param {string} textField - O nome do campo para o texto (ex: 'nome')
         * @param {string} [prompt] - Texto inicial (ex: "Selecione...")
         */
        function populateSelect(selectEl, data, valueField, textField, prompt) {
            selectEl.innerHTML = ''; // Limpa
            if (prompt) {
                selectEl.add(new Option(prompt, ""));
            }
            data.forEach(item => {
                selectEl.add(new Option(item[textField], item[valueField]));
            });
        }

        /**
         * Filtra o <select> de profissionais baseado no serviço escolhido
         * @param {HTMLElement} selectServico - O <select> de serviços
         * @param {HTMLElement} selectProfissional - O <select> de profissionais
         */
        function filterProfissionaisPorServico(selectServico, selectProfissional) {
            const selectedServicoId = selectServico.value;
            const servico = adminDataCache.servicos_e_tiers.find(s => s.id === selectedServicoId);
            const profissionalIds = servico ? servico.profissionais_ids : [];

            // Guarda o valor que estava selecionado
            const currentSelectedProfId = selectProfissional.value;

            // Filtra a lista completa de profissionais
            const profissionaisFiltrados = adminDataCache.profissionais.filter(p => 
                profissionalIds.includes(p.id)
            );

            // Popula o select de profissionais
            populateSelect(selectProfissional, profissionaisFiltrados, 'id', 'nome', "Selecione um profissional...");

            // Tenta reselecionar o profissional que estava antes (se ele ainda for válido)
            if (profissionaisFiltrados.some(p => p.id == currentSelectedProfId)) {
                selectProfissional.value = currentSelectedProfId;
            }
        }


        // --- FUNÇÕES DE DADOS ---

        /**
         * Busca os dados de clientes, serviços e profissionais da API
         */
        async function loadAdminFormData() {
            try {
                const response = await fetch('/api/admin/get-form-data/');
                if (!response.ok) throw new Error('Falha ao carregar dados do formulário.');
                adminDataCache = await response.json();
            } catch (error) {
                console.error(error);
                alert("Erro crítico: Não foi possível carregar os dados para o agendamento.");
            }
        }

        // --- FUNÇÕES DE INICIALIZAÇÃO DO FULLCALENDAR ---

        function initializeCalendar() {
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: '' // Nossos botões customizados cuidam disso
                },
                locale: 'pt-br',
                timeZone: 'local',
                height: 'auto',
                events: '/api/admin/agendamentos-calendario/',
                
                // --- NOVAS PROPRIEDADES ---
                selectable: true,  // Permite clicar em dias vazios
                editable: true,    // Permite arrastar eventos
                
                // --- NOVOS HANDLERS ---
                
                // 1. Ao clicar em um dia vazio (ou selecionar vários)
                select: handleDateSelect,
                
                // 2. Ao clicar em um evento existente
                eventClick: handleEventClick,
                
                // 3. Ao soltar um evento (arrastar e soltar)
                eventDrop: handleEventDrop,
                
                eventTimeFormat: {
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                }
            });
            calendar.render();
        }

        // --- HANDLERS DO FULLCALENDAR ---

        /**
         * (Handler) Chamado ao clicar em um dia vazio no calendário
         * @param {object} selectInfo - Informações da seleção (data/hora)
         */
        function handleDateSelect(selectInfo) {
            const modal = document.getElementById('new-event-modal');
            const form = document.getElementById('new-event-form');
            form.reset(); // Limpa o formulário

            // Preenche a data e hora de início
            document.getElementById('new-event-date').value = selectInfo.startStr.split('T')[0];
            
            // Se a visão for de dia/semana, pega a hora
            if (selectInfo.startStr.includes('T')) {
                 document.getElementById('new-event-time').value = selectInfo.startStr.split('T')[1].substring(0, 5);
            } else {
                 document.getElementById('new-event-time').value = "09:00"; // Padrão
            }

            // Popula os dropdowns com dados do cache
            const selectClient = document.getElementById('new-event-client');
            const selectService = document.getElementById('new-event-service');
            const selectProfessional = document.getElementById('new-event-professional');
            
            populateSelect(selectClient, adminDataCache.clientes, 'id', 'nome', "Selecione um cliente...");
            populateSelect(selectService, adminDataCache.servicos_e_tiers, 'id', 'nome', "Selecione um serviço...");
            populateSelect(selectProfessional, adminDataCache.profissionais, 'id', 'nome', "Selecione um profissional...");

            // Filtra profissionais baseado no serviço (inicialmente vazio)
            filterProfissionaisPorServico(selectService, selectProfessional);

            // Abre o modal
            modal.classList.remove('hidden');
        }

        /**
         * (Handler) Chamado ao clicar em um evento existente
         * @param {object} clickInfo - Informações do evento clicado
         */
        function handleEventClick(clickInfo) {
            currentEditingEventId = clickInfo.event.id;
            const eventData = clickInfo.event.extendedProps;
            const start = clickInfo.event.start;
            
            // Popula os dropdowns com dados do cache
            const selectClient = document.getElementById('event-edit-client');
            const selectService = document.getElementById('event-edit-service');
            const selectProfessional = document.getElementById('event-edit-professional');

            populateSelect(selectClient, adminDataCache.clientes, 'id', 'nome', "Selecione um cliente...");
            populateSelect(selectService, adminDataCache.servicos_e_tiers, 'id', 'nome', "Selecione um serviço...");
            populateSelect(selectProfessional, adminDataCache.profissionais, 'id', 'nome', "Selecione um profissional...");

            // --- Preenche o formulário com os dados do agendamento ---
            
            // Simples
            document.getElementById('event-edit-status').value = eventData.status;
            document.getElementById('event-edit-payment').value = eventData.status_pagamento;
            document.getElementById('event-edit-notes').value = eventData.observacoes;
            
            // Data e Hora
            document.getElementById('event-edit-date').value = start.toISOString().split('T')[0];
            document.getElementById('event-edit-time').value = start.toTimeString().substring(0, 5);
            
            
            // --- INÍCIO DA CORREÇÃO (Lógica de pré-seleção) ---
            
            // Cliente (continua adivinhando pelo nome, como antes)
            const cliente = adminDataCache.clientes.find(c => c.nome === eventData.cliente);
            if(cliente) selectClient.value = cliente.id;

            // Serviço (USA O ID CORRETO enviado pela API)
            if (eventData.servico_tier_id) {
                selectService.value = eventData.servico_tier_id; // Ex: "tier_5" ou "service_1"
                
                // Filtra profissionais baseado no serviço selecionado
                filterProfissionaisPorServico(selectService, selectProfessional);
            }
            
            // Profissional (Ainda não temos o ID do profissional no extendedProps,
            // então esta parte continua sem pré-seleção.)
            
            // --- FIM DA CORREÇÃO ---
            
            // Abre o modal
            eventModal.classList.remove('hidden');
        }

        /**
         * (Handler) Chamado ao arrastar e soltar um evento
         * @param {object} dropInfo - Informações do evento e da nova data/hora
         */
        function handleEventDrop(dropInfo) {
            const newStart = dropInfo.event.start;
            const formattedDate = newStart.toLocaleDateString('pt-BR');
            const formattedTime = newStart.toTimeString().substring(0, 5);

                // Salva a mudança no backend
                saveEventDrop(dropInfo.event);

        }


        // --- FUNÇÕES DE SALVAMENTO (API CALLS) ---

        /**
         * Salva as alterações de um agendamento (Modal de Edição)
         */
        async function saveUpdatedAppointment() {
            const payload = {
                cliente_id: document.getElementById('event-edit-client').value,
                servico_tier_id: document.getElementById('event-edit-service').value,
                profissional_id: document.getElementById('event-edit-professional').value,
                data: document.getElementById('event-edit-date').value,
                horario: document.getElementById('event-edit-time').value,
                status: document.getElementById('event-edit-status').value,
                status_pagamento: document.getElementById('event-edit-payment').value,
                observacoes: document.getElementById('event-edit-notes').value,
            };

            // Validação simples
            if (!payload.cliente_id || !payload.servico_tier_id || !payload.profissional_id || !payload.data || !payload.horario) {
                alert("Por favor, preencha todos os campos (Cliente, Serviço, Profissional, Data e Hora).");
                return;
            }

            try {
                const response = await fetch(`/api/admin/atualizar-agendamento/${currentEditingEventId}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                eventModal.classList.add('hidden');
                calendar.refetchEvents(); // Recarrega os eventos no calendário
            } catch (error) {
                alert(`Erro ao atualizar: ${error.message}`);
            }
        }
        
        /**
         * Deleta um agendamento (Modal de Edição)
         */
        async function deleteAppointment() {
            
            try {
                const response = await fetch(`/api/admin/deletar-agendamento/${currentEditingEventId}/`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                eventModal.classList.add('hidden');
                calendar.refetchEvents(); // Recarrega os eventos
            } catch (error) {
                alert(`Erro ao excluir: ${error.message}`);
            }
        }

        /**
         * Salva o novo agendamento (Modal de Criação)
         * @param {Event} e - Evento de submit do formulário
         */
        async function saveNewAppointment(e) {
            e.preventDefault();
            
            const payload = {
                // Cliente (Depende da aba selecionada)
                cliente_id: 'existing', // (será sobrescrito)
                
                // Dados do Agendamento
                servico_tier_id: document.getElementById('new-event-service').value,
                profissional_id: document.getElementById('new-event-professional').value,
                data: document.getElementById('new-event-date').value,
                horario: document.getElementById('new-event-time').value,
                observacoes: document.getElementById('new-event-notes').value,
            };

            // Lógica do Cliente
            const isNewClient = document.getElementById('panel-new-client').classList.contains('hidden') === false;
            
            if (isNewClient) {
                payload.cliente_id = 'new';
                payload.novo_cliente_nome = document.getElementById('new-client-nome').value;
                payload.novo_cliente_sobrenome = document.getElementById('new-client-sobrenome').value;
                payload.novo_cliente_telefone = document.getElementById('new-client-telefone').value.replace(/\D/g, '');
                payload.novo_cliente_nascimento = document.getElementById('new-client-nascimento').value;
                payload.novo_cliente_email = document.getElementById('new-client-email').value;
                
                if (!payload.novo_cliente_nome || !payload.novo_cliente_telefone || !payload.novo_cliente_nascimento || !payload.novo_cliente_email) {
                    alert("Para novos clientes, todos os campos são obrigatórios.");
                    return;
                }
            } else {
                payload.cliente_id = document.getElementById('new-event-client').value;
                if (!payload.cliente_id) {
                    alert("Por favor, selecione um cliente existente.");
                    return;
                }
            }

            // Validação final
             if (!payload.servico_tier_id || !payload.profissional_id) {
                alert("Por favor, selecione o serviço e o profissional.");
                return;
            }

            try {
                const response = await fetch('/api/admin/criar-agendamento/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                newEventModal.classList.add('hidden');
                calendar.refetchEvents(); // Recarrega os eventos
                
                // Se criamos um cliente novo, recarrega o cache de dados
                if (isNewClient) {
                    await loadAdminFormData();
                }

            } catch (error) {
                alert(`Erro ao criar agendamento: ${error.message}`);
            }
        }

        /**
         * Salva a nova data/hora de um evento (Drag-and-Drop)
         * @param {object} event - O objeto do evento do FullCalendar
         */
        async function saveEventDrop(event) {
            const payload = {
                start_iso: event.start.toISOString() // Envia a data/hora completa
            };
            
            try {
                const response = await fetch(`/api/admin/atualizar-horario-agendamento/${event.id}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (!response.ok) throw new Error(result.message);

                alert(result.message);
                calendar.refetchEvents(); // Recarrega (para garantir consistência)
            } catch (error) {
                alert(`Erro ao remanejar: ${error.message}`);
                event.revert(); // Desfaz a mudança visual no calendário
            }
        }

        // --- LISTENERS DE INICIALIZAÇÃO E MODAIS ---
        
        // Botões de visualização do calendário
        document.getElementById('btn-month').addEventListener('click', () => calendar.changeView('dayGridMonth'));
        document.getElementById('btn-week').addEventListener('click', () => calendar.changeView('timeGridWeek'));
        document.getElementById('btn-day').addEventListener('click', () => calendar.changeView('timeGridDay'));

        // Botão "Novo Agendamento" (fora do calendário)
        document.getElementById('btn-new-appointment').addEventListener('click', () => {
             // Simula um clique no dia de hoje
            const todayStr = new Date().toISOString().split('T')[0];
            handleDateSelect({ startStr: todayStr });
        });

        // --- Listeners do Modal de EDIÇÃO ---
        document.getElementById('event-modal-close').addEventListener('click', () => eventModal.classList.add('hidden'));
        document.getElementById('event-modal-cancel').addEventListener('click', () => eventModal.classList.add('hidden'));
        document.getElementById('event-modal-save').addEventListener('click', saveUpdatedAppointment);
        document.getElementById('event-modal-delete').addEventListener('click', deleteAppointment);
        document.getElementById('event-edit-service').addEventListener('change', (e) => {
             filterProfissionaisPorServico(e.target, document.getElementById('event-edit-professional'));
        });


        // --- Listeners do Modal de CRIAÇÃO ---
        document.getElementById('new-event-form').addEventListener('submit', saveNewAppointment);
        document.getElementById('new-event-modal-close').addEventListener('click', () => newEventModal.classList.add('hidden'));
        document.getElementById('new-event-modal-cancel').addEventListener('click', () => newEventModal.classList.add('hidden'));
        
        // Filtro de profissional no modal de criação
        document.getElementById('new-event-service').addEventListener('change', (e) => {
             filterProfissionaisPorServico(e.target, document.getElementById('new-event-professional'));
        });

        // Abas do modal de criação (Novo Cliente / Cliente Existente)
        document.querySelectorAll('#new-event-modal .form-toggle .toggle-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const toggle = e.target.closest('.form-toggle');
                const panelContainer = e.target.closest('.modal-body');
                
                // Botões
                toggle.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                
                // Painéis
                const targetPanelId = `panel-${e.target.dataset.tab}`;
                panelContainer.querySelectorAll('.form-tab-panel').forEach(p => p.classList.add('hidden'));
                document.getElementById(targetPanelId).classList.remove('hidden');

                // Animação do toggle
                toggle.classList.toggle('toggle-right', e.target.dataset.tab === 'new-client');
                
                // Gerencia 'required'
                const isNewClient = e.target.dataset.tab === 'new-client';
                document.getElementById('new-event-client').required = !isNewClient;
                document.getElementById('new-client-nome').required = isNewClient;
                document.getElementById('new-client-telefone').required = isNewClient;
                document.getElementById('new-client-nascimento').required = isNewClient;
                document.getElementById('new-client-email').required = isNewClient;
            });
        });

        // --- CARREGAMENTO INICIAL ---
        await loadAdminFormData(); // Carrega os dados (clientes, etc.)
        initializeCalendar();    // Inicia o calendário
        
    });
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\financeiro.html

<!-- templates/agendamentos/dashboard/financeiro.html -->
{% extends 'agendamentos/dashboard/base.html' %}

{% block dashboard_content %}
<h1>Gestão Financeira</h1>

<div class="dashboard-tabs">
    <button class="tab-btn active" data-tab="overview">Visão Geral</button>
    <button class="tab-btn" data-tab="income">Receitas</button>
    <button class="tab-btn" data-tab="expenses">Despesas</button>
</div>

<div class="tab-content" id="tab-overview">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Resumo Financeiro</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <div class="period-selector">
                    <label>Período:</label>
                    <select id="overview-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                
                <div id="custom-period" class="custom-period hidden">
                    <div class="form-row">
                        <input type="date" id="overview-start" class="form-control">
                        <span>até</span>
                        <input type="date" id="overview-end" class="form-control">
                        <button id="overview-apply" class="btn btn--primary btn--sm">Aplicar</button>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Receita Total</div>
                    <div class="stat-value" id="total-income">R$ 0,00</div>
                    <div class="stat-description">Pagamentos recebidos</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Despesas</div>
                    <div class="stat-value" id="total-expenses">R$ 0,00</div>
                    <div class="stat-description">Total de gastos no período</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Lucro</div>
                    <div class="stat-value" id="total-profit">R$ 0,00</div>
                    <div class="stat-description">Receita - Despesas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Pendente</div>
                    <div class="stat-value" id="pending-income">R$ 0,00</div>
                    <div class="stat-description">Pagamentos a receber</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="financial-overview-chart"></canvas>
            </div>
            
            <div class="summary-table">
                <h4>Resumo de Serviços</h4>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Serviço</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="services-summary">
                            <tr>
                                <td colspan="3">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-income">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Gestão de Receitas</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <div class="period-selector">
                    <label>Período:</label>
                    <select id="income-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                
                <div id="income-custom-period" class="custom-period hidden">
                    <div class="form-row">
                        <input type="date" id="income-start" class="form-control">
                        <span>até</span>
                        <input type="date" id="income-end" class="form-control">
                        <button id="income-apply" class="btn btn--primary btn--sm">Aplicar</button>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="income-chart"></canvas>
            </div>
            
            <h4>Pagamentos Recebidos</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="income-table">
                        <tr>
                            <td colspan="5">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h4>Pagamentos Pendentes</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="pending-table">
                        <tr>
                            <td colspan="5">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-expenses">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Gestão de Despesas</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <button id="btn-add-expense" class="btn btn--primary">Nova Despesa</button>
                
                <div class="filters">
                    <select id="expense-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    
                    <select id="expense-category" class="form-control">
                        <option value="">Todas as Categorias</option>
                        <option value="Aluguel">Aluguel</option>
                        <option value="Materiais">Materiais</option>
                        <option value="Serviços">Serviços</option>
                        <option value="Impostos">Impostos</option>
                        <option value="Salários">Salários</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="expenses-chart"></canvas>
            </div>
            
            <div class="summary-table">
                <h4>Resumo por Categoria</h4>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-summary">
                            <tr>
                                <td colspan="3">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <h4>Lista de Despesas</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table">
                        <tr>
                            <td colspan="6">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Despesa -->
<div id="expense-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="expense-modal-title">Registrar Nova Despesa</h3>
            <button id="expense-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label" for="expense-description">Descrição</label>
                    <input type="text" class="form-control" id="expense-description" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-amount">Valor (R$)</label>
                    <input type="number" class="form-control" id="expense-amount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-date">Data</label>
                    <input type="date" class="form-control" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-category-select">Categoria</label>
                    <select class="form-control" id="expense-category-select" required>
                        <option value="">Selecione...</option>
                        <option value="Aluguel">Aluguel</option>
                        <option value="Materiais">Materiais</option>
                        <option value="Serviços">Serviços</option>
                        <option value="Impostos">Impostos</option>
                        <option value="Salários">Salários</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox">
                        <input type="checkbox" id="expense-paid">
                        <label for="expense-paid">Despesa já paga</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="expense-modal-cancel" class="btn btn--outline">Cancelar</button>
            <button id="expense-modal-save" class="btn btn--primary">Salvar Despesa</button>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<style>
    /* Adiciona um estilo para o botão de excluir */
    .btn--danger-outline {
        color: var(--color-danger);
        border-color: var(--color-danger);
    }
    .btn--danger-outline:hover {
        background-color: var(--color-danger-light);
        color: var(--color-danger);
    }
</style>
<script>
    // =================================================================
    // INÍCIO: Conteúdo movido do static/js/financial.js 
    // =================================================================

    /**
     * Mark an expense as paid
     * @param {number} expenseId - The ID of the expense to mark as paid
     */
    window.markExpenseAsPaid = async function(expenseId) {
        
        try {
            const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    pago: true
                })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Despesa marcada como paga com sucesso!');
                // Recarrega os dados (agora as funções estão no escopo)
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao atualizar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao marcar despesa como paga:', error);
            alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
        }
    };

    /**
     * Edit an expense
     * @param {number} expenseId - The ID of the expense to edit
     */
    window.editExpense = async function(expenseId) {
        try {
            // Fetch expense details
            const response = await fetch(`/api/admin/despesa/${expenseId}/`);
            const expense = await response.json();
            
            if (!expense || expense.status === 'error') {
                throw new Error(expense.message || 'Não foi possível obter os detalhes da despesa.');
            }
            
            // Populate modal with expense data
            document.getElementById('expense-description').value = expense.descricao;
            document.getElementById('expense-amount').value = expense.valor;
            document.getElementById('expense-date').value = expense.data;
            document.getElementById('expense-category-select').value = expense.categoria;
            document.getElementById('expense-paid').checked = expense.pago;
            // Store expense ID in the form for reference
            document.getElementById('expense-form').dataset.expenseId = expenseId;
            document.getElementById('expense-modal-title').textContent = 'Editar Despesa';
            
            // Update save button to handle edit vs. new
            const saveButton = document.getElementById('expense-modal-save');
            saveButton.textContent = 'Atualizar Despesa';
            saveButton.onclick = updateExpense; // <--- APONTA PARA A FUNÇÃO DE ATUALIZAR
            
            // Show modal
            document.getElementById('expense-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Erro ao carregar dados da despesa:', error);
            alert('Erro ao carregar dados da despesa. Verifique o console para mais detalhes.');
        }
    };

    // =================================================================
    // NOVA FUNÇÃO: DELETAR DESPESA
    // =================================================================
    /**
     * Deletes an expense
     * @param {number} expenseId - The ID of the expense to delete
     */
    window.deleteExpense = async function(expenseId) {
        
        try {
            const response = await fetch(`/api/admin/deletar-despesa/${expenseId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert(data.message); // 'Despesa excluída com sucesso'
                // Recarrega os dados
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao excluir despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao excluir despesa:', error);
            alert('Erro ao excluir despesa. Verifique o console para mais detalhes.');
        }
    };
    // =================================================================
    // FIM DA NOVA FUNÇÃO
    // =================================================================

    /**
     * Update an existing expense
     */
    async function updateExpense() {
        const expenseId = document.getElementById('expense-form').dataset.expenseId;
        if (!expenseId) return;

        const description = document.getElementById('expense-description').value;
        const amount = document.getElementById('expense-amount').value;
        const date = document.getElementById('expense-date').value;
        const category = document.getElementById('expense-category-select').value;
        const paid = document.getElementById('expense-paid').checked;

        if (!description || !amount || !date || !category) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    descricao: description,
                    valor: parseFloat(amount),
                    data: date,
                    categoria: category,
                    pago: paid
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Despesa atualizada com sucesso!');
                document.getElementById('expense-modal').classList.add('hidden');
                
                // CORREÇÃO: Estas funções agora estão no mesmo escopo e serão encontradas
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao atualizar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao atualizar despesa:', error);
            // Este alerta não será mais chamado por ReferenceError
            alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
        }
    }

    /**
     * Reset the expense form for a new expense
     */
    window.resetExpenseForm = function() {
        const form = document.getElementById('expense-form');
        form.reset();
        delete form.dataset.expenseId;
        
        document.getElementById('expense-date').valueAsDate = new Date();
        document.getElementById('expense-modal-title').textContent = 'Registrar Nova Despesa';
        
        const saveButton = document.getElementById('expense-modal-save');
        saveButton.textContent = 'Salvar Despesa';
        saveButton.onclick = saveNewExpense; // <--- APONTA PARA A FUNÇÃO DE SALVAR NOVO
        
        document.getElementById('expense-modal').classList.remove('hidden');
    };

    /**
     * Save a new expense
     */
    async function saveNewExpense() {
        const description = document.getElementById('expense-description').value;
        const amount = document.getElementById('expense-amount').value;
        const date = document.getElementById('expense-date').value;
        const category = document.getElementById('expense-category-select').value;
        const paid = document.getElementById('expense-paid').checked;

        if (!description || !amount || !date || !category) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        try {
            const response = await fetch('/api/admin/registrar-despesa/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    descricao: description,
                    valor: parseFloat(amount),
                    data: date,
                    categoria: category,
                    pago: paid
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                alert('Despesa registrada com sucesso!');
                document.getElementById('expense-modal').classList.add('hidden');
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao registrar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao registrar despesa:', error);
            alert('Erro ao registrar despesa. Verifique o console para mais detalhes.');
        }
    }

    /**
     * Generate payment status select with the appropriate status selected
     * @param {string} status - Current payment status
     * @returns {string} - HTML for the select element
     */
    function generatePaymentStatusSelect(status, id) {
        return `
            <select class="form-control payment-status-select" data-appointment-id="${id}">
                <option value="Aguardando Pagamento" ${status === 'Aguardando Pagamento' ? 'selected' : ''}>Aguardando Pagamento</option>
                <option value="Pendente" ${status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                <option value="Adiantamento Realizado" ${status === 'Adiantamento Realizado' ? 'selected' : ''}>Adiantamento Realizado</option>
                <option value="Pago" ${status === 'Pago' ? 'selected' : ''}>Pago</option> <option value="Cancelado" ${status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
        `;
    }

    /**
     * Update an appointment's payment status
     * @param {number} appointmentId - The appointment ID
     * @param {string} status - The new payment status
     */
    async function updateAppointmentPaymentStatus(appointmentId, status) {
        try {
            const response = await fetch(`/api/admin/atualizar-pagamento/${appointmentId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status_pagamento: status
                })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Status de pagamento atualizado com sucesso!');
                // Reload financial data
                if (typeof loadIncomeData === 'function') {
                    loadIncomeData();
                }
                if (typeof loadFinancialOverview === 'function') {
                    loadFinancialOverview();
                }
            } else {
                alert('Erro ao atualizar status de pagamento: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao atualizar status de pagamento:', error);
            alert('Erro ao atualizar status de pagamento. Verifique o console para mais detalhes.');
        }
    }
    
    // =================================================================
    // FIM: Conteúdo movido do static/js/financial.js
    // =================================================================


    // =================================================================
    // INÍCIO: Script original da página (financeiro.html) 
    // =================================================================
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: { display: true, color: '#EDF2F7', drawBorder: false },
                ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
            }
        },
        plugins: {
            legend: {
                display: false,
            },
            tooltip: {
                enabled: true,
                backgroundColor: '#1A202C',
                titleFont: { family: "'Inter', sans-serif", size: 14 },
                bodyFont: { family: "'Inter', sans-serif", size: 12 },
                padding: 12,
                cornerRadius: 8
            }
        }
    };

    // =================================================================
    // MUDANÇA AQUI: As definições das funções foram movidas para fora do DOMContentLoaded
    // =================================================================

    function loadFinancialOverview() {
        const period = document.getElementById('overview-period').value;
        let url = `/api/admin/resumo-financeiro/?periodo=${period}`;
        if (period === 'custom') {
            url += `&inicio=${document.getElementById('overview-start').value}&fim=${document.getElementById('overview-end').value}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // (O conteúdo desta função permanece o mesmo)
                // Atualizar estatísticas
                document.getElementById('total-income').textContent = `R$ ${data.financeiro.faturamento.toFixed(2)}`;
                document.getElementById('total-expenses').textContent = `R$ ${data.financeiro.despesas.toFixed(2)}`;
                document.getElementById('total-profit').textContent = `R$ ${data.financeiro.lucro.toFixed(2)}`;
                document.getElementById('pending-income').textContent = `R$ ${data.financeiro.faturamento_pendente.toFixed(2)}`;
                
                const profitElement = document.getElementById('total-profit');
                profitElement.classList.toggle('stat-positive', data.financeiro.lucro >= 0);
                profitElement.classList.toggle('stat-negative', data.financeiro.lucro < 0);
                
                // --- Gráfico de Visão Geral (Estilizado) ---
                const ctx = document.getElementById('financial-overview-chart').getContext('2d');
                if (window.overviewChart) { window.overviewChart.destroy(); }
                
                const lucroValor = data.financeiro.lucro;
                const lucroBG = lucroValor >= 0 ? 'rgba(56, 161, 105, 0.7)' : 'rgba(255, 90, 95, 0.7)';
                const lucroBorder = lucroValor >= 0 ? '#38A169' : '#FF5A5F';
                
                window.overviewChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Receita', 'Despesas', 'Lucro'],
                        datasets: [{
                            label: 'Valores em R$',
                            data: [data.financeiro.faturamento, data.financeiro.despesas, lucroValor],
                            backgroundColor: [
                                'rgba(13, 153, 255, 0.7)', // Azul
                                'rgba(255, 90, 95, 0.7)', // Vermelho
                                lucroBG
                            ],
                            borderColor: [
                                '#0D99FF',
                                '#FF5A5F',
                                lucroBorder
                            ],
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: { ...chartOptions }
                });

                // Tabela de resumo de serviços
                const tableBody = document.getElementById('services-summary');
                if (data.servicos_populares && data.servicos_populares.length > 0) {
                    tableBody.innerHTML = data.servicos_populares.map(servico => `
                        <tr>
                            <td>${servico.servico__nome}</td>
                            <td>${servico.total}</td>
                            <td>R$ ${(servico.total * (servico.preco || 0)).toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhum serviço no período.</td></tr>';
                }
            });
    }

    function loadIncomeData() {
        const period = document.getElementById('income-period').value;
        let baseUrl = `periodo=${period}`;
        if (period === 'custom') {
            baseUrl += `&inicio=${document.getElementById('income-start').value}&fim=${document.getElementById('income-end').value}`;
        }

        // (O conteúdo desta função permanece o mesmo)
        // --- Gráfico de Faturamento (Estilizado) ---
        fetch(`/api/admin/faturamento/?${baseUrl}&tipo=diario`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('income-chart').getContext('2d');
                if (window.incomeChart) { window.incomeChart.destroy(); }

                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(13, 153, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(13, 153, 255, 0.05)');

                const labels = data.dados.map(item => new Date(item.data).toLocaleDateString('pt-BR'));
                const values = data.dados.map(item => item.total);

                window.incomeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Faturamento Diário (R$)',
                            data: values,
                            backgroundColor: gradient,
                            borderColor: 'rgba(13, 153, 255, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4, // Linha curva
                            pointBackgroundColor: 'rgba(13, 153, 255, 1)',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { ...chartOptions }
                });
            });
        
        // --- Tabelas de Pagamentos (Lógica mantida) ---
        fetch(`/api/admin/agendamentos-pagamento/?${baseUrl}`)
            .then(response => response.json())
            .then(data => {
                const pendingTable = document.getElementById('pending-table');
                if (data.pendentes && data.pendentes.length > 0) {
                    pendingTable.innerHTML = data.pendentes.map(apt => `
                        <tr>
                            <td>${new Date(apt.data).toLocaleDateString('pt-BR')}</td>
                            <td>${apt.cliente}</td>
                            <td>${apt.servico}</td>
                            <td>R$ ${apt.valor.toFixed(2)}</td>
                            <td>${generatePaymentStatusSelect(apt.status_pagamento, apt.id)}</td>
                        </tr>
                    `).join('');
                } else {
                    pendingTable.innerHTML = '<tr><td colspan="5">Nenhum pagamento pendente.</td></tr>';
                }
                
                const incomeTable = document.getElementById('income-table');
                if (data.pagos && data.pagos.length > 0) {
                    incomeTable.innerHTML = data.pagos.map(apt => `
                        <tr>
                            <td>${new Date(apt.data).toLocaleDateString('pt-BR')}</td>
                            <td>${apt.cliente}</td>
                            <td>${apt.servico}</td>
                            <td>R$ ${apt.valor.toFixed(2)}</td>
                            <td><span class="status status--success">${apt.status}</span></td>
                        </tr>
                    `).join('');
                } else {
                    incomeTable.innerHTML = '<tr><td colspan="5">Nenhum pagamento recebido.</td></tr>';
                }
            });
    }

    function loadExpensesData() {
        const period = document.getElementById('expense-period').value;
        const category = document.getElementById('expense-category').value;
        let url = `/api/admin/despesas/?periodo=${period}`;
        if (category) { url += `&categoria=${category}`; }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // (O conteúdo desta função permanece o mesmo)
                // --- Gráfico de Despesas (Estilizado) ---
                const ctx = document.getElementById('expenses-chart').getContext('2d');
                if (window.expensesChart) { window.expensesChart.destroy(); }
                
                const sortedCategories = data.resumo_categorias.sort((a, b) => b.total - a.total);
                const labels = sortedCategories.map(item => item.categoria);
                const values = sortedCategories.map(item => item.total);

                window.expensesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Despesas por Categoria (R$)',
                            data: values,
                            backgroundColor: [
                                'rgba(255, 90, 95, 0.7)',
                                'rgba(255, 149, 0, 0.7)',
                                'rgba(13, 153, 255, 0.7)',
                                'rgba(155, 89, 182, 0.7)',
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(56, 161, 105, 0.7)'
                            ],
                            borderWidth: 0,
                            borderRadius: 5
                        }]
                    },
                    options: { 
                        ...chartOptions,
                        indexAxis: 'y', // <-- Gráfico de barras horizontal
                    }
                });
                
                // --- Tabelas de Despesas (Lógica mantida) ---
                const expensesSummary = document.getElementById('expenses-summary');
                if (sortedCategories.length > 0) {
                    expensesSummary.innerHTML = sortedCategories.map(cat => `
                        <tr>
                            <td>${cat.categoria}</td>
                            <td>${cat.quantidade}</td>
                            <td>R$ ${cat.total.toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    expensesSummary.innerHTML = '<tr><td colspan="3">Sem despesas.</td></tr>';
                }

                const expensesTable = document.getElementById('expenses-table');
                if (data.despesas && data.despesas.length > 0) {
                    expensesTable.innerHTML = data.despesas.map(expense => `
                        <tr>
                            <td>${new Date(expense.data).toLocaleDateString('pt-BR')}</td>
                            <td>${expense.descricao}</td>
                            <td>${expense.categoria}</td>
                            <td>R$ ${expense.valor.toFixed(2)}</td>
                            <td><span class="status status--${expense.pago ? 'success' : 'warning'}">${expense.pago ? 'Pago' : 'Pendente'}</span></td>
                            
                            <td style="display: flex; gap: 8px;">
                                <button class="btn btn--sm btn--outline" onclick="editExpense(${expense.id})">Editar</button>
                                <button class="btn btn--sm btn--danger-outline" onclick="deleteExpense(${expense.id})">Excluir</button>
                            </td>
                            </tr>
                    `).join('');
                } else {
                    expensesTable.innerHTML = '<tr><td colspan="6">Nenhuma despesa no período.</td></tr>';
                }
            });
    }

    // =================================================================
    // FIM DA SEÇÃO MOVIDA
    // =================================================================


    document.addEventListener('DOMContentLoaded', function() {
        // --- Configurações Globais dos Gráficos ---

        // --- Tabs ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                tabBtns.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                this.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'overview') { loadFinancialOverview(); }
                else if (tab === 'income') { loadIncomeData(); }
                else if (tab === 'expenses') { loadExpensesData(); }
            });
        });

        // --- Seletores de Período ---
        const periodSelectors = ['overview-period', 'income-period', 'expense-period'];
        periodSelectors.forEach(selector => {
            const el = document.getElementById(selector);
            if (el) {
                el.addEventListener('change', function() {
                    const customPeriodId = selector === 'overview-period' ? 'custom-period' : 
                                          selector === 'income-period' ? 'income-custom-period' : null;
                    
                    if (customPeriodId && this.value === 'custom') {
                        document.getElementById(customPeriodId).classList.remove('hidden');
                    } else if (customPeriodId) {
                        document.getElementById(customPeriodId).classList.add('hidden');
                        if (selector === 'overview-period') { loadFinancialOverview(); }
                        else if (selector === 'income-period') { loadIncomeData(); }
                        else if (selector === 'expense-period') { loadExpensesData(); }
                    }
                    // CORREÇÃO: Adicionamos o 'else' para recarregar quando não for 'custom'
                    else {
                        if (selector === 'overview-period') { loadFinancialOverview(); }
                        else if (selector === 'income-period') { loadIncomeData(); }
                        else if (selector === 'expense-period') { loadExpensesData(); }
                    }
                });
            }
        });
        document.getElementById('overview-apply')?.addEventListener('click', loadFinancialOverview);
        document.getElementById('income-apply')?.addEventListener('click', loadIncomeData);
        document.getElementById('expense-category')?.addEventListener('change', loadExpensesData);
        
        // --- Modal de Despesas ---
        document.getElementById('btn-add-expense')?.addEventListener('click', resetExpenseForm);
        document.getElementById('expense-modal-close')?.addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
        document.getElementById('expense-modal-cancel')?.addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
        // CORREÇÃO: O botão salvar deve chamar 'saveNewExpense' por padrão
        document.getElementById('expense-modal-save').onclick = saveNewExpense;

        // --- Carregamento Inicial ---
        loadFinancialOverview();
        
        // --- Handlers de Eventos do financial.js (que agora estão aqui) ---
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('payment-status-select')) {
                updateAppointmentPaymentStatus(e.target.dataset.appointmentId, e.target.value);
            }
        });
    });
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\gestao.html

{% extends 'agendamentos/dashboard/base.html' %}
{% load static %}

{% block dashboard_content %}
<h1>Gestão do Negócio</h1>

<div class="dashboard-tabs">
    <button class="tab-btn active" data-tab="categorias">Categorias</button>
    <button class="tab-btn" data-tab="servicos">Serviços</button>
    <button class="tab-btn" data-tab="equipe">Equipe</button>
    <button class="tab-btn" data-tab="horarios">Meus Horários</button>
    <button class="tab-btn" data-tab="avisos">Mural de Avisos</button>
    <button class="tab-btn" data-tab="configuracoes">Configurações</button>
</div>

<div class="tab-content" id="tab-categorias">
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Categorias de Serviços
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">Gerencie as categorias (ex: Cílios, Unhas) para agrupar serviços e manutenções.</p>
            
            <form id="form-add-categoria" class="form-add-lista mb-4">
                <input type="text" class="form-control" id="categoria-nome-input" placeholder="Nome da nova categoria" required>
                <button type="submit" class="btn btn--primary btn--sm">Adicionar</button>
            </form>
            
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome da Categoria</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="categorias-lista-tbody">
                        <tr><td colspan="2">Carregando categorias...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-servicos">
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Meus Serviços
            <button id="btn-novo-servico" class="btn btn--primary btn--sm">Novo Serviço</button>
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">Adicione, edite ou remova os serviços oferecidos pelo seu negócio.</p>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Categoria</th>
                            <th>Preço</th>
                            <th>Duração</th>
                            <th>Profissionais</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="servicos-lista-tbody">
                        <tr><td colspan="6">Carregando serviços...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-equipe">
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Minha Equipe
            <button id="btn-convidar-membro" class="btn btn--primary btn--sm">Convidar Membro</button>
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">Gerencie quem pode acessar este dashboard e executar serviços.</p>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Email</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="equipe-lista-tbody">
                        <tr><td colspan="3">Carregando equipe...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-horarios">
    
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Meus Horários de Trabalho
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">
                Defina seus blocos de trabalho para cada dia da semana. O sistema usará esses horários para calcular sua disponibilidade.
            </p>
            <div id="horarios-semana-container">
                </div>
        </div>
    </div> <div class="dashboard-card" style="margin-top: 1.5rem;">
        <div class="dashboard-card-title">
            Folgas e Dias Bloqueados
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">
                Adicione dias específicos que você não irá trabalhar (feriados, férias, etc.). Isso irá sobrepor seus horários recorrentes.
            </p>
            <form id="form-add-bloqueio" class="form-add-lista">
                <input type="date" class="form-control" id="bloqueio-data" style="width: 150px;" required>
                <input type="text" class="form-control" id="bloqueio-descricao" placeholder="Descrição (ex: Feriado)">
                <button type="submit" class="btn btn--primary btn--sm">Bloquear Dia</button>
            </form>
            <div id="lista-dias-bloqueados" class="lista-preview" style="margin-top: 1rem;">
                <p>Carregando bloqueios...</p>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-configuracoes">
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Configurações da Marca
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">
                Personalize o nome, a tagline e as cores do seu site de agendamento.
            </p>
            
            <form id="config-form">
            
                <div class="form-group">
                    <label class="form-label" for="config-nome-negocio">Nome do Negócio (Texto do Logo)</label>
                    <input type="text" class="form-control" id="config-nome-negocio" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Logo Atual</label>
                                <div id="logo-preview-container" class="mt-4" style="display: block;">
                        <img id="logo-preview" alt="Preview" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 1px solid var(--color-border);">
                    </div>
                                <input type="file" id="config-logo-input" accept="image/png, image/jpeg, image/webp" style="display: none;">
                                     <button type="button" id="btn-change-logo" class="btn btn--outline btn--sm" style="margin-top: 1rem;">
                        Alterar Imagem
                    </button>
                                <button type="button" id="btn-revert-logo" class="btn btn--outline btn--sm" style="margin-top: 1rem; margin-left: 8px; display: none;">
                        Desfazer
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label" for="config-tagline">Tagline (Frase abaixo do logo)</label>
                    <input type="text" class="form-control" id="config-tagline">
                </div>

                <div class="form-group">
                    <label class="form-label" for="config-portfolio-url">Link do Portfólio Externo</label>
                    <input type="url" class="form-control" id="config-portfolio-url" placeholder="https://www.canva.com/seu-link...">
                    <small class="form-text">Cole aqui o link do seu portfólio (Canva, site, etc.). Ele será exibido em um modal no seu site.</small>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="config-cor-primaria">Cor Primária</label>
                                        <input type="text" class="form-control" id="config-cor-primaria" data-coloris>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="config-cor-secundaria">Cor Secundária</label>
                                        <input type="text" class="form-control" id="config-cor-secundaria" data-coloris>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="config-dias-antecedencia">Janela de Agendamento (em dias)</label>
                    <input type="number" class="form-control" id="config-dias-antecedencia" min="1" max="365">
                    <small class="form-text">Por quantos dias no futuro os clientes podem agendar? (Ex: 60 dias)</small>
                </div>

                <div class="form-group">
                    <label class="form-label" for="config-pagamento-online">Pagamentos Online (Pix)</label>
                    <div class="toggle-switch">
                        <input type="checkbox" id="config-pagamento-online">
                        <label for="config-pagamento-online" class="slider"></label>
                    </div>
                    <small class="form-text">Habilita a cobrança de adiantamento via Pix no agendamento do cliente.</small>
                </div>
                
                <div class="modal-footer" style="padding: 0; margin-top: 1.5rem;">
                    <button type="submit" id="config-save" class="btn btn--primary">Salvar Configurações</button>
                </div>   
            </form>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-avisos">
    <div class="dashboard-card">
        <div class="dashboard-card-title">
            Mural de Avisos
            <button id="btn-novo-aviso" class="btn btn--primary btn--sm">Novo Aviso</button>
        </div>
        <div class="dashboard-card-body">
            <p class="text-secondary mb-4">
                Crie e gerencie os avisos que seus clientes verão antes de agendar.
            </p>
            <div id="avisos-lista-container">
                <p>Carregando avisos...</p>
            </div>
        </div>
    </div>
</div>

<div id="aviso-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="aviso-modal-title">Novo Aviso</h3>
            <button id="aviso-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="aviso-form">
            <input type="hidden" id="aviso-id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="aviso-titulo">Título do Aviso</label>
                    <input type="text" class="form-control" id="aviso-titulo" required placeholder="Ex: Política de Cancelamento">
                </div>
                <div class="form-group">
                    <label class="form-label" for="aviso-conteudo">Conteúdo do Aviso</label>
                                        <textarea class="form-control" id="aviso-conteudo" rows="7" 
                              placeholder="Digite seu aviso aqui.&#10;Para criar uma lista, basta pular uma linha.&#10;&#10;Exemplo:&#10;Item 1&#10;Item 2&#10;Item 3"></textarea>
                                       <small class="form-text">Para criar uma lista, basta pular uma linha para cada item.</small>
                </div>
                <div class="form-group">
                    <label class="form-label" for="aviso-ordem">Ordem (0 aparece primeiro)</label>
                    <input type="number" class="form-control" id="aviso-ordem" value="0">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="aviso-modal-delete" class="btn btn--outline" style="color: #FF5A5F; border-color: #FF5A5F; margin-right: auto;">Excluir</button>
                <button type="button" id="aviso-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" id="aviso-modal-save" class="btn btn--primary">Salvar</button>
            </div>
        </form>
    </div>
</div>



<style>
    .aviso-card {
        background: var(--color-light-gray);
        border-radius: var(--radius-base);
        padding: var(--space-16);
        margin-bottom: var(--space-16);
    }
    .aviso-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid var(--color-medium-gray);
        padding-bottom: var(--space-12);
        margin-bottom: var(--space-12);
    }
    .aviso-card-header h4 {
        margin: 0;
    }
    .aviso-card-body ul {
        margin: 0;
        padding-left: var(--space-20);
    }
</style>

<style>
    .dia-semana-bloco {
        margin-bottom: 2rem;
        border-bottom: 1px solid var(--color-light-gray);
        padding-bottom: 1.5rem;
    }
    .dia-semana-bloco h4 {
        font-size: 1.25rem;
        margin-bottom: 1rem;
    }
    .horario-slot-lista {
        list-style: none;
        padding: 0;
        margin-bottom: 1rem;
    }
    .horario-slot-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: var(--color-light-gray);
        padding: 0.75rem 1rem;
        border-radius: var(--radius-base);
        margin-bottom: 0.5rem;
        font-weight: 500;
    }
    .horario-slot-item button {
        background: none;
        border: none;
        color: var(--color-red);
        font-size: 1.25rem;
        cursor: pointer;
        opacity: 0.7;
        transition: opacity 0.2s;
    }
    .horario-slot-item button:hover {
        opacity: 1;
    }
    .form-add-horario {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }
    .form-add-horario input[type="time"] {
        width: 100px;
        padding: 0.5rem;
    }
    .form-add-horario button {
        padding: 0.6rem 1rem;
    }
</style>


<div id="servico-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="servico-modal-title">Novo Serviço</h3>
            <button id="servico-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="servico-form">
            <input type="hidden" id="servico-id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="servico-nome">Nome do Serviço</label>
                    <input type="text" class="form-control" id="servico-nome" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="servico-preco">Preço (R$)</label>
                        <input type="number" class="form-control" id="servico-preco" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="servico-duracao">Duração (minutos)</label>
                        <input type="number" class="form-control" id="servico-duracao" step="15" min="0" required>
                    </div>
                    <div class="form-group form-group-percentual" style="display: none;"> <label class="form-label" for="servico-percentual">Adiantamento (%)</label>
                        <input type="number" class="form-control" id="servico-percentual" step="1" min="0" max="100" value="0">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="servico-descricao">Descrição</label>
                    <textarea class="form-control" id="servico-descricao" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Imagem do Serviço</label>
                    <input type="file" id="servico-imagem-input" accept="image/png, image/jpeg, image/webp" style="display: none;">

                    <div id="servico-preview-container" class="mt-4" style="display: block; width: 150px; height: 150px; overflow: hidden; border-radius: 50%; border: 1px solid var(--color-border);">
                        <img id="servico-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAASwAAACoCAMAAABt9SM9AAAAFVBMVEXe3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t49nE3IAAABGklEQVR42u3Y2w6DIAwEUBWChv7/l7sIIbFpZ/rQ3pnOvNYA8BwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAECc3Z99V/f41lBxLzL38x/3c5QkS93sQ0x1d3sA+8L1kE/v9sO9AF9KthpY9r87oAvJjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjoYWPb/u6APyY6GFjWf/ugP8kOxhY9v+7ow/IjseWE095mNnN59mfePZzcT0/oA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODf/QBt4ANrBw1qfAAAAABJRU5ErkJggg==" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>

                    <button type="button" id="btn-change-servico-img" class="btn btn--outline btn--sm" style="margin-top: 1rem;">
                        Alterar Imagem
                    </button>
                    <button type="button" id="btn-revert-servico-img" class="btn btn--outline btn--sm" style="margin-top: 1rem; margin-left: 8px; display: none;">
                        Desfazer
                    </button>
                </div>
                <div id="service-cropper-modal" class="modal-container hidden">
                    <div class="modal-content" style="max-width: 600px;">
                        <div class="modal-header">
                            <h3>Ajustar Imagem do Serviço</h3>
                        </div>
                        <div class="modal-body">
                            <p class="text-secondary mb-4">
                                Use o mouse (ou os dedos) para dar zoom e mover a imagem.
                            </p>
                            <div class="img-container" style="width: 100%; height: 400px; background: #f7f7f7;">
                                <img id="service-cropper-image" src="" alt="Imagem para cortar" style="display: block; max-width: 100%;">
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" id="service-cropper-cancel" class="btn btn--outline">Cancelar</button>
                            <button type="button" id="service-cropper-save" class="btn btn--primary">Salvar Corte</button>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="servico-categoria">Categoria</label>
                    <select id="servico-categoria" class="form-control">
                        <option value="">(Nenhuma)</option>
                        </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="servico-profissionais-flags">Profissionais que executam este serviço</label>
                    <div id="servico-profissionais-flags" class="flags-container">
                        </div>
                    </div>
                </div>
            <div class="modal-footer">
                <button type="button" id="servico-modal-delete" class="btn btn--outline" style="color: #FF5A5F; border-color: #FF5A5F; margin-right: auto;">Excluir</Vbutton>
                <button type="button" id="servico-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" id="servico-modal-save" class="btn btn--primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="categoria-modal" class="modal-container hidden">
    <div class="modal-content" style="max-width: 500px;">
        <div class="modal-header">
            <h3 id="categoria-modal-title">Editar Categoria</h3>
            <button id="categoria-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="categoria-edit-form">
            <input type="hidden" id="categoria-edit-id">
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label" for="categoria-edit-nome">Nome da Categoria</label>
                    <input type="text" class="form-control" id="categoria-edit-nome" required>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="categoria-modal-delete" class="btn btn--outline" style="color: #FF5A5F; border-color: #FF5A5F; margin-right: auto;">Excluir</button>
                <button type="button" id="categoria-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" class="btn btn--primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

<div id="equipe-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="equipe-modal-title">Convidar Novo Membro</h3>
            <button id="equipe-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="equipe-form">
            <div class="modal-body">
                <p class="text-secondary mb-4">
                    Você está criando uma nova conta de funcionário. Esta pessoa poderá acessar o dashboard e ser associada a serviços.
                </p>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="equipe-nome">Nome</label>
                        <input type="text" class="form-control" id="equipe-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="equipe-sobrenome">Sobrenome</label>
                        <input type="text" class="form-control" id="equipe-sobrenome">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="equipe-email">Email</label>
                    <input type="email" class="form-control" id="equipe-email" required>
                </div>
                 <div class="form-group">
                    <label class="form-label" for="equipe-telefone">Telefone (Opcional)</label>
                    <input type="tel" class="form-control" id="equipe-telefone">
                </div>
                <div class="form-group">
                    <label class="form-label" for="equipe-foto">Foto do Profissional (Opcional)</label>
                    <input type="file" class="form-control" id="equipe-foto" accept="image/png, image/jpeg, image/webp">
                </div>
                <div class="form-group">
                    <label class="form-label" for="equipe-password">Senha Inicial</label>
                    <input type="password" class="form-control" id="equipe-password" required>
                    <small class="form-text">Crie uma senha temporária. O membro poderá alterá-la depois.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="equipe-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" id="equipe-modal-save" class="btn btn--primary">Salvar e Convidar</button>
            </div>
        </form>
    </div>
</div>

<div id="equipe-edit-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="equipe-edit-modal-title">Editar Membro</h3>
            <button id="equipe-edit-modal-close" class="modal-close">&times;</button>
        </div>
        <form id="equipe-edit-form">
            <input type="hidden" id="equipe-edit-id">
            
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="equipe-edit-nome">Nome</label>
                        <input type="text" class="form-control" id="equipe-edit-nome" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="equipe-edit-sobrenome">Sobrenome</label>
                        <input type="text" class="form-control" id="equipe-edit-sobrenome">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="equipe-edit-email">Email (Não pode ser alterado)</label>
                    <input type="email" class="form-control" id="equipe-edit-email" readonly style="background-color: var(--color-gray-50);">
                </div>
                 <div class="form-group">
                    <label class="form-label" for="equipe-edit-telefone">Telefone</label>
                    <input type="tel" class="form-control" id="equipe-edit-telefone">
                </div>

                <div class="form-group">
                    <label class="form-label">Foto do Profissional</label>
                    <div id="equipe-edit-preview-container" class="mt-4" style="display: block; width: 100px; height: 100px; overflow: hidden; border-radius: 50%; border: 1px solid var(--color-border); margin-bottom: 1rem;">
                        <img id="equipe-edit-preview" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAMAAAAL3woPAAAAFVBMVEXe3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t49nE3IAAAAB3RSTlMAgICAgICA+b2dYwAAAUdJREFUeNrt29lqwzAQRcGqIAj//5c+ClqgImga6c2cE3sIqRSPbYIgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgG/uPzG3fbd/tzbZ8gJ2rln1Gq5yR6/hL6rLvyRPL0TveDqA6c6T61T5E6vY/sL7I6mBj2f7ujn8kOxpY9v+7ox/JjoYWPb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjseWE495nNnN59mfePZzcT0/oA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODf/QBt4ANrBw1qfAAAAABJRU5ErkJggg==" alt="Preview" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <input type="file" id="equipe-edit-foto-input" accept="image/png, image/jpeg, image/webp" style="display: none;">
                    <button type="button" id="btn-change-equipe-img" class="btn btn--outline btn--sm">
                        Alterar Foto
                    </button>
                    </div>

                <div class="form-group">
                    <label class="form-label" for="equipe-edit-password">Nova Senha (Opcional)</label>
                    <input type="password" class="form-control" id="equipe-edit-password" placeholder="Deixe em branco para não alterar">
                    <small class="form-text">Se preenchido, a senha do membro será redefinida.</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="equipe-edit-modal-delete" class="btn btn--outline" style="color: #FF5A5F; border-color: #FF5A5F; margin-right: auto;">Excluir Membro</button>
                <button type="button" id="equipe-edit-modal-cancel" class="btn btn--outline">Cancelar</button>
                <button type="submit" id="equipe-edit-modal-save" class="btn btn--primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div id="manutencao-modal" class="modal-container hidden">
    <div class="modal-content" style="max-width: 800px;">
        <div class="modal-header">
            <h3 id="manutencao-modal-title">Preços de Manutenção</h3>
            <button id="manutencao-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p class="text-secondary mb-4">
                Gerencie a manutenção para o serviço: <strong id="manutencao-servico-nome" style="color: var(--color-primary);"></strong>.
            </p>
            
            <form id="form-add-manutencao" class="form-add-manutencao" style="margin-bottom: 24px;">
                <div class="manutencao-form-grid">
                    <div class="form-group" style="flex: 2;">
                        <label class="form-label" for="manutencao-nome">Nome da manutenção</label>
                        <input type="text" class="form-control" id="manutencao-nome" placeholder="Ex: Manutenção 15 dias" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="manutencao-dias-min">Dias Min</label>
                        <input type="number" class="form-control" id="manutencao-dias-min" placeholder="Ex: 15" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="manutencao-dias-max">Dias Max</label>
                        <input type="number" class="form-control" id="manutencao-dias-max" placeholder="Ex: 20" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="manutencao-preco">Preço (R$)</label>
                        <input type="number" class="form-control" id="manutencao-preco" step="0.01" placeholder="Ex: 85.00" min="0" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="manutencao-duracao">Duração (min)</label>
                        <input type="number" class="form-control" id="manutencao-duracao" step="15" placeholder="Ex: 45" min="0" required>
                    </div>
                    <div class="form-group form-group-percentual" style="display: none;"> <label class="form-label" for="manutencao-percentual">Adiant. (%)</label>
                        <input type="number" class="form-control" id="manutencao-percentual" step="1" min="0" max="100" value="0">
                    </div>
                    <div class="form-group" style="align-self: flex-end;">
                        <button type="submit" class="btn btn--primary" style="width: 100%;">Adicionar</button>
                    </div>
                </div>
            </form>
            
            <div id="manutencao-lista" class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Nome do Tier</th>
                            <th>Dias Min</th>
                            <th>Dias Max</th>
                            <th>Preço</th>
                            <th>Duração</th>
                            <th class="col-percentual" style="display: none;">Adiant. (%)</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="manutencao-lista-tbody">
                        </tbody>
                </table>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="manutencao-modal-cancel" class="btn btn--outline">Fechar</button>
        </div>
    </div>
</div>

<div id="cropper-modal" class="modal-container hidden">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Ajustar Imagem da Logo</h3>
            </div>
        <div class="modal-body">
            <p class="text-secondary mb-4">
                Use o mouse (ou os dedos) para dar zoom e mover a imagem.
            </p>
            <div class_="img-container" style="width: 100%; height: 400px; background: #f7f7f7;">
                <img id="cropper-image" src="" alt="Imagem para cortar" style="display: block; max-width: 100%;">
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" id="cropper-cancel" class="btn btn--outline">Cancelar</button>
            <button type="button" id="cropper-save" class="btn btn--primary">Salvar Corte</button>
        </div>
    </div>
</div>

<style>
.form-add-manutencao .manutencao-form-grid {
    display: grid;
    /* Define 6 colunas, com a primeira sendo 2x maior */
    grid-template-columns: 2fr 1fr 1fr 1fr 1fr auto;
    gap: var(--space-12);
    align-items: flex-start;
}
.form-add-manutencao .form-group {
    margin-bottom: 0;
}

/* Deixa o layout responsivo */
@media (max-width: 992px) {
    .form-add-manutencao .manutencao-form-grid {
        /* Quebra em 3 colunas */
        grid-template-columns: 2fr 1fr 1fr;
    }
    .form-add-manutencao .form-group {
        margin-bottom: var(--space-12);
    }
}
@media (max-width: 768px) {
    .form-add-manutencao .manutencao-form-grid {
        /* Empilha tudo no mobile */
        grid-template-columns: 1fr;
    }
}
</style>
{% endblock %}

{% block dashboard_js %}
<script src="{% static 'js/gestao.js' %}"></script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\index.html

<!-- templates/agendamentos/dashboard/index.html -->
{% extends 'agendamentos/dashboard/base.html' %}

{% block dashboard_content %}
<h1>Dashboard</h1>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-title">Agendamentos Hoje</div>
        <div class="stat-value">{{ agendamentos_hoje }}</div>
        <div class="stat-description">Total de agendamentos para hoje</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-title">Agendamentos Pendentes</div>
        <div class="stat-value">{{ agendamentos_pendentes }}</div>
        <div class="stat-description">Agendamentos futuros confirmados</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-title">Pagamentos Pendentes</div>
        <div class="stat-value">{{ pagamentos_pendentes }}</div>
        <div class="stat-description">Clientes que ainda não pagaram</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-title">Faturamento do Mês</div>
        <div class="stat-value">R$ {{ faturamento_mes|floatformat:2 }}</div>
        <div class="stat-description">Total faturado neste mês</div>
    </div>
</div>

<div class="dashboard-grid">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Resumo Financeiro</div>
        <div class="dashboard-card-body">
            <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                <div>
                    <div style="color: var(--color-text-secondary); font-size: 0.875rem;">Faturamento</div>
                    <div style="font-size: 1.25rem; font-weight: var(--font-weight-bold);">R$ {{ faturamento_mes|floatformat:2 }}</div>
                </div>
                <div>
                    <div style="color: var(--color-text-secondary); font-size: 0.875rem;">Despesas</div>
                    <div style="font-size: 1.25rem; font-weight: var(--font-weight-bold);">R$ {{ despesas_mes|floatformat:2 }}</div>
                </div>
                <div>
                    <div style="color: var(--color-text-secondary); font-size: 0.875rem;">Lucro</div>
                    <div style="font-size: 1.25rem; font-weight: var(--font-weight-bold); color: {% if lucro_mes|add:0 >= 0 %}var(--color-mint-green){% else %}var(--color-red){% endif %};">
                        R$ {{ lucro_mes|floatformat:2 }}
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <canvas id="financialChart"></canvas>
            </div>
        </div>
    </div>
    
    <div class="dashboard-card">
        <div class="dashboard-card-title">Próximos Agendamentos</div>
        <div class="dashboard-card-body">
            <div id="upcoming-appointments">Carregando...</div>
        </div>
    </div>
</div>

<div class="dashboard-card">
    <div class="dashboard-card-title">Atividade Recente</div>
    <div class="dashboard-card-body">
        <div id="recent-activity">Carregando...</div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Gráfico Financeiro Estilizado ---
        const ctx = document.getElementById('financialChart').getContext('2d');
        
        // Criar gradiente
        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
        gradient.addColorStop(0, 'rgba(13, 153, 255, 0.5)'); // Azul
        gradient.addColorStop(1, 'rgba(13, 153, 255, 0.05)');

        // Gradiente de Despesa
        const gradientRed = ctx.createLinearGradient(0, 0, 0, 300);
        gradientRed.addColorStop(0, 'rgba(255, 90, 95, 0.5)');
        gradientRed.addColorStop(1, 'rgba(255, 90, 95, 0.05)');

        // Gradiente de Lucro
        const gradientGreen = ctx.createLinearGradient(0, 0, 0, 300);
        gradientGreen.addColorStop(0, 'rgba(56, 161, 105, 0.5)');
        gradientGreen.addColorStop(1, 'rgba(56, 161, 105, 0.05)');
        
        const lucroValor = {{ lucro_mes }};
        const lucroBackground = lucroValor >= 0 ? gradientGreen : gradientRed;
        const lucroBorder = lucroValor >= 0 ? 'rgba(56, 161, 105, 1)' : 'rgba(255, 90, 95, 1)';

        const financialChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Faturamento', 'Despesas', 'Lucro'],
                datasets: [{
                    label: 'Valores em R$',
                    data: [{{ faturamento_mes }}, {{ despesas_mes }}, lucroValor],
                    backgroundColor: [
                        gradient,
                        gradientRed,
                        lucroBackground
                    ],
                    borderColor: [
                        'rgba(13, 153, 255, 1)',
                        'rgba(255, 90, 95, 1)',
                        lucroBorder
                    ],
                    borderWidth: 2,
                    borderRadius: 5
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: {
                            display: true,
                            color: '#EDF2F7', // Cor da grade suave
                            drawBorder: false
                        },
                        ticks: {
                            color: '#4A5568', // Cor do texto dos eixos
                            font: { family: "'Inter', sans-serif" }
                        }
                    },
                    x: {
                        grid: {
                            display: false // Sem grade vertical
                        },
                        ticks: {
                            color: '#4A5568',
                            font: { family: "'Inter', sans-serif" }
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: false // Esconde a legenda
                    },
                    tooltip: {
                        enabled: true,
                        backgroundColor: '#1A202C',
                        titleFont: { family: "'Inter', sans-serif", size: 14 },
                        bodyFont: { family: "'Inter', sans-serif", size: 12 },
                        padding: 12,
                        cornerRadius: 8
                    }
                }
            }
        });
        
        // --- Carregar próximos agendamentos (lógica mantida) ---
        fetch('/api/admin/agendamentos-calendario/?start={{ hoje|date:"Y-m-d" }}&end={{ hoje|date:"Y-m-d" }}')
            .then(response => response.json())
            .then(data => {
                const upcomingEl = document.getElementById('upcoming-appointments');
                if (data.length === 0) {
                    upcomingEl.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 1rem;">Nenhum agendamento para hoje.</p>';
                    return;
                }
                
                let html = '<ul style="list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 16px;">';
                data.forEach(event => {
                    const start = new Date(event.start);
                    html += `
                        <li style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #F7FAFC; border-radius: 8px;">
                            <div style="background: var(--color-primary-light); color: var(--color-primary-active); padding: 10px; border-radius: 6px; font-weight: 600; font-size: 0.9rem;">
                                ${start.getHours().toString().padStart(2, '0')}:${start.getMinutes().toString().padStart(2, '0')}
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; color: var(--color-gray-900);">${event.extendedProps.cliente}</div>
                                <div style="color: var(--color-gray-500); font-size: 0.9rem;">${event.extendedProps.servico}</div>
                            </div>
                            <span class="status status--${event.extendedProps.status_pagamento === 'Pago' ? 'success' : 'warning'}">${event.extendedProps.status_pagamento}</span>
                        </li>
                    `;
                });
                html += '</ul>';
                upcomingEl.innerHTML = html;
            });
        
        // --- Carregar atividade recente (lógica mantida) ---
        fetch('/api/admin/agendamentos-calendario/?start={{ semana_passada|date:"Y-m-d" }}&end={{ hoje|date:"Y-m-d" }}')
            .then(response => response.json())
            .then(data => {
                const activityEl = document.getElementById('recent-activity');
                if (data.length === 0) {
                    activityEl.innerHTML = '<p class="text-secondary" style="text-align: center; padding: 1rem;">Nenhuma atividade recente.</p>';
                    return;
                }
                
                data.sort((a, b) => new Date(b.start) - new Date(a.start));
                let html = '<ul style="list-style: none; padding: 0; margin: 0;">';
                data.slice(0, 5).forEach(event => {
                    const date = new Date(event.start);
                    const today = new Date();
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    
                    let dateStr;
                    if (date.toDateString() === today.toDateString()) { dateStr = 'Hoje'; }
                    else if (date.toDateString() === yesterday.toDateString()) { dateStr = 'Ontem'; }
                    else { dateStr = date.toLocaleDateString('pt-BR'); }
                    
                    html += `
                        <li style="display: flex; padding: 12px 0; border-bottom: 1px solid var(--color-gray-100);">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${event.color}; margin-right: 12px; margin-top: 6px; flex-shrink: 0;"></div>
                            <div style="flex: 1;">
                                <div style="font-weight: 500; color: var(--color-gray-700);">${event.extendedProps.cliente} - ${event.extendedProps.servico}</div>
                                <div style="display: flex; gap: 12px; font-size: 0.85rem; color: var(--color-gray-500); margin-top: 4px;">
                                    <span>${dateStr} às ${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}</span>
                                    <span>${event.extendedProps.status}</span>
                                    <span>${event.extendedProps.status_pagamento}</span>
                                </div>
                            </div>
                        </li>
                    `;
                });
                html += '</ul>';
                activityEl.innerHTML = html;
            });
    });
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\dashboard\relatorios.html

<!-- templates/agendamentos/dashboard/relatorios.html -->
{% extends 'agendamentos/dashboard/base.html' %}

{% block dashboard_content %}
<h1>Relatórios</h1>

<div class="dashboard-card">
    <div class="dashboard-card-title">Geração de Relatórios</div>
    <div class="dashboard-card-body">
        <div class="report-filters">
            <div class="form-group">
                <label>Tipo de Relatório:</label>
                <select id="report-type" class="form-control">
                    <option value="faturamento">Faturamento</option>
                    <option value="servicos">Serviços</option>
                    <option value="clientes">Clientes</option>
                    <option value="despesas">Despesas</option>
                </select>
            </div>
            
            <div class="form-group">
                <label>Período:</label>
                <select id="report-period" class="form-control">
                    <option value="semana">Esta Semana</option>
                    <option value="mes" selected>Este Mês</option>
                    <option value="ano">Este Ano</option>
                    <option value="custom">Personalizado</option>
                </select>
            </div>
        </div>
        
        <div id="custom-period" class="form-row hidden">
            <div class="form-group">
                <label>De:</label>
                <input type="date" id="report-start" class="form-control">
            </div>
            <div class="form-group">
                <label>Até:</label>
                <input type="date" id="report-end" class="form-control">
            </div>
        </div>
        
        <div class="form-group">
            <button id="generate-report" class="btn btn--primary">Gerar Relatório</button>
        </div>
    </div>
</div>

<div class="dashboard-card">
    <div class="dashboard-card-title" id="report-title">Relatório de Faturamento</div>
    <div class="dashboard-card-body">
        <div class="report-period-display" id="report-period-display"></div>
        
        <div class="chart-container">
            <canvas id="report-chart"></canvas>
        </div>
        
        <div class="report-summary" id="report-summary">
            <!-- Conteúdo do resumo será preenchido pelo JavaScript -->
        </div>
        
        <div class="report-table-container" id="report-table-container">
            <!-- Tabela de dados será preenchida pelo JavaScript -->
        </div>
        
        <div class="report-actions">
            <button id="download-pdf" class="btn btn--outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                Baixar PDF
            </button>
            <button id="download-excel" class="btn btn--outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>
                Exportar Excel
            </button>
            <button id="print-report" class="btn btn--outline">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                Imprimir
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Configurações Globais dos Gráficos ---
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    grid: { display: true, color: '#EDF2F7', drawBorder: false },
                    ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        color: '#4A5568',
                        font: { family: "'Inter', sans-serif" }
                    }
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: '#1A202C',
                    titleFont: { family: "'Inter', sans-serif", size: 14 },
                    bodyFont: { family: "'Inter', sans-serif", size: 12 },
                    padding: 12,
                    cornerRadius: 8
                }
            }
        };

        // --- Elementos do DOM ---
        const reportType = document.getElementById('report-type');
        const reportPeriod = document.getElementById('report-period');
        const customPeriod = document.getElementById('custom-period');
        const reportStart = document.getElementById('report-start');
        const reportEnd = document.getElementById('report-end');
        const generateButton = document.getElementById('generate-report');
        
        const today = new Date();
        const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
        reportStart.valueAsDate = firstDayOfMonth;
        reportEnd.valueAsDate = today;

        // --- Handlers de Eventos ---
        reportPeriod.addEventListener('change', function() {
            customPeriod.classList.toggle('hidden', this.value !== 'custom');
        });
        reportType.addEventListener('change', function() {
            const type = this.value;
            document.getElementById('report-title').textContent = `Relatório de ${type.charAt(0).toUpperCase() + type.slice(1)}`;
        });
        generateButton.addEventListener('click', generateReport);
        
        // --- Funções de Relatório ---
        function generateReport() {
            const type = reportType.value;
            const period = reportPeriod.value;
            let apiParams = `periodo=${period}`;
            
            if (period === 'custom') {
                if (!reportStart.value || !reportEnd.value) {
                    alert('Por favor, selecione um período válido.'); return;
                }
                apiParams += `&inicio=${reportStart.value}&fim=${reportEnd.value}`;
            }
            
            let apiUrl;
            switch (type) {
                case 'faturamento': apiUrl = `/api/admin/faturamento/?${apiParams}&tipo=diario`; break;
                case 'servicos': apiUrl = `/api/admin/faturamento/?${apiParams}&tipo=servico`; break;
                case 'clientes': alert('Relatório de clientes não implementado.'); return;
                case 'despesas': apiUrl = `/api/admin/despesas/?${apiParams}`; break;
                default: return;
            }
            
            fetch(apiUrl)
                .then(response => response.json())
                .then(data => {
                    const periodDisplay = document.getElementById('report-period-display');
                    const start = new Date(data.periodo.inicio + 'T00:00:00-03:00'); // Adiciona fuso
                    const end = new Date(data.periodo.fim + 'T00:00:00-03:00');
                    periodDisplay.textContent = `Período: ${start.toLocaleDateString('pt-BR')} a ${end.toLocaleDateString('pt-BR')}`;
                    
                    switch (type) {
                        case 'faturamento': generateFaturamentoReport(data); break;
                        case 'servicos': generateServicosReport(data); break;
                        case 'despesas': generateDespesasReport(data); break;
                    }
                })
                .catch(error => console.error('Erro ao gerar relatório:', error));
        }
        
        function generateFaturamentoReport(data) {
            let totalFaturamento = 0, totalAgendamentos = 0;
            data.dados.forEach(item => {
                totalFaturamento += item.total;
                totalAgendamentos += item.quantidade;
            });

            // Resumo
            document.getElementById('report-summary').innerHTML = `
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card"><div class="stat-title">Total Faturado</div><div class="stat-value">R$ ${totalFaturamento.toFixed(2)}</div></div>
                    <div class="stat-card"><div class="stat-title">Total de Agendamentos</div><div class="stat-value">${totalAgendamentos}</div></div>
                    <div class="stat-card"><div class="stat-title">Ticket Médio</div><div class="stat-value">R$ ${(totalFaturamento / totalAgendamentos || 0).toFixed(2)}</div></div>
                </div>`;

            // Gráfico (Estilizado)
            const ctx = document.getElementById('report-chart').getContext('2d');
            if (window.reportChart) { window.reportChart.destroy(); }
            
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(13, 153, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(13, 153, 255, 0.05)');
            
            const labels = data.dados.map(item => new Date(item.data + 'T00:00:00-03:00').toLocaleDateString('pt-BR'));
            const values = data.dados.map(item => item.total);
            
            window.reportChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento (R$)',
                        data: values,
                        backgroundColor: gradient,
                        borderColor: '#0D99FF',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { ...chartOptions }
            });

            // Tabela (Lógica mantida)
            let tableHTML = `<div class="data-table-container"><table class="data-table"><thead><tr><th>Data</th><th>Quantidade</th><th>Valor Total</th></tr></thead><tbody>`;
            data.dados.forEach(item => {
                tableHTML += `<tr><td>${new Date(item.data + 'T00:00:00-03:00').toLocaleDateString('pt-BR')}</td><td>${item.quantidade}</td><td>R$ ${item.total.toFixed(2)}</td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><th>Total</th><th>${totalAgendamentos}</th><th>R$ ${totalFaturamento.toFixed(2)}</th></tr></tfoot></table></div>`;
            document.getElementById('report-table-container').innerHTML = tableHTML;
        }
        
        function generateServicosReport(data) {
            let totalFaturamento = 0, totalAgendamentos = 0;
            data.dados.forEach(item => {
                totalFaturamento += item.total;
                totalAgendamentos += item.quantidade;
            });
            
            // Resumo
            document.getElementById('report-summary').innerHTML = `
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card"><div class="stat-title">Total Faturado</div><div class="stat-value">R$ ${totalFaturamento.toFixed(2)}</div></div>
                    <div class="stat-card"><div class="stat-title">Total de Serviços</div><div class="stat-value">${data.dados.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Total de Agendamentos</div><div class="stat-value">${totalAgendamentos}</div></div>
                </div>`;
            
            // Gráfico (Estilizado)
            const ctx = document.getElementById('report-chart').getContext('2d');
            if (window.reportChart) { window.reportChart.destroy(); }
            
            const labels = data.dados.map(item => item.servico);
            const values = data.dados.map(item => item.total);
            
            window.reportChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Faturamento por Serviço (R$)',
                        data: values,
                        backgroundColor: [
                            'rgba(13, 153, 255, 0.7)', 'rgba(56, 161, 105, 0.7)', 'rgba(255, 149, 0, 0.7)',
                            'rgba(255, 90, 95, 0.7)', 'rgba(155, 89, 182, 0.7)', 'rgba(52, 152, 219, 0.7)'
                        ],
                        borderRadius: 5
                    }]
                },
                options: { ...chartOptions }
            });
            
            // Tabela (Lógica mantida)
            let tableHTML = `<div class="data-table-container"><table class="data-table"><thead><tr><th>Serviço</th><th>Quantidade</th><th>Valor Total</th><th>% do Faturamento</th></tr></thead><tbody>`;
            data.dados.sort((a, b) => b.total - a.total).forEach(item => {
                const percentual = (item.total / totalFaturamento * 100).toFixed(2);
                tableHTML += `<tr><td>${item.servico}</td><td>${item.quantidade}</td><td>R$ ${item.total.toFixed(2)}</td><td>${percentual}%</td></tr>`;
            });
            tableHTML += `</tbody><tfoot><tr><th>Total</th><th>${totalAgendamentos}</th><th>R$ ${totalFaturamento.toFixed(2)}</th><th>100%</th></tr></tfoot></table></div>`;
            document.getElementById('report-table-container').innerHTML = tableHTML;
        }
        
        function generateDespesasReport(data) {
            // Resumo
            document.getElementById('report-summary').innerHTML = `
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card"><div class="stat-title">Total de Despesas</div><div class="stat-value">R$ ${data.total.toFixed(2)}</div></div>
                    <div class="stat-card"><div class="stat-title">Total de Itens</div><div class="stat-value">${data.despesas.length}</div></div>
                    <div class="stat-card"><div class="stat-title">Categorias</div><div class="stat-value">${data.resumo_categorias.length}</div></div>
                </div>`;
            
            // Gráfico (Estilizado)
            const ctx = document.getElementById('report-chart').getContext('2d');
            if (window.reportChart) { window.reportChart.destroy(); }
            
            const labels = data.resumo_categorias.map(item => item.categoria);
            const values = data.resumo_categorias.map(item => item.total);
            
            window.reportChart = new Chart(ctx, {
                type: 'doughnut', // Gráfico de Rosca
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            'rgba(13, 153, 255, 0.8)', 'rgba(56, 161, 105, 0.8)', 'rgba(255, 149, 0, 0.8)',
                            'rgba(255, 90, 95, 0.8)', 'rgba(155, 89, 182, 0.8)', 'rgba(52, 152, 219, 0.8)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    ...chartOptions,
                    scales: { y: { display: false }, x: { display: false } }, // Oculta eixos
                    plugins: {
                        legend: {
                            position: 'right', // Legenda à direita
                        }
                    }
                }
            });
            
            // Tabela (Lógica mantida)
            let tableHTML = `<h4>Resumo por Categoria</h4><div class="data-table-container"><table class="data-table">...</table></div>`; // (Tabela de Resumo)
            tableHTML += `<h4>Lista de Despesas</h4><div class="data-table-container"><table class="data-table">...</table></div>`; // (Tabela de Lista)
            
            // Preenchimento da Tabela 1 (Resumo)
            let tableSummary = `<div class="data-table-container"><table class="data-table"><thead><tr><th>Categoria</th><th>Quantidade</th><th>Valor Total</th><th>% do Total</th></tr></thead><tbody>`;
            data.resumo_categorias.sort((a, b) => b.total - a.total).forEach(cat => {
                const percentual = (cat.total / data.total * 100).toFixed(2);
                tableSummary += `<tr><td>${cat.categoria}</td><td>${cat.quantidade}</td><td>R$ ${cat.total.toFixed(2)}</td><td>${percentual}%</td></tr>`;
            });
            tableSummary += `</tbody><tfoot><tr><th>Total</th><th>${data.despesas.length}</th><th>R$ ${data.total.toFixed(2)}</th><th>100%</th></tr></tfoot></table></div>`;
            
            // Preenchimento da Tabela 2 (Lista)
            let tableList = `<h4 style="margin-top: 24px;">Lista de Despesas</h4><div class="data-table-container"><table class="data-table"><thead><tr><th>Data</th><th>Descrição</th><th>Categoria</th><th>Valor</th><th>Status</th></tr></thead><tbody>`;
            data.despesas.forEach(expense => {
                tableList += `<tr><td>${new Date(expense.data + 'T00:00:00-03:00').toLocaleDateString('pt-BR')}</td><td>${expense.descricao}</td><td>${expense.categoria}</td><td>R$ ${expense.valor.toFixed(2)}</td><td><span class="status status--${expense.pago ? 'success' : 'warning'}">${expense.pago ? 'Pago' : 'Pendente'}</span></td></tr>`;
            });
            tableList += `</tbody></table></div>`;

            document.getElementById('report-table-container').innerHTML = tableSummary + tableList;
        }
        
        // Handlers de exportação (Lógica mantida)
        document.getElementById('download-pdf').addEventListener('click', () => alert('Exportar PDF não implementado.'));
        document.getElementById('download-excel').addEventListener('click', () => alert('Exportar Excel não implementado.'));
        document.getElementById('print-report').addEventListener('click', () => window.print());
        
        // Gerar relatório inicial
        generateReport();
    });
</script>
{% endblock %}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\admin_area.html

<div id="admin-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('home-screen')">
                 <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                Voltar
            </button>
            <h2>Área Administrativa</h2>
        </div>

        <div class="admin-tabs">
            <button class="tab-btn active" onclick="showAdminTab('appointments', event)">Agendamentos</button>
            <button class="tab-btn" onclick="showAdminTab('services', event)">Serviços</button>
        </div>

        <div id="admin-appointments" class="admin-content">
            <h3>Todos os Agendamentos</h3>
            <div class="admin-appointments-list" id="admin-appointments-list">
                </div>
        </div>

        <div id="admin-services" class="admin-content hidden">
            <div class="services-header">
                <h3>Gerenciar Serviços</h3>
            </div>
            <div class="admin-services-list" id="admin-services-list">
                </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\admin_login.html

<div id="admin-login-screen" class="screen">
    <div class="container" style="max-width: 450px;">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('home-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Voltar</span> </button>
            <h2>Acesso Restrito</h2>
            <div class="header-placeholder"></div> </div>

        <div class="login-form-section">
            <form id="admin-login-form">
                <p class="text-secondary" style="text-align: center; margin-bottom: 24px;">
                    Esta área é exclusiva para administradores.
                </p>
                <div class="form-group">
                    <label class="form-label" for="admin-login-email">Email</label>
                    <input type="email" class="form-control" id="admin-login-email" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="admin-login-password">Senha</label>
                    <input type="password" class="form-control" id="admin-login-password" required>
                </div>
                <button type="submit" class="btn btn--primary btn--full-width">Entrar</button>
            </form>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\calendar.html

<div id="calendar-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('services-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Voltar</span> </button>
            <h2>Escolha a Data e Hora</h2> <div class="header-placeholder"></div> </div>
        <div class="selected-service-info" id="selected-service-info"></div>
        
        <div class="calendar-container">
            <div class="calendar-header">
                <button class="btn btn--outline" onclick="changeMonth(-1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <h3 id="current-month"></h3>
                <button class="btn btn--outline" onclick="changeMonth(1)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="calendar-grid" id="calendar-grid"></div>
        </div>
        
        <div class="time-selection hidden" id="time-selection">
            <h3>Horários Disponíveis:</h3>
            <div class="time-slots" id="time-slots"></div>
            <button class="btn btn--primary btn--lg btn--full-width" id="continue-to-login" disabled>
                Continuar
            </button>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\client_area.html

<div id="client-area-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('home-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Voltar</span> </button>
            <h2>Meus Agendamentos</h2> <div class="header-placeholder"></div> </div>
        
        <div class="client-dashboard">
            
            <div class="form-toggle" style="max-width: 500px; margin: 0 auto 24px auto;">
                <button class="toggle-btn active" data-tab="proximos" onclick="showClientTab(event, 'proximos')">
                    Próximos
                </button>
                <button class="toggle-btn" data-tab="historico" onclick="showClientTab(event, 'historico')">
                    Histórico
                </button>
            </div>

            <div id="client-tab-proximos" class="client-tab-content">
                <div class="dashboard-section" id="client-appointments-proximos">
                    </div>
            </div>

            <div id="client-tab-historico" class="client-tab-content hidden">
                <div class="dashboard-section" id="client-appointments-historico">
                    </div>
            </div>

        </div> <div class="client-actions-footer" style="text-align: center; border-top: 1px solid var(--color-border); padding-top: 24px; margin-top: 32px; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn--outline" onclick="showScreen('profile-screen')">
                Gerenciar Perfil
            </button>
            <button class="btn btn--secondary" onclick="performLogout(event)">
                Sair
            </button>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\confirmation.html

<div id="confirmation-screen" class="screen">
    <div class="container">
        <div class="confirmation-content">
            <div class="success-icon">✅</div>
            <h2>Agendamento Confirmado!</h2>
            <p>Seu horário foi agendado com sucesso. Você receberá os detalhes por e-mail.</p>

            <div class="booking-details" id="booking-details">
                </div>

            <div class="confirmation-actions">
                <button class="btn btn--primary btn--lg" onclick="showScreen('home-screen')">Voltar ao Início</button>
                <button class="btn btn--outline btn--lg" onclick="showScreen('client-area-screen')">Meus Agendamentos</button>
            </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\forced_login.html

<div id="forced-login-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('home-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Voltar</span> </button>
            <h2>Acesso à Conta</h2>
            <div class="header-placeholder"></div> </div>

        <div class="login-container" style="grid-template-columns: 1fr; max-width: 500px; margin: 0 auto;">
            <div class="login-form-section">
        <div class="warning-card" style="margin-bottom: 24px;">
                    <div class="warning-icon">🔒</div>
                    <h3>Login Necessário</h3>
                    <p class="text-secondary">Para acessar a Área do Cliente e ver seus agendamentos, por favor, entre na sua conta.</p>
                </div>

                <div class="form-toggle">
                    <button class="toggle-btn active" onclick="showLoginForm(event)">Já sou cliente</button>
                    <button class="toggle-btn" onclick="showRegisterForm(event)">Ainda não sou cliente</button>
                </div>

                <form id="forced-login-form" class="auth-form">

                    <div class="form-group">
                        <label class="form-label" for="forced-login-phone">Telefone (com DDD)</label>
                        <input type="tel" class="form-control" id="forced-login-phone" required placeholder="Ex: 11987654321">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="forced-login-nascimento">Data de Nascimento</label>
                        <input type="date" class="form-control" id="forced-login-nascimento" required>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Entrar</button>
                </form>

                <form id="forced-register-form" class="auth-form hidden">
                    <div class="form-group">
                        <label class="form-label" for="forced-register-name">Nome</label>
                        <input type="text" class="form-control" id="forced-register-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="forced-register-lastname">Sobrenome</label>
                        <input type="text" class="form-control" id="forced-register-lastname" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="forced-register-nascimento">Data de Nascimento</label>
                        <input type="date" class="form-control" id="forced-register-nascimento" required>
                        <small class="form-text">Usado como senha.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="forced-register-phone">Telefone (WhatsApp)</label>
                        <input type="tel" class="form-control" id="forced-register-phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="forced-register-email">Email (Opcional)</label>
                        <input type="email" class="form-control" id="forced-register-email">
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Cadastrar e Entrar</button>
                </form>
            </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\home.html

<div id="home-screen" class="screen active">
    <div class="hero-container">
        <div class="hero-overlay"></div>
        <div class="hero-content">
            
            <div class="logo-section">
                <img id="negocio-logo" class="negocio-logo" src="" alt="Logo do Negócio" style="display: none;">
                <h1 class="logo">Bella Designer</h1>
                <p class="tagline">Espaço dedicado à beleza e bem-estar</p>
            </div>
            <div class="action-buttons">
                <button class="btn btn--primary" onclick="startBookingFlow()">
                    Agendar Horário
                </button>

                <button id="btn-portfolio" class="btn btn--outline hidden" onclick="openPortfolioModal()">
                    Ver Portfólio
                </button>

                <button class="btn btn--outline" onclick="showScreen('client-area-screen')">
                    Área do Cliente
                </button>
                
                <button id="home-logout-button" class="btn btn--outline hidden" onclick="performLogout(event)">
                    Sair
                </button>
            </div>

            <div class="admin-login-link">
                <a href="#" onclick="showAdminLoginScreen(event)">Acesso Administrativo</a>
            </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\login.html

<div id="login-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('calendar-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/><path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
                <span>Voltar</span> </button>
            <h2>Finalizar Agendamento</h2> <div class="header-placeholder"></div> </div>

        <div class="login-container">
            <div class="login-form-section">
                <div class="form-toggle">
                    <button class="toggle-btn active" onclick="showLoginForm(event)">Já sou cliente</button>
                    <button class="toggle-btn" onclick="showRegisterForm(event)">Primeiro agendamento</button>
                </div>

                <form id="login-form" class="auth-form">
                    
                    <div class="form-group">
                        <label class="form-label" for="login-phone">Telefone (com DDD)</label>
                        <input type="tel" class="form-control" id="login-phone" required placeholder="Ex: 11987654321">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="login-nascimento">Data de Nascimento</label>
                        <input type="date" class="form-control" id="login-nascimento" required>
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Entrar e Agendar</button>
                </form>

                <form id="register-form" class="auth-form hidden">
                    <div class="form-group">
                        <label class="form-label" for="register-name">Nome</label>
                        <input type="text" class="form-control" id="register-name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-lastname">Sobrenome</label>
                        <input type="text" class="form-control" id="register-lastname" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-nascimento">Data de Nascimento</label>
                        <input type="date" class="form-control" id="register-nascimento" required>
                        <small class="form-text">Usado como senha.</small>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-phone">Telefone (WhatsApp)</label>
                        <input type="tel" class="form-control" id="register-phone" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="register-email">Email (Opcional)</label>
                        <input type="email" class="form-control" id="register-email">
                    </div>
                    <button type="submit" class="btn btn--primary btn--full-width">Cadastrar e Agendar</button>
                </form>
            </div>

            <div class="booking-summary">
                <h3>Resumo do Agendamento</h3>
                <div class="summary-item">
                    <span class="label">Serviço:</span>
                    <span class="value" id="summary-service"></span>
                </div>
                <div class="summary-item">
                    <span class="label">Profissional:</span>
                    <span class="value" id="summary-professional"></span>
                </div>
                <div class="summary-item">
                    <span class="label">Data:</span>
                    <span class="value" id="summary-date"></span>
                </div>
                <div class="summary-item">
                    <span class="label">Horário:</span>
                    <span class="value" id="summary-time"></span>
                </div>
                <div class="summary-item">
                    <span class="label">Duração:</span>
                    <span class="value" id="summary-duration"></span>
                </div>
                <div class="summary-total">
                    <span class="label">Total:</span>
                    <span class="value" id="summary-price"></span>
                </div>
            </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\payment.html

<div id="payment-screen" class="screen">
    <div class="container" style="max-width: 500px;">
        <div class="screen-header">
            <div class="header-placeholder"></div>
            <h2>Confirme seu Agendamento</h2>
            <div class="header-placeholder"></div>
        </div>

        <div class.payment-container">
            <div class="warning-card" style="border-color: var(--color-primary); margin-bottom: 24px;">
                <div class="warning-icon" style="color: var(--color-primary);">⏳</div>
                <h3>Quase lá! Pague para confirmar.</h3>
                <p class="text-secondary" style="font-size: 1.1rem; line-height: 1.6;">
                    Seu horário está reservado. Realize o pagamento do adiantamento via PIX para confirmar.
                </p>
                <div class="payment-timer" id="payment-timer-display">
                    Reservado por: <span>05:00</span>
                </div>
            </div>

            <div class="pix-container">
                <div class="pix-qr-code">
                    <img id="payment-qr-code-img" src="" alt="PIX QR Code">
                </div>
                
                <p class="text-secondary text-center" style="margin-top: 16px;">
                    Use o app do seu banco para ler o QR Code
                </p>

                <div class="pix-copy-paste">
                    <label class="form-label" for="payment-qr-code-text">Ou copie o código PIX:</label>
                    <div class="copy-input-group">
                        <input type="text" id="payment-qr-code-text" class="form-control" readonly>
                        <button id="btn-copy-pix" class="btn btn--outline">Copiar</button>
                    </div>
                </div>
            </div>

            <div class="payment-footer">
                <p class="text-secondary" style="font-size: 0.9rem; text-align: center;">
                    Estamos aguardando a confirmação do pagamento...
                </p>
                <div class="loading-indicator" style="margin-top: 16px;">
                    <div class="loading-spinner small"></div>
                    <p>Verificando status...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.payment-container {
    animation: fadeIn 0.5s ease;
}

.payment-timer {
    font-size: 1.25rem;
    font-weight: 600;
    color: var(--color-dark-gray);
    margin-top: 16px;
    padding: 12px;
    background: var(--color-light-gray);
    border-radius: var(--radius-base);
}
.payment-timer span {
    color: var(--color-primary);
    font-variant-numeric: tabular-nums;
}

.pix-container {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: 24px;
    box-shadow: var(--shadow-sm);
}

.pix-qr-code {
    display: flex;
    justify-content: center;
    margin-bottom: 16px;
}
.pix-qr-code img {
    width: 100%;
    max-width: 280px;
    height: auto;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-base);
}

.copy-input-group {
    display: flex;
    gap: 8px;
}
.copy-input-group input {
    flex: 1;
    font-size: 0.9rem;
    background: var(--color-light-gray);
}
</style>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\payment_failed.html

<div id="payment-failed-screen" class="screen">
    <div class="container" style="max-width: 500px;">
        <div class="screen-header">
            <div class="header-placeholder"></div>
            <h2>Agendamento Cancelado</h2>
            <div class="header-placeholder"></div>
        </div>

        <div class="confirmation-content" style="padding-top: 0;">
            <div class="success-icon" style="color: var(--color-red);">🚫</div>
            <h2>Tempo Esgotado</h2>
            <p class="text-secondary" style="font-size: 1.1rem; line-height: 1.6;">
                O tempo para pagamento do PIX expirou e seu agendamento foi cancelado.
            </p>
            <p class="text-secondary" style="margin-top: 16px;">
                Por favor, inicie o processo novamente para escolher um novo horário.
            </p>

            <div class="confirmation-actions" style="margin-top: 32px;">
                <button class="btn btn--primary btn--lg" onclick="showScreen('home-screen')">Voltar ao Início</button>
            </div>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\professional.html

<div id="professional-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('services-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> </svg>
                <span>Voltar aos Serviços</span> </button>
            <h2>Escolha o Profissional</h2>
            <div class="header-placeholder"></div> </div>
        
        <div class="selected-service-info" id="selected-service-info-pro">
            </div>
        
        <div class="professionals-grid" id="professional-list">
            </div>
    </div>
</div>

<style>
    .professionals-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-16);
        margin-top: var(--space-24);
    }
    
    .professional-card {
        background: var(--color-surface);
        border: 1px solid var(--color-border);
        border-radius: var(--radius-lg);
        padding: var(--space-20);
        text-align: center;
        cursor: pointer;
        transition: all var(--duration-normal) var(--ease-standard);
        box-shadow: var(--shadow-sm);
    }
    
    .professional-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-color: var(--color-primary);
    }
    
    .professional-avatar {
        width: 80px;
        height: 80px;
        border-radius: var(--radius-full);
        background: var(--color-light-gray);
        margin: 0 auto var(--space-16);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        font-weight: 600;
        color: var(--color-primary);
    }
    
    .professional-name {
        font-size: var(--font-size-lg);
        font-weight: var(--font-weight-semibold);
        color: var(--color-dark-gray);
    }
</style>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\profile.html

<div id="profile-screen" class="screen">
    <div class="container" style="max-width: 600px;">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('client-area-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Voltar</span>
            </button>
            <h2>Gerenciar Perfil</h2>
            <div class="header-placeholder"></div>
        </div>

        <div class="login-form-section">
            <form id="profile-form">
                <p class="text-secondary" style="margin-bottom: 24px;">
                    Mantenha seus dados de contato atualizados.
                </p>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="profile-name">Nome</label>
                        <input type="text" class="form-control" id="profile-name" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="profile-lastname">Sobrenome</label>
                        <input type="text" class="form-control" id="profile-lastname" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="profile-email">Email</label>
                    <input type="email" class="form-control" id="profile-email" required>
                    <small class="form-text">Seu email é usado para login. Alterá-lo pode desconectar você.</small>
                </div>

                <div class="form-row">
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="profile-phone">Telefone (WhatsApp)</label>
                        <input type="tel" class="form-control" id="profile-phone" required>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label class="form-label" for="profile-nascimento">Data de Nascimento</label>
                        <input type="date" class="form-control" id="profile-nascimento" required>
                    </div>
                </div>
                
                <button type="submit" class="btn btn--primary btn--full-width" style="margin-top: 16px;">
                    Salvar Alterações
                </button>
            </form>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\services.html

<div id="services-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="navigateBackFromServices()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/> </svg>
                <span>Voltar</span>
            </button>
            <h2>Nossos Serviços</h2>
            <div class="header-placeholder"></div> </div>

        <div class="services-grid" id="services-list">
            </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\agendamentos\templates\agendamentos\partials\warnings.html

<div id="warnings-screen" class="screen">
    <div class="container">
        <div class="screen-header">
            <button class="btn-back" onclick="showScreen('home-screen')">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M19 12H5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M12 19L5 12L12 5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <span>Voltar</span> </button>
            <h2>Informações Importantes</h2>
            <div class="header-placeholder"></div> </div>
        
        <div class="warnings-content" id="warnings-content-lista">
            <p>Carregando avisos...</p>
        </div>
        
        <div class="continue-section">
            <button class="btn btn--primary btn--lg btn--full-width" onclick="showScreen('services-screen')">
                Li e entendi, continuar
            </button>
        </div>
    </div>
</div>
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\bella_designer\asgi.py

"""
ASGI config for bella_designer project.

It exposes the ASGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/asgi/
"""

import os

from django.core.asgi import get_asgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bella_designer.settings')

application = get_asgi_application()

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\bella_designer\settings.py

# bella_designer/settings.py

import os
from pathlib import Path
import os
from dotenv import load_dotenv
from django.conf import settings  # <-- 1. ADICIONE ESTA IMPORTAÇÃO
from django.conf.urls.static import static  # <-- 2. ADICIONE ESTA IMPORTAÇÃO

# Chame isso em algum lugar perto do BASE_DIR se ainda não estiver fazendo
load_dotenv()

MERCADO_PAGO_ACCESS_TOKEN = os.getenv('MERCADO_PAGO_ACCESS_TOKEN')

BASE_URL = os.getenv('BASE_URL', 'https://jrtechhub.online')

# Tempo em minutos que o PIX ficará ativo antes de expirar
MINUTOS_EXPIRACAO_PIX = 5

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent

# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.2/howto/deployment/checklist/

SECRET_KEY = 'django-insecure-sua-chave-secreta-aqui'  # Mantenha sua chave original

DEBUG = True

ALLOWED_HOSTS = ['*', 'jrtechhub.online',
                 'www.jrtechhub.online', '127.0.0.1', 'localhost']

urlpatterns = []


CSRF_TRUSTED_ORIGINS = ['https://jrtechhub.online',
                        'https://www.jrtechhub.online']

# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    # Aplicações do projeto
    'agendamentos',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'whitenoise.middleware.WhiteNoiseMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'bella_designer.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        # Adicione o diretório de templates global
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'bella_designer.wsgi.application'


# Database
# https://docs.djangoproject.com/en/4.2/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/4.2/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    # ... (mantenha os validadores originais)
]


# Internationalization
# https://docs.djangoproject.com/en/4.2/topics/i18n/

LANGUAGE_CODE = 'pt-br'

TIME_ZONE = 'America/Sao_Paulo'

USE_I18N = True

USE_TZ = True

LOGIN_URL = None


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.2/howto/static-files/

STATIC_URL = 'static/'

MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')

# Adicione o diretório de arquivos estáticos global
STATICFILES_DIRS = [
    os.path.join(BASE_DIR, 'static'),
]

STATIC_ROOT = os.path.join(BASE_DIR, 'staticfiles')

# STATICFILES_STORAGE = 'whitenoise.storage.CompressedManifestStaticFilesStorage'

# Default primary key field type
# https://docs.djangoproject.com/en/4.2/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL,
                          document_root=settings.MEDIA_ROOT)

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\bella_designer\urls.py

# bella_designer/urls.py

from django.contrib import admin
from django.urls import path, include
# Importamos as views para usar nas rotas globais
from agendamentos import views as agendamentos_views
from django.conf import settings
from django.conf.urls.static import static

urlpatterns = [
    # Rota para a administração padrão do Django
    path('admin/', admin.site.urls),

    # --- ROTAS GLOBAIS DO DASHBOARD DO EMPREENDEDOR (LOGIN NECESSÁRIO) ---
    # Estas rotas são acessadas pelo empreendedor logado, não pelo cliente final
    path('dashboard/', agendamentos_views.admin_dashboard, name='admin_dashboard'),
    path('dashboard/calendario/', agendamentos_views.admin_calendario,
         name='admin_calendario'),
    path('dashboard/financeiro/', agendamentos_views.admin_financeiro,
         name='admin_financeiro'),
    path('dashboard/relatorios/', agendamentos_views.admin_relatorios,
         name='admin_relatorios'),

    path('webhook/mercado-pago/',
         agendamentos_views.mercadopago_webhook,
         name='mercadopago_webhook'),

    # --- ADICIONE ESTAS 4 NOVAS ROTAS PARA A GESTÃO ---
    path('dashboard/gestao/', agendamentos_views.admin_gestao, name='admin_gestao'),
    path('dashboard/api/gestao/servicos/',
         agendamentos_views.api_gestao_servicos, name='api_gestao_servicos'),
    path('dashboard/api/gestao/servicos/<int:servico_id>/',
         agendamentos_views.api_gestao_servico_detalhe, name='api_gestao_servico_detalhe'),
    path('dashboard/api/gestao/equipe/',
         agendamentos_views.api_gestao_equipe, name='api_gestao_equipe'),

    path('dashboard/api/gestao/equipe/<int:membro_id>/',
         agendamentos_views.api_gestao_equipe_detalhe, name='api_gestao_equipe_detalhe'),

    path('api/admin/agendamentos-pagamento/',
         agendamentos_views.api_agendamentos_pagamento, name='api_agendamentos_pagamento'),

    # =================================================================
    # NOVA ADIÇÃO: ROTAS DE CATEGORIA
    # =================================================================
    path('dashboard/api/gestao/categorias/',
         agendamentos_views.api_gestao_categorias, name='api_gestao_categorias'),
    path('dashboard/api/gestao/categorias/<int:categoria_id>/',
         agendamentos_views.api_gestao_categoria_detalhe, name='api_gestao_categoria_detalhe'),

    # =================================================================
    # NOVA ADIÇÃO: ROTAS DE PREÇOS DE MANUTENÇÃO (ligadas a um serviço)
    # =================================================================
    path('dashboard/api/gestao/servicos/<int:servico_id>/manutencao/',
         agendamentos_views.api_gestao_precos_manutencao, name='api_gestao_precos_manutencao'),
    path('dashboard/api/gestao/manutencao/<int:preco_id>/',
         agendamentos_views.api_gestao_preco_manutencao_detalhe, name='api_gestao_preco_manutencao_detalhe'),

    # --- ADICIONE ESTAS DUAS LINHAS ---
    path('dashboard/api/gestao/horarios/',
         agendamentos_views.api_gestao_horarios, name='api_gestao_horarios'),
    path('dashboard/api/gestao/horarios/<int:horario_id>/',
         agendamentos_views.api_gestao_horario_detalhe, name='api_gestao_horario_detalhe'),

    path('dashboard/api/gestao/configuracoes/',
         agendamentos_views.api_gestao_configuracoes, name='api_gestao_configuracoes'),

    path('dashboard/api/gestao/avisos/',
         agendamentos_views.api_gestao_avisos, name='api_gestao_avisos'),
    path('dashboard/api/gestao/avisos/<int:aviso_id>/',
         agendamentos_views.api_gestao_aviso_detalhe, name='api_gestao_aviso_detalhe'),

    path('dashboard/api/gestao/dias-bloqueados/',
         agendamentos_views.api_gestao_dias_bloqueados, name='api_gestao_dias_bloqueados'),
    path('dashboard/api/gestao/dias-bloqueados/<int:bloqueio_id>/',
         agendamentos_views.api_gestao_dia_bloqueado_detalhe, name='api_gestao_dia_bloqueado_detalhe'),

    # --- ROTAS GLOBAIS DA API DO DASHBOARD (LOGIN NECESSÁRIO) ---
    path('api/admin/agendamentos-calendario/',
         agendamentos_views.api_agendamentos_calendario, name='api_agendamentos_calendario'),
    path('api/admin/resumo-financeiro/',
         agendamentos_views.api_resumo_financeiro, name='api_resumo_financeiro'),
    path('api/admin/faturamento/',
         agendamentos_views.api_faturamento, name='api_faturamento'),
    path('api/admin/despesas/', agendamentos_views.api_despesas, name='api_despesas'),
    path('api/admin/get-form-data/',
         agendamentos_views.api_admin_get_form_data, name='api_admin_get_form_data'),
    path('api/admin/criar-agendamento/',
         agendamentos_views.api_admin_criar_agendamento, name='api_admin_criar_agendamento'),
    path('api/admin/atualizar-agendamento/<int:agendamento_id>/',
         agendamentos_views.api_admin_atualizar_agendamento, name='api_admin_atualizar_agendamento'),
    path('api/admin/atualizar-horario-agendamento/<int:agendamento_id>/',
         agendamentos_views.api_admin_atualizar_horario_agendamento, name='api_admin_atualizar_horario_agendamento'),
    path('api/admin/deletar-agendamento/<int:agendamento_id>/',
         agendamentos_views.api_admin_deletar_agendamento, name='api_admin_deletar_agendamento'),
    path('api/admin/registrar-despesa/',
         agendamentos_views.api_registrar_despesa, name='api_registrar_despesa'),
    path('api/admin/despesa/<int:despesa_id>/',
         agendamentos_views.api_despesa, name='api_despesa'),
    path('api/admin/atualizar-despesa/<int:despesa_id>/',
         agendamentos_views.api_atualizar_despesa, name='api_atualizar_despesa'),
    path('api/admin/deletar-despesa/<int:despesa_id>/',
         agendamentos_views.api_deletar_despesa, name='api_deletar_despesa'),
    path('api/admin/agendamentos-pagamento/',
         agendamentos_views.api_agendamentos_pagamento, name='api_agendamentos_pagamento'),


    # --- ROTA PRINCIPAL PARA OS CLIENTES ---
    # Esta é a mágica: ela captura o "slug" do empreendedor na URL
    # e passa o resto da requisição para o arquivo 'agendamentos.urls'
    path('<slug:empreendedor_slug>/',
         include('agendamentos.urls', namespace='agendamentos')),

    # Opcional: Uma página inicial para quem acessa a raiz do site (ex: seudominio.com)
    # Você pode criar uma view chamada 'landing_page' em 'agendamentos/views.py'
    # path('', agendamentos_views.landing_page, name='landing_page'),
]

# Isso serve os arquivos de mídia (logos) no modo de desenvolvimento
if settings.DEBUG:
    urlpatterns += static(settings.MEDIA_URL,
                          document_root=settings.MEDIA_ROOT)

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\bella_designer\wsgi.py

"""
WSGI config for bella_designer project.

It exposes the WSGI callable as a module-level variable named ``application``.

For more information on this file, see
https://docs.djangoproject.com/en/5.2/howto/deployment/wsgi/
"""

import os

from django.core.wsgi import get_wsgi_application

os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'bella_designer.settings')

application = get_wsgi_application()

_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\bella_designer\__init__.py


_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard-main.css

/* static/css/dashboard-main.css */

/* 1. Base (Variáveis, Resets, Tipografia) */
@import url('dashboard/base/_variables.css');
@import url('dashboard/base/_base.css');
@import url('dashboard/base/_typography.css');

/* 2. Layout (Sidebar, Estrutura) */
@import url('dashboard/layout/_layout.css');

/* 3. Componentes (Botões, Forms, Modais, Cards) */
@import url('dashboard/components/_button.css');
@import url('dashboard/components/_badge.css');
@import url('dashboard/components/_card.css');
@import url('dashboard/components/_chart.css');
@import url('dashboard/components/_table.css');
@import url('dashboard/components/_form.css');
@import url('dashboard/components/_tabs.css');
@import url('dashboard/components/_calendar.css');
@import url('dashboard/components/_modal.css');
@import url('dashboard/components/_utils.css');
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\main.css

/* =================================================== */
/* ARQUIVO PRINCIPAL DE ESTILOS DO CLIENTE             */
/* =================================================== */
/* Este arquivo apenas importa os parciais.            */
/* Não adicione regras de CSS diretamente aqui.        */
/* =================================================== */

/* 1. Base (Variáveis, Resets, Fontes, Utils) */
@import url('base/_variables.css');
@import url('base/_base.css');
@import url('base/_animations.css');
@import url('base/_utils.css');

/* 2. Componentes (Botões, Forms, Modais, Cards) */
@import url('components/_button.css');
@import url('components/_form.css');
@import url('components/_screen.css');
@import url('components/_modal.css');
@import url('components/_calendar.css');
@import url('components/_card.css');
@import url('components/_service-card.css');
@import url('components/_professional-card.css');
@import url('components/_appointment-card.css');
@import url('components/_warning-card.css');

/* 3. Layout (Estilos específicos de cada "página") */
@import url('layout/_home.css');
@import url('layout/_login.css');
@import url('layout/_client-area.css');
@import url('layout/_confirmation.css');
@import url('layout/_warnings.css');
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\base\_animations.css

/* * Todas as animações (@keyframes) centralizadas.
 */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes spin {
  100% {
    transform: rotate(360deg);
  }
}

@keyframes bounceIn {
  0% {
    transform: scale(0);
    opacity: 0;
  }
  60% {
    transform: scale(1.1);
    opacity: 1;
  }
  100% {
    transform: scale(1);
  }
}

@keyframes scaleIn {
  from {
    transform: scale(0.9);
    opacity: 0;
  }
  to {
    transform: scale(1);
    opacity: 1;
  }
}

/* Animações da Home */
@keyframes scaleInBounce {
  from {
      transform: scale(0) rotate(-180deg);
      opacity: 0;
  }
  to {
      transform: scale(1) rotate(0deg);
      opacity: 1;
  }
}

@keyframes gradientShift {
  0%, 100% { background-position: 0% center; }
  50% { background-position: 100% center; }
}

@keyframes fadeInUp {
  from {
      opacity: 0;
      transform: translateY(30px);
  }
  to {
      opacity: 1;
      transform: translateY(0);
  }
}

/* Animação da tela de Avisos */
@media (max-width: 768px) {
  @keyframes slideInFromLeft {
    from {
      opacity: 0;
      transform: translateX(-40px);
    }
    to {
      opacity: 1;
      transform: translateX(0);
    }
  }
}

@keyframes growUnderline {
  from {
    /* Começa invisível e com 0% de largura */
    transform: scaleX(0);
  }
  to {
    /* Termina visível e com 100% de largura */
    transform: scaleX(1);
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\base\_base.css

/* * Estilos de base: reset, tags HTML (body, h1, p) e o .container principal.
 */
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  margin: 0;
  font-family: var(--font-family-base);
  font-size: var(--font-size-base);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  line-height: var(--line-height-normal);
}

h1, h2, h3, h4, h5 { 
  font-weight: var(--font-weight-semibold); 
  margin: 0; 
  line-height: var(--line-height-tight);
}

h1 { font-size: var(--font-size-3xl); }
h2 { font-size: var(--font-size-xl); }
h3 { font-size: var(--font-size-lg); }
h4 { font-size: var(--font-size-base); }
h5 { font-size: var(--font-size-sm); }

p { 
  margin: 0 0 var(--space-16) 0; 
  line-height: var(--line-height-relaxed);
}

p:last-child {
  margin-bottom: 0;
}

a {
  color: var(--color-primary);
  text-decoration: none;
  transition: color var(--duration-fast) ease;
}

a:hover {
  color: var(--color-primary-hover);
  text-decoration: underline;
}

/* Container Responsivo */
.container {
  width: 100%;
  max-width: 1140px;
  margin: 0 auto;
  padding: 0 var(--space-16);
}

@media (min-width: 768px) {
  .container {
    padding: 0 var(--space-24);
  }
}

/* Ajustes gerais de responsividade */
@media (max-width: 768px) {
  .container {
    padding: 0 var(--space-16);
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\base\_utils.css

/* * Classes utilitárias (helpers) como .hidden, .text-center, .mt-4, etc.
 */
.hidden {
  display: none !important;
}

.text-center {
  text-align: center;
}

.mt-4 {
  margin-top: var(--space-16);
}

.mb-4 {
  margin-bottom: var(--space-16);
}

.mt-6 {
  margin-top: var(--space-24);
}

.mb-6 {
  margin-bottom: var(--space-24);
}

.flex {
  display: flex;
}

.items-center {
  align-items: center;
}

.justify-between {
  justify-content: space-between;
}

.justify-center {
  justify-content: center;
}

.gap-4 {
  gap: var(--space-16);
}

.w-full {
  width: 100%;
}

.text-primary {
  color: var(--color-primary);
}

.text-secondary {
  color: var(--color-text-secondary);
}

.text-error {
  color: var(--color-error);
}

.text-success {
  color: var(--color-success);
}

.rounded {
  border-radius: var(--radius-base);
}

.shadow {
  box-shadow: var(--shadow-sm);
}

.shadow-md {
  box-shadow: var(--shadow-md);
}

.border {
  border: 1px solid var(--color-border);
}

.bg-surface {
  background-color: var(--color-surface);
}

.bg-primary-light {
  background-color: var(--color-mint-green-light);
}

.p-4 {
  padding: var(--space-16);
}

.p-6 {
  padding: var(--space-24);
}

/* Animações e Efeitos */
.fade-in {
  animation: fadeIn 0.5s ease forwards;
}

.fade-in-up {
  animation: fadeInUp 0.5s ease forwards;
}

.scale-in {
  animation: scaleIn 0.3s var(--ease-bounce) forwards;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\base\_variables.css

/* * Contém todas as suas variáveis CSS (:root). 
 * É a base para todo o design.
 */
:root {
  /* --- CORES BASE (NÃO MEXER) --- */
  --color-white: #ffffff;
  --color-off-white: #fdfdfd;
  --color-light-gray: #f5f5f5;
  --color-medium-gray: #e0e0e0;
  --color-text-gray: #888888;
  --color-dark-gray: #4f4f4f;

  /* VALORES PADRÃO PARA COR SECUNDÁRIA */
  --color-secondary-hsl: 345, 100%, 91%; /* #FFD1DC */
  --color-secondary-h: 345;
  --color-secondary-s: 100%;
  --color-secondary-l: 91%;

  --color-secondary: hsl(var(--color-secondary-hsl));

  
  /* Cores de Status (Fixas) */
  --color-red: #FF5A5F;
  --color-red-light: #FFEBEE;
  --color-orange: #FF9500;
  --color-orange-light: #FFF8E1;
  --color-blue: #0D99FF;
  --color-blue-light: #E3F2FD;

  /* --- COR PRIMÁRIA DINÂMICA (Baseada em HSL) --- */
  /* O JavaScript vai sobrescrever estas 4 variáveis. */
  /* Estes são os valores PADRÃO (verde-menta) */
  --color-primary-hsl: 160, 41%, 58%;
  --color-primary-h: 160;
  --color-primary-s: 41%;
  --color-primary-l: 58%;
  /* --- FIM DA CORREÇÃO --- */

  /* --- CORES SEMÂNTICAS DINÂMICAS --- */
  /* (Esta seção agora usará os valores H, S, L corretos) */
  --color-background: var(--color-off-white);
  --color-surface: var(--color-white);
  --color-text: var(--color-dark-gray);
  --color-text-secondary: var(--color-text-gray);
  
  /* Usa a variável HSL principal */
  --color-primary: hsl(var(--color-primary-hsl));
  
  /* Usa os componentes H, S, L separados para calcular as variações */
  --color-primary-hover: hsl(var(--color-primary-h), var(--color-primary-s), calc(var(--color-primary-l) - 8%));
  --color-primary-active: hsl(var(--color-primary-h), var(--color-primary-s), calc(var(--color-primary-l) - 15%));
  --color-primary-light: hsl(var(--color-primary-h), var(--color-primary-s), 95%);
  
  --color-border: var(--color-medium-gray);
  --color-btn-primary-text: var(--color-white);
  --color-error: var(--color-red);
  --color-success: var(--color-primary);
  --color-warning: var(--color-orange);
  --color-focus-ring: hsla(var(--color-primary-hsl), 0.4);

  /* --- VARIÁVEIS ANTIGAS (Sobrescritas) --- */
  --color-mint-green: var(--color-primary);
  --color-mint-green-hover: var(--color-primary-hover);
  --color-mint-green-active: var(--color-primary-active);
  --color-mint-green-light: var(--color-primary-light);

  /* Tipografia Modernizada */
  --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-size-xs: 12px;
  --font-size-sm: 14px;
  --font-size-base: 16px;
  --font-size-md: 18px;
  --font-size-lg: 20px;
  --font-size-xl: 24px;
  --font-size-2xl: 32px;
  --font-size-3xl: 48px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --line-height-relaxed: 1.75;

  /* Espaçamento e Bordas Refinados */
  --space-2: 2px;
  --space-4: 4px;
  --space-8: 8px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;
  --space-40: 40px;
  --space-48: 48px;
  --space-64: 64px;
  --radius-sm: 4px;
  --radius-base: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-full: 9999px;
  
  /* Sombras Aprimoradas */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.05);
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.1);
  --shadow-inner: inset 0 2px 4px rgba(0, 0, 0, 0.05);
  
  /* Transições */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --duration-slow: 350ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);
  --ease-bounce: cubic-bezier(0.34, 1.56, 0.64, 1);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_appointment-card.css

/* Em: static/css/components/_appointment-card.css */

.appointment-card {
  background: var(--color-white);
  border-radius: var(--radius-lg);
  padding: var(--space-20);
  border: 1px solid var(--color-border);
  margin-bottom: var(--space-16);
  display: flex;
  
  /* --- MUDANÇAS AQUI --- */
  justify-content: space-between; /* Mantém, mas agora alinha no topo */
  align-items: flex-start;      /* Alinha os itens no topo */
  gap: var(--space-16);         /* Adiciona espaço entre info e ações */
  /* --- FIM DAS MUDANÇAS --- */
  
  transition: transform 0.2s, box-shadow 0.2s;
}

.appointment-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-sm);
}

.appointment-info {
  /* --- MUDANÇA AQUI --- */
  flex-grow: 1; /* Permite que a info ocupe o espaço */
  /* --- FIM DA MUDANÇA --- */
}

.appointment-info h4 {
  margin-bottom: var(--space-8);
  color: var(--color-dark-gray);
}

.appointment-info p {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-12);
}

/* --- MUDANÇA AQUI --- */
/* Estiliza a área de ações/botões */
.appointment-actions {
  display: flex;
  flex-direction: column; /* Empilha os botões */
  gap: var(--space-8);
  flex-shrink: 0;         /* Impede que os botões encolham */
  width: 120px;           /* Define uma largura fixa */
}

.cant-reschedule-text {
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
  text-align: right;
  line-height: var(--line-height-normal);
}

/* --- FIM DAS MUDANÇAS --- */


@media (max-width: 768px) {
  /* No mobile, voltamos ao layout de coluna */
  .appointment-card {
    flex-direction: column;
    align-items: center;
    gap: var(--space-20);
  }
  
  .appointment-info {
    text-align: center; /* Centraliza o texto no mobile */
  }

  .appointment-actions {
    width: 100%;
    margin-top: 0;
    display: flex;
    flex-direction: row; /* Botões lado a lado no mobile */
    justify-content: flex-end;
  }
}

.appointment-card {
  /* ... (estilos existentes) ... */
  display: flex;
  align-items: flex-start; /* Garante que os itens comecem alinhados ao topo */
  gap: var(--space-16);
}

.appointment-image-wrapper {
  flex-shrink: 0; /* Impede que a imagem encolha */
  width: 80px; /* Largura fixa para a imagem */
  height: 80px; /* Altura fixa para a imagem */
  border-radius: var(--radius-base);
  overflow: hidden; /* Garante que a imagem não transborde */
  border: 1px solid var(--color-border);
}

.appointment-service-image {
  width: 100%;
  height: 100%;
  object-fit: cover; /* Faz a imagem cobrir o espaço sem distorcer */
}

.appointment-info {
  flex-grow: 1; /* Permite que o texto cresça */
  display: flex; /* Transforma em flex para alinhar verticalmente */
  flex-direction: column;
}

.appointment-info p {
  margin-bottom: var(--space-4); /* Diminui a margem entre parágrafos */
}

.appointment-professional {
    font-size: var(--font-size-sm);
    color: var(--color-text-gray);
    margin-bottom: var(--space-8) !important; /* Mais espaço antes do status */
}

/* --- Ajuste para mobile --- */
@media (max-width: 768px) {
  .appointment-card {
    flex-direction: column; /* Volta para coluna no mobile */
    align-items: center; /* Centraliza tudo no mobile */
    text-align: center;
  }

  .appointment-image-wrapper {
    margin-bottom: var(--space-12); /* Espaço abaixo da imagem no mobile */
  }

  .appointment-info {
    align-items: center; /* Centraliza o texto no mobile */
  }

  .appointment-actions {
    justify-content: center; /* Centraliza botões no mobile */
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_button.css

/* * Todos os estilos de botões (.btn, .btn--primary, .btn--outline, etc.)
 */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-12) var(--space-24);
  border-radius: var(--radius-full);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border: none;
  text-decoration: none;
  line-height: 1.4;
  position: relative;
  overflow: hidden;
}

.btn::after {
  content: '';
  position: absolute;
  height: 100%;
  width: 100%;
  top: 0;
  left: 0;
  background-color: transparent;
  transform: translateY(100%);
  transition: transform var(--duration-normal) var(--ease-standard);
  pointer-events: none;
}

.btn:active::after {
  transform: translateY(0);
  background-color: rgba(0, 0, 0, 0.1);
}

.btn--primary { 
  background: var(--color-primary); 
  color: var(--color-btn-primary-text); 
  border: 2px solid var(--color-primary); 
  border-bottom-color: var(--color-primary-active);
  box-shadow: none; 
}

.btn--primary:hover { 
  background: var(--color-primary-hover);
  border-color: var(--color-primary-hover);
  border-bottom-color: var(--color-primary-active);
  transform: translateY(-2px); 
  box-shadow: 0 4px 0 var(--color-primary-active);
}

.btn--primary:active {
  transform: translateY(0);
  box-shadow: none;
}

.btn--outline { 
  background: transparent;
  border: 2px solid transparent; 
  color: var(--color-primary);
  font-weight: var(--font-weight-medium);
  box-shadow: inset 0 0 0 2px var(--color-primary);
}

.btn--outline:hover { 
  background: var(--color-primary-light);
  border-color: transparent; 
  color: var(--color-primary);
  transform: translateY(-2px); 
}

.btn--secondary { 
  background: var(--color-light-gray); 
  color: var(--color-text); 
}

.btn--secondary:hover { 
  background: var(--color-medium-gray); 
}

.btn--danger {
  background: var(--color-red);
  color: var(--color-white);
}

.btn--danger:hover {
  background: #e64549;
}

.btn--lg { 
  font-size: var(--font-size-md); 
  padding: var(--space-16) var(--space-32);
}

.btn--sm {
  font-size: var(--font-size-sm);
  padding: var(--space-8) var(--space-16);
}

.btn--full-width { 
  width: 100%; 
}

.btn:disabled { 
  opacity: 0.5; 
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}

.btn .btn-icon {
  display: inline-flex;
  margin-right: var(--space-8);
}

.btn--icon-only {
  width: 40px;
  height: 40px;
  padding: 0;
  border-radius: var(--radius-full);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_calendar.css

/* * Estilos para o .calendar-container e .time-selection.
 */
.calendar-container {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  margin-bottom: var(--space-24);
  box-shadow: var(--shadow-sm);
  margin-top: var(--space-24);
}

.calendar-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: var(--space-24);
}

.calendar-header h3 {
  font-weight: var(--font-weight-semibold);
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: var(--space-8);
}

.day-of-week {
  text-align: center;
  color: var(--color-text-secondary);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
  text-transform: uppercase;
  padding-bottom: var(--space-8);
}

.calendar-day {
  aspect-ratio: 1;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: var(--radius-full);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  font-weight: var(--font-weight-medium);
  position: relative;
  user-select: none;
}

.calendar-day::before {
  content: '';
  position: absolute;
  inset: 2px;
  border-radius: var(--radius-full);
  z-index: -1;
  transition: background-color var(--duration-normal) var(--ease-standard);
}

.calendar-day:hover::before {
  background-color: var(--color-light-gray);
}

.calendar-day.available {
  color: var(--color-text);
}

.calendar-day.today {
  color: var(--color-primary);
  font-weight: var(--font-weight-bold);
}

.calendar-day.today::after {
  content: '';
  position: absolute;
  bottom: 2px;
  width: 4px;
  height: 4px;
  border-radius: var(--radius-full);
  background-color: var(--color-primary);
}

.calendar-day.selected {
  background-color: var(--color-primary); 
  color: var(--color-white);
}

.calendar-day.unavailable {
  color: var(--color-medium-gray);
  cursor: not-allowed;
  text-decoration: line-through;
}

.calendar-day.other-month {
  opacity: 0.3;
  pointer-events: none;
}

.calendar-day.has-availability::after {
  content: '';
  position: absolute;
  bottom: 6px;
  left: 50%;
  transform: translateX(-50%);
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background-color: var(--color-success);
  box-shadow: 0 0 5px rgba(92, 207, 172, 0.7);
}

/* Seleção de Horário */
.time-selection {
  margin-top: var(--space-32);
  animation: fadeIn 0.5s ease;
}

.time-periods-container {
  display: flex;
  flex-direction: column;
  gap: var(--space-24);
}

.time-period {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-20);
  border: 1px solid var(--color-border);
  box-shadow: var(--shadow-xs);
}

.period-title {
  margin-bottom: var(--space-16);
  padding-bottom: var(--space-8);
  border-bottom: 1px solid var(--color-border);
  color: var(--color-text);
}

.time-slots-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
  gap: var(--space-12);
}

.time-slot {
  padding: var(--space-12);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  text-align: center;
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  font-size: var(--font-size-sm);
  background: var(--color-surface);
}

.time-slot:hover {
  background: var(--color-light-gray);
  border-color: var(--color-medium-gray);
  transform: translateY(-2px);
  box-shadow: var(--shadow-xs);
}

.time-slot.selected {
  background: var(--color-primary);
  color: var(--color-white);
  border-color: var(--color-primary);
  transform: translateY(-2px);
  box-shadow: 0 2px 6px rgba(92, 207, 172, 0.3);
}

.time-slot.unavailable {
  opacity: 0.5;
  cursor: not-allowed;
  background: var(--color-light-gray);
}

/* Media Queries */
@media (max-width: 768px) {
  .calendar-container {
    padding: var(--space-16);
  }
  
  .calendar-day {
    font-size: var(--font-size-sm);
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_card.css

/* * Estilos para componentes genéricos em forma de "card".
 * (Cards de serviço, profissional, aviso, etc. estão em arquivos separados)
 */

/* Card de Estado Vazio/Erro */
.empty-state, .error-state {
  text-align: center;
  padding: var(--space-32);
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  max-width: 500px;
  margin: 0 auto;
}

.empty-icon, .error-icon {
  font-size: 3rem;
  margin-bottom: var(--space-16);
  opacity: 0.8;
}

.empty-state h3, .error-state h3 {
  margin-bottom: var(--space-12);
}

.empty-state p, .error-state p {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-24);
}

/* Card de Informação de Serviço (usado no calendário/profissionais) */
.service-info-card {
    display: flex;
    align-items: center;
    gap: var(--space-16);
    padding: var(--space-16);
    border-radius: var(--radius-base);
    box-shadow: var(--shadow-sm);
    
    /* --- MUDANÇAS AQUI --- */
    background: var(--color-primary-light); /* Fundo suave [cite: 883] */
    border: 1px solid var(--color-primary); /* Borda na cor primária */
    /* --- FIM DA MUDANÇA --- */
}

.service-info-card .service-info-img {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-full);
    object-fit: cover;
    flex-shrink: 0; 
}

.service-info-card .service-icon {
    font-size: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: var(--color-primary-light);
    border-radius: var(--radius-full);
    flex-shrink: 0;
}

.service-info-card .service-details {
    flex: 1;
}

.service-info-card .service-meta {
    display: flex;
    align-items: center;
    gap: var(--space-12);
    margin-top: var(--space-4);
}

/* Badge de Status (usado no card de agendamento) */
.status {
  display: inline-block;
  padding: var(--space-4) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.status--success {
  background-color: var(--color-mint-green-light);
  color: var(--color-mint-green-active);
}

.status--warning {
  background-color: var(--color-orange-light);
  color: var(--color-orange);
}

.status--danger {
  background-color: var(--color-red-light);
  color: var(--color-red);
}

/* Para status "Concluído" */
.status--info {
  background-color: var(--color-blue-light);
  color: var(--color-blue);
}

/* Para status "Pendente" */
.status--pending {
  background-color: var(--color-light-gray);
  color: var(--color-text-gray);
  border: 1px solid var(--color-medium-gray);
}

/* * Estilos para componentes genéricos em forma de "card".
 * (Cards de serviço, profissional, aviso, etc. estão em arquivos separados)
 */

/* Card de Estado Vazio/Erro */
.empty-state, .error-state {
  text-align: center;
  padding: var(--space-32);
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-border);
  max-width: 500px;
  margin: 0 auto;
}

.empty-icon, .error-icon {
  font-size: 3rem;
  margin-bottom: var(--space-16);
  opacity: 0.8;
}

.empty-state h3, .error-state h3 {
  margin-bottom: var(--space-12);
}

.empty-state p, .error-state p {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-24);
}

/* Card de Informação de Serviço (usado no calendário/profissionais) */
.service-info-card {
    display: flex;
    align-items: center;
    gap: var(--space-16);
    padding: var(--space-16);
    border-radius: var(--radius-base);
    box-shadow: var(--shadow-sm);
    
    /* --- MUDANÇAS AQUI --- */
    background: var(--color-primary-light);
    [cite_start]/* Fundo suave [cite: 883] */
    border: 1px solid var(--color-primary);
    /* Borda na cor primária */
    /* --- FIM DA MUDANÇA --- */
}

.service-info-card .service-info-img {
    width: 60px;
    height: 60px;
    border-radius: var(--radius-full);
    object-fit: cover;
    flex-shrink: 0; 
}

.service-info-card .service-icon {
    font-size: 2rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 60px;
    height: 60px;
    background: var(--color-primary-light);
    border-radius: var(--radius-full);
    flex-shrink: 0;
}

.service-info-card .service-details {
    flex: 1;
}

.service-info-card .service-meta {
    display: flex;
    align-items: center;
    flex-wrap: wrap; /* <-- NOVO */
    gap: var(--space-4) var(--space-12); /* <-- NOVO */
    margin-top: var(--space-4);
}

/* --- INÍCIO DA NOVA ADIÇÃO --- */
.service-info-card .service-price-signal {
    font-weight: var(--font-weight-medium);
    color: var(--color-text-secondary);
    font-size: 14px;
    width: 100%; /* Faz quebrar a linha */
    margin-top: 4px;
}
/* --- FIM DA NOVA ADIÇÃO --- */


/* Badge de Status (usado no card de agendamento) */
.status {
  display: inline-block;
  padding: var(--space-4) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.status--success {
  background-color: var(--color-mint-green-light);
  color: var(--color-mint-green-active);
}

.status--warning {
  background-color: var(--color-orange-light);
  color: var(--color-orange);
}

.status--danger {
  background-color: var(--color-red-light);
  color: var(--color-red);
}

/* Para status "Concluído" */
.status--info {
  background-color: var(--color-blue-light);
  color: var(--color-blue);
}

/* Para status "Pendente" */
.status--pending {
  background-color: var(--color-light-gray);
  color: var(--color-text-gray);
  border: 1px solid var(--color-medium-gray);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_form.css

/* * Estilos para formulários: .form-group, .form-control, .form-toggle, etc.
 */
.form-group {
  margin-bottom: var(--space-20);
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
}

.form-control {
  display: block;
  width: 100%;
  padding: var(--space-12) var(--space-16);
  font-size: var(--font-size-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-white);
  background-clip: padding-box;
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  transition: border-color var(--duration-fast) ease-in-out, 
              box-shadow var(--duration-fast) ease-in-out;
}

.form-control:focus {
  border-color: var(--color-primary);
  outline: none;
  box-shadow: 0 0 0 3px var(--color-focus-ring);
}

.form-control::placeholder {
  color: var(--color-text-secondary);
  opacity: 0.7;
}

.form-text {
  display: block;
  margin-top: var(--space-4);
  font-size: var(--font-size-xs);
  color: var(--color-text-secondary);
}

.form-control.is-invalid {
  border-color: var(--color-red);
}

.invalid-feedback {
  display: block;
  width: 100%;
  margin-top: var(--space-4);
  font-size: var(--font-size-xs);
  color: var(--color-red);
}

/* Toggle Aprimorado */
.form-toggle {
  display: flex;
  background: var(--color-light-gray);
  border-radius: var(--radius-base);
  padding: var(--space-4);
  margin-bottom: var(--space-24);
  position: relative;
  overflow: hidden;
}

.toggle-btn {
  flex: 1;
  padding: var(--space-12);
  border: none;
  background: transparent;
  border-radius: calc(var(--radius-base) - 2px);
  cursor: pointer;
  font-weight: var(--font-weight-medium);
  color: var(--color-text-secondary);
  position: relative;
  z-index: 1;
  transition: color var(--duration-fast) ease;
}

.toggle-btn.active {
  color: var(--color-text);
}

.form-toggle::before {
  content: '';
  position: absolute;
  height: calc(100% - var(--space-8));
  top: var(--space-4);
  width: calc(50% - var(--space-4));
  background: var(--color-white);
  border-radius: calc(var(--radius-base) - 2px);
  box-shadow: var(--shadow-sm);
  transition: transform var(--duration-normal) var(--ease-standard);
  z-index: 0;
}

.form-toggle.toggle-right::before {
  transform: translateX(calc(100% + var(--space-8)));
}

/* Formulário de lista (para Avisos) */
.form-add-lista {
    display: flex;
    gap: var(--space-8);
    margin-bottom: var(--space-12);
}
.form-add-lista .form-control {
    flex: 1;
}

.lista-preview {
    background: var(--color-light-gray);
    border-radius: var(--radius-base);
    padding: var(--space-8);
    min-height: 40px;
}
.lista-preview-item {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: var(--color-white);
    padding: var(--space-8) var(--space-12);
    border-radius: var(--radius-sm);
    margin: var(--space-8);
    font-size: var(--font-size-sm);
    box-shadow: var(--shadow-xs);
}
.lista-preview-item button {
    background: none;
    border: none;
    color: var(--color-red);
    font-size: 1.25rem;
    cursor: pointer;
    opacity: 0.7;
}
.lista-preview-item button:hover {
    opacity: 1;
}

/* Classe responsiva para linhas de formulário */
.form-row {
  display: flex;
  flex-direction: column; /* No celular, os campos ficam um em cima do outro */
  gap: var(--space-20); /* Espaçamento entre os campos empilhados */
}

.form-row .form-group {
  flex: 1; /* Garante que ocupem espaço */
}

/* No computador (desktop) */
@media (min-width: 768px) {
  .form-row {
    flex-direction: row; /* No desktop, ficam lado a lado */
    gap: var(--space-16); /* Espaçamento entre os campos lado a lado */
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_modal.css

/* * Estilos para pop-ups: .modal-container, .toast, .loading-overlay
 */

/* Modal Padrão */
.modal-container {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(2px);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--duration-normal) ease, visibility var(--duration-normal) ease;
}

.modal-container:not(.hidden) {
  opacity: 1;
  visibility: visible;
}

.modal-content {
  background: var(--color-white);
  border-radius: var(--radius-lg);
  width: 90%;
  max-width: 500px;
  box-shadow: var(--shadow-lg);
  overflow: hidden;
  transform: translateY(20px);
  transition: transform var(--duration-normal) var(--ease-bounce);
}

.modal-container:not(.hidden) .modal-content {
  transform: translateY(0);
}

.modal-header {
  padding: var(--space-16);
  border-bottom: 1px solid var(--color-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  opacity: 0.6;
  transition: opacity var(--duration-fast) ease;
}

.modal-close:hover {
  opacity: 1;
}

.modal-body {
  padding: var(--space-24);
  max-height: 60vh;
  overflow-y: auto;
}

.modal-footer {
  padding: var(--space-16);
  border-top: 1px solid var(--color-border);
  display: flex;
  justify-content: flex-end;
  gap: var(--space-12);
}

/* Toast Notifications */
#toast-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 9999;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.toast {
  min-width: 250px;
  padding: 12px 16px;
  border-radius: var(--radius-base);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  display: flex;
  justify-content: space-between;
  align-items: center;
  transform: translateX(100%);
  opacity: 0;
  transition: transform 0.3s, opacity 0.3s;
}

.toast--visible {
  transform: translateX(0);
  opacity: 1;
}

.toast--hiding {
  transform: translateX(100%);
  opacity: 0;
}

.toast--success {
  background-color: #e6f6f2;
  color: #54a88a;
  border-left: 4px solid #54a88a;
}

.toast--error {
  background-color: #ffebee;
  color: #e53935;
  border-left: 4px solid #e53935;
}

.toast--warning {
  background-color: #fff8e1;
  color: #f57c00;
  border-left: 4px solid #f57c00;
}

.toast--info {
  background-color: #e3f2fd;
  color: #1976d2;
  border-left: 4px solid #1976d2;
}

.toast-close {
  background: none;
  border: none;
  font-size: 16px;
  cursor: pointer;
  margin-left: 10px;
  opacity: 0.6;
}

.toast-close:hover {
  opacity: 1;
}

/* Loading Overlay */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(3px);
  opacity: 0;
  visibility: hidden;
  transition: opacity var(--duration-normal) ease, visibility var(--duration-normal) ease;
}

.loading-overlay:not(.hidden) {
  opacity: 1;
  visibility: visible;
}

.loading-spinner {
  width: 40px;
  height: 40px;
  border: 4px solid var(--color-light-gray);
  border-top-color: var(--color-primary);
  border-radius: 50%;
  animation: spin 1s linear infinite;
  margin-bottom: var(--space-16);
}

/* Portfolio Modal (Tela Cheia) */
.portfolio-modal-container {
  position: fixed;
  inset: 0; 
  background-color: #FFF; 
  z-index: 1000;
  padding: 0; 
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}

.portfolio-modal-container:not(.hidden) {
  opacity: 1;
  visibility: visible;
}

.portfolio-modal-body {
  position: relative;
  width: 100%;
  height: 100vh; 
  background: var(--color-light-gray);
  border-radius: 0; 
  overflow: hidden; 
}

#portfolio-iframe {
  width: 100%;
  height: 100%;
  border: none;
}

.portfolio-modal-close-btn { 
  position: fixed; 
  top: 20px;
  right: 20px;
  z-index: 1005; 
  background-color: rgba(0, 0, 0, 0.5);
  color: white;
  border: none;
  border-radius: 50%;
  width: 40px;
  height: 40px;
  font-size: 1.5rem;
  line-height: 1;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: var(--shadow-md);
  transition: background-color 0.2s ease;
}

.portfolio-modal-close-btn:hover {
  background-color: rgba(0, 0, 0, 0.8);
}

#portfolio-loading {
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.9);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 1002;
}

#portfolio-loading.hidden {
  display: none;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_professional-card.css

/* * Estilos para o Card de Profissional
 */
.professionals-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-16);
    margin-top: var(--space-24);
}

.professional-card {
    background: var(--color-surface);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-20);
    text-align: center;
    cursor: pointer;
    transition: all var(--duration-normal) var(--ease-standard);
    box-shadow: var(--shadow-sm);
}

.professional-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-md);
    border-color: var(--color-primary);
}

.professional-avatar {
    width: 80px;
    height: 80px;
    border-radius: var(--radius-full);
    margin: 0 auto var(--space-16);
    display: flex;
    align-items: center;
    justify-content: center;
    background: var(--color-light-gray);
    overflow: hidden; 
}

.professional-avatar-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.professional-avatar-default {
    font-size: 2rem;
    font-weight: 600;
    color: var(--color-primary);
}

.professional-name {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-dark-gray);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_screen.css

.screen {
  display: none;
  min-height: 100vh;
  animation: fadeIn 0.5s ease-in-out;
  padding-bottom: var(--space-64);
}

#home-screen {
  padding-bottom: 0;
}

.screen.active {
  display: block;
}

/* --- SEÇÃO MODIFICADA --- */

/* * Cabeçalho das Telas (Layout de 3 Colunas)
 * Col 1: Botão Voltar
 * Col 2: Título (Centralizado)
 * Col 3: Placeholder (Para balancear)
*/
.screen-header {
  display: flex;
  align-items: center;
  justify-content: space-between; /* MODIFICADO (era center ) */
  margin-bottom: var(--space-32);
  padding-top: var(--space-24);
  /* position: relative; REMOVIDO [cite: 1055] */
}

.screen-header .btn-back {
  all: unset;
  cursor: pointer;
  font-size: var(--font-size-base);
  color: var(--color-text-gray);
  display: inline-flex;
  align-items: center;
  transition: color var(--duration-fast) ease;
  
  /* NOVAS REGRAS (Substituindo o position: absolute [cite: 1057, 1058]) */
  flex-basis: 90px;
  flex-shrink: 0;
  justify-content: flex-start;
}

.btn-back svg {
  margin-right: var(--space-4);
  transition: transform var(--duration-fast) ease;
}

.btn-back:hover {
  color: var(--color-dark-gray);
}

.btn-back:hover svg {
  transform: translateX(-2px);
}

/* Título (Col 2) */
.screen-header h2 {
  position: relative; 
  padding-bottom: var(--space-12);
  font-size: var(--font-size-xl);
  
  /* --- MODIFICAÇÕES --- */
  display: inline-block; /* ADICIONADO: Faz o H2 ter a largura do texto */
  margin: 0 auto;       /* ADICIONADO: Centra o H2 (que agora é inline-block) no espaço flexível */
}

/* Espaçador (Col 3) */
.header-placeholder {
  flex-basis: 90px; /* Deve ter a mesma largura do .btn-back */
  flex-shrink: 0;
}

/* --- FIM DA SEÇÃO MODIFICADA --- */


.screen-header h2::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0; 
  width: 100%;
  height: 3px; 
  background-color: var(--color-primary);
  border-radius: var(--radius-full);
  transform: scaleX(0);
  transform-origin: center;
  transition: transform 0.6s var(--ease-standard);
}

.screen.active .screen-header h2::after {
  animation: growUnderline 0.7s var(--ease-standard) 0.2s forwards;
}


/* 5. Ajustes para o mobile */
@media (max-width: 768px) {
  
  /* --- SEÇÃO MODIFICADA --- */
  
  /* * A REGRA QUE ESCONDIA O BOTÃO FOI REMOVIDA 
  */
  
  .screen-header {
     align-items: center;
  }
  
  /* Diminui a base do botão (só ícone) */
  .screen-header .btn-back {
    flex-basis: 40px; 
    font-size: 0; /* Esconde texto que não está no span */
  }

  /* Esconde o <span> "Voltar" */
  .screen-header .btn-back span {
    display: none;
  }

  /* Diminui a base do placeholder */
  .header-placeholder {
    flex-basis: 40px;
  }
  
  /* --- FIM DA SEÇÃO MODIFICADA --- */
  
  .screen-header h2 {
    font-size: var(--font-size-lg);
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_service-card.css

/* * Estilos específicos para o Card de Serviço
 */

/* 1. Grade de serviços com padding superior para a imagem flutuar */
.services-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
  margin-top: var(--space-24);
  padding-top: 75px; /* Padrão (Desktop: 150px / 2) */

  /* --- CORREÇÃO AQUI --- */
  /* 1. Remove o 'gap' unificado */
  /* gap: var(--space-32); */ 
  
  /* 2. Define o gap das colunas (horizontal) */
  column-gap: var(--space-32); /* 32px */

  /* 3. Define o gap das linhas (vertical) */
  /* Deve ser MAIOR que o pull-up (75px) */
  row-gap: 100px; /* (75px de pull-up + 25px de espaço livre) */
}

/* 2. Card de serviço sem borda e com overflow visível */
.service-card {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-md);
  transition: all var(--duration-normal) var(--ease-standard);
  display: flex;
  flex-direction: column;
  height: 100%;
  border: none; 
  overflow: visible; 
  
  /* --- ADICIONE ESTAS DUAS LINHAS --- */
  position: relative; /* Isso cria o "prédio" (contexto de empilhamento) */
}

.service-card:hover {
  box-shadow: var(--shadow-lg); 
  transform: translateY(-4px);

  /* --- ADICIONE ESTA LINHA --- */
  z-index: 3; /* Faz o card "saltar" para frente no hover */
}

/* 3. Imagem flutuante */
.service-image {
  height: 150px;           
  width: 150px;            
  border-radius: 50%;      
  margin: 0 auto 0; /* Centraliza */
  background: var(--color-light-gray);
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  
  /* O Efeito Flutuante */
  margin-top: -75px; /* Puxa para cima */
  margin-bottom: var(--space-16);
  border: 4px solid var(--color-white); 
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
  position: relative; 
}

/* 4. Conteúdo do card (sem padding no topo) */
.service-content {
  padding: 0 var(--space-20) var(--space-20) var(--space-20);
  display: flex;
  flex-direction: column;
  flex-grow: 1;
  text-align: center;
  /* --- ADICIONE ESTAS DUAS LINHAS --- */
  position: relative;
  z-index: 1; /* Isso coloca o conteúdo acima da imagem (z-index: auto) */
}

/* Fallback de ícone/emoji */
.service-image-default {
  font-size: 3rem;
  color: var(--color-primary);
}

/* Tag <img> real da imagem */
.service-image-tag {
  width: 100%;
  height: 100%;
  object-fit: cover; 
  transition: transform 0.3s ease;
}

.service-card:hover .service-image-tag {
  transform: scale(1.05); 
}

.service-title {
  font-size: var(--font-size-lg);
  margin-bottom: var(--space-12);
  color: var(--color-dark-gray);
}

.service-description {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-16);
  flex-grow: 1;
}

.service-details {
  display: flex;
  justify-content: center; 
  align-items: center;
  margin-bottom: var(--space-20);
  gap: var(--space-16); 
}

.service-duration {
  background: var(--color-primary-light);
  color: var(--color-primary-active);
  padding: var(--space-4) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.service-price {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-primary);
}

/* Media Query para Mobile */
@media (max-width: 768px) {
  
  .services-grid {
    padding-top: 60px; 
    padding-left: var(--space-8);
    padding-right: var(--space-8);

    /* --- ADICIONE ESTAS DUAS LINHAS --- */
    column-gap: var(--space-24); /* 24px horizontal no mobile */
    row-gap: 84px; /* (60px de pull-up + 24px de espaço livre) */
  }
  
  .service-image {
    width: 120px;
    height: 120px;
    margin-top: -60px; 
  }

  .service-card {
    flex-direction: column;
    align-items: center;
  }
}

/* =================================================== */
/* ANIMAÇÃO DE ENTRADA (STAGGERED)                     */
/* =================================================== */

.service-card--animate {
  /* Começa invisível e 20px para baixo */
  opacity: 0;
  transform: translateY(20px);
  
  /* * Aplica a animação 'fadeInUp' que já existe.
   * 'forwards' garante que o card permaneça visível (opacity: 1) 
   * após a animação terminar.
  */
  animation: fadeInUp 0.5s var(--ease-standard) forwards;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\components\_warning-card.css

/* * Estilos para o Card de Aviso (na tela de instruções)
 */
.warning-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  box-shadow: var(--shadow-sm);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.warning-card:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.warning-icon {
  font-size: 2rem;
  margin-bottom: var(--space-16);
  color: var(--color-warning);
}

.warning-card h3 {
  margin-bottom: var(--space-16);
  color: var(--color-dark-gray);
}

.warning-card ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.warning-card li {
  list-style: none; 
  padding: var(--space-8) 0 var(--space-8) var(--space-20);
  position: relative;
  color: var(--color-text-secondary);
}

.warning-card li:before {
  content: "";
  position: absolute;
  left: 0;
  top: calc(var(--space-8) + 8px);
  width: 8px;
  height: 8px;
  border-radius: var(--radius-full);
  background-color: var(--color-primary);
}

/* Animação de slide-in para mobile */
@media (max-width: 768px) {
  #warnings-screen .warning-card {
    opacity: 0; 
    animation: slideInFromLeft 0.5s var(--ease-standard) forwards;
  }

  #warnings-screen .warning-card:nth-child(2) {
    animation-delay: 0.1s;
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\base\_animations.css

/* * Animações e Keyframes do DASHBOARD
 * (Baseado em dashboard.css [cite: 895-897])
 */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes modalEnter {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\base\_base.css

/* static/css/dashboard/base/_base.css */
*,
*::before,
*::after {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: var(--font-family-base);
  background-color: var(--color-gray-50);
  color: var(--color-gray-700);
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\base\_typography.css

/* static/css/dashboard/base/_typography.css */
h1, h2, h3, h4, h5 {
  font-family: var(--font-family-base);
  font-weight: var(--font-weight-bold);
  color: var(--color-gray-900);
  line-height: 1.3;
}

h1 { font-size: 2.25rem; } /* 36px */
h2 { font-size: 1.875rem; } /* 30px */
h3 { font-size: 1.5rem; } /* 24px */
h4 { font-size: 1.25rem; } /* 20px */
h5 { font-size: 1.125rem; } /* 18px */

p {
  color: var(--color-gray-700);
  line-height: 1.6;
}

a {
  color: var(--color-primary);
  text-decoration: none;
  transition: var(--transition-fast);
}
a:hover {
  color: var(--color-primary-hover);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\base\_utils.css

/* * Classes utilitárias do DASHBOARD
 * (Baseado em dashboard.css [cite: 907-908])
 */
.hidden {
  display: none !important;
}

.text-center {
  text-align: center;
}

.mb-4 {
  margin-bottom: var(--space-16);
}

.mt-4 {
  margin-top: var(--space-16);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\base\_variables.css

/* static/css/dashboard/base/_variables.css */
:root {
  /* Paleta de Cores Primária (Azul Profissional) */
  --color-primary: #0D99FF;
  --color-primary-hover: #007BE5;
  --color-primary-active: #005DBA;
  --color-primary-light: #E3F2FD;

  /* Cores Neutras */
  --color-white: #ffffff;
  --color-gray-50: #f7fafc;  /* Fundo do conteúdo */
  --color-gray-100: #edf2f7; /* Bordas suaves */
  --color-gray-300: #e2e8f0; /* Bordas de inputs */
  --color-gray-500: #a0aec0; /* Texto secundário */
  --color-gray-700: #4a5568; /* Texto principal */
  --color-gray-900: #1a202c; /* Fundo da Sidebar, Títulos */

  /* Cores de Status */
  --color-success: #38A169;
  --color-success-light: #E6F6F2;
  --color-warning: #FF9500;
  --color-warning-light: #FFF8E1;
  --color-danger: #FF5A5F;
  --color-danger-light: #FFEBEE;

  /* Tipografia */
  --font-family-base: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 600;
  --font-weight-bold: 700;

  /* Espaçamento */
  --space-4: 4px;
  --space-8: 8px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Bordas e Sombras */
  --radius-base: 8px;
  --radius-lg: 12px;
  --radius-full: 9999px;
  --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.05), 0 1px 2px 0 rgba(0, 0, 0, 0.03);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.07), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);

  /* Transições */
  --transition-fast: all 150ms ease-out;
  --transition-slow: all 300ms ease-out;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_badge.css

/* static/css/dashboard/components/_badge.css */
.status {
  display: inline-block;
  padding: var(--space-4) var(--space-12);
  border-radius: var(--radius-full);
  font-size: 0.75rem;
  font-weight: 600;
  text-transform: uppercase;
}
.status--success {
  background-color: var(--color-success-light);
  color: var(--color-success);
}
.status--warning {
  background-color: var(--color-warning-light);
  color: var(--color-warning);
}
.status--danger {
  background-color: var(--color-danger-light);
  color: var(--color-danger);
}
.status--info {
  background-color: var(--color-primary-light);
  color: var(--color-primary);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_button.css

/* static/css/dashboard/components/_button.css */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-12) var(--space-16);
  border-radius: var(--radius-base);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: var(--transition-fast);
  border: 1px solid transparent;
  text-decoration: none;
  font-size: 0.875rem;
}

.btn svg {
  width: 16px;
  height: 16px;
  margin-right: var(--space-8);
}

.btn--primary {
  background-color: var(--color-primary);
  color: var(--color-white);
  border-color: var(--color-primary);
}
.btn--primary:hover {
  background-color: var(--color-primary-hover);
  border-color: var(--color-primary-hover);
  transform: translateY(-1px);
}

.btn--outline {
  background-color: transparent;
  border: 1px solid var(--color-gray-300);
  color: var(--color-gray-700);
}
.btn--outline:hover {
  background-color: var(--color-gray-50);
  border-color: var(--color-gray-500);
}

.btn--sm {
  padding: var(--space-8) var(--space-12);
  font-size: 0.75rem;
}
.btn--lg {
  padding: var(--space-16) var(--space-20);
  font-size: 1rem;
}
.btn--full-width {
  width: 100%;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_calendar.css

/* static/css/dashboard/components/_calendar.css */
#calendar {
}
.fc .fc-toolbar-title {
  font-size: 1.5rem;
  font-weight: 600;
  color: var(--color-gray-900);
}
.fc-daygrid-day.fc-day-today {
  background-color: var(--color-primary-light) !important;
}
.fc-event {
  cursor: pointer;
  border-radius: var(--radius-base) !important;
  padding: var(--space-4) var(--space-8) !important;
  font-size: 0.8rem !important;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_card.css

/* static/css/dashboard/components/_card.css */

.dashboard-card {
  margin-bottom: var(--space-24);
  background-color: var(--color-white);
  border-radius: var(--radius-lg);
  border: none;
  box-shadow: var(--shadow-md);
  transition: var(--transition-slow);
  overflow: hidden; /* Para cabeçalhos arredondados */
  display: flex;
  flex-direction: column;
}

.dashboard-card:hover {
  box-shadow: var(--shadow-lg);
  transform: translateY(-2px);
}

.dashboard-card-title {
  padding: var(--space-20) var(--space-24);
  margin: 0;
  border-bottom: 1px solid var(--color-gray-100);
  font-size: 1.25rem;
  font-weight: 600;
  color: var(--color-gray-900);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.dashboard-card-body {
  padding: var(--space-24);
  flex: 1;
  display: flex;
  flex-direction: column;
}

/* Grid de Estatísticas (Visão Geral) */
.stats-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-16);
  margin-bottom: var(--space-24);
}

.stat-card {
  background-color: var(--color-white);
  border-radius: var(--radius-lg);
  padding: var(--space-20);
  border: none;
  box-shadow: var(--shadow-sm);
  transition: var(--transition-slow);
}
.stat-card:hover {
  box-shadow: var(--shadow-md);
  transform: translateY(-2px);
}

.stat-title {
  color: var(--color-gray-500);
  font-size: 0.875rem;
  font-weight: var(--font-weight-medium);
  margin-bottom: var(--space-8);
}

.stat-value {
  font-size: 2.25rem;
  font-weight: 700;
  color: var(--color-gray-900);
  margin-bottom: var(--space-4);
}

.stat-description {
  color: var(--color-gray-500);
  font-size: 0.875rem;
  margin-top: auto;
}

.stat-positive {
  color: var(--color-success);
}
.stat-negative {
  color: var(--color-danger);
}

/* Grids do layout do dashboard */
.dashboard-grid {
  display: grid;
  grid-template-columns: 1fr;
  gap: var(--space-24);
}

/* Desktop Overrides */
@media (min-width: 576px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
}

@media (min-width: 992px) {
  .stats-grid {
    grid-template-columns: repeat(4, 1fr);
  }
  .dashboard-grid {
    grid-template-columns: 2fr 1fr; /* Coluna 2/3 e 1/3 */
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_chart.css

/* static/css/dashboard/components/_chart.css */
.chart-container {
  position: relative;
  height: 300px; /* Altura padrão */
  max-height: 50vh;
  margin: var(--space-20) 0;
  width: 100%;
}
/* Para gráficos menores, como na visão geral */
.dashboard-grid .chart-container {
  height: 250px;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_form.css

/* static/css/dashboard/components/_form.css */
.form-row {
  display: flex;
  flex-direction: column;
  gap: var(--space-16);
  margin-bottom: var(--space-20);
}
.form-group {
  flex: 1;
}

.form-label {
  display: block;
  margin-bottom: var(--space-8);
  font-weight: var(--font-weight-medium);
  color: var(--color-gray-700);
  font-size: 0.875rem;
}

.form-control,
.form-control-static {
  width: 100%;
  padding: var(--space-12) var(--space-16);
  border: 1px solid var(--color-gray-300);
  border-radius: var(--radius-base);
  background-color: var(--color-white);
  transition: var(--transition-fast);
  font-size: 1rem;
  color: var(--color-gray-900);
}
.form-control-static {
  background-color: var(--color-gray-50);
}

.form-control:focus {
  border-color: var(--color-primary);
  box-shadow: 0 0 0 3px var(--color-primary-light);
  outline: none;
}
.form-text {
  font-size: 0.875rem;
  color: var(--color-gray-500);
  margin-top: var(--space-8);
}
textarea.form-control {
  min-height: 100px;
}
.checkbox {
  display: flex;
  align-items: center;
  gap: var(--space-8);
}
.checkbox label {
  font-weight: var(--font-weight-medium);
}

/* O container que substitui o <select> */
.flags-container {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-8);
    padding: var(--space-8);
    border: 1px solid var(--color-gray-300);
    border-radius: var(--radius-base);
    min-height: 80px; /* Altura similar ao select multiple */
}

/* O botão individual (flag/toggle) */
.flag-item-toggle {
    display: inline-block;
    background-color: var(--color-gray-50);
    border: 1px solid var(--color-gray-300);
    color: var(--color-gray-700);
    padding: var(--space-8) var(--space-12);
    border-radius: var(--radius-base);
    cursor: pointer;
    transition: all var(--transition-fast);
    user-select: none; /* Impede seleção de texto ao clicar */
    font-size: 0.875rem; /* 14px */
}

.flag-item-toggle:hover {
    background-color: var(--color-gray-100);
}

/* Estado selecionado */
.flag-item-toggle.selected {
    background-color: var(--color-primary-light);
    border-color: var(--color-primary);
    color: var(--color-primary-active);
    font-weight: var(--font-weight-medium);
    box-shadow: 0 0 0 1px var(--color-primary); /* Destaque extra */
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_modal.css

/* static/css/dashboard/components/_modal.css */
.modal-container {
  position: fixed;
  inset: 0;
  background-color: rgba(0, 0, 0, 0.5);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  backdrop-filter: blur(3px);
  animation: fadeIn 0.2s ease;
}
.modal-content {
  background-color: var(--color-white);
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-lg);
  width: 95%;
  max-width: 600px;
  max-height: 90vh;
  overflow-y: auto;
}
.modal-header {
  padding: var(--space-16) var(--space-24);
  border-bottom: 1px solid var(--color-gray-100);
  display: flex;
  align-items: center;
  justify-content: space-between;
}
.modal-header h3 {
  margin: 0;
  font-size: 1.25rem;
}
.modal-body {
  padding: var(--space-24);
}
.modal-footer {
  padding: var(--space-16) var(--space-24);
  border-top: 1px solid var(--color-gray-100);
  display: flex;
  justify-content: flex-end;
  gap: var(--space-12);
}
.modal-close {
  background: none;
  border: none;
  font-size: 1.5rem;
  cursor: pointer;
  color: var(--color-gray-500);
  transition: var(--transition-fast);
}
.modal-close:hover {
  color: var(--color-gray-900);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_table.css

/* static/css/dashboard/components/_table.css */
.data-table-container {
  overflow-x: auto;
  border: 1px solid var(--color-gray-100);
  border-radius: var(--radius-lg);
  background-color: var(--color-white);
}

.data-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.875rem;
}

.data-table th,
.data-table td {
  padding: var(--space-16);
  text-align: left;
  border-bottom: 1px solid var(--color-gray-100);
  white-space: nowrap;
}

.data-table th {
  background-color: var(--color-gray-50);
  color: var(--color-gray-500);
  font-weight: 600;
  text-transform: uppercase;
  font-size: 0.75rem;
  letter-spacing: 0.5px;
}

.data-table tbody tr:last-child td {
  border-bottom: none;
}

.data-table tbody tr:hover {
  background-color: var(--color-primary-light);
}

.data-table tfoot th,
.data-table tfoot td {
  font-weight: bold;
  font-size: 1rem;
  background-color: var(--color-gray-50);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_tabs.css

/* static/css/dashboard/components/_tabs.css */

.dashboard-tabs, .report-filters {
  display: flex;
  flex-wrap: wrap; /* Permite quebrar linha no mobile */
  background-color: transparent;
  padding: 0;
  margin-bottom: var(--space-20);
  border-bottom: 2px solid var(--color-gray-100);
}

.tab-btn, .filter-btn {
  flex: 0;
  padding: var(--space-12) var(--space-16);
  border: none;
  background: transparent;
  border-radius: 0;
  cursor: pointer;
  font-weight: 500;
  color: var(--color-gray-500);
  transition: var(--transition-fast);
  margin-bottom: -2px; /* Puxa para baixo para tocar a borda */
  border-bottom: 2px solid transparent;
}
.tab-btn:hover, .filter-btn:hover {
  color: var(--color-gray-700);
}

.tab-btn.active, .filter-btn.active {
  color: var(--color-primary);
  border-bottom-color: var(--color-primary);
  font-weight: 600;
}

.tab-content {
  animation: fadeIn 0.3s ease;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\components\_utils.css

/* static/css/dashboard/components/_utils.css */
.hidden {
  display: none !important;
}
.text-center {
  text-align: center;
}
.mb-4 {
  margin-bottom: var(--space-16);
}
.mt-4 {
  margin-top: var(--space-16);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\dashboard\layout\_layout.css

/* static/css/dashboard/layout/_layout.css */

/* Mobile-First: Layout em coluna */
.dashboard-container {
  display: flex;
  flex-direction: column;
  min-height: 100vh;
  background-color: var(--color-gray-50);
}

.dashboard-sidebar {
  width: 100%;
  background-color: var(--color-gray-900);
  color: var(--color-white);
  border-bottom: 1px solid var(--color-gray-700);
  z-index: 10;
  padding: var(--space-8);
}

.sidebar-header {
  padding: var(--space-12) var(--space-16);
  border-bottom: 1px solid var(--color-gray-700);
  display: block; /* Visível no mobile e desktop */
}

.sidebar-header h2 {
  color: var(--color-white);
  font-weight: 600;
  margin: 0;
  font-size: 1.25rem;
}

.sidebar-nav {
  list-style: none;
  padding: var(--space-8) 0;
  margin: 0;
  display: flex;
  overflow-x: auto; /* Scroll horizontal no mobile */
}

.sidebar-nav li {
  margin: 0 var(--space-4);
  flex-shrink: 0;
}

.sidebar-nav a {
  display: flex;
  align-items: center;
  padding: var(--space-12) var(--space-16);
  color: var(--color-gray-300);
  text-decoration: none;
  transition: var(--transition-fast);
  border-radius: var(--radius-base);
  white-space: nowrap;
  font-weight: var(--font-weight-medium);
}

.sidebar-nav a:hover {
  background-color: var(--color-gray-700);
  color: var(--color-white);
}

.sidebar-nav a.active {
  background-color: var(--color-primary);
  color: var(--color-white);
  font-weight: 600;
}

.sidebar-nav a svg {
  margin-right: var(--space-12);
  width: 20px;
  height: 20px;
  flex-shrink: 0;
}

.dashboard-content {
  flex: 1;
  padding: var(--space-16);
  overflow-y: auto;
}

/* Desktop Overrides */
@media (min-width: 768px) {
  .dashboard-container {
    flex-direction: row;
    height: 100vh; /* NOVO: Trava a altura total do container */
    overflow: hidden; /* NOVO: Impede o container de rolar */
  }

  .dashboard-sidebar {
    width: 260px;
    height: 100vh;
    border-right: 1px solid var(--color-gray-100);
    border-bottom: none;
    padding: var(--space-16);
    display: flex;
    flex-direction: column;
    
    /* --- MODIFICAÇÕES --- */
    position: fixed; /* NOVO: Fixa a sidebar na tela */
    top: 0;          /* NOVO: Alinha no topo */
    left: 0;         /* NOVO: Alinha na esquerda */
    z-index: 100;    /* NOVO: Garante que fique por cima de tudo */
  }
  
  .sidebar-header {
     padding: var(--space-16);
  }

  .sidebar-nav {
    display: flex;
    flex-direction: column;
    overflow-x: hidden;
    margin: var(--space-16) 0;
    
    /* --- NOVO (para scroll interno se o menu for grande) --- */
    flex: 1; /* Ocupa o espaço restante dentro da sidebar */
    overflow-y: auto; /* Adiciona scroll SÓ no menu se ele for maior que a tela */
  }

  .sidebar-nav li {
    margin: 0 0 var(--space-8) 0;
  }
  
  .dashboard-content {
    padding: var(--space-32);
    
    /* --- MODIFICAÇÕES --- */
    /* width: calc(100% - 260px); REMOVIDO */
    margin-left: 260px; /* NOVO: Empurra o conteúdo para a direita (largura da sidebar) */
    width: 100%; /* NOVO: Faz o conteúdo ocupar o espaço restante */
    height: 100vh; /* NOVO: Trava a altura do conteúdo à tela */
    /* overflow-y: auto; (Esta regra já existe na base [cite: 1135] e fará o conteúdo rolar) */
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\layout\_client-area.css

/* * Estilos para a Área do Cliente (Barra de Usuário, lista de agendamentos)
 */
.user-bar {
  background: var(--color-primary);
  color: var(--color-white);
  padding: var(--space-8) 0;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.user-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.user-info span {
  font-weight: var(--font-weight-medium);
}

.user-actions {
  display: flex;
  gap: var(--space-16);
}

.user-action {
  color: var(--color-white);
  text-decoration: none;
  opacity: 0.9;
  font-size: var(--font-size-sm);
  transition: opacity var(--duration-fast) ease;
}

.user-action:hover {
  opacity: 1;
  text-decoration: underline;
}

.appointments-section {
  margin-bottom: var(--space-32);
  animation: fadeIn 0.5s ease;
}

@media (max-width: 768px) {
  .user-info {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--space-8);
  }
  
  .user-actions {
    width: 100%;
    justify-content: space-between;
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\layout\_confirmation.css

/* * Estilos para a Tela de Confirmação
 */
.confirmation-content {
  text-align: center;
  max-width: 600px;
  margin: 0 auto;
  padding-top: var(--space-32);
}

.success-icon {
  font-size: 4rem;
  margin-bottom: var(--space-24);
  color: var(--color-success);
  animation: bounceIn 0.6s var(--ease-bounce);
}

.confirmation-content h2 {
  color: var(--color-success);
  margin-bottom: var(--space-16);
}

.confirmation-content p {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-32);
  max-width: 400px;
  margin-left: auto;
  margin-right: auto;
}

.booking-details {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  margin-bottom: var(--space-32);
  text-align: left;
  box-shadow: var(--shadow-sm);
  border: 1px solid var(--color-border);
}

.confirmation-actions {
  display: flex;
  gap: var(--space-16);
  justify-content: center;
  flex-wrap: wrap;
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\layout\_home.css

/* * Estilos de layout para a Home Screen (.hero-container, .logo, etc.)
 */
.hero-container {
  min-height: 100vh;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
  background: linear-gradient(135deg, hsla(var(--color-secondary-h), var(--color-secondary-s), var(--color-secondary-l), 0.3) 0%, hsl(var(--color-primary-h), var(--color-primary-s), 95%, 0.5) 100%);
  position: relative;
  overflow: hidden;
}

.hero-overlay {
  position: absolute;
  inset: 0;
  background-image: radial-gradient(hsl(var(--color-primary-h), var(--color-primary-s), 90%) 6px, transparent 2px);
  background-size: 30px 30px;
  opacity: 0.5;
}

.hero-content {
  position: relative;
  z-index: 2;
  max-width: 700px;
  padding: var(--space-24);
}

.logo-section {
  margin-bottom: var(--space-32);
  animation: fadeInUp 1s ease-out;
}

.logo {
  font-size: var(--font-size-3xl);
  color: var(--color-dark-gray);
  margin-bottom: var(--space-16);
  font-weight: var(--font-weight-bold);
  background: linear-gradient(120deg, 
      var(--color-primary), 
      var(--color-secondary),
      var(--color-primary));
  background-size: 200% auto; 
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  animation: gradientShift 3s ease infinite;
  letter-spacing: -0.5px;
}

.negocio-logo {
  width: 160px; 
  height: 160px;
  border-radius: 50%;
  object-fit: cover;
  margin: 0 auto var(--space-24); 
  border: 5px solid var(--color-white);
  box-shadow: 
      0 0 0 3px var(--color-white), 
      0 0 0 7px var(--color-secondary),
      0 0 40px rgba(0, 0, 0, 0.15),
      0 0 80px hsla(var(--color-secondary-h), var(--color-secondary-s), var(--color-secondary-l), 0.3);
  display: block;
  transform: scale(0) rotate(-180deg);
  opacity: 0;
  animation: scaleInBounce 0.6s var(--ease-bounce) 0.3s forwards;
  position: relative;
  overflow: hidden;
  transition: transform 0.3s ease;
}

.negocio-logo:hover {
  transform: scale(1.05) rotate(5deg);
}

.tagline {
  font-size: var(--font-size-lg);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-normal);
}

.action-buttons {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
  align-items: center;
  animation: fadeInUp 1s ease-out 0.3s both;
}

.admin-login-link {
    text-align: center;
    margin-top: var(--space-24);
}

.admin-login-link a {
    color: var(--color-text-secondary);
    font-size: var(--font-size-sm);
    text-decoration: none;
    transition: color 0.2s;
}

.admin-login-link a:hover {
    color: var(--color-text);
    text-decoration: underline;
}

/* Botões finos da Home */
.action-buttons .btn {
    width: 250px; 
    max-width: 90vw; 
    padding-top: var(--space-8) !important;
    padding-bottom: var(--space-8) !important;
    padding-left: var(--space-32) !important;
    padding-right: var(--space-32) !important;
}

/* Media Queries para Home */
@media (max-width: 767px) {
    .hero-container {
        align-items: flex-start; 
    }
    
    .hero-content {
        padding-top: 10vh; 
        padding-bottom: var(--space-64); 
    }

    .logo-section {
        margin-bottom: var(--space-64); 
    }

    .logo {
      font-size: var(--font-size-2xl);
    }
    
    .tagline {
      font-size: var(--font-size-md);
    }
}

@media (min-width: 768px) {
    .action-buttons {
      flex-direction: row;
      justify-content: center;
    }
  
    .action-buttons .btn {
        width: auto; 
        padding-top: var(--space-8) !important;
        padding-bottom: var(--space-8) !important;
        padding-left: var(--space-32) !important;
        padding-right: var(--space-32) !important;
    }

    .logo-section {
        margin-bottom: var(--space-48);
    }
    
    .hero-content {
      transform: translateY(-60px);
    }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\layout\_login.css

/* * Estilos de layout para a Tela de Login/Cadastro
 */
.login-container {
  display: grid;
  gap: var(--space-32);
  grid-template-columns: 1fr;
  max-width: 800px;
  margin: 0 auto;
  width: 100%;
}

.login-form-section {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  box-shadow: var(--shadow-sm);
}

.booking-summary {
  background: var(--color-mint-green-light);
  border: 1px solid var(--color-primary);
  border-radius: var(--radius-lg);
  padding: var(--space-24);
  height: fit-content;
  box-shadow: var(--shadow-sm);
  position: relative;
  overflow: hidden;
}

.booking-summary::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(to right, var(--color-primary), var(--color-primary-hover));
}

.booking-summary h3 {
  margin-bottom: var(--space-20);
  color: var(--color-primary-active);
}

.summary-item {
  display: flex;
  justify-content: space-between;
  padding: var(--space-12) 0;
  border-bottom: 1px solid rgba(var(--color-primary-rgb), 0.2);
}

.summary-item .label {
  color: var(--color-text-secondary);
}

.summary-item .value {
  font-weight: var(--font-weight-semibold);
}

.summary-total {
  display: flex;
  justify-content: space-between;
  padding-top: var(--space-16);
  margin-top: var(--space-16);
  font-size: var(--font-size-md);
  font-weight: var(--font-weight-semibold);
}

.summary-total .value {
  color: var(--color-primary);
}

/* Mensagem de "Já logado" */
.auth-success-message {
  text-align: center;
  padding: var(--space-24);
}

.auth-success-message .success-icon {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 60px;
  height: 60px;
  background-color: var(--color-mint-green-light);
  border-radius: var(--radius-full);
  margin: 0 auto var(--space-20);
  font-size: var(--font-size-xl);
  color: var(--color-primary);
}

.auth-success-message h3 {
  margin-bottom: var(--space-12);
  color: var(--color-success);
}

.auth-success-message p {
  color: var(--color-text-secondary);
  margin-bottom: var(--space-8);
}

.auth-actions {
  display: flex;
  gap: var(--space-12);
  margin-top: var(--space-20);
  justify-content: center;
}


@media (min-width: 768px) {
  .login-container {
    grid-template-columns: 1fr 350px;
  }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\css\layout\_warnings.css

/* * Estilos para a Tela de Avisos
 */
.warnings-content {
  display: flex;
  flex-direction: column;
  gap: var(--space-16); 
}

.continue-section {
  margin-top: var(--space-32);
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\admin.js

// static/js/admin.js
// Sistema de gerenciamento administrativo


window.showAdminLoginScreen = function(event) {
    if (event) {
        event.preventDefault();
    }
    showScreen('admin-login-screen');
};

/**
 * Carrega o conteúdo da área administrativa
 */
function loadAdminContent() {
    // Por padrão, carrega a primeira aba (agendamentos)
    loadAdminAppointments();
    
    // Marca o botão da primeira aba como ativo
    const tabs = document.querySelectorAll('.tab-btn');
    if (tabs.length > 0) {
        tabs.forEach(tab => tab.classList.remove('active'));
        tabs[0].classList.add('active');
    }
}

/**
 * Alterna entre as abas administrativas
 * @param {string} tabName - Nome da aba a ser exibida
 * @param {Event} event - Evento de clique
 */
window.showAdminTab = function(tabName, event) {
    // Atualiza estado visual dos botões
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Oculta todos os conteúdos
    document.querySelectorAll('.admin-content').forEach(content => content.classList.add('hidden'));
    
    // Exibe o conteúdo selecionado
    const targetContent = document.getElementById(`admin-${tabName}`);
    if (targetContent) {
        targetContent.classList.remove('hidden');
        
        // Carrega o conteúdo específico da aba
        if (tabName === 'appointments') {
            loadAdminAppointments();
        } else if (tabName === 'services') {
            loadAdminServices();
        }
    }
};

/**
 * Carrega a lista de agendamentos para a área administrativa
 */
async function loadAdminAppointments() {
    const list = document.getElementById('admin-appointments-list');
    if (!list) return;
    
    // Exibe estado de carregamento
    list.innerHTML = `
        <div class="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Carregando agendamentos...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/agendamentos/');
        
        if (!response.ok) {
            throw new Error('Falha ao carregar agendamentos.');
        }
        
        const appointments = await response.json();
        
        // Verifica se há agendamentos
        if (appointments.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">📅</div>
                    <h3>Nenhum agendamento</h3>
                    <p>Não há agendamentos registrados no sistema.</p>
                </div>
            `;
            return;
        }
        
        // Limpa o container
        list.innerHTML = '';
        
        // Agrupa agendamentos por data
        const appointmentsByDate = {};
        
        appointments.forEach(apt => {
            if (!appointmentsByDate[apt.date]) {
                appointmentsByDate[apt.date] = [];
            }
            appointmentsByDate[apt.date].push(apt);
        });
        
        // Organiza as datas em ordem cronológica
        const sortedDates = Object.keys(appointmentsByDate).sort();
        
        // Cria seções para cada data
        sortedDates.forEach(date => {
            const [year, month, day] = date.split('-');
            const formattedDate = `${day}/${month}/${year}`;
            
            const dateSection = document.createElement('div');
            dateSection.className = 'admin-date-section';
            dateSection.innerHTML = `<h3 class="date-header">${formattedDate}</h3>`;
            
            const appointmentsGroup = document.createElement('div');
            appointmentsGroup.className = 'admin-appointments-group';
            
            // Ordena agendamentos por horário
            const sortedAppointments = appointmentsByDate[date].sort((a, b) => {
                return a.time.localeCompare(b.time);
            });
            
            // Adiciona cada agendamento
            sortedAppointments.forEach(apt => {
                const appointmentCard = createAdminAppointmentCard(apt);
                appointmentsGroup.appendChild(appointmentCard);
            });
            
            dateSection.appendChild(appointmentsGroup);
            list.appendChild(dateSection);
        });
        
    } catch (error) {
        console.error('Erro ao carregar agendamentos:', error);
        
        list.innerHTML = `
            <div class="error-state">
                <div class="error-icon">⚠️</div>
                <h3>Erro ao carregar agendamentos</h3>
                <p>Ocorreu um erro ao buscar os agendamentos.</p>
                <button class="btn btn--outline" onclick="loadAdminAppointments()">
                    Tentar Novamente
                </button>
            </div>
        `;
    }
}

/**
 * Cria um card de agendamento para a área administrativa
 * @param {Object} appointment - Dados do agendamento
 * @returns {HTMLElement} - Elemento HTML do card
 */
function createAdminAppointmentCard(appointment) {
    const card = document.createElement('div');
    card.className = 'admin-appointment-card';
    
    // Define a classe de status
    const statusClass = appointment.status === 'Confirmado' ? 'success' : 
                        appointment.status === 'Cancelado' ? 'danger' : 'warning';
    
    card.innerHTML = `
        <div class="admin-appointment-info">
            <div class="appointment-time">${appointment.time}</div>
            <div class="appointment-details">
                <h4>${appointment.service}</h4>
                <p class="client-name">${appointment.client}</p>
                <span class="status status--${statusClass}">${appointment.status}</span>
            </div>
        </div>
        <div class="admin-actions">
            <button class="btn btn--sm btn--outline" 
                    onclick="viewAppointmentDetails(${appointment.id})">
                Detalhes
            </button>
        </div>
    `;
    
    return card;
}

/**
 * Exibe detalhes de um agendamento específico
 * @param {number} appointmentId - ID do agendamento
 */
window.viewAppointmentDetails = function(appointmentId) {
    // Nesta implementação simplificada, apenas exibe um modal com uma mensagem
    // Em uma implementação completa, buscaria detalhes adicionais do servidor
    
    showModal({
        title: 'Detalhes do Agendamento',
        message: `
            <p>Detalhes completos do agendamento #${appointmentId}.</p>
            <p class="text-secondary">Para gerenciar este agendamento, utilize a interface administrativa do Django.</p>
            <div class="admin-link-container mt-4">
                <a href="/admin/agendamentos/agendamento/${appointmentId}/change/" 
                   target="_blank" class="btn btn--primary">
                    Abrir no Admin Django
                </a>
            </div>
        `,
        confirmText: 'Fechar',
        showCancel: false
    });
};

/**
 * Carrega a lista de serviços para a área administrativa
 */
async function loadAdminServices() {
    const list = document.getElementById('admin-services-list');
    if (!list) return;
    
    // Exibe estado de carregamento
    list.innerHTML = `
        <div class="loading-indicator">
            <div class="loading-spinner"></div>
            <p>Carregando serviços...</p>
        </div>
    `;
    
    try {
        const response = await fetch('/api/servicos/');
        
        if (!response.ok) {
            throw new Error('Falha ao carregar serviços.');
        }
        
        const services = await response.json();
        
        // Verifica se há serviços
        if (services.length === 0) {
            list.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">💇‍♀️</div>
                    <h3>Nenhum serviço</h3>
                    <p>Não há serviços cadastrados no sistema.</p>
                    <a href="/admin/agendamentos/servico/add/" target="_blank" class="btn btn--primary">
                        Adicionar Serviço
                    </a>
                </div>
            `;
            return;
        }
        
        // Limpa o container
        list.innerHTML = '';
        
        // Adiciona cada serviço
        services.forEach(service => {
            const serviceCard = createAdminServiceCard(service);
            list.appendChild(serviceCard);
        });
        
        // Adiciona link para o admin do Django
        list.insertAdjacentHTML('beforeend', `
            <div class="admin-django-link">
                <p>Para adicionar ou editar serviços, use a 
                   <a href="/admin/agendamentos/servico/" target="_blank">Área de Administração do Django</a>.
                </p>
            </div>
        `);
        
    } catch (error) {
        console.error('Erro ao carregar serviços:', error);
        
        list.innerHTML = `
            <div class="error-state">
                <div class="error-icon">⚠️</div>
                <h3>Erro ao carregar serviços</h3>
                <p>Ocorreu um erro ao buscar os serviços.</p>
                <button class="btn btn--outline" onclick="loadAdminServices()">
                    Tentar Novamente
                </button>
            </div>
        `;
    }
}

/**
 * Cria um card de serviço para a área administrativa
 * @param {Object} service - Dados do serviço
 * @returns {HTMLElement} - Elemento HTML do card
 */
function createAdminServiceCard(service) {
    const card = document.createElement('div');
    card.className = 'admin-service-card';
    
    // Formata preço para exibição
    const preco = service.price.toFixed(2).replace('.', ',');
    
    // Prepara a duração para exibição
    const duracao = service.duracao_formatada || `${service.duracao_minutos} min`;
    
    card.innerHTML = `
        <div class="admin-service-info">
            <div class="service-icon-small">${service.icon}</div>
            <div class="service-details">
                <h4>${service.name}</h4>
                <div class="service-meta">
                    <span class="service-duration">${duracao}</span>
                    <span class="service-price">R$ ${preco}</span>
                </div>
            </div>
        </div>
        <div class="admin-actions">
            <a href="/admin/agendamentos/servico/${service.id}/change/" 
               target="_blank" class="btn btn--sm btn--outline">
                Editar
            </a>
        </div>
    `;
    
    return card;
}

// --- ESTILOS ADICIONAIS ---
document.addEventListener('DOMContentLoaded', function() {
    const adminLoginForm = document.getElementById('admin-login-form');
    if (adminLoginForm) {
        adminLoginForm.addEventListener('submit', async function(event) {
            event.preventDefault();
            showLoading();

            const payload = {
                email: document.getElementById('admin-login-email').value,
                password: document.getElementById('admin-login-password').value
            };

            try {
                // A variável 'empreendedorSlug' vem do app.js
                const response = await fetch(`/${empreendedorSlug}/api/admin/login/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCsrfToken()
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.message);
                }

                // Se o login for bem-sucedido:
                showToast({ message: 'Login administrativo bem-sucedido!', type: 'success' });
                
                // MUDANÇA AQUI: Em vez de ir para admin-screen, redirecionar para o dashboard
                window.location.href = '/dashboard/';

            } catch (error) {
                showToast({ message: error.message, type: 'error' });
            } finally {
                hideLoading();
            }
        });
    }
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\app.js

// static/js/app.js
// Arquivo principal da aplicação - inicialização e configuração global

// --- ESTADO GLOBAL DA APLICAÇÃO ---
let currentScreen = 'home-screen';
let empreendedorSlug = null;
let portfolioLink = null;

// --- NOVA ADIÇÃO ---
// Guarda a tela de destino após o login forçado
window.nextScreenAfterLogin = null; 
// --- FIM DA ADIÇÃO ---

window.wasWarningsScreenSkipped = false;

function getEmpreendedorSlug() {
    // Ex: /salao-da-maria/ -> ['','salao-da-maria','']
    const pathParts = window.location.pathname.split('/');
    if (pathParts.length > 1 && pathParts[1]) {
        return pathParts[1];
    }
    return null;
}

/**
 * Exibe uma tela específica com transição suave
 * @param {string} screenId - ID da tela a ser exibida
 * @param {boolean} addToHistory - Se deve adicionar ao histórico do navegador
 */
window.showScreen = function(screenId, addToHistory = true) {
    const currentScreenElement = document.getElementById(currentScreen);
    const targetScreen = document.getElementById(screenId);

    if (!targetScreen || screenId === currentScreen) return;

    // Adiciona ao histórico do navegador
    if (addToHistory) {
        window.history.pushState({ screen: screenId }, '', '#' + screenId);
    }

    const runTransition = () => {
        if (currentScreenElement) {
            currentScreenElement.classList.remove('active');
        }
        targetScreen.classList.add('active');
        currentScreen = screenId;
        initializeScreenContent(screenId);
        window.scrollTo(0, 0);
    };

    // Simples troca sem transição para evitar complexidade inicial
    runTransition();
};

/**
 * Inicializa o conteúdo específico de cada tela
 * @param {string} screenId - ID da tela a ser inicializada
 */
function initializeScreenContent(screenId) {
    switch(screenId) {
        case 'services-screen':
            loadServices();
            break;
        
        // --- ADICIONE ESTE 'case' ---
        case 'warnings-screen':
            loadAvisosCliente();
            break;
        // --- FIM DA ADIÇÃO ---
        
        case 'professional-screen':
            if (typeof loadProfessionals === 'function') {
                loadProfessionals();
            }
            break;
        case 'calendar-screen':
            loadCalendar();
            break;
        case 'login-screen':
            if (typeof updateBookingSummary === 'function') {
                updateBookingSummary();
            }
            break;
        case 'client-area-screen':
            if (typeof loadClientAppointments === 'function') {
                loadClientAppointments();
            }
            break;

        case 'profile-screen':
            if (typeof loadProfileForEditing === 'function') {
                loadProfileForEditing();
            }
            break;
        case 'admin-screen':
            if (typeof loadAdminContent === 'function') {
                loadAdminContent();
            }
            break;
    }
}

/**
 * Carrega e exibe o mural de avisos dinâmico na tela do cliente.
 */
async function loadAvisosCliente() {
    const container = document.getElementById('warnings-content-lista');
    if (!container) return;
    
    container.innerHTML = '<p>Carregando avisos...</p>';
    
    try {
        const response = await fetch(`/${empreendedorSlug}/api/avisos/`);
        if (!response.ok) throw new Error('Falha ao carregar avisos.');
        const avisos = await response.json();
        
        if (avisos.length === 0) {
            container.innerHTML = '<p class="text-secondary text-center">Nenhum aviso importante no momento.</p>';
            return;
        }
        
        container.innerHTML = ''; // Limpa
        avisos.forEach(aviso => {
            const card = document.createElement('div');
            card.className = 'warning-card';
            card.innerHTML = `
                <div class="warning-icon">⚠️</div>
                <h3>${aviso.titulo}</h3>
                <div class="aviso-conteudo-cliente">
                    ${aviso.conteudo} </div>
            `;
            container.appendChild(card);
        });

    } catch (error) {
        console.error(error);
        container.innerHTML = `<p class="text-error">${error.message}</p>`;
    }
}

// =================================================================
// NOVA ADIÇÃO: FUNÇÃO PARA INICIAR O FLUXO DE AGENDAMENTO
// =================================================================
/**
 * Inicia o fluxo de agendamento, verificando o login primeiro.
 * Chamado pelo botão "Agendar Horário" na home.
 */
window.startBookingFlow = async function() {
    // Mostra o loading, pois agora faremos uma verificação na rede
    showLoading();
    
    let proximaTela = 'warnings-screen'; // O destino padrão

    window.wasWarningsScreenSkipped = false;

    try {
        // 1. Verifica se existem avisos antes de decidir para onde ir
        const response = await fetch(`/${empreendedorSlug}/api/avisos/`);
        if (!response.ok) {
            // Se a API falhar, mantenha o comportamento padrão (ir para a tela de avisos)
            console.warn('Falha ao verificar avisos. Exibindo tela de avisos por padrão.');
        } else {
            const avisos = await response.json();
            
            // 2. A MUDANÇA PRINCIPAL: Se não houver avisos, pule para os serviços
            if (avisos.length === 0) {
                proximaTela = 'services-screen';
                window.wasWarningsScreenSkipped = true;
            }
        }
    } catch (error) {
        console.error('Erro ao verificar avisos:', error);
        // Em caso de erro, mantenha o comportamento padrão
    }

    // 3. Continua com a lógica de autenticação que já existia
    const auth = window.getAuthState();
    if (auth.isAuthenticated) {
        // Se já está logado, vai para a próxima tela decidida (avisos OU serviços)
        showScreen(proximaTela);
    } else {
        // Se não está logado, define o destino e vai para o login forçado
        window.nextScreenAfterLogin = proximaTela;
        showScreen('forced-login-screen');
    }
    
    // Esconde o loading
    hideLoading();
}
// --- FIM DA NOVA ADIÇÃO ---

window.navigateBackFromServices = function() {
    if (window.wasWarningsScreenSkipped) {
        // Se pulamos os avisos, volte direto para a home
        showScreen('home-screen');
    } else {
        // Caso contrário, volte para os avisos
        showScreen('warnings-screen');
    }
}

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', async function() {
    console.log('Bella Designer - Aplicação inicializada');
    empreendedorSlug = getEmpreendedorSlug();

    if (!empreendedorSlug) {
        // Lógica para o que fazer se não houver slug (ex: mostrar uma página inicial)
        console.log("Página principal, nenhum empreendedor selecionado.");
        return;
    }

    // --- INÍCIO DA NOVA LÓGICA DE CARREGAMENTO ---
    try {
        const response = await fetch(`/${empreendedorSlug}/api/negocio-info/`);
        if (!response.ok) throw new Error('Negócio não encontrado.');
        
        const negocioInfo = await response.json();
        
        // --- LÓGICA DA COR PRIMÁRIA (JÁ EXISTE) ---
        const hslParts = negocioInfo.cor_primaria_hsl.split(',');
        if (hslParts.length === 3) {
            const h = hslParts[0].trim();
            const s = hslParts[1].trim();
            const l = hslParts[2].trim();
            
            document.documentElement.style.setProperty('--color-primary-hsl', negocioInfo.cor_primaria_hsl);
            document.documentElement.style.setProperty('--color-primary-h', h);
            document.documentElement.style.setProperty('--color-primary-s', s);
            document.documentElement.style.setProperty('--color-primary-l', l);
        } else {
            console.error("Formato HSL primário inválido:", negocioInfo.cor_primaria_hsl);
        }
        
        // --- ADICIONE ESTA NOVA LÓGICA PARA A COR SECUNDÁRIA ---
        const hslPartsSec = negocioInfo.cor_secundaria_hsl.split(',');
        if (hslPartsSec.length === 3) {
            const h_sec = hslPartsSec[0].trim();
            const s_sec = hslPartsSec[1].trim();
            const l_sec = hslPartsSec[2].trim();

            document.documentElement.style.setProperty('--color-secondary-hsl', negocioInfo.cor_secundaria_hsl);
            document.documentElement.style.setProperty('--color-secondary-h', h_sec);
            document.documentElement.style.setProperty('--color-secondary-s', s_sec);
            document.documentElement.style.setProperty('--color-secondary-l', l_sec);
        } else {
            console.error("Formato HSL secundário inválido:", negocioInfo.cor_secundaria_hsl);
        }
        
        // 3. Atualiza o nome e tagline na Home
        const logoElement = document.querySelector('#home-screen .logo');
        const taglineElement = document.querySelector('#home-screen .tagline');
        if (logoElement) logoElement.textContent = negocioInfo.nome_negocio;
        if (taglineElement) taglineElement.textContent = negocioInfo.tagline;
        
        // --- ADICIONE ESTE BLOCO ---
        // 4. Atualiza a Logo na Home
        const logoImg = document.getElementById('negocio-logo');
        if (logoImg) {
            if (negocioInfo.logo_url) {
                logoImg.src = negocioInfo.logo_url;
                logoImg.style.display = 'block'; // Mostra a imagem
            } else {
                logoImg.style.display = 'none'; // Esconde se não houver logo
            }
        }
        // // 5. Atualiza os Avisos na Tela de Warnings
        // const avisoProcEl = document.getElementById('aviso-procedimento-lista');
        // const avisoCancEl = document.getElementById('aviso-cancelamento-lista');

        // if (avisoProcEl) {
        //     avisoProcEl.innerHTML = negocioInfo.aviso_procedimento || "<li>Nenhum aviso definido.</li>";
        // }
        // if (avisoCancEl) {
        //     avisoCancEl.innerHTML = negocioInfo.aviso_cancelamento || "<li>Nenhuma política definida.</li>";
        // }
        // --- FIM DA ADIÇÃO ---

        // --- INÍCIO DA ADIÇÃO ---
        if (negocioInfo.portfolio_url) {
            portfolioLink = negocioInfo.portfolio_url;
            const portfolioBtn = document.getElementById('btn-portfolio');
            if (portfolioBtn) {
                portfolioBtn.classList.remove('hidden');
            }
        }
        // --- FIM DA ADIÇÃO ---
        
    } catch (error) {
        console.error("Erro ao carregar informações do negócio:", error);
    }

    // Garante que apenas a tela inicial esteja ativa
    document.querySelectorAll('.screen').forEach(screen => {
        if(screen.id !== 'home-screen'){
            screen.classList.remove('active');
        } else {
            screen.classList.add('active');
        }
    });

    // Inicializa o estado de autenticação
    if (typeof initAuthState === 'function') {
        initAuthState();
    }

    // Detecta navegação por histórico do navegador
    window.addEventListener('popstate', function(event) {
        if (event.state && event.state.screen) {
            showScreen(event.state.screen, false); // false = não adicionar ao histórico
        } else {
            showScreen('home-screen', false);
        }
    });

    // --- INÍCIO DA ADIÇÃO ---
    // Adicione o listener para fechar o modal
    const portfolioModalClose = document.getElementById('portfolio-modal-close');
    if (portfolioModalClose) {
        portfolioModalClose.addEventListener('click', closePortfolioModal);
    }
});

// --- INÍCIO DA ADIÇÃO ---
// Adicione estas DUAS NOVAS FUNÇÕES no final do arquivo app.js

/**
 * Abre o modal do portfólio e carrega o iframe
 */
window.openPortfolioModal = function() {
    if (!portfolioLink) return;

    const modal = document.getElementById('portfolio-modal-container');
    const iframe = document.getElementById('portfolio-iframe');
    const loading = document.getElementById('portfolio-loading');

    if (!modal || !iframe || !loading) return;

    // 1. Mostra o loading e o modal
    loading.classList.remove('hidden');
    modal.classList.remove('hidden');

    // 2. Define o src do iframe (isso começa o carregamento)
    iframe.src = portfolioLink;

    // 3. Oculta o loading QUANDO o iframe terminar de carregar
    iframe.onload = () => {
        loading.classList.add('hidden');
    };
    
    // 4. Fallback (se demorar mais de 10s, esconde o loading)
    setTimeout(() => loading.classList.add('hidden'), 10000);
}

/**
 * Fecha o modal do portfólio
 */
window.closePortfolioModal = function() {
    const modal = document.getElementById('portfolio-modal-container');
    const iframe = document.getElementById('portfolio-iframe');
    
    if (modal) modal.classList.add('hidden');
    
    // Para o carregamento e limpa o iframe (economiza memória)
    if (iframe) iframe.src = 'about:blank'; 
}
// --- FIM DA ADIÇÃO ---
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\auth.js

// static/js/auth.js
// Sistema de autenticação e gerenciamento de usuário

// --- ESTADO GLOBAL DA APLICAÇÃO ---

// Estado de autenticação
let authState = {
    isAuthenticated: false,
    user: null
};

// Estado do Agendamento (Compartilhado entre services, professional, calendar)
let selectedService = null;
let selectedProfessional = null;
let selectedTierInfo = {
    tierId: null,
    preco: 0,
    duracao: 0,
    valor_adiantamento: 0
};
let selectedDate = null;
let selectedTime = null;
let reschedulingAppointmentId = null;
let servicesData = []; // Cache global de serviços

// --- FIM DO ESTADO GLOBAL ---


/**
 * Converte data de dd/mm/aaaa para YYYY-MM-DD
 * @param {string} dateString - Data no formato dd/mm/aaaa
 * @returns {string|null} - Data no formato YYYY-MM-DD ou null se inválido
 */
function convertDateToISO(dateString) {
    if (!dateString) return null;
    // Se a data já estiver no formato ISO (do PC), retorna ela mesma
    if (dateString.includes('-') && dateString.length === 10) {
        return dateString;
    }

    // Se estiver no formato dd/mm/aaaa
    if (dateString.length !== 10) return null; // Garante que tem 10 caracteres
    
    const parts = dateString.split('/');
    if (parts.length !== 3) return null; // Formato inválido
    
    const day = parts[0];
    const month = parts[1];
    const year = parts[2];
    
    if (year.length !== 4) return null; // Ano inválido
    
    return `${year}-${month}-${day}`;
}

// =================================================================
// NOVA ADIÇÃO: GETTER GLOBAL DO ESTADO
// =================================================================
/**
 * Retorna o estado de autenticação atual
 * @returns {Object}
 */
window.getAuthState = function() {
    return authState;
}
// --- FIM DA ADIÇÃO ---

/**
 * Inicializa o estado de autenticação a partir do servidor
 * @returns {Promise} - Promise que resolve para o estado de autenticação
 */
async function initAuthState() {
    try {
        const response = await fetch(`/${empreendedorSlug}/api/check_auth/`);
        const data = await response.json();
        
        // Atualiza o estado global
        authState = {
            isAuthenticated: data.isAuthenticated,
            user: data.isAuthenticated ? {
                name: data.user.name,
                lastname: data.user.lastname,
                email: data.user.email
            } : null
        };
        // Atualiza a UI com base no estado de autenticação
        updateAuthUI();
        
        return authState;
    } catch (error) {
        console.error('Erro ao verificar autenticação:', error);
        return { isAuthenticated: false, user: null };
    }
}

/**
 * Atualiza a UI com base no estado de autenticação
 */
function updateAuthUI() {
    // Elementos que dependem do estado de autenticação
    const userBar = document.querySelector('.user-bar');
    const loginForms = document.querySelectorAll('.auth-form');
    const userInfoElements = document.querySelectorAll('.user-info-display');
    const logoutButtonHome = document.getElementById('home-logout-button');
    // <-- Adicione esta linha

    if (authState.isAuthenticated) {
        // Exibe a barra de usuário se existir
        if (userBar) userBar.classList.remove('hidden');
        if (logoutButtonHome) logoutButtonHome.classList.remove('hidden'); // <-- Adicione esta linha para MOSTRAR o botão

        // Atualiza elementos com informações do usuário
        userInfoElements.forEach(el => {
            if (el.dataset.field === 'name') {
                el.textContent = authState.user.name;
            } else if (el.dataset.field === 'email') {
                el.textContent = authState.user.email;
            } else if (el.dataset.field === 'fullname') {
                el.textContent = `${authState.user.name} ${authState.user.lastname}`;
            }
        });
        // Oculta formulários de login/registro se estiver autenticado
        loginForms.forEach(form => {
            const container = form.closest('.login-form-section');
            if (container) {
                container.innerHTML = `
                    <div class="auth-success-message">
                        <div class="success-icon">✓</div>
                        <h3>Usuário Autenticado</h3>
                        <p>Você já está logado(a) como <strong>${authState.user.name} ${authState.user.lastname}</strong>.</p>
                        <p>Pode prosseguir com seu agendamento.</p>
                        <div class="auth-actions" style="margin-top: 16px;">
                            <button class="btn btn--outline" onclick="performLogout(event)">Sair da Conta</button>
                            <button class="btn btn--primary" onclick="processBooking()">Continuar Agendamento</button>
                        </div>
                    </div>
                `;
            }
        });
    } else {
        // Oculta a barra de usuário se existir
        if (userBar) userBar.classList.add('hidden');
        if (logoutButtonHome) logoutButtonHome.classList.add('hidden'); // <-- Adicione esta linha para ESCONDER o botão
    }
}

/**
 * Realiza o login do usuário
 * @param {Object} credentials - Credenciais de login
 * @param {string} credentials.email - Email do usuário
 * @param {string} credentials.password - Senha do usuário
 * @returns {Promise} - Promise que resolve para o resultado do login
 */
async function loginUser(credentials) {
    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/login/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(credentials)
        });
        
        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || 'Falha ao realizar login');
        }
        
        // Atualiza o estado de autenticação
        await initAuthState();
        // Exibe mensagem de sucesso
        showToast({
            message: 'Login realizado com sucesso!',
            type: 'success',
            duration: 3000
        });
        return true;
    } catch (error) {
        console.error('Erro no login:', error);
        showToast({
            message: error.message || 'Falha ao realizar login',
            type: 'error',
            duration: 4000
        });
        return false;
    } finally {
        hideLoading();
    }
}

/**
 * Registra um novo usuário
 * @param {Object} userData - Dados do usuário
 * @param {string} userData.name - Nome do usuário
 * @param {string} userData.lastname - Sobrenome do usuário
 * @param {string} userData.phone - Telefone do usuário
 * @param {string} userData.email - Email do usuário
 * @param {string} userData.password - Senha do usuário
 * @returns {Promise} - Promise que resolve para o resultado do registro
 */
async function registerUser(userData) {
    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/register/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(userData)
        });
        
        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || 'Falha ao realizar cadastro');
        }
        
        // Atualiza o estado de autenticação após registro
        await initAuthState();
        // Exibe mensagem de sucesso
        showToast({
            message: 'Cadastro realizado com sucesso!',
            type: 'success',
            duration: 3000
        });
        return true;
    } catch (error) {
        console.error('Erro no registro:', error);
        showToast({
            message: error.message || 'Falha ao realizar cadastro',
            type: 'error',
            duration: 4000
        });
        return false;
    } finally {
        hideLoading();
    }
}

/**
 * Realiza o login do cliente usando Telefone e Data de Nascimento
 * @param {string} phone - Telefone (apenas dígitos)
 * @param {string} nascimento - Data de nascimento (YYYY-MM-DD)
 * @returns {Promise<boolean>} - True se o login for bem-sucedido
 */
async function loginUserWithPhone(phone, nascimento) {
    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/login-phone/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({ phone: phone, nascimento: nascimento })
        });
        
        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || 'Falha ao realizar login');
        }
        
        await initAuthState();
        // Atualiza o estado global
        showToast({ message: 'Login realizado com sucesso!', type: 'success' });
        return true;
    } catch (error) {
        console.error('Erro no login por telefone:', error);
        showToast({ message: error.message || 'Telefone ou data de nascimento inválidos.', type: 'error' });
        return false;
    } finally {
        hideLoading();
    }
}

/**
 * Valida um número de telefone (com DDD).
 * Exige 10 ou 11 dígitos (ex: 11987654321 ou 1187654321).
 * @param {string} phone - O número de telefone.
 * @returns {boolean} - True se for válido.
 */
function validatePhoneNumber(phone) {
    if (!phone) return false;
    // Remove qualquer caractere não numérico (como '(', ')', '-', ' ')
    const numericPhone = phone.replace(/\D/g, '');
    // Verifica se tem 10 (fixo+ddd) ou 11 (celular+ddd) dígitos
    const phoneRegex = /^\d{10,11}$/; 
    return phoneRegex.test(numericPhone);
}

/**
 * Realiza o logout do usuário
 * @returns {Promise} - Promise que resolve para o resultado do logout
 */
async function logoutUser() {
    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/logout/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCsrfToken()
            }
        });
        // Atualiza o estado de autenticação
        authState = {
            isAuthenticated: false,
            user: null
        };
        // Atualiza a UI
        updateAuthUI();
        // Exibe mensagem de sucesso
        showToast({
            message: 'Logout realizado com sucesso!',
            type: 'info',
            duration: 2000
        });
        return true;
    } catch (error) {
        console.warn('Erro no logout:', error);
        // Mesmo com erro, atualiza o estado local
        authState = {
            isAuthenticated: false,
            user: null
        };
        // Atualiza a UI
        updateAuthUI();
        
        return false;
    } finally {
        hideLoading();
    }
}

/**
 * Obtém o token CSRF do cookie
 * @returns {string} - Token CSRF
 */
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    return cookieValue;
}

/**
 * Verifica se o usuário está autenticado e exibe o modal de login se não estiver
 * @returns {boolean} - Se o usuário está autenticado
 */
function requireAuth() {
    if (!authState.isAuthenticated) {
        showScreen('forced-login-screen');
        return false;
    }
    
    return true;
}



/**
 * Função global para logout
 */
window.performLogout = async function(event) {
    if (event) {
        event.preventDefault();
        // Previne a ação padrão do link/botão
    }

    // Exibe modal de confirmação
    showModal({
        title: 'Confirmar Logout',
        message: 'Tem certeza que deseja sair da sua conta?',
        confirmText: 'Sim, sair',
        cancelText: 'Cancelar',
        onConfirm: async () => {
            const success = await logoutUser();
            if (success) {
                // CORREÇÃO APLICADA AQUI: Recarrega a página para limpar o estado
                window.location.reload();
            }
        }
    });
};

// --- CONFIGURAÇÃO DE FORMULÁRIOS ---
document.addEventListener('DOMContentLoaded', function() {
    // Inicializa o estado de autenticação
    initAuthState();
    
    // Formulário de login
    const loginForm = document.getElementById('login-form');
    if (loginForm) {
        loginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
           // --- BLOCO TOTALMENTE MODIFICADO ---
    
            const phoneInput = document.getElementById('login-phone').value;
            const numericPhone = phoneInput.replace(/\D/g, ''); // Limpa
            
            // --- MUDANÇA AQUI ---
            const nascimentoInput = document.getElementById('login-nascimento').value;
            const nascimentoISO = convertDateToISO(nascimentoInput); // Converte para YYYY-MM-DD
            
            if (!validatePhoneNumber(numericPhone) || !nascimentoISO) { // Valida o formato ISO
                showToast({ message: 'Por favor, preencha o telefone (com DDD) e uma data de nascimento válida (dd/mm/aaaa).', type: 'error' });
                return;
            }
            
            const success = await loginUserWithPhone(numericPhone, nascimentoISO);
            // Envia o formato ISO
            
            if (success && currentScreen === 'login-screen') {
                proceedWithBooking();
            }
            // --- FIM DA MODIFICAÇÃO ---
        });
    }
    
    // Formulário de registro
    const registerForm = document.getElementById('register-form');
    if (registerForm) {
        registerForm.addEventListener('submit', async function(e) {
            e.preventDefault();

            const phoneInput = document.getElementById('register-phone').value;
            const numericPhone = phoneInput.replace(/\D/g, ''); // Remove não-dígitos
            if (!validatePhoneNumber(numericPhone)) { // Valida os dígitos
                showToast({ message: 'Por favor, insira um telefone válido com DDD (10 ou 11 dígitos).', type: 'error' });
                return;
            }

            const nascimentoInput = document.getElementById('register-nascimento').value;
            const nascimentoISO = convertDateToISO(nascimentoInput); // Converte para YYYY-MM-DD
            if (!nascimentoISO) {
                showToast({ message: 'A data de nascimento é obrigatória e deve estar no formato dd/mm/aaaa.', type: 'error' });
                return;
            }
            
            const userData = {
                name: document.getElementById('register-name').value,
                lastname: document.getElementById('register-lastname').value,
                nascimento: nascimentoISO, // <-- Envia YYYY-MM-DD
                phone: numericPhone, // <-- Envia o telefone limpo
                email: document.getElementById('register-email').value,
            };
            const success = await registerUser(userData);
            
            if (success && currentScreen === 'login-screen') {
                // Se estiver na tela de login, processa o agendamento
                proceedWithBooking();
            } else if (success && currentScreen === 'forced-login-screen') {
                // Se estiver na tela de login forçado, vai para a área do cliente
                showScreen('client-area-screen');
            }
        });
    }
    
    // Formulário de login forçado
    const forcedLoginForm = document.getElementById('forced-login-form');
    if (forcedLoginForm) {
        forcedLoginForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // --- BLOCO TOTALMENTE MODIFICADO ---
            const phoneInput = document.getElementById('forced-login-phone').value;
            const numericPhone = phoneInput.replace(/\D/g, ''); // Limpa
            
 
            // --- MUDANÇA AQUI ---
            const nascimentoInput = document.getElementById('forced-login-nascimento').value;
            const nascimentoISO = convertDateToISO(nascimentoInput); // Converte para YYYY-MM-DD

            if (!validatePhoneNumber(numericPhone) || !nascimentoISO) { // Valida o formato ISO
                showToast({ message: 'Por favor, preencha o telefone (com DDD) e uma data de nascimento válida (dd/mm/aaaa).', type: 'error' });
                return;
            }
            
            const success = await loginUserWithPhone(numericPhone, nascimentoISO); // Envia o formato ISO
            
            if (success) {
                const nextScreen = window.nextScreenAfterLogin || 'client-area-screen';
                window.nextScreenAfterLogin = null; 
                showScreen(nextScreen);
            }
            // --- FIM DA MODIFICAÇÃO ---
        });
    }
    
    // Formulário de registro forçado
    const forcedRegisterForm = document.getElementById('forced-register-form');
    if (forcedRegisterForm) {
    forcedRegisterForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        // --- MUDANÇA AQUI ---
        const phoneInput = document.getElementById('forced-register-phone').value;
        const numericPhone = phoneInput.replace(/\D/g, ''); // Remove não-dígitos
        if (!validatePhoneNumber(numericPhone)) { // Valida os dígitos
            showToast({ message: 'Por favor, insira um telefone válido com DDD (10 ou 11 dígitos).', type: 'error' });
            return;
        }

        const nascimentoInput = document.getElementById('forced-register-nascimento').value;
        const nascimentoISO = convertDateToISO(nascimentoInput); // Converte para YYYY-MM-DD
        if (!nascimentoISO) {
            showToast({ message: 'A data de nascimento é obrigatória e deve estar no formato dd/mm/aaaa.', type: 'error' });
            return;
        }
        
        // CORREÇÃO APLICADA AQUI
        const userData = {
            name: document.getElementById('forced-register-name').value,
            lastname: document.getElementById('forced-register-lastname').value,
            nascimento: nascimentoISO, // <-- CORRIGIDO: Enviando "YYYY-MM-DD"
            phone: numericPhone, 
            email: document.getElementById('forced-register-email').value,
        };
        
        const success = await registerUser(userData);
        if (success) {
            // --- LÓGICA MODIFICADA ---
            // Verifica se há uma tela de destino, senão vai para 'client-area-screen'
            const nextScreen = window.nextScreenAfterLogin || 'client-area-screen';
            window.nextScreenAfterLogin = null; // Limpa a variável
            showScreen(nextScreen);
            // --- FIM DA MODIFICAÇÃO ---
        }
    });
}
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\calendar.js

// static/js/calendar.js
// Sistema de calendário e agendamento

// --- VARIÁVEIS GLOBAIS ---
// As variáveis de estado (selectedService, selectedProfessional, selectedTierInfo, etc.)
// são definidas em auth.js para garantir a ordem de carregamento.

// --- VARIÁVEIS LOCAIS DO CALENDÁRIO ---
let currentMonth = new Date().getMonth();
let currentYear = new Date().getFullYear();
let paymentPollingInterval = null; // Guarda o ID do setInterval
let paymentTimerInterval = null;   // Guarda o ID do setInterval do timer
let currentPendingAgendamentoId = null; // Guarda o ID do agendamento pendente
// --- FIM DAS VARIÁVEIS LOCAIS ---


// --- FUNÇÕES DE INICIALIZAÇÃO ---

/**
 * Carrega o calendário e configurações iniciais
 */
function loadCalendar() {
    // Para qualquer limpeza de agendamento anterior
    stopPaymentPolling();

    updateCalendarHeader();
    
    // Passa a duração selecionada para a geração do calendário
    // selectedTierInfo é global (de auth.js) e foi definido em services.js
    if (!selectedTierInfo || selectedTierInfo.duracao === 0) {
        console.error("Erro: A duração do serviço (selectedTierInfo.duracao) é 0. Voltando.");
        showToast({message: "Erro ao carregar dados do serviço. Tente selecionar novamente.", type: "error"});
        showScreen('services-screen'); // Volta para a tela de serviços
        return;
    }
    
    generateCalendar(selectedTierInfo.duracao, selectedTierInfo.tierId);
    
    updateSelectedServiceInfo();
    
    // Limpa seleções anteriores
    document.getElementById('time-selection').classList.add('hidden');
    document.getElementById('continue-to-login').disabled = true;
    selectedDate = null; // selectedDate é global (de auth.js)
    selectedTime = null; // selectedTime é global (de auth.js)
}

/**
 * Atualiza o cabeçalho do calendário com mês e ano atuais
 */
function updateCalendarHeader() {
    const months = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho', 'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
    document.getElementById('current-month').textContent = `${months[currentMonth]} ${currentYear}`;
}

/**
 * Atualiza as informações do serviço selecionado
 */
function updateSelectedServiceInfo() {
    const serviceInfo = document.getElementById('selected-service-info');
    
    // selectedService e selectedTierInfo são globais (de auth.js)
    if (selectedService && serviceInfo && selectedTierInfo) {
        // Usa os dados do tier selecionado (preço e duração)
        const duracao = formatarDuracao(selectedTierInfo.duracao);
        const preco = selectedTierInfo.preco.toFixed(2).replace('.', ',');
        
        // Exibe adiantamento
        let adiantamentoHTML = '';
        if (selectedTierInfo.valor_adiantamento > 0) {
            const adiantamento = selectedTierInfo.valor_adiantamento.toFixed(2).replace('.', ',');
            adiantamentoHTML = `<span class="service-price-signal">Adiantamento: R$ ${adiantamento}</span>`;
        }

        let imagemHTML = '';
        if (selectedService.image_url) {
            imagemHTML = `<img src="${selectedService.image_url}" alt="${selectedService.name}" class="service-info-img">`;
        } else {
            imagemHTML = `<div class="service-icon">${selectedService.icon || '✨'}</div>`;
        }

        let nomeExibido = selectedService.name;
        if (selectedTierInfo.tierId) {
            const tier = selectedService.tiers_manutencao.find(t => t.id === selectedTierInfo.tierId);
            if (tier) {
                nomeExibido = tier.nome_tier;
            }
        }
        
        serviceInfo.innerHTML = `
            <div class="service-info-card">
                ${imagemHTML}
                <div class="service-details">
                    <h3>${nomeExibido}</h3>
                    <div class="service-meta">
                        <span class="service-duration">${duracao}</span>
                        <span class="service-price">Total: R$ ${preco}</span>
                        ${adiantamentoHTML}
                    </div>
                </div>
            </div>
         `;
    }
}


// Helper para formatar duração (pode ser global)
function formatarDuracao(minutos) {
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;

  if (horas > 0) {
    return mins > 0 ? `${horas}h ${mins}min` : `${horas}h`;
  }
  return `${mins} min`;
}


/**
 * Gera a visualização do calendário para o mês atual
 */
async function generateCalendar(duracao, tierId) {
    const calendarGrid = document.getElementById('calendar-grid');
    calendarGrid.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div></div>'; // Mostra loading

    // Busca os dias com horários disponíveis para o mês corrente
    let availableDays = [];
    try {
        // Usa as variáveis globais selectedService e selectedProfessional
        let apiUrl = `/${empreendedorSlug}/api/dias_disponiveis/?mes=${currentMonth + 1}&ano=${currentYear}&servico_id=${selectedService.id}&empreendedor_id=${selectedProfessional.id}&duracao=${duracao}`;
        if (tierId) {
            apiUrl += `&tier_id=${tierId}`;
        }
        
        const response = await fetch(apiUrl);
        if (response.ok) {
            availableDays = await response.json();
        }
    } catch (error) {
        console.error("Não foi possível buscar os dias disponíveis:", error);
    }

    calendarGrid.innerHTML = ''; // Limpa o loading

    // Cabeçalho dos dias da semana
    const dayHeaders = ['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'];
    dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'day-of-week';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
    });
    
    const firstDay = new Date(currentYear, currentMonth, 1).getDay();
    const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
    const today = new Date();
    today.setHours(0, 0, 0, 0);

    for (let i = 0; i < firstDay; i++) {
        calendarGrid.insertAdjacentHTML('beforeend', '<div class="calendar-day other-month"></div>');
    }

    for (let day = 1; day <= daysInMonth; day++) {
        const dayElement = document.createElement('div');
        dayElement.className = 'calendar-day';
        dayElement.textContent = day;

        const currentDate = new Date(currentYear, currentMonth, day);
        const dateString = formatDateForAPI(currentDate);

        // 1. Bloqueia dias no passado
        if (currentDate < today) {
            dayElement.classList.add('unavailable');
        } 
        // 2. Verifica se a API (dias_disponiveis) retornou este dia
        else if (availableDays.includes(dateString)) {
            // Se sim, é um dia clicável e com horários
            dayElement.classList.add('available');
            dayElement.classList.add('has-availability'); // Adiciona o ponto
            dayElement.onclick = () => selectDate(dateString, dayElement, duracao, tierId);
        } 
        // 3. Se não está no passado E não foi retornado pela API, é indisponível
        else {
            dayElement.classList.add('unavailable');
        }

        if (isSameDay(currentDate, today)) {
            dayElement.classList.add('today');
        }

        calendarGrid.appendChild(dayElement);
    }
}

// --- FUNÇÕES DE NAVEGAÇÃO E SELEÇÃO ---

/**
 * Muda o mês do calendário
 * @param {number} direction - Direção da mudança (1 para próximo, -1 para anterior)
 */
window.changeMonth = function(direction) {
    currentMonth += direction;
    if (currentMonth > 11) {
        currentMonth = 0;
        currentYear++;
    } else if (currentMonth < 0) {
        currentMonth = 11;
        currentYear--;
    }
    
    // Passa a duração e o tier selecionados (globais)
    generateCalendar(selectedTierInfo.duracao, selectedTierInfo.tierId);
    
    updateCalendarHeader();
};

/**
 * Seleciona uma data no calendário e busca os horários disponíveis
 * @param {string} dateString - Data no formato YYYY-MM-DD
 * @param {HTMLElement} dayElement - Elemento HTML do dia
 */
window.selectDate = async function(dateString, dayElement, duracao, tierId) {
    if (dayElement.classList.contains('unavailable')) return;

    // Atualiza UI
    document.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
    dayElement.classList.add('selected');
    selectedDate = dateString; // Atualiza o estado global

    // Limpa seleções anteriores e exibe carregamento
    const timeSelection = document.getElementById('time-selection');
    const timeSlots = document.getElementById('time-slots');
    timeSelection.classList.remove('hidden');
    timeSlots.innerHTML = '<div class="loading-indicator"><div class="loading-spinner small"></div><p>Buscando horários disponíveis...</p></div>';
    document.getElementById('continue-to-login').disabled = true;
    selectedTime = null; // Atualiza o estado global

    try {
        // Passa a duração para a API de horários
        let apiUrl = `/${empreendedorSlug}/api/horarios_disponiveis/?data=${dateString}&servico_id=${selectedService.id}&empreendedor_id=${selectedProfessional.id}&duracao=${duracao}`;
        
        const response = await fetch(apiUrl);
        if (!response.ok) {
            throw new Error('Falha ao buscar horários.');
        }
        
        const horarios = await response.json();
        showTimeSlots(horarios);
    } catch (error) {
        console.error("Erro ao buscar horários:", error);
        timeSlots.innerHTML = `
            <div class="error-message">
                <p>Não foi possível carregar os horários. Tente novamente.</p>
                <button class="btn btn--outline" onclick="selectDate('${dateString}', document.querySelector('.calendar-day.selected'))">
                    Tentar Novamente
                </button>
            </div>
        `;
    }
};

/**
 * Exibe os horários disponíveis para a data selecionada
 * @param {Array} availableTimes - Lista de horários disponíveis
 */
function showTimeSlots(availableTimes) {
    const timeSlots = document.getElementById('time-slots');
    timeSlots.innerHTML = ''; // Limpa o "carregando"

    if (availableTimes.length === 0) {
        timeSlots.innerHTML = `
            <div class="empty-state">
                <div class="empty-icon">📅</div>
                <p>Nenhum horário disponível para este serviço neste dia.</p>
                <p class="empty-subtitle">Por favor, selecione outra data.</p>
            </div>
        `;
        return;
    }

    // Separa os horários em períodos
    const manha = availableTimes.filter(time => {
        const hour = parseInt(time.split(':')[0]);
        return hour >= 8 && hour < 12;
    });
    const tarde = availableTimes.filter(time => {
        const hour = parseInt(time.split(':')[0]);
        return hour >= 12 && hour < 18; // Ajustado para pegar 12:00
    });
    const noite = availableTimes.filter(time => {
         const hour = parseInt(time.split(':')[0]);
         return hour >= 18;
    });

    // Cria containers para os períodos
    const timeSlotsContainer = document.createElement('div');
    timeSlotsContainer.className = 'time-periods-container';

    // Função helper para criar um período
    const createPeriodSection = (title, times) => {
        if (times.length === 0) return;
        
        const container = document.createElement('div');
        container.className = 'time-period';
        container.innerHTML = `<h4 class="period-title">${title}</h4>`;
        
        const slotsGrid = document.createElement('div');
        slotsGrid.className = 'time-slots-grid';
        
        times.forEach(time => {
            const timeSlot = document.createElement('div');
            timeSlot.className = 'time-slot';
            timeSlot.textContent = time;
            timeSlot.onclick = () => selectTime(time, timeSlot);
            slotsGrid.appendChild(timeSlot);
        });
        
        container.appendChild(slotsGrid);
        timeSlotsContainer.appendChild(container);
    };

    // Adiciona os períodos
    createPeriodSection('Manhã', manha);
    createPeriodSection('Tarde', tarde);
    createPeriodSection('Noite', noite);

    // Adiciona a estrutura ao container principal
    timeSlots.appendChild(timeSlotsContainer);
}

/**
 * Seleciona um horário
 * @param {string} time - Horário selecionado
 * @param {HTMLElement} timeSlotElement - Elemento HTML do horário
 */
window.selectTime = function(time, timeSlotElement) {
    document.querySelectorAll('.time-slot.selected').forEach(s => s.classList.remove('selected'));
    timeSlotElement.classList.add('selected');
    selectedTime = time; // Atualiza o estado global
    document.getElementById('continue-to-login').disabled = false;
};

// --- FUNÇÕES DE AGENDAMENTO ---

/**
 * Inicia o processo de remarcação de um agendamento
 * @param {number} appointmentId - ID do agendamento a ser remarcado
 * @param {number} serviceId - ID do serviço do agendamento
 */
window.startReschedule = function(appointmentId, serviceId) {
    // Exibe modal de confirmação personalizado
    showModal({
        title: 'Confirmar Remarcação',
        message: `
            <p>Você será redirecionado para a agenda para escolher um novo horário.</p>
            <p><strong>Atenção:</strong> O seu horário atual será cancelado ao confirmar a nova data.</p>
            <p>Deseja continuar?</p>
        `,
        confirmText: 'Sim, remarcar',
        cancelText: 'Não, manter agendamento',
        onConfirm: () => {
            // Define o estado de remarcação (global)
            reschedulingAppointmentId = appointmentId;

            // Pré-seleciona o serviço e vai para a tela do calendário
            selectedService = servicesData.find(service => service.id === serviceId);
            
            if (selectedService) {
                // Assumindo que remarcação usa o preço/duração originais (sem tiers)
                 selectedTierInfo = {
                    tierId: null,
                    preco: selectedService.price,
                    duracao: selectedService.duracao_minutos,
                    valor_adiantamento: 0 // Remarcação não cobra adiantamento
                };
                
                showScreen('professional-screen'); // Remarcação deve escolher profissional
            } else {
                // Se os serviços não estiverem carregados, carrega e depois vai
                loadServices().then(() => {
                    selectedService = servicesData.find(service => service.id === serviceId);
                    
                    selectedTierInfo = {
                        tierId: null,
                        preco: selectedService.price,
                        duracao: selectedService.duracao_minutos,
                        valor_adiantamento: 0
                    };
                    showScreen('professional-screen');
                 });
            }
        }
    });
};
/**
 * Processa o agendamento com os dados selecionados
 * (CHAMADO PELA TELA DE LOGIN/RESUMO)
 */
window.processBooking = async function() {
    // Verifica os dados selecionados (todos globais)
    if (!selectedService || !selectedDate || !selectedTime || !selectedTierInfo || !selectedProfessional) {
        showToast({
            message: 'Por favor, selecione todos os dados do agendamento.',
            type: 'warning'
        });
        return;
    }
    
    // Verifica autenticação (global)
    if (!authState.isAuthenticated) {
        showScreen('login-screen');
        return;
    }
    
    showLoading();
    try {
        // --- LÓGICA DE REMARCAÇÃO ---
        if (reschedulingAppointmentId) {
            // Exibe confirmação final para cancelar o agendamento antigo
            const cancelResponse = await fetch(`/${empreendedorSlug}/api/agendamentos/${reschedulingAppointmentId}/cancelar/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': getCsrfToken() }
             });
            
            if (!cancelResponse.ok) {
                const errorData = await cancelResponse.json();
                throw new Error(errorData.message || 'Não foi possível cancelar o agendamento antigo. A operação foi interrompida.');
            }
            
            showToast({
                message: 'Agendamento antigo cancelado com sucesso.',
                type: 'info'
            });
        }

        // --- DADOS PARA O NOVO AGENDAMENTO ---
        const payload = {
            serviceId: selectedService.id,
            date: selectedDate,
            time: selectedTime,
            empreendedorId: selectedProfessional.id,
            tierManutencaoId: selectedTierInfo.tierId 
        };

        // --- CHAMADA FETCH PARA CRIAR AGENDAMENTO ---
        const response = await fetch(`/${empreendedorSlug}/api/agendar/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(payload)
        });
        
        const result = await response.json();

        if (!response.ok) {
            throw new Error(result.message || 'Falha ao criar agendamento.');
        }

        // --- LÓGICA DE DECISÃO PÓS-CRIAÇÃO ---
        
        if (result.status === 'success' && !result.payment_required) {
            // CASO 1: SUCESSO DIRETO (Adiantamento R$ 0)
            showToast({ message: 'Agendamento realizado com sucesso!', type: 'success' });
            await showConfirmation(result.agendamento_id); // Passa o ID

        } else if (result.status === 'pending_payment' && result.payment_required) {
            // CASO 2: PAGAMENTO PENDENTE (PIX Gerado)
            currentPendingAgendamentoId = result.agendamento_id;
            
            // Preenche a tela de pagamento
            document.getElementById('payment-qr-code-img').src = `data:image/png;base64,${result.qr_code_base64}`;
            document.getElementById('payment-qr-code-text').value = result.qr_code;
            
            // Mostra a tela de pagamento
            showScreen('payment-screen');
            
            // Inicia o timer e o polling
            startPaymentTimer(result.expires_at);
            startPaymentPolling(result.agendamento_id, result.expires_at);

        } else {
            // Caso inesperado
            throw new Error(result.message || 'Resposta inesperada do servidor.');
        }

    } catch (error) {
        console.error('Falha no agendamento:', error);
        showToast({
            message: `Erro: ${error.message}`,
            type: 'error',
            duration: 5000
        });
    } finally {
        reschedulingAppointmentId = null;
        // Limpa o estado de remarcação
        hideLoading();
    }
}

/**
 * Exibe a tela de confirmação com os detalhes do agendamento
 */
async function showConfirmation(agendamento_id) {
    // Verifica autenticação novamente por segurança
    const authStatus = await fetch(`/${empreendedorSlug}/api/check_auth/`).then(res => res.json());
    if(!authStatus.isAuthenticated) {
        showScreen('forced-login-screen');
        return;
    }

    // Formata a data para exibição
    const [year, month, day] = selectedDate.split('-');
    const formattedDate = `${day}/${month}/${year}`;

    // Determina o nome a ser exibido
    let nomeExibido = selectedService.name;
    if (selectedTierInfo.tierId) {
        const tier = selectedService.tiers_manutencao.find(t => t.id === selectedTierInfo.tierId);
        if (tier) nomeExibido = tier.nome_tier;
    }
    
    // Preenche os detalhes do agendamento
    document.getElementById('booking-details').innerHTML = `
        <div class="summary-item">
            <span class="label">Cliente:</span>
            <span class="value">${authStatus.user.name} ${authStatus.user.lastname}</span>
        </div>
        <div class="summary-item">
            <span class="label">Profissional:</span>
            <span class="value">${selectedProfessional.nome}</span>
        </div>
        <div class="summary-item">
            <span class="label">Serviço:</span>
            <span class="value">${nomeExibido}</span>
        </div>
        <div class="summary-item">
            <span class="label">Data:</span>
            <span class="value">${formattedDate}</span>
        </div>
        <div class="summary-item">
            <span class="label">Horário:</span>
            <span class="value">${selectedTime}</span>
        </div>
        <div class="summary-total">
            <span class="label">Total:</span>
            <span class="value">R$ ${selectedTierInfo.preco.toFixed(2).replace('.', ',')}</span>
        </div>
        ${selectedTierInfo.valor_adiantamento > 0 ? `
        <div class="summary-total" style="font-size: 1rem; margin-top: 8px;">
            <span class="label">Adiantamento Pago:</span>
            <span class="value" style="color: var(--color-success);">R$ ${selectedTierInfo.valor_adiantamento.toFixed(2).replace('.', ',')}</span>
        </div>
        ` : `
        <div class="summary-total" style="font-size: 1rem; margin-top: 8px;">
            <span class="label">Adiantamento:</span>
            <span class="value">R$ 0,00</span>
        </div>
        `}
    `;
    
    showScreen('confirmation-screen');
}

/**
 * Atualiza o resumo do agendamento na tela de login
 */
function updateBookingSummary() {
    if (selectedService && selectedDate && selectedTime && selectedTierInfo) {
        // Formata a data para exibição
        const [year, month, day] = selectedDate.split('-');
        const formattedDate = `${day}/${month}/${year}`;

        let nomeExibido = selectedService.name;
        if (selectedTierInfo.tierId) {
            const tier = selectedService.tiers_manutencao.find(t => t.id === selectedTierInfo.tierId);
            if (tier) nomeExibido = tier.nome_tier;
        }
        
        let adiantamentoHTML = '';
        if (selectedTierInfo.valor_adiantamento > 0) {
            const adiantamento = selectedTierInfo.valor_adiantamento.toFixed(2).replace('.', ',');
            adiantamentoHTML = `
                <div class="summary-total" style="font-size: 1rem; margin-top: 8px; border-top: 1px solid var(--color-border); padding-top: 8px;">
                    <span class="label">Adiantamento (PIX):</span>
                    <span class="value">R$ ${adiantamento}</span>
                </div>`;
        }

        // Preenche os detalhes do agendamento
        document.getElementById('summary-service').textContent = nomeExibido;
        document.getElementById('summary-date').textContent = formattedDate;
        document.getElementById('summary-time').textContent = selectedTime;
        document.getElementById('summary-duration').textContent = formatarDuracao(selectedTierInfo.duracao);
        document.getElementById('summary-price').textContent = `R$ ${selectedTierInfo.preco.toFixed(2).replace('.', ',')}`;
        document.getElementById('summary-professional').textContent = selectedProfessional.nome;

        // Adiciona o HTML do adiantamento
        const priceElement = document.getElementById('summary-price');
        
        // Remove o adiantamento antigo se houver
        const oldAdiantamento = priceElement.parentElement.parentElement.querySelector('.summary-total-adiantamento');
        if(oldAdiantamento) oldAdiantamento.remove();
        
        if(adiantamentoHTML) {
             priceElement.parentElement.parentElement.insertAdjacentHTML('beforeend', adiantamentoHTML.replace('summary-total', 'summary-total summary-total-adiantamento'));
        }
    }
}

// --- FUNÇÕES UTILITÁRIAS ---

/**
 * Formata uma data para o formato esperado pela API (YYYY-MM-DD)
 * @param {Date} date - Objeto de data
 * @returns {string} - Data formatada
 */
function formatDateForAPI(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

/**
 * Verifica se duas datas são o mesmo dia
 * @param {Date} date1 - Primeira data
 * @param {Date} date2 - Segunda data
 * @returns {boolean} - Se são o mesmo dia
 */
function isSameDay(date1, date2) {
    return date1.getFullYear() === date2.getFullYear() &&
           date1.getMonth() === date2.getMonth() &&
           date1.getDate() === date2.getDate();
}

/**
 * Obtém o token CSRF do cookie
 * @returns {string} - Token CSRF
 */
function getCsrfToken() {
    const name = 'csrftoken';
    let cookieValue = null;
    
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    
    return cookieValue;
}

// --- INÍCIO DE NOVAS FUNÇÕES (Pagamento) ---

/**
 * Inicia o timer de contagem regressiva na tela de pagamento.
 * @param {string} expiresAtISO - Data/hora ISO de quando o PIX expira.
 */
function startPaymentTimer(expiresAtISO) {
    const timerDisplay = document.getElementById('payment-timer-display').querySelector('span');
    if (!timerDisplay) return;

    const expirationTime = new Date(expiresAtISO).getTime();

    // Limpa timer anterior, se houver
    if (paymentTimerInterval) {
        clearInterval(paymentTimerInterval);
    }

    paymentTimerInterval = setInterval(() => {
        const now = new Date().getTime();
        const distance = expirationTime - now;

        if (distance <= 0) {
            clearInterval(paymentTimerInterval);
            timerDisplay.textContent = "Expirado";
            // O polling vai tratar o cancelamento
        } else {
            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);
            timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }
    }, 1000);
}

/**
 * Inicia o polling para verificar o status do agendamento.
 * @param {number} agendamentoId - ID do agendamento a ser verificado.
 * @param {string} expiresAtISO - Data/hora ISO de quando o PIX expira.
 */
function startPaymentPolling(agendamentoId, expiresAtISO) {
    // Limpa polling anterior, se houver
    stopPaymentPolling();

    const expirationTime = new Date(expiresAtISO).getTime();

    paymentPollingInterval = setInterval(async () => {
        const now = new Date().getTime();

        // 1. Verifica se o tempo expirou
        if (now >= expirationTime) {
            console.log("Timer expirou. Parando polling.");
            stopPaymentPolling();
            showScreen('payment-failed-screen');
            // O backend (cron job) vai limpar o agendamento
            return;
        }

        // 2. Se ainda há tempo, verifica o status no backend
        try {
            const response = await fetch(`/${empreendedorSlug}/api/check-booking-status/${agendamentoId}/`);
            if (!response.ok) {
                 // Se o agendamento não for encontrado (404), para o polling
                if(response.status === 404) stopPaymentPolling();
                return; // Tenta de novo na próxima
            }

            const result = await response.json();

            if (result.status === 'Confirmado') {
                // SUCESSO!
                console.log("Pagamento confirmado via polling!");
                stopPaymentPolling();
                showToast({ message: 'Pagamento recebido!', type: 'success' });
                // (selectedService, etc. ainda estão no estado global)
                await showConfirmation(agendamentoId);
                
            } else if (result.status === 'Cancelado') {
                // FALHA (Ex: webhook recebeu 'rejected' antes do polling)
                console.log("Agendamento cancelado via polling.");
                stopPaymentPolling();
                showScreen('payment-failed-screen');
            
            } else {
                // Ainda 'Aguardando Pagamento', continua o polling
                console.log("Aguardando pagamento...");
            }

        } catch (error) {
            console.error("Erro no polling:", error);
            // Continua tentando
        }
    }, 5000);
    // Verifica a cada 5 segundos
}

/**
 * Para todos os timers e intervals de pagamento.
 */
function stopPaymentPolling() {
    if (paymentPollingInterval) {
        clearInterval(paymentPollingInterval);
        paymentPollingInterval = null;
    }
    if (paymentTimerInterval) {
        clearInterval(paymentTimerInterval);
        paymentTimerInterval = null;
    }
    currentPendingAgendamentoId = null;
}

// --- FIM DE NOVAS FUNÇÕES (Pagamento) ---


// --- INICIALIZAÇÃO ---
window.proceedWithBooking = function() {
    processBooking();
};

// Listener para o botão de continuar
document.addEventListener('DOMContentLoaded', function() {
    const continueButton = document.getElementById('continue-to-login');
    if (continueButton) {
        continueButton.addEventListener('click', function() {
            // Em AMBOS os casos (logado ou não), vamos para a tela de login/resumo.
            // A tela irá se adaptar sozinha, mostrando o formulário ou a mensagem de "usuário logado".
            showScreen('login-screen');
        });
    }

    // --- NOVA ADIÇÃO (Botão Copiar PIX) ---
    const copyButton = document.getElementById('btn-copy-pix');
    if (copyButton) {
        copyButton.addEventListener('click', () => {
            const input = document.getElementById('payment-qr-code-text');
            input.select(); // Seleciona o texto
            input.setSelectionRange(0, 99999); // Para mobile
            
            try {
                navigator.clipboard.writeText(input.value);
                showToast({ message: 'Código PIX copiado!', type: 'success' });
                copyButton.textContent = 'Copiado!';
                setTimeout(() => { copyButton.textContent = 'Copiar'; }, 2000);
            } catch (err) {
                showToast({ message: 'Falha ao copiar. Copie manualmente.', type: 'error' });
            }
        });
    }
    // --- FIM DA NOVA ADIÇÃO ---
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\client.js

// static/js/client.js
// Funções relacionadas à área do cliente

// --- FUNÇÃO DE LÓGICA DE ABAS (NOVA) ---
/**
 * Alterna entre as abas de "Próximos" e "Histórico"
 * @param {Event} event - O evento do clique
 * @param {string} tabName - 'proximos' ou 'historico'
 */
window.showClientTab = function(event, tabName) {
    // 1. Botões
    const toggleContainer = event.target.closest('.form-toggle');
    toggleContainer.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // Animação da barra do toggle
    if (tabName === 'historico') {
        toggleContainer.classList.add('toggle-right');
    } else {
        toggleContainer.classList.remove('toggle-right');
    }

    // 2. Conteúdo
    document.querySelectorAll('.client-tab-content').forEach(tab => tab.classList.add('hidden'));
    document.getElementById(`client-tab-${tabName}`).classList.remove('hidden');
}


// --- FUNÇÃO PRINCIPAL (MODIFICADA) ---
/**
 * Carrega os agendamentos do cliente logado e os FILTRA
 */
async function loadClientAppointments() {
    const proximosContainer = document.getElementById('client-appointments-proximos');
    const historicoContainer = document.getElementById('client-appointments-historico');
    if (!proximosContainer || !historicoContainer) return;

    // Mostra o loading em ambas as abas
    const loadingHTML = `<div class="loading-indicator"><div class="loading-spinner"></div><p>Carregando...</p></div>`;
    proximosContainer.innerHTML = loadingHTML;
    historicoContainer.innerHTML = loadingHTML;
    
    try {
        const response = await fetch(`/${empreendedorSlug}/api/meus_agendamentos/`);
        if (!response.ok) {
            if (response.status === 403) {
                showScreen('forced-login-screen'); 
                return;
            }
            throw new Error('Falha ao carregar os dados.');
        }

        const appointments = await response.json();
        
        // --- LÓGICA DE FILTRO (NOVA) ---
        // 'Pendente' e 'Confirmado' são "Próximos"
        const proximos = appointments.filter(apt => 
            apt.status === 'Confirmado' || apt.status === 'Pendente'
        );
        
        // 'Concluído' e 'Cancelado' são "Histórico"
        const historico = appointments.filter(apt => 
            apt.status === 'Concluído' || apt.status === 'Cancelado'
        );
        
        // Renderiza as duas listas
        renderAppointmentList(
            proximosContainer, 
            proximos, 
            "Você não tem agendamentos futuros."
        );
        
        renderAppointmentList(
            historicoContainer, 
            historico, 
            "Você não possui histórico de agendamentos."
        );

    } catch (error) {
        const errorHTML = `<div class="error-state"><p>Ocorreu um erro ao carregar seus agendamentos.</p></div>`;
        proximosContainer.innerHTML = errorHTML;
        historicoContainer.innerHTML = errorHTML;
        console.error('Error fetching client appointments:', error);
    }
}

// --- FUNÇÃO HELPER DE RENDERIZAÇÃO (NOVA) ---
/**
 * Renderiza uma lista de agendamentos em um container
 * @param {HTMLElement} container - O elemento para preencher
 * @param {Array} list - A lista de agendamentos
 * @param {string} emptyMessage - Mensagem para lista vazia
 */
function renderAppointmentList(container, list, emptyMessage) {
    if (list.length === 0) {
        container.innerHTML = `
                    <div class="empty-state" style="padding-top: 16px;">
                        <div class="empty-icon">🗓️</div>
                        <h3>${emptyMessage}</h3>
                        ${(container.id === 'client-appointments-proximos') ?
'<button class="btn btn--primary mt-4" onclick="startBookingFlow()">Fazer um Novo Agendamento</button>' : ''}
                    </div>`;
        return;
    }

    container.innerHTML = ''; // Limpa o loading
    list.forEach(apt => {
        const card = createAppointmentCard(apt); // Usa a função existente
        container.appendChild(card);
    });
}


// --- FUNÇÃO DO CARD (MODIFICADA) ---
/**
 * Cria um card de agendamento para a área do cliente
 * @param {Object} appointment - Dados do agendamento
 * @returns {HTMLElement} - O elemento do card
 */
function createAppointmentCard(appointment) {
    const card = document.createElement('div');
    card.className = 'appointment-card';

    const [year, month, day] = appointment.date.split('-');
    const formattedDate = `${day}/${month}/${year}`;

    // Lógica dos botões de ação
    let actionsHTML = '';
    if (appointment.can_reschedule && (appointment.status === 'Confirmado' || appointment.status === 'Pendente')) {
        actionsHTML = `
            <button class="btn btn--secondary btn--sm" onclick="startReschedule(${appointment.id}, ${appointment.serviceId})">Remarcar</button>
            <button class="btn btn--danger btn--sm" onclick="confirmCancelAppointment(${appointment.id})">Cancelar</button>
        `;
    } else if (appointment.status === 'Confirmado' || appointment.status === 'Pendente') {
         actionsHTML = `<p class="cant-reschedule-text">Não é possível remarcar ou cancelar com menos de 24h de antecedência.</p>`;
    } else {
        // Se for "Concluído" ou "Cancelado", não mostra ações
        actionsHTML = ''; 
    }

    // --- LÓGICA DE STATUS (NOVA) ---
    let statusClass = '';
    switch(appointment.status) {
        case 'Confirmado': statusClass = 'success'; break;
        case 'Pendente': statusClass = 'pending'; break;
        case 'Concluído': statusClass = 'info'; break;
        case 'Cancelado': statusClass = 'danger'; break;
        default: statusClass = 'secondary';
    }
    // --- FIM DA LÓGICA DE STATUS ---

    // Cria a tag da imagem se houver URL, caso contrário, será vazia
    const serviceImageHTML = appointment.serviceImageUrl ? 
        `<div class="appointment-image-wrapper">
            <img src="${appointment.serviceImageUrl}" alt="Imagem do Serviço" class="appointment-service-image">
        </div>` : '';

    card.innerHTML = `
        ${serviceImageHTML} <div class="appointment-info">
            <h4>${appointment.service}</h4>
            <p>${formattedDate} às ${appointment.time}</p>
            <p class="appointment-professional">Com ${appointment.profissional}</p> <span class="status status--${statusClass}">${appointment.status}</span>
        </div>
        <div class="appointment-actions">
            ${actionsHTML}
        </div>
    `;
    return card;
}


// --- FUNÇÕES DE CANCELAMENTO (SEM MUDANÇA) ---
/**
 * Exibe um modal de confirmação para cancelar o agendamento
 * @param {number} appointmentId - O ID do agendamento a ser cancelado
 */
window.confirmCancelAppointment = function(appointmentId) {
    showModal({
        title: 'Confirmar Cancelamento',
        message: 'Tem certeza que deseja cancelar este agendamento? Esta ação não pode ser desfeita.',
        confirmText: 'Sim, cancelar',
        onConfirm: () => cancelAppointment(appointmentId)
    });
};

/**
 * Envia a requisição para cancelar um agendamento
 * @param {number} appointmentId - O ID do agendamento
 */
async function cancelAppointment(appointmentId) {
    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/agendamentos/${appointmentId}/cancelar/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': getCsrfToken() }
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);

        showToast({ message: 'Agendamento cancelado com sucesso!', type: 'success' });
        loadClientAppointments(); // Recarrega a lista
    } catch (error) {
        showToast({ message: `Erro: ${error.message}`, type: 'error' });
    } finally {
        hideLoading();
    }
}



/**
 * Carrega os dados do perfil do usuário e preenche o formulário de edição.
 */
window.loadProfileForEditing = async function() {
    const form = document.getElementById('profile-form');
    if (!form) return;

    showLoading();
    try {
        const response = await fetch(`/${empreendedorSlug}/api/me/profile/`);
        if (!response.ok) {
            // Se falhar (ex: sessão expirou), manda para o login
            if (response.status === 403 || response.status === 404) {
                showScreen('forced-login-screen');
                return;
            }
            throw new Error('Falha ao carregar dados do perfil.');
        }
        
        const profile = await response.json();
        
        // Preenche o formulário
        document.getElementById('profile-name').value = profile.first_name || '';
        document.getElementById('profile-lastname').value = profile.last_name || '';
        document.getElementById('profile-email').value = profile.email || '';
        document.getElementById('profile-phone').value = profile.phone || '';
        
        // --- MUDANÇA AQUI ---
        const nascimentoInput = document.getElementById('profile-nascimento');
        if (nascimentoInput.type === 'text') {
            // Se for mobile (campo de texto), converte para dd/mm/aaaa
            nascimentoInput.value = convertISOToDate(profile.nascimento);
        } else {
            // Se for PC (campo de data), usa o formato ISO
            nascimentoInput.value = profile.nascimento || '';
        }

    } catch (error) {
        showToast({ message: error.message, type: 'error' });
        // Se der erro, volta para a área do cliente
        showScreen('client-area-screen');
    } finally {
        hideLoading();
    }
}

/**
 * Salva os dados do perfil atualizados.
 */
async function saveProfile(event) {
    event.preventDefault();
    showLoading();

    const nascimentoInput = document.getElementById('profile-nascimento').value;
    const nascimentoISO = convertDateToISO(nascimentoInput); // Converte para YYYY-MM-DD
    
    if (!nascimentoISO) {
        showToast({ message: 'A data de nascimento é obrigatória e deve estar no formato dd/mm/aaaa.', type: 'error' });
        hideLoading();
        return;
    }

    // Coleta os dados do formulário
    const payload = {
        first_name: document.getElementById('profile-name').value,
        last_name: document.getElementById('profile-lastname').value,
        email: document.getElementById('profile-email').value,
        phone: document.getElementById('profile-phone').value.replace(/\D/g, ''), // Limpa o telefone
        nascimento: nascimentoISO // <-- Envia o formato ISO
    };

    // Validação simples do telefone
    if (!validatePhoneNumber(payload.phone)) {
        showToast({ message: 'Por favor, insira um telefone válido com DDD (10 ou 11 dígitos).', type: 'error' });
        hideLoading();
        return;
    }

    try {
        const response = await fetch(`/${empreendedorSlug}/api/me/profile/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (!response.ok) {
            throw new Error(result.message || 'Falha ao salvar o perfil.');
        }

        showToast({ message: result.message, type: 'success' });
        
        // Se o email foi alterado, o 'username' mudou.
        // É mais seguro forçar o logout para o usuário logar novamente
        // com o novo email, mas por enquanto vamos apenas recarregar o authState.
        await initAuthState(); // Recarrega os dados do usuário na UI

        showScreen('client-area-screen'); // Volta para a tela anterior

    } catch (error) {
        showToast({ message: `Erro: ${error.message}`, type: 'error' });
    } finally {
        hideLoading();
    }
}

// Adiciona o listener ao formulário de perfil
document.addEventListener('DOMContentLoaded', () => {
    const profileForm = document.getElementById('profile-form');
    if (profileForm) {
        profileForm.addEventListener('submit', saveProfile);
    }
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\dashboard.js

// static/js/dashboard.js

document.addEventListener('DOMContentLoaded', function() {
    // Inicializa tooltips
    const tooltips = document.querySelectorAll('[data-tooltip]');
    tooltips.forEach(tooltip => {
        new Tooltip(tooltip, {
            placement: tooltip.dataset.placement || 'top',
            title: tooltip.dataset.tooltip
        });
    });
    
    // Inicializa datepickers
    const datepickers = document.querySelectorAll('.datepicker');
    datepickers.forEach(datepicker => {
        new Datepicker(datepicker, {
            format: 'dd/mm/yyyy',
            language: 'pt-BR',
            autohide: true
        });
    });
    
    // Formatar números como moeda
    const currencyElements = document.querySelectorAll('.format-currency');
    currencyElements.forEach(el => {
        const value = parseFloat(el.textContent);
        el.textContent = formatCurrency(value);
    });
    
    // Formatação responsiva de tabelas
    const tables = document.querySelectorAll('.data-table');
    tables.forEach(table => {
        if (window.innerWidth < 768) {
            table.parentElement.classList.add('data-table-container');
        }
    });
    
    // Funções utilitárias
    function formatCurrency(value) {
        return new Intl.NumberFormat('pt-BR', {
            style: 'currency',
            currency: 'BRL'
        }).format(value);
    }
    
    // Handler de redimensionamento
    window.addEventListener('resize', function() {
        tables.forEach(table => {
            if (window.innerWidth < 768) {
                table.parentElement.classList.add('data-table-container');
            } else {
                table.parentElement.classList.remove('data-table-container');
            }
        });
    });
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\financial.js

// static/js/financial.js
// Handles financial management functions for the admin dashboard

/**
 * Mark an expense as paid
 * @param {number} expenseId - The ID of the expense to mark as paid
 */
window.markExpenseAsPaid = async function(expenseId) {
    
    try {
        const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                pago: true
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Show success message
            alert('Despesa marcada como paga com sucesso!');
            
            // Reload expenses data
            loadExpensesData();
            // Also reload financial overview to update totals
            loadFinancialOverview();
        } else {
            alert('Erro ao atualizar despesa: ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao marcar despesa como paga:', error);
        alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
    }
};

/**
 * Edit an expense
 * @param {number} expenseId - The ID of the expense to edit
 */
window.editExpense = async function(expenseId) {
    try {
        // Fetch expense details
        const response = await fetch(`/api/admin/despesa/${expenseId}/`);
        const expense = await response.json();
        
        if (!expense || expense.status === 'error') {
            throw new Error(expense.message || 'Não foi possível obter os detalhes da despesa.');
        }
        
        // Populate modal with expense data
        document.getElementById('expense-description').value = expense.descricao;
        document.getElementById('expense-amount').value = expense.valor;
        document.getElementById('expense-date').value = expense.data;
        document.getElementById('expense-category-select').value = expense.categoria;
        document.getElementById('expense-paid').checked = expense.pago;
        
        // Store expense ID in the form for reference
        document.getElementById('expense-form').dataset.expenseId = expenseId;
        document.getElementById('expense-modal-title').textContent = 'Editar Despesa';
        
        // Update save button to handle edit vs. new
        const saveButton = document.getElementById('expense-modal-save');
        saveButton.textContent = 'Atualizar Despesa';
        saveButton.onclick = updateExpense;
        
        // Show modal
        document.getElementById('expense-modal').classList.remove('hidden');
    } catch (error) {
        console.error('Erro ao carregar dados da despesa:', error);
        alert('Erro ao carregar dados da despesa. Verifique o console para mais detalhes.');
    }
};

/**
 * Update an existing expense
 */
async function updateExpense() {
    const expenseId = document.getElementById('expense-form').dataset.expenseId;
    if (!expenseId) return;
    
    const description = document.getElementById('expense-description').value;
    const amount = document.getElementById('expense-amount').value;
    const date = document.getElementById('expense-date').value;
    const category = document.getElementById('expense-category-select').value;
    const paid = document.getElementById('expense-paid').checked;
    
    if (!description || !amount || !date || !category) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    try {
        const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                descricao: description,
                valor: parseFloat(amount),
                data: date,
                categoria: category,
                pago: paid
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Despesa atualizada com sucesso!');
            document.getElementById('expense-modal').classList.add('hidden');
            loadExpensesData();
            loadFinancialOverview();
        } else {
            alert('Erro ao atualizar despesa: ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao atualizar despesa:', error);
        alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
    }
}

/**
 * Reset the expense form for a new expense
 */
window.resetExpenseForm = function() {
    const form = document.getElementById('expense-form');
    form.reset();
    delete form.dataset.expenseId;
    
    document.getElementById('expense-date').valueAsDate = new Date();
    document.getElementById('expense-modal-title').textContent = 'Registrar Nova Despesa';
    
    const saveButton = document.getElementById('expense-modal-save');
    saveButton.textContent = 'Salvar Despesa';
    saveButton.onclick = saveNewExpense;
    
    document.getElementById('expense-modal').classList.remove('hidden');
};

/**
 * Save a new expense
 */
async function saveNewExpense() {
    const description = document.getElementById('expense-description').value;
    const amount = document.getElementById('expense-amount').value;
    const date = document.getElementById('expense-date').value;
    const category = document.getElementById('expense-category-select').value;
    const paid = document.getElementById('expense-paid').checked;
    
    if (!description || !amount || !date || !category) {
        alert('Por favor, preencha todos os campos obrigatórios.');
        return;
    }
    
    try {
        const response = await fetch('/api/admin/registrar-despesa/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                descricao: description,
                valor: parseFloat(amount),
                data: date,
                categoria: category,
                pago: paid
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Despesa registrada com sucesso!');
            document.getElementById('expense-modal').classList.add('hidden');
            loadExpensesData();
            loadFinancialOverview();
        } else {
            alert('Erro ao registrar despesa: ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao registrar despesa:', error);
        alert('Erro ao registrar despesa. Verifique o console para mais detalhes.');
    }
}

/**
 * Generate payment status select with the appropriate status selected
 * @param {string} status - Current payment status
 * @returns {string} - HTML for the select element
 */
function generatePaymentStatusSelect(status, id) {
    return `
        <select class="form-control payment-status-select" data-appointment-id="${id}">
            <option value="Pendente" ${status === 'Pendente' ? 'selected' : ''}>Pendente</option>
            <option value="Pago" ${status === 'Pago' ? 'selected' : ''}>Pago</option>
            <option value="Cancelado" ${status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
        </select>
    `;
}

// Initialize event listeners for the financial page
document.addEventListener('DOMContentLoaded', function() {
    // Payment status select change handlers (for pending payments table)
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('payment-status-select')) {
            updateAppointmentPaymentStatus(e.target.dataset.appointmentId, e.target.value);
        }
    });

    // Modify btn-add-expense to use our new function
    const addExpenseBtn = document.getElementById('btn-add-expense');
    if (addExpenseBtn) {
        addExpenseBtn.addEventListener('click', resetExpenseForm);
    }
});

/**
 * Update an appointment's payment status
 * @param {number} appointmentId - The appointment ID
 * @param {string} status - The new payment status
 */
async function updateAppointmentPaymentStatus(appointmentId, status) {
    try {
        const response = await fetch(`/api/admin/atualizar-pagamento/${appointmentId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            },
            body: JSON.stringify({
                status_pagamento: status
            })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            alert('Status de pagamento atualizado com sucesso!');
            // Reload financial data
            if (typeof loadIncomeData === 'function') {
                loadIncomeData();
            }
            if (typeof loadFinancialOverview === 'function') {
                loadFinancialOverview();
            }
        } else {
            alert('Erro ao atualizar status de pagamento: ' + data.message);
        }
    } catch (error) {
        console.error('Erro ao atualizar status de pagamento:', error);
        alert('Erro ao atualizar status de pagamento. Verifique o console para mais detalhes.');
    }
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\gestao.js

// static/js/gestao.js

document.addEventListener('DOMContentLoaded', function() {
    
    // --- Variáveis Globais ---
    let equipeForm = document.getElementById('equipe-form');
    let equipeModal = document.getElementById('equipe-modal');
    let servicoForm = document.getElementById('servico-form');
    let servicoModal = document.getElementById('servico-modal');
    let servicoModalTitle = document.getElementById('servico-modal-title');
    let configForm = document.getElementById('config-form');
    let currentEditingServiceId = null;
    let localEquipe = []; // Cache local da equipe para popular o <select>

    let cropper = null; // A instância do Cropper
    let croppedLogoBlob = null; // O arquivo final (cortado) para enviar
    let logoModal = document.getElementById('cropper-modal');
    let logoImage = document.getElementById('cropper-image');
    let logoInput = document.getElementById('config-logo-input');

    let revertLogoBtn = null; // Será o botão "Desfazer"
    let originalLogoUrl = null; // Guarda a URL da logo original

    let serviceCropper = null;
    let croppedServiceBlob = null;
    let serviceCropperModal = document.getElementById('service-cropper-modal');
    let serviceCropperImage = document.getElementById('service-cropper-image');
    let serviceImageInput = document.getElementById('servico-imagem-input');
    let revertServiceImageBtn = null;
    let originalServiceImageUrl = null;

    let localCategorias = []; // Cache local de categorias
    let categoriaForm = document.getElementById('form-add-categoria');
    let categoriaModal = document.getElementById('categoria-modal');
    let categoriaEditForm = document.getElementById('categoria-edit-form');

    let isPagamentoOnlineHabilitado = false; // Cache global do interruptor
    let configToggleInput = document.getElementById('config-pagamento-online');

    // --- MUDANÇA ---
    // Variáveis para o novo modal de manutenção
    let manutencaoModal = document.getElementById('manutencao-modal');
    // O ID "form-add-manutencao" agora pertence ao novo modal
    let manutencaoForm = document.getElementById('form-add-manutencao'); 
    // O ID "manutencao-lista-tbody" agora também pertence ao novo modal
    let manutencaoTbody = document.getElementById('manutencao-lista-tbody');
    // Variável para saber qual serviço estamos editando
    let currentEditingManutencaoServiceId = null;

    let equipeEditModal = document.getElementById('equipe-edit-modal');
    let equipeEditForm = document.getElementById('equipe-edit-form');
    let currentEditingMembroId = null;

    // --- Token CSRF (Necessário para POST/DELETE) ---
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                      (document.cookie.match(/csrftoken=([^;]+)/) || [])[1];

    // --- Funções de Carregamento de Dados ---

    async function loadConfiguracoes() {
        try {
            console.log("Iniciando loadConfiguracoes...");
            const response = await fetch('/dashboard/api/gestao/configuracoes/');
            if (!response.ok) throw new Error('Falha ao carregar configurações.');
            
            const config = await response.json();
            console.log("Configurações recebidas:", config);

            // Vamos checar cada elemento ANTES de tentar usá-lo
            const nomeInput = document.getElementById('config-nome-negocio');
            if (!nomeInput) throw new Error("Elemento 'config-nome-negocio' não foi encontrado.");
            nomeInput.value = config.nome_negocio;

            const taglineInput = document.getElementById('config-tagline');
            if (!taglineInput) throw new Error("Elemento 'config-tagline' não foi encontrado.");
            taglineInput.value = config.tagline;

            // --- INÍCIO DA ADIÇÃO ---
            const portfolioInput = document.getElementById('config-portfolio-url');
            if (!portfolioInput) throw new Error("Elemento 'config-portfolio-url' não foi encontrado.");
            // Define o valor, tratando o caso de ser nulo (null) para não exibir "null" no campo
            portfolioInput.value = config.portfolio_url || ''; 
            // --- FIM DA ADIÇÃO ---

            const corPrimariaInput = document.getElementById('config-cor-primaria');
            if (!corPrimariaInput) throw new Error("Elemento 'config-cor-primaria' não foi encontrado.");
            corPrimariaInput.value = config.cor_primaria;

            const corSecundariaInput = document.getElementById('config-cor-secundaria');
            if (!corSecundariaInput) throw new Error("Elemento 'config-cor-secundaria' não foi encontrado.");
            corSecundariaInput.value = config.cor_secundaria;

            // Checagem da Logo
            const logoPreview = document.getElementById('logo-preview');
            const logoPreviewContainer = document.getElementById('logo-preview-container');
            if (!logoPreview || !logoPreviewContainer) throw new Error("Elementos de preview da logo não foram encontrados.");

            if (config.logo_url) {
                logoPreview.src = config.logo_url;
                logoPreviewContainer.style.display = 'block';
            } else {
                // Mantém o placeholder visível
                logoPreviewContainer.style.display = 'block'; 
            }
            originalLogoUrl = logoPreview.src; // Salva a URL inicial (seja a logo ou o placeholder)

            document.getElementById('config-dias-antecedencia').value = config.dias_antecedencia_maxima;

            // 1. Carrega o estado do interruptor
            document.getElementById('config-dias-antecedencia').value = config.dias_antecedencia_maxima;
            isPagamentoOnlineHabilitado = config.pagamento_online_habilitado; // Salva no cache
            configToggleInput.checked = isPagamentoOnlineHabilitado; // Define o estado visual
            
            // 2. Aciona a função para mostrar/esconder os campos de %
            togglePercentualFields(isPagamentoOnlineHabilitado);
            

            // const hiddenProcInput = document.getElementById('config-aviso-procedimento');
            // if (!hiddenProcInput) throw new Error("Elemento 'config-aviso-procedimento' não foi encontrado.");
            // hiddenProcInput.value = config.aviso_procedimento; // Salva o HTML no campo oculto
            // renderListPreview('aviso-proc-preview', parseHtmlList(config.aviso_procedimento)); // Renderiza a lista
            
            // const hiddenCancInput = document.getElementById('config-aviso-cancelamento');
            // if (!hiddenCancInput) throw new Error("Elemento 'config-aviso-cancelamento' não foi encontrado.");
            // hiddenCancInput.value = config.aviso_cancelamento; // Salva o HTML no campo oculto
            // renderListPreview('aviso-canc-preview', parseHtmlList(config.aviso_cancelamento)); // Renderiza a lista
            // // --- FIM DA CORREÇÃO ---

            console.log("loadConfiguracoes concluído com sucesso.");

        } catch (error) {
            // Isso vai nos dar a mensagem de erro específica
            console.error(error);
            alert(`Erro ao carregar configurações: ${error.message}`);
        }
    }

    // --- NOVA FUNÇÃO AUXILIAR ---
    /**
     * Mostra ou esconde os campos de percentual em toda a página de gestão
     * @param {boolean} isHabilitado - Se o interruptor global está ligado
     */
    function togglePercentualFields(isHabilitado) {
        const displayValue = isHabilitado ? 'block' : 'none';
        
        // Esconde no modal de Serviço
        document.querySelectorAll('.form-group-percentual').forEach(el => {
            el.style.display = displayValue;
        });
        
        // Esconde na tabela de Manutenção
        document.querySelectorAll('.col-percentual').forEach(el => {
            el.style.display = displayValue;
        });

        // Ajusta o grid do formulário de manutenção
        const gridForm = document.querySelector('.form-add-manutencao .manutencao-form-grid');
        if (gridForm) {
            if (isHabilitado) {
                gridForm.style.gridTemplateColumns = "2fr 1fr 1fr 1fr 1fr 1fr auto";
            } else {
                gridForm.style.gridTemplateColumns = "2fr 1fr 1fr 1fr 1fr auto"; // Mantém o layout, mas o campo está 'none'
            }
        }
    }

    /**
     * Carrega a lista de serviços do negócio e preenche a tabela
     */
    async function loadServicos() {
        const tbody = document.getElementById('servicos-lista-tbody');
        tbody.innerHTML = '<tr><td colspan="5">Carregando...</td></tr>';
        
        try {
            const response = await fetch('/dashboard/api/gestao/servicos/');
            if (!response.ok) throw new Error('Falha ao carregar serviços.');
            
            const servicos = await response.json();
            if (servicos.length === 0) {
                // CORREÇÃO: O colspan estava 5, mas são 6 colunas.
                tbody.innerHTML = '<tr><td colspan="6">Nenhum serviço cadastrado.</td></tr>';
                return;
            }
            
            tbody.innerHTML = ''; // Limpa a tabela
            servicos.forEach(s => {
                // Mapeia IDs de profissionais para nomes
                const nomesProfissionais = s.profissionais_ids
                    .map(id => {
                        const membro = localEquipe.find(m => m.id === id);
                        return membro ? membro.nome : 'N/A';
                    })
                    .join(', ');

                const categoriaNome = s.categoria_nome || '(Nenhuma)';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${s.nome}</td>
                    <td>${categoriaNome}</td>
                    <td>R$ ${s.preco.toFixed(2)}</td>
                    <td>${s.duracao_minutos} min</td>
                    <td>${nomesProfissionais || 'Nenhum'}</td>
                    <td class="actions-cell" style="display: flex; gap: 8px;">
                        <button class="btn btn--outline btn--sm btn-edit" data-id="${s.id}">Editar</button>
                        <button class="btn btn--secondary btn--sm btn-manutencao" data-id="${s.id}" data-nome="${s.nome}">Manutenção</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

        } catch (error) {
            console.error('Erro ao carregar serviços:', error);
            tbody.innerHTML = `<tr><td colspan="5" class="text-error">${error.message}</td></tr>`;
        }
    }

    async function loadCategorias(selectElementId = null) {
        const tbody = document.getElementById('categorias-lista-tbody');
        
        try {
            const response = await fetch('/dashboard/api/gestao/categorias/');
            if (!response.ok) throw new Error('Falha ao carregar categorias.');
            
            localCategorias = await response.json(); // Salva no cache
            
            // 1. Popula a tabela na aba "Categorias"
            if (tbody) {
                if (localCategorias.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="2">Nenhuma categoria cadastrada.</td></tr>';
                } else {
                    tbody.innerHTML = '';
                    localCategorias.forEach(c => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${c.nome}</td>
                            <td>
                                <button class="btn btn--outline btn--sm btn-edit-categoria" data-id="${c.id}" data-nome="${c.nome}">Editar</button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
                }
            }
            
            // 2. Popula o <select> no modal de serviço (opcional)
            const selectServicoCat = document.getElementById(selectElementId);
            if (selectServicoCat) {
                selectServicoCat.innerHTML = '<option value="">(Nenhuma)</option>'; // Reset
                localCategorias.forEach(c => {
                    selectServicoCat.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
                });
            }

        } catch (error) {
            console.error('Erro ao carregar categorias:', error);
            if (tbody) tbody.innerHTML = `<tr><td colspan="2" class="text-error">${error.message}</td></tr>`;
        }
    }

    async function saveConfiguracoes(event) {
        event.preventDefault();
        
        // 1. Não podemos mais usar JSON. Temos que usar FormData.
        const formData = new FormData();
        formData.append('nome_negocio', document.getElementById('config-nome-negocio').value);
        formData.append('tagline', document.getElementById('config-tagline').value);
        // --- INÍCIO DA ADIÇÃO ---
        formData.append('portfolio_url', document.getElementById('config-portfolio-url').value);
        // --- FIM DA ADIÇÃO ---
        formData.append('cor_primaria', document.getElementById('config-cor-primaria').value);
        formData.append('cor_secundaria', document.getElementById('config-cor-secundaria').value);
        
        // --- CORREÇÃO AQUI ---
        // O nome do campo é o mesmo, mas agora ele é um input oculto.
        // O código continua o mesmo, pois o ID não mudou.
        // formData.append('aviso_procedimento', document.getElementById('config-aviso-procedimento').value);
        // formData.append('aviso_cancelamento', document.getElementById('config-aviso-cancelamento').value);

        formData.append('dias_antecedencia_maxima', document.getElementById('config-dias-antecedencia').value);
        
        // 2. Pega o arquivo de imagem
        formData.append('dias_antecedencia_maxima', document.getElementById('config-dias-antecedencia').value);

        formData.append('pagamento_online_habilitado', configToggleInput.checked);
        
        // --- MUDANÇA AQUI ---
        // 2. Pega o arquivo de imagem CORTADO (se existir)
        if (croppedLogoBlob) {
            // Envia o Blob cortado com um nome de arquivo
            formData.append('logo', croppedLogoBlob, 'logo_cortada.png');
        }
        // (Não precisamos mais checar o logoInput.files)

        try {
            const response = await fetch('/dashboard/api/gestao/configuracoes/', {
                method: 'POST',
                headers: {
                    // 3. NÃO definimos 'Content-Type'. O browser faz isso
                    // automaticamente para 'multipart/form-data'
                    'X-CSRFToken': csrfToken
                },
                body: formData // 4. Enviamos o FormData
            });

            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            showToast({ message: result.message, type: 'success' });

            
            // Atualiza o preview da logo se uma nova foi enviada
            if (result.new_logo_url) {
                 document.getElementById('logo-preview').src = result.new_logo_url;
                 document.getElementById('logo-preview-container').style.display = 'block';
                 // --- ADICIONE ESTA LINHA ---
                 originalLogoUrl = result.new_logo_url; // O "original" agora é o que foi salvo
            }

            croppedLogoBlob = null; // Limpa o blob após o envio

            if (revertLogoBtn) revertLogoBtn.style.display = 'none'; // Esconde o botão "Desfazer"
            
        } catch (error) {
            showToast({ message: `Erro ao salvar: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Carrega a lista de equipe para o cache local (usado no modal)
     */
    async function loadEquipe() {
        const tbody = document.getElementById('equipe-lista-tbody');
        tbody.innerHTML = '<tr><td colspan="3">Carregando...</td></tr>';
        
        try {
            const response = await fetch('/dashboard/api/gestao/equipe/');
            if (!response.ok) throw new Error('Falha ao carregar equipe.');
            
            localEquipe = await response.json(); // Salva no cache
            
            // --- NOVA LÓGICA PARA PREENCHER A TABELA ---
            if (localEquipe.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3">Nenhum membro na equipe.</td></tr>';
                return;
            }
            
            tbody.innerHTML = ''; // Limpa a tabela
            localEquipe.forEach(m => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${m.nome}</td>
                    <td>${m.email}</td>
                    <td style="text-align: right;">
                        <button class="btn btn--outline btn--sm btn-edit-equipe" data-id="${m.id}">Editar</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            // --- FIM DA NOVA LÓGICA ---

        } catch (error) {
            console.error('Erro ao carregar equipe:', error);
            localEquipe = []; // Limpa o cache em caso de erro
            tbody.innerHTML = `<tr><td colspan="3" class="text-error">${error.message}</td></tr>`;
        }
    }

    async function loadHorarios() {
        const container = document.getElementById('horarios-semana-container');
        container.innerHTML = '<p>Carregando horários...</p>';
        
        try {
            const response = await fetch('/dashboard/api/gestao/horarios/');
            if (!response.ok) throw new Error('Falha ao carregar horários.');
            
            const horarios = await response.json();
            
            // Agrupa horários por dia da semana
            const diasSemana = [
                { id: 0, nome: 'Segunda-feira', horarios: [] },
                { id: 1, nome: 'Terça-feira', horarios: [] },
                { id: 2, nome: 'Quarta-feira', horarios: [] },
                { id: 3, nome: 'Quinta-feira', horarios: [] },
                { id: 4, nome: 'Sexta-feira', horarios: [] },
                { id: 5, nome: 'Sábado', horarios: [] },
                { id: 6, nome: 'Domingo', horarios: [] },
            ];
            
            horarios.forEach(h => {
                const dia = diasSemana.find(d => d.id === h.dia_da_semana);
                if (dia) {
                    dia.horarios.push(h);
                }
            });
            
            container.innerHTML = ''; // Limpa o "Carregando"
            
            // Renderiza os 7 dias
            diasSemana.forEach(dia => {
                const diaEl = document.createElement('div');
                diaEl.className = 'dia-semana-bloco';
                
                let horariosHTML = '<ul class="horario-slot-lista">';
                if (dia.horarios.length === 0) {
                    horariosHTML += '<li class="text-secondary">Nenhum horário definido.</li>';
                }
                dia.horarios.forEach(h => {
                    horariosHTML += `
                        <li class="horario-slot-item">
                            <span>${h.hora_inicio} - ${h.hora_fim}</span>
                            <button class="btn-delete-horario" data-id="${h.id}">&times;</button>
                        </li>
                    `;
                });
                horariosHTML += '</ul>';
                
                // Formulário para adicionar novo
                diaEl.innerHTML = `
                    <h4>${dia.nome}</h4>
                    ${horariosHTML}
                    <form class="form-add-horario" data-dia="${dia.id}">
                        <input type="time" class="form-control" name="inicio" required>
                        <span>até</span>
                        <input type="time" class="form-control" name="fim" required>
                        <button type="submit" class="btn btn--primary btn--sm">Adicionar</button>
                    </form>
                `;
                container.appendChild(diaEl);
            });
            
        } catch (error) {
            console.error(error);
            container.innerHTML = `<p class="text-error">${error.message}</p>`;
        }
    }
    
    // --- ADICIONE ESTAS NOVAS FUNÇÕES ---
    
    /**
     * Salva um novo horário de trabalho
     */
    async function saveHorario(event) {
        event.preventDefault();
        const form = event.target;
        const diaId = form.dataset.dia;
        const horaInicio = form.elements['inicio'].value;
        const horaFim = form.elements['fim'].value;
        
        if (horaInicio >= horaFim) {
            alert('A hora de início deve ser anterior à hora de fim.');
            return;
        }
        
        try {
            const response = await fetch('/dashboard/api/gestao/horarios/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    dia_da_semana: diaId,
                    hora_inicio: horaInicio,
                    hora_fim: horaFim
                })
            });
            const result = await response.json();
            if (!response.ok) {
                throw new Error(result.message || 'Falha ao salvar.');
            }
            
            await loadHorarios(); // Recarrega a lista
            
            // --- CORREÇÃO ---
            showToast({ message: result.message, type: 'success' });
            
        } catch (error) {
            // --- CORREÇÃO ---
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }
    
    /**
     * Exclui um horário de trabalho
     */
    async function deleteHorario(horarioId) {
        
        try {
            const response = await fetch(`/dashboard/api/gestao/horarios/${horarioId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message || 'Falha ao excluir.');
            }
            
            await loadHorarios(); // Recarrega
            
            // --- CORREÇÃO ---
            showToast({ message: 'Horário removido.', type: 'success' });
            
        } catch (error) {
            // --- CORREÇÃO ---
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    async function loadDiasBloqueados() {
        const container = document.getElementById('lista-dias-bloqueados');
        container.innerHTML = '<p>Carregando...</p>';
        try {
            const response = await fetch('/dashboard/api/gestao/dias-bloqueados/');
            const bloqueios = await response.json();
            
            container.innerHTML = '';
            if (bloqueios.length === 0) {
                container.innerHTML = '<p class="text-secondary text-center" style="margin: 0; padding: 8px; font-size: 14px;">Nenhum dia bloqueado.</p>';
                return;
            }
            
            bloqueios.forEach(b => {
                const dataFormatada = new Date(b.data + 'T00:00:00-03:00').toLocaleDateString('pt-BR');
                const itemEl = document.createElement('div');
                itemEl.className = 'lista-preview-item';
                itemEl.innerHTML = `
                    <span>
                        <strong>${dataFormatada}</strong> - ${b.descricao || 'Dia bloqueado'}
                    </span>
                    <button type="button" class="btn-delete-bloqueio" data-id="${b.id}">&times;</button>
                `;
                container.appendChild(itemEl);
            });
        } catch (error) {
            container.innerHTML = `<p class="text-error">${error.message}</p>`;
        }
    }

    /**
     * Salva um novo dia bloqueado
     */
    async function saveDiaBloqueado(event) {
        event.preventDefault();
        const dataInput = document.getElementById('bloqueio-data');
        const descInput = document.getElementById('bloqueio-descricao');
        
        try {
            const response = await fetch('/dashboard/api/gestao/dias-bloqueados/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({
                    data: dataInput.value,
                    descricao: descInput.value
                })
            });
            const result = await response.json();

            // --- CORREÇÃO ---
            if (!response.ok) {
                // Lança o erro com a MENSAGEM DA API
                throw new Error(result.message || 'Falha ao salvar.');
            }
            // --- FIM DA CORREÇÃO ---
            
            dataInput.value = '';
            descInput.value = '';
            await loadDiasBloqueados();
            
            // --- CORREÇÃO ---
            showToast({ message: result.message, type: 'success' });
            
        } catch (error) {
            // --- CORREÇÃO ---
            // Agora isso vai mostrar "Não é possível bloquear..."
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Exclui um dia bloqueado
     */
    async function deleteDiaBloqueado(bloqueioId) {
        try {
            const response = await fetch(`/dashboard/api/gestao/dias-bloqueados/${bloqueioId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message);
            }
            await loadDiasBloqueados();
            
            // --- CORREÇÃO ---
            showToast({ message: 'Bloqueio removido.', type: 'success' });

        } catch (error) {
            // --- CORREÇÃO ---
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    // ---
    // --- FUNÇÕES DO MURAL DE AVISOS ---
    // ---
    
    let currentEditingAvisoId = null;
    let avisoForm = document.getElementById('aviso-form');
    let avisoModal = document.getElementById('aviso-modal');

    /**
     * Carrega e renderiza a lista de avisos
     */
    async function loadAvisos() {
        const container = document.getElementById('avisos-lista-container');
        container.innerHTML = '<p>Carregando avisos...</p>';
        
        try {
            const response = await fetch('/dashboard/api/gestao/avisos/');
            if (!response.ok) throw new Error('Falha ao carregar avisos.');
            const avisos = await response.json();
            
            if (avisos.length === 0) {
                container.innerHTML = '<p class="text-secondary">Nenhum aviso cadastrado.</p>';
                return;
            }
            
            container.innerHTML = ''; // Limpa
            avisos.forEach(aviso => {
                const card = document.createElement('div');
                card.className = 'aviso-card';
                card.innerHTML = `
                    <div class="aviso-card-header">
                        <h4>${aviso.titulo}</h4>
                        <button class="btn btn--outline btn--sm btn-edit-aviso" data-id="${aviso.id}">Editar</button>
                    </div>
                    <div class="aviso-card-body">
                        ${aviso.conteudo} </div>
                `;
                container.appendChild(card);
            });

        } catch (error) {
            console.error(error);
            container.innerHTML = `<p class="text-error">${error.message}</p>`;
        }
    }

    /**
     * Abre o modal de aviso (para criar ou editar)
     */
    async function openAvisoModal(avisoId = null) {
        avisoForm.reset();
        currentEditingAvisoId = avisoId;
        const deleteButton = document.getElementById('aviso-modal-delete');

        if (avisoId) {
            // --- MODO EDIÇÃO ---
            document.getElementById('aviso-modal-title').textContent = 'Editar Aviso';
            deleteButton.classList.remove('hidden');
            
            // Busca dados do aviso
            try {
                const response = await fetch(`/dashboard/api/gestao/avisos/${avisoId}/`);
                if (!response.ok) throw new Error('Falha ao carregar aviso.');
                const aviso = await response.json();
                
                document.getElementById('aviso-id').value = aviso.id;
                document.getElementById('aviso-titulo').value = aviso.titulo;
                document.getElementById('aviso-conteudo').value = convertHtmlListToText(aviso.conteudo);
                document.getElementById('aviso-ordem').value = aviso.ordem;

            } catch (error) {
                alert('Erro ao carregar dados do aviso.');
                return;
            }
        } else {
            // --- MODO CRIAÇÃO ---
            document.getElementById('aviso-modal-title').textContent = 'Novo Aviso';
            deleteButton.classList.add('hidden');
        }
        avisoModal.classList.remove('hidden');
    }

    /**
     * Fecha o modal de aviso
     */
    function closeAvisoModal() {
        avisoModal.classList.add('hidden');
        currentEditingAvisoId = null;
    }

    /**
     * Converte um texto simples com quebras de linha em uma lista HTML.
     * Cada linha vira um <li>. Linhas em branco viram <p>.
     * @param {string} plainText
     * @returns {string} - HTML formatado
     */
    function convertTextToHtmlList(plainText) {
        if (!plainText || plainText.trim() === '') return '';

        const lines = plainText.split('\n');
        let html = '';
        let inList = false;

        for (const line of lines) {
            const trimmedLine = line.trim();

            if (trimmedLine !== '') {
                // Linha com texto
                if (!inList) {
                    html += '<ul>'; // Começa uma nova lista
                    inList = true;
                }
                html += `<li>${trimmedLine}</li>`; // Adiciona o item
            } else {
                // Linha vazia
                if (inList) {
                    html += '</ul>'; // Fecha a lista anterior
                    inList = false;
                }
                html += '<p>&nbsp;</p>'; // Adiciona um parágrafo de espaço
            }
        }
        if (inList) {
            html += '</ul>'; // Fecha a lista se ela ainda estiver aberta
        }
        return html;
    }

    /**
     * Converte uma lista HTML (<ul><li>...</li></ul>) de volta para texto puro.
     * @param {string} htmlContent
     * @returns {string} - Texto puro com quebras de linha
     */
    function convertHtmlListToText(htmlContent) {
        if (!htmlContent) return '';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = htmlContent;
        let plainText = '';

        tempDiv.childNodes.forEach((node, index) => {
            if (index > 0) {
                plainText += '\n'; // Adiciona quebra de linha entre os blocos
            }
            if (node.nodeName === 'UL') {
                const items = Array.from(node.querySelectorAll('li')).map(li => li.textContent);
                plainText += items.join('\n');
            } else if (node.nodeName === 'P' && node.innerHTML !== '&nbsp;') {
                plainText += node.textContent;
            }
        });
        return plainText;
    }

    /**
     * Salva (Cria ou Edita) um aviso
     */
    async function saveAviso(event) {
        event.preventDefault();
        
        // --- MUDANÇA AQUI ---
        // 1. Pega o texto puro
        const rawText = document.getElementById('aviso-conteudo').value;
        // 2. Converte o texto para HTML
        const htmlContent = convertTextToHtmlList(rawText);
        // --- FIM DA MUDANÇA ---

        const data = {
        titulo: document.getElementById('aviso-titulo').value,
        conteudo: htmlContent, // <-- Envia o HTML processado
        ordem: parseInt(document.getElementById('aviso-ordem').value)
    };
        
        let url = '/dashboard/api/gestao/avisos/';
        let method = 'POST';
        
        if (currentEditingAvisoId) {
            url = `/dashboard/api/gestao/avisos/${currentEditingAvisoId}/`;
        }

        try {
            const response = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            showToast({ message: result.message, type: 'success' });
            closeAvisoModal();
            await loadAvisos(); // Recarrega a lista
            
        } catch (error) {
            showToast({ message: `Erro ao salvar: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Exclui um aviso
     */
    async function deleteAviso() {
        if (!currentEditingAvisoId) return;

        try {
            const response = await fetch(`/dashboard/api/gestao/avisos/${currentEditingAvisoId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message);
            }
            
            showToast({ message: 'Aviso excluído.', type: 'success' });
            closeAvisoModal();
            await loadAvisos();
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Pega uma string HTML <ul><li>...</li></ul> e a transforma em uma array de strings.
     */
    // function parseHtmlList(htmlString) {
    //     if (!htmlString || !htmlString.includes('<li>')) return [];
    //     const doc = new DOMParser().parseFromString(htmlString, 'text/html');
    //     return Array.from(doc.querySelectorAll('li')).map(li => li.textContent);
    // }

    // /**
    //  * Pega uma array de strings e a transforma em uma string HTML <ul>...</ul>.
    //  */
    // function buildHtmlList(items) {
    //     if (items.length === 0) return '';
    //     const listItems = items.map(item => `<li>${item}</li>`).join('');
    //     return `<ul>${listItems}</ul>`;
    // }

    // /**
    //  * Renderiza a pré-visualização da lista com botões de "remover".
    //  */
    // function renderListPreview(previewId, items) {
    //     const previewContainer = document.getElementById(previewId);
    //     previewContainer.innerHTML = ''; // Limpa a lista
        
    //     if (items.length === 0) {
    //         previewContainer.innerHTML = '<p class="text-secondary text-center" style="margin: 0; padding: 8px; font-size: 14px;">Nenhum item adicionado.</p>';
    //         return;
    //     }

    //     items.forEach(itemText => {
    //         const itemEl = document.createElement('div');
    //         itemEl.className = 'lista-preview-item';
    //         itemEl.innerHTML = `
    //             <span>${itemText}</span>
    //             <button type="button" class="btn-remove-lista-item">&times;</button>
    //         `;
    //         // Adiciona o listener para o botão de remover
    //         itemEl.querySelector('button').addEventListener('click', () => {
                
    //             // --- INÍCIO DA CORREÇÃO ---
    //             // Define o ID do input oculto correto baseado no previewId
    //             const hiddenInputId = (previewId === 'aviso-proc-preview') 
    //                 ? 'config-aviso-procedimento' 
    //                 : 'config-aviso-cancelamento';
    //             // --- FIM DA CORREÇÃO ---

    //             // 1. Remove o item da array
    //             const currentItems = parseHtmlList(document.getElementById(hiddenInputId).value);
    //             const newItems = currentItems.filter(item => item !== itemText);
                
    //             // 2. Atualiza o input oculto
    //             document.getElementById(hiddenInputId).value = buildHtmlList(newItems);
                
    //             // 3. Renderiza a preview novamente
    //             renderListPreview(previewId, newItems);
    //         });
    //         previewContainer.appendChild(itemEl);
    //     });
    // }

    // /**
    //  * Adiciona um novo item à lista.
    //  */
    // function addListItem(inputId, previewId, hiddenInputId) {
    //     const input = document.getElementById(inputId);
    //     const text = input.value.trim();
    //     if (text === '') return;

    //     // 1. Pega os itens atuais do input oculto
    //     const currentItems = parseHtmlList(document.getElementById(hiddenInputId).value);
        
    //     // 2. Adiciona o novo item
    //     currentItems.push(text);
        
    //     // 3. Salva a nova lista HTML no input oculto
    //     document.getElementById(hiddenInputId).value = buildHtmlList(currentItems);
        
    //     // 4. Renderiza a nova preview
    //     renderListPreview(previewId, currentItems);
        
    //     // 5. Limpa o campo de texto
    //     input.value = '';
    // }

    // =================================================================
    // NOVAS FUNÇÕES: Gerenciamento de Categoria
    // =================================================================

    /**
     * Salva uma nova categoria (do formulário da aba)
     */
    async function saveCategoria(event) {
        event.preventDefault();
        const input = document.getElementById('categoria-nome-input');
        const nome = input.value.trim();
        if (nome === '') return;

        try {
            const response = await fetch('/dashboard/api/gestao/categorias/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ nome: nome })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            showToast({ message: 'Categoria criada!', type: 'success' });
            input.value = '';
            await loadCategorias('servico-categoria'); // Recarrega tabela E o select
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Abre o modal de edição de categoria
     */
    function openCategoriaModal(id, nome) {
        document.getElementById('categoria-edit-id').value = id;
        document.getElementById('categoria-edit-nome').value = nome;
        categoriaModal.classList.remove('hidden');
    }

    function closeCategoriaModal() {
        categoriaModal.classList.add('hidden');
    }

    /**
     * Salva a edição da categoria (do modal)
     */
    async function saveCategoriaEdit(event) {
        event.preventDefault();
        const id = document.getElementById('categoria-edit-id').value;
        const nome = document.getElementById('categoria-edit-nome').value.trim();
        
        try {
            const response = await fetch(`/dashboard/api/gestao/categorias/${id}/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify({ nome: nome })
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            showToast({ message: 'Categoria atualizada!', type: 'success' });
            closeCategoriaModal();
            await loadCategorias('servico-categoria'); // Recarrega
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Exclui uma categoria (do modal)
     */
    async function deleteCategoria() {
        const id = document.getElementById('categoria-edit-id').value;

        try {
            const response = await fetch(`/dashboard/api/gestao/categorias/${id}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message);
            }

            showToast({ message: 'Categoria excluída.', type: 'success' });
            closeCategoriaModal();
            await loadCategorias('servico-categoria'); // Recarrega
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }
    
    // =================================================================
    // NOVAS FUNÇÕES: Gerenciamento de Preços de Manutenção
    // =================================================================
    
    /**
     * Carrega os tiers de manutenção para o modal de serviço
     */
    async function loadManutencaoTiers(servicoId) {
        const tbody = document.getElementById('manutencao-lista-tbody');
        tbody.innerHTML = '<tr><td colspan="6">Carregando...</td></tr>';
        
        try {
            const response = await fetch(`/dashboard/api/gestao/servicos/${servicoId}/manutencao/`);
            if (!response.ok) throw new Error('Falha ao carregar tiers.');
            
            const tiers = await response.json();

            // Atualiza a visibilidade da coluna (antes de preencher)
            togglePercentualFields(isPagamentoOnlineHabilitado);
            
            if (tiers.length === 0) {
                tbody.innerHTML = `<tr><td colspan="${isPagamentoOnlineHabilitado ? 7 : 6}">Nenhum preço de manutenção cadastrado.</td></tr>`;
                return;
            }
            tbody.innerHTML = '';
            tiers.forEach(tier => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${tier.nome_tier}</td>
                    <td>${tier.dias_min}</td>
                    <td>${tier.dias_max}</td>
                    <td>R$ ${tier.preco.toFixed(2)}</td>
                    <td>${tier.duracao_minutos} min</td>
                    <td class="col-percentual" style="display: ${isPagamentoOnlineHabilitado ? 'table-cell' : 'none'};">
                        ${tier.percentual_adiantamento}%
                    </td>
                    <td>
                        <button type="button" class="btn btn--outline btn--sm btn-delete-manutencao" data-id="${tier.id}">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="6" class="text-error">${error.message}</td></tr>`;
        }
    }
    
    /**
     * Salva um novo tier de manutenção (do modal de serviço)
     */
    async function saveManutencaoTier(event) {
        event.preventDefault();
        // --- MUDANÇA ---
        if (!currentEditingManutencaoServiceId) return;

        // =================================================================
        // INÍCIO: Bloco de Validação Client-Side
        // =================================================================
        
        // 1. Pega os dados do formulário para validar
        const newNomeInput = document.getElementById('manutencao-nome');
        const newMinInput = document.getElementById('manutencao-dias-min');
        const newMaxInput = document.getElementById('manutencao-dias-max');

        const newNome = newNomeInput.value.trim();
        const newMin = parseInt(newMinInput.value);
        const newMax = parseInt(newMaxInput.value);

        // Validação básica de dias
        if (newMin >= newMax) {
            showToast({ message: 'O "Dias Mín" deve ser menor que o "Dias Max".', type: 'error' });
            return;
        }

        // 2. Pega os dados existentes na tabela para comparar
        const existingRows = manutencaoTbody.querySelectorAll('tr');
        
        for (const row of existingRows) {
            // Pula a linha de "carregando" ou "vazio" [cite: 1874, 1877]
            if (row.cells.length < 6) continue; 

            const existingNome = row.cells[0].textContent.trim();
            const existingMin = parseInt(row.cells[1].textContent);
            const existingMax = parseInt(row.cells[2].textContent);

            // TRAVA 1: Verifica o nome duplicado
            if (existingNome.toLowerCase() === newNome.toLowerCase()) {
                showToast({ message: `Erro: O nome "${newNome}" já está em uso.`, type: 'error' });
                newNomeInput.focus(); // Ajuda o usuário
                return; // Para a execução
            }

            // TRAVA 2: Verifica sobreposição de dias
            // A lógica é: (NovoMin <= ExistenteMax) E (NovoMax >= ExistenteMin)
            if (newMin <= existingMax && newMax >= existingMin) {
                showToast({ 
                    message: `Erro: O período (${newMin}-${newMax} dias) conflita com um período existente (${existingMin}-${existingMax} dias).`, 
                    type: 'error' 
                });
                newMinInput.focus(); // Ajuda o usuário
                return; // Para a execução
            }
        }
        // =================================================================
        // FIM: Bloco de Validação Client-Side
        // =================================================================

        // Se passou pelas travas, continua com o salvamento
        const data = {
            nome_tier: newNome,
            dias_min: newMin,
            dias_max: newMax,
            preco: parseFloat(document.getElementById('manutencao-preco').value),
            duracao_minutos: parseInt(document.getElementById('manutencao-duracao').value),
            percentual_adiantamento: parseInt(document.getElementById('manutencao-percentual').value)
        };

        try {
            const response = await fetch(`/dashboard/api/gestao/servicos/${currentEditingManutencaoServiceId}/manutencao/`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrfToken },
                body: JSON.stringify(data)
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);
            
            showToast({ message: 'Tier de manutenção salvo!', type: 'success' });
            manutencaoForm.reset();
            await loadManutencaoTiers(currentEditingManutencaoServiceId); // Recarrega a lista
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }
    
    /**
     * Deleta um tier de manutenção
     */
    async function deleteManutencaoTier(tierId) {
        
        try {
            const response = await fetch(`/dashboard/api/gestao/manutencao/${tierId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message);
            }
            
            showToast({ message: 'Tier de manutenção removido.', type: 'success' });
            await loadManutencaoTiers(currentEditingManutencaoServiceId); // Recarrega
            
        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    // --- Funções do Modal ---

    /**
     * Abre o modal de serviço, seja para criar um novo ou editar um existente
     * @param {number|null} serviceId - O ID do serviço para editar, ou null para criar
     */
    async function openServicoModal(serviceId = null) {
        servicoForm.reset();
        // manutencaoForm.reset(); // <-- REMOVIDO
        // document.getElementById('manutencao-lista-tbody').innerHTML = ''; // <-- REMOVIDO
        currentEditingServiceId = serviceId; // (Mantido)

        // 1. Popula os 'flags' de profissionais
        const flagsContainer = document.getElementById('servico-profissionais-flags');
        flagsContainer.innerHTML = ''; // Limpa o container
        if (localEquipe.length === 0) {
            flagsContainer.innerHTML = '<p class="text-secondary" style="padding: 8px 0;">Nenhum membro na equipe.</p>';
        } else {
            localEquipe.forEach(membro => {
                const flag = document.createElement('div');
                flag.className = 'flag-item-toggle';
                flag.textContent = membro.nome;
                flag.dataset.id = membro.id; // Armazena o ID no data attribute
                
                // Adiciona o evento de clique para toggle
                flag.addEventListener('click', () => {
                    flag.classList.toggle('selected');
                });
                
                flagsContainer.appendChild(flag);
            });
        }

        // --- NOVA ADIÇÃO ---
        // 2. Popula o <select> de categorias (usando o cache)
        const selectCategorias = document.getElementById('servico-categoria');
        selectCategorias.innerHTML = '<option value="">(Nenhuma)</option>';
        localCategorias.forEach(c => {
            selectCategorias.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
        });
        // --- FIM DA ADIÇÃO ---

        // Mostra/Esconde o campo de percentual ANTES de popular
        togglePercentualFields(isPagamentoOnlineHabilitado);

        const deleteButton = document.getElementById('servico-modal-delete');
        if (serviceId) {
            // --- MODO EDIÇÃO ---
            servicoModalTitle.textContent = 'Editar Serviço';
            deleteButton.classList.remove('hidden');
            
            // await loadManutencaoTiers(serviceId); // <-- REMOVIDO
            
            try {
                const response = await fetch(`/dashboard/api/gestao/servicos/${serviceId}/`);
                if (!response.ok) throw new Error('Falha ao carregar dados do serviço.');
                const servico = await response.json();
                
                // Preenche o formulário
                document.getElementById('servico-id').value = servico.id;
                document.getElementById('servico-nome').value = servico.nome;
                document.getElementById('servico-preco').value = servico.preco;
                document.getElementById('servico-duracao').value = servico.duracao_minutos;
                document.getElementById('servico-descricao').value = servico.descricao;

                // --- NOVA ADIÇÃO ---
                // Seleciona a categoria
                document.getElementById('servico-categoria').value = servico.categoria_id || "";
                document.getElementById('servico-percentual').value = servico.percentual_adiantamento
                // --- FIM DA ADIÇÃO ---

                // Mostra o preview da imagem atual
                const imgPreview = document.getElementById('servico-preview');
                const imgContainer = document.getElementById('servico-preview-container');
                if (servico.imagem_url) {
                    imgPreview.src = servico.imagem_url;
                    imgContainer.style.display = 'block';
                } else {
                    // Mostra o placeholder
                    imgPreview.src = ""; 
                    imgContainer.style.display = 'block';
                }
                
                // --- ADICIONE ESTAS 3 LINHAS ---
                originalServiceImageUrl = imgPreview.src; // Salva a URL original
                croppedServiceBlob = null; // Limpa o blob de uma edição anterior
                if (revertServiceImageBtn) revertServiceImageBtn.style.display = 'none'; // Esconde o "Desfazer"
                
                // Seleciona os profissionais nas 'flags'
                flagsContainer.querySelectorAll('.flag-item-toggle').forEach(flag => {
                    const flagId = parseInt(flag.dataset.id);
                    if (servico.profissionais_ids.includes(flagId)) {
                        flag.classList.add('selected');
                    }
                });

            } catch (error) {
                console.error(error);
                alert('Erro ao carregar o serviço.');
                return;
            }
            
        } else {
            // --- MODO CRIAÇÃO ---
            servicoModalTitle.textContent = 'Novo Serviço';
            deleteButton.classList.add('hidden');
            document.getElementById('servico-preview-container').style.display = 'none';
            document.getElementById('servico-percentual').value = 0;
            // Linha de "Salve o serviço primeiro..." <-- REMOVIDA
        }
        
        servicoModal.classList.remove('hidden');
    }

    /**
     * Fecha o modal de serviço
     */
    function closeServicoModal() {
        servicoModal.classList.add('hidden');
        currentEditingServiceId = null;
    }

    /**
     * Salva o serviço (Criação ou Edição)
     */
    async function saveServico(event) {
        event.preventDefault();
        
        // --- MUDANÇA: USANDO FORMDATA ---
        const formData = new FormData();
        
        // 1. Coleta os dados de texto
        formData.append('nome', document.getElementById('servico-nome').value);
        formData.append('preco', parseFloat(document.getElementById('servico-preco').value));
        formData.append('duracao_minutos', parseInt(document.getElementById('servico-duracao').value));
        formData.append('descricao', document.getElementById('servico-descricao').value);
        formData.append('percentual_adiantamento', parseInt(document.getElementById('servico-percentual').value) || 0);

        // --- NOVA ADIÇÃO ---
        // 1.5. Coleta a Categoria
        const categoriaId = document.getElementById('servico-categoria').value;
        if (categoriaId) {
            formData.append('categoria_id', categoriaId);
        }
        
        // 2. Coleta os IDs dos profissionais das flags
        const flagsContainer = document.getElementById('servico-profissionais-flags');
        const selectedFlags = flagsContainer.querySelectorAll('.flag-item-toggle.selected');
        const profissionais_ids = Array.from(selectedFlags).map(flag => parseInt(flag.dataset.id));
        formData.append('profissionais_ids', profissionais_ids.join(','));

        // 3. Coleta o arquivo de imagem (se houver)
        if (croppedServiceBlob) {
            formData.append('imagem', croppedServiceBlob, 'servico_cortado.png');
        }
        // --- FIM DA MUDANÇA ---
        
        // 2. Define a URL e o Método (Criar vs Editar)
        let url = '/dashboard/api/gestao/servicos/';
        let method = 'POST';
        
        if (currentEditingServiceId) {
            url = `/dashboard/api/gestao/servicos/${currentEditingServiceId}/`;
        }

        // 3. Envia a requisição
        try {
            const response = await fetch(url, {
                method: method,
                headers: {
                    // NÃO USAR 'Content-Type': 'application/json'
                    'X-CSRFToken': csrfToken
                },
                body: formData // Envia o FormData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Falha ao salvar o serviço.');
            }
            
            // SUBSTITUÍDO: alert() por showToast()
            showToast({ message: result.message, type: 'success' });
            closeServicoModal();
            await loadServicos(); 
            await loadCategorias('servico-categoria'); // Recarrega
            
        } catch (error) {
            console.error('Erro ao salvar:', error);
            // SUBSTITUÍDO: alert() por showToast()
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }
    
    /**
     * Exclui um serviço
     */
    async function deleteServico() {
        if (!currentEditingServiceId) return;

        try {
            const response = await fetch(`/dashboard/api/gestao/servicos/${currentEditingServiceId}/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': csrfToken
                }
            });

            if (!response.ok) {
                const result = await response.json();
                throw new Error(result.message || 'Falha ao excluir.');
            }
            
            alert('Serviço excluído com sucesso.');
            closeServicoModal();
            await loadServicos(); // Recarrega a lista

        } catch (error) {
            console.error('Erro ao excluir:', error);
            alert(`Erro: ${error.message}`);
        }
    }

    // =================================================================
    // NOVAS FUNÇÕES: Lógica do Editor de Logo (Cropper.js)
    // =================================================================

    /**
     * Inicializa toda a lógica do editor de logo.
     * Esta função deve ser chamada no DOMContentLoaded.
     */
    function setupLogoCropper() {
        const changeLogoBtn = document.getElementById('btn-change-logo');

        // 1. Botão "Alterar Imagem" clica no input escondido
        changeLogoBtn.addEventListener('click', () => {
            logoInput.click();
        });

        // 2. Quando um arquivo é selecionado no input
        logoInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const file = files[0];
                const reader = new FileReader();

                reader.onload = (event) => {
                    // 3. Mostra o modal e a imagem
                    logoImage.src = event.target.result;
                    logoModal.classList.remove('hidden');

                    // 4. Destrói o cropper antigo (se existir)
                    if (cropper) {
                        cropper.destroy();
                    }

                    // 5. Inicializa o Cropper.js
                    cropper = new Cropper(logoImage, {
                        aspectRatio: 1 / 1, // Força um corte quadrado (1:1)
                        viewMode: 1,        // Restringe a área de corte à imagem
                        dragMode: 'move',   // Permite mover a imagem
                        background: false,  // Sem fundo xadrez
                        autoCropArea: 0.8,  // O corte começa com 80% da área
                        responsive: true,
                        modal: true,        // Escurece o fundo
                    });
                };
                reader.readAsDataURL(file);
            }
        });

        // 6. Botão "Salvar Corte" (dentro do modal)
        document.getElementById('cropper-save').addEventListener('click', () => {
            if (!cropper) return;

            // Pega o canvas cortado (com 300x300px)
            const canvas = cropper.getCroppedCanvas({
                width: 300,
                height: 300,
                imageSmoothingQuality: 'high',
            });

            // 7. Converte o canvas para Blob (o "arquivo" que será enviado)
            canvas.toBlob((blob) => {
                croppedLogoBlob = blob;
                const previewImg = document.getElementById('logo-preview');
                previewImg.src = URL.createObjectURL(blob); 
                closeLogoCropperModal();
            // --- ADICIONE ESTA LINHA ---
            if (revertLogoBtn) revertLogoBtn.style.display = 'inline-flex'; // Mostra o botão "Desfazer"
        }, 'image/png'); 
    });

        // 11. Botão "Cancelar" (dentro do modal)
        document.getElementById('cropper-cancel').addEventListener('click', () => {
            closeLogoCropperModal();
        });
    }

    /**
     * Fecha o modal do editor e limpa tudo.
     */
    function closeLogoCropperModal() {
        logoModal.classList.add('hidden'); // Esconde o modal
        if (cropper) {
            cropper.destroy(); // Destrói a instância
            cropper = null;
        }
        logoImage.src = ''; // Limpa a imagem
        logoInput.value = null; // Limpa o input de arquivo
    }

    // =================================================================
    // NOVAS FUNÇÕES: Lógica do Editor de Imagem do SERVIÇO
    // =================================================================

    function setupServiceCropper() {
        const changeImageBtn = document.getElementById('btn-change-servico-img');
        
        // 1. Botão "Alterar Imagem"
        changeImageBtn.addEventListener('click', () => {
            serviceImageInput.click(); // Aciona o input escondido
        });

        // 2. Quando um arquivo é selecionado
        serviceImageInput.addEventListener('change', (e) => {
            const files = e.target.files;
            if (files && files.length > 0) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    serviceCropperImage.src = event.target.result;
                    serviceCropperModal.classList.remove('hidden'); // Mostra o modal de corte

                    if (serviceCropper) serviceCropper.destroy();

                    // 3. Inicializa o Cropper com aspect ratio RETANGULAR
                    serviceCropper = new Cropper(serviceCropperImage, {
                        aspectRatio: 1 / 1, // Proporção retangular
                        viewMode: 1,
                        dragMode: 'move',
                        background: false,
                        autoCropArea: 0.9,
                    });
                };
                reader.readAsDataURL(files[0]);
            }
        });

        // 4. Botão "Salvar Corte"
        document.getElementById('service-cropper-save').addEventListener('click', () => {
            if (!serviceCropper) return;

            const canvas = serviceCropper.getCroppedCanvas({
                width: 800, // Salva com uma largura boa
                imageSmoothingQuality: 'high',
            });

            canvas.toBlob((blob) => {
                croppedServiceBlob = blob; // Armazena o "arquivo" cortado
                document.getElementById('servico-preview').src = URL.createObjectURL(blob); // Atualiza o preview
                closeServiceCropperModal();
                if (revertServiceImageBtn) revertServiceImageBtn.style.display = 'inline-flex'; // Mostra "Desfazer"
            }, 'image/png');
        });

        // 5. Botão "Cancelar"
        document.getElementById('service-cropper-cancel').addEventListener('click', () => {
            closeServiceCropperModal();
        });

        // 6. Botão "Desfazer" (fora do modal)
        revertServiceImageBtn = document.getElementById('btn-revert-servico-img');
        if (revertServiceImageBtn) {
            revertServiceImageBtn.addEventListener('click', () => {
                croppedServiceBlob = null; // Descarta o corte
                document.getElementById('servico-preview').src = originalServiceImageUrl; // Restaura preview
                revertServiceImageBtn.style.display = 'none'; // Esconde o "Desfazer"
                serviceImageInput.value = null;
                showToast({ message: 'Alteração desfeita.', type: 'info' });
            });
        }
    }

    /**
     * Fecha o modal do editor de serviço e limpa.
     */
    function closeServiceCropperModal() {
        serviceCropperModal.classList.add('hidden');
        if (serviceCropper) {
            serviceCropper.destroy();
            serviceCropper = null;
        }
        serviceCropperImage.src = '';
        serviceImageInput.value = null;
    }

    /**
     * Abre o modal de manutenção
     */
    async function openManutencaoModal(serviceId, serviceName) {
        // Define a variável global para este modal
        currentEditingManutencaoServiceId = serviceId; 
        
        // Atualiza o título e o nome do serviço no modal
        document.getElementById('manutencao-servico-nome').textContent = serviceName;
        manutencaoForm.reset();
        
        // Carrega os tiers de manutenção existentes
        await loadManutencaoTiers(serviceId);
        
        // Exibe o modal
        manutencaoModal.classList.remove('hidden');
    }

    /**
     * Fecha o modal de manutenção
     */
    function closeManutencaoModal() {
        manutencaoModal.classList.add('hidden');
        currentEditingManutencaoServiceId = null; // Limpa a variável
    }

    // --- ADICIONE ESTAS NOVAS FUNÇÕES (Modal da Equipe) ---
    
    /**
     * Abre o modal de convidar membro
     */
    function openEquipeModal() {
        equipeForm.reset();
        equipeModal.classList.remove('hidden');
    }

    /**
     * Fecha o modal de convidar membro
     */
    function closeEquipeModal() {
        equipeModal.classList.add('hidden');
    }
    
    /**
     * Salva o novo membro da equipe (Envia o convite)
     */
    async function saveEquipeMembro(event) {
        event.preventDefault();
        
        // --- MUDANÇA: USANDO FORMDATA ---
        const formData = new FormData();
        formData.append('nome', document.getElementById('equipe-nome').value);
        formData.append('sobrenome', document.getElementById('equipe-sobrenome').value);
        formData.append('email', document.getElementById('equipe-email').value);
        formData.append('telefone', document.getElementById('equipe-telefone').value);
        formData.append('password', document.getElementById('equipe-password').value);
        
        // Adiciona a foto se ela existir
        const fotoInput = document.getElementById('equipe-foto');
        if (fotoInput.files.length > 0) {
            formData.append('foto', fotoInput.files[0]);
        }
        // --- FIM DA MUDANÇA ---

        // 2. Envia a requisição
        try {
            const response = await fetch('/dashboard/api/gestao/equipe/', {
                method: 'POST',
                headers: {
                    // NÃO USAR 'Content-Type': 'application/json'
                    'X-CSRFToken': csrfToken
                },
                body: formData // Envia o FormData
            });

            const result = await response.json();
            
            if (!response.ok) {
                throw new Error(result.message || 'Falha ao salvar o membro.');
            }
            
            showToast({ message: result.message, type: 'success' });
            closeEquipeModal();
            await loadEquipe(); // Recarrega a lista de equipe
            
        } catch (error) {
            console.error('Erro ao salvar membro:', error);
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Abre o modal de EDIÇÃO de membro
     */
    async function openEquipeEditModal(membroId) {
        equipeEditForm.reset();
        currentEditingMembroId = membroId;

        // Busca os dados atuais do membro
        try {
            const response = await fetch(`/dashboard/api/gestao/equipe/${membroId}/`);
            if (!response.ok) throw new Error('Falha ao carregar dados do membro.');
            const membro = await response.json();

            // Popula o formulário de edição
            document.getElementById('equipe-edit-id').value = membro.id;
            document.getElementById('equipe-edit-nome').value = membro.first_name;
            document.getElementById('equipe-edit-sobrenome').value = membro.last_name;
            document.getElementById('equipe-edit-email').value = membro.email;
            document.getElementById('equipe-edit-telefone').value = membro.telefone || '';
            
            // Define o preview da foto
            const preview = document.getElementById('equipe-edit-preview');
            if (membro.foto_url) {
                preview.src = membro.foto_url;
            } else {
                // (Use o mesmo placeholder que você tem no HTML)
                preview.src = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJYAAACWCAMAAAAL3woPAAAAFVBMVEXe3t7e3t7e3t7e3t7e3t7e3t7e3t7e3t49nE3IAAAAB3RSTlMAgICAgICA+b2dYwAAAUdJREFUeNrt29lqwzAQRcGqIAj//5c+ClqgImga6c2cE3sIqRSPbYIgAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADgG/uPzG3fbd/tzbZ8gJ2rln1Gq5yR6/hL6rLvyRPL0TveDqA6c6T61T5E6vY/sL7I6mBj2f7ujn8kOxpY9v+7ox/JjoYWPb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjoYWNb/u6MfyY6GFjW/7ujH8mOhhY1v+7ox/JjseWE495nNnN59mfePZzcT0/oA0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAODf/QBt4ANrBw1qfAAAAABJRU5ErkJggg==";
            }

            equipeEditModal.classList.remove('hidden');

        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * Fecha o modal de EDIÇÃO de membro
     */
    function closeEquipeEditModal() {
        equipeEditModal.classList.add('hidden');
        document.getElementById('equipe-edit-foto-input').value = null; // Limpa o file input
        currentEditingMembroId = null;
    }

    /**
     * Salva as ALTERAÇÕES do membro da equipe
     */
    async function saveEquipeEdit(event) {
        event.preventDefault();
        if (!currentEditingMembroId) return;

        // Usa FormData para enviar a foto
        const formData = new FormData();
        formData.append('nome', document.getElementById('equipe-edit-nome').value);
        formData.append('sobrenome', document.getElementById('equipe-edit-sobrenome').value);
        formData.append('telefone', document.getElementById('equipe-edit-telefone').value);
        
        // Adiciona a nova senha (se houver)
        const newPassword = document.getElementById('equipe-edit-password').value;
        if (newPassword && newPassword.trim()) {
            formData.append('password', newPassword);
        }

        // Adiciona a foto (se uma nova foi selecionada)
        const fotoInput = document.getElementById('equipe-edit-foto-input');
        if (fotoInput.files.length > 0) {
            formData.append('foto', fotoInput.files[0]);
        }

        try {
            const response = await fetch(`/dashboard/api/gestao/equipe/${currentEditingMembroId}/`, {
                method: 'POST',
                headers: { 'X-CSRFToken': csrfToken },
                body: formData
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            showToast({ message: result.message, type: 'success' });
            closeEquipeEditModal();
            await loadEquipe(); // Recarrega a lista da equipe

        } catch (error) {
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    /**
     * EXCLUI um membro da equipe
     */
    async function deleteEquipeMembro() {
        if (!currentEditingMembroId) return;

        try {
            const response = await fetch(`/dashboard/api/gestao/equipe/${currentEditingMembroId}/`, {
                method: 'DELETE',
                headers: { 'X-CSRFToken': csrfToken }
            });
            const result = await response.json();
            if (!response.ok) throw new Error(result.message);

            showToast({ message: result.message, type: 'success' });
            closeEquipeEditModal();
            await loadEquipe(); // Recarrega a lista

        } catch (error) {
            // A API vai retornar a mensagem de erro (ex: "possui agendamentos futuros")
            showToast({ message: `Erro: ${error.message}`, type: 'error' });
        }
    }

    // --- Inicialização e Event Listeners ---
    
    // Botão "Novo Serviço"
    document.getElementById('btn-novo-servico').addEventListener('click', () => {
        openServicoModal(null);
    });

    if (configToggleInput) {
        configToggleInput.addEventListener('change', (e) => {
            isPagamentoOnlineHabilitado = e.target.checked;
            togglePercentualFields(isPagamentoOnlineHabilitado);
        });
    }
    
    // Botões de fechar o modal
    document.getElementById('servico-modal-close').addEventListener('click', closeServicoModal);
    document.getElementById('servico-modal-cancel').addEventListener('click', closeServicoModal);
    
    // Botão de salvar (submit)
    servicoForm.addEventListener('submit', saveServico);
    
    // Botão de excluir
    document.getElementById('servico-modal-delete').addEventListener('click', deleteServico);

    // --- ADICIONE ESTAS 3 LINHAS ---
    // Botão "Convidar Membro"
    document.getElementById('btn-convidar-membro').addEventListener('click', openEquipeModal);
    // --- FIM DA ADIÇÃO ---

    // Botões de fechar o modal de Equipe
    document.getElementById('equipe-modal-close').addEventListener('click', closeEquipeModal);
    document.getElementById('equipe-modal-cancel').addEventListener('click', closeEquipeModal);
    
    // Botão de salvar (submit) Equipe
    equipeForm.addEventListener('submit', saveEquipeMembro);

    // Listeners do modal de EDITAR equipe
    if (equipeEditModal) {
        equipeEditForm.addEventListener('submit', saveEquipeEdit);
        document.getElementById('equipe-edit-modal-close').addEventListener('click', closeEquipeEditModal);
        document.getElementById('equipe-edit-modal-cancel').addEventListener('click', closeEquipeEditModal);
        document.getElementById('equipe-edit-modal-delete').addEventListener('click', deleteEquipeMembro);
        
        // Listener para o botão de alterar foto
        document.getElementById('btn-change-equipe-img').addEventListener('click', () => {
            document.getElementById('equipe-edit-foto-input').click();
        });
        
        // Listener para o preview da foto
        document.getElementById('equipe-edit-foto-input').addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    document.getElementById('equipe-edit-preview').src = event.target.result;
                }
                reader.readAsDataURL(file);
            }
        });
    }

    // Listener para o botão "Editar" na tabela de equipe
    document.getElementById('equipe-lista-tbody').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-edit-equipe')) {
            const membroId = event.target.dataset.id;
            openEquipeEditModal(membroId);
        }
    });

    // Event listener para os botões "Editar" (usando delegação de evento)
    document.getElementById('servicos-lista-tbody').addEventListener('click', function(event) {
        const target = event.target; // O elemento clicado
        if (target.classList.contains('btn-edit')) {
            const serviceId = target.dataset.id;
            openServicoModal(serviceId);
        }
        
        // --- NOVA ADIÇÃO ---
        // Botão Manutenção
        if (target.classList.contains('btn-manutencao')) {
            const serviceId = target.dataset.id;
            const serviceName = target.dataset.nome;
            openManutencaoModal(serviceId, serviceName);
        }
        // --- FIM DA ADIÇÃO ---
    });

    // Listeners da Aba Categoria
    if (categoriaForm) {
        categoriaForm.addEventListener('submit', saveCategoria);
    }
    document.getElementById('categorias-lista-tbody').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-edit-categoria')) {
            const id = event.target.dataset.id;
            const nome = event.target.dataset.nome;
            openCategoriaModal(id, nome);
        }
    });
    if (categoriaModal) {
        categoriaEditForm.addEventListener('submit', saveCategoriaEdit);
        document.getElementById('categoria-modal-close').addEventListener('click', closeCategoriaModal);
        document.getElementById('categoria-modal-cancel').addEventListener('click', closeCategoriaModal);
        document.getElementById('categoria-modal-delete').addEventListener('click', deleteCategoria);
    }
    
    // Listeners do Modal de Serviço (para Tiers de Manutenção)
    if (manutencaoForm) {
        manutencaoForm.addEventListener('submit', saveManutencaoTier);
    }
    document.getElementById('manutencao-lista-tbody').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-delete-manutencao')) {
            deleteManutencaoTier(event.target.dataset.id);
        }
    });
    // --- FIM DOS NOVOS LISTENERS ---

    // --- NOVA ADIÇÃO ---
    // Listeners para fechar o novo modal de manutenção
    if (manutencaoModal) {
        document.getElementById('manutencao-modal-close').addEventListener('click', closeManutencaoModal);
        document.getElementById('manutencao-modal-cancel').addEventListener('click', closeManutencaoModal);
    }
    // --- FIM DA ADIÇÃO ---

    // Listeners para os formulários de Horário (delegação)
    document.getElementById('horarios-semana-container').addEventListener('submit', function(event) {
        if (event.target.classList.contains('form-add-horario')) {
            saveHorario(event);
        }
    });

    // Listeners para os botões de delete de Horário (delegação)
    document.getElementById('horarios-semana-container').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-delete-horario')) {
            const horarioId = event.target.dataset.id;
            deleteHorario(horarioId);
        }
    });

    if (configForm) {
        configForm.addEventListener('submit', saveConfiguracoes);
    }

    // document.getElementById('btn-add-aviso-proc').addEventListener('click', () => {
    //     addListItem('aviso-proc-input', 'aviso-proc-preview', 'config-aviso-procedimento');
    // });

    // document.getElementById('btn-add-aviso-canc').addEventListener('click', () => {
    //     addListItem('aviso-canc-input', 'aviso-canc-preview', 'config-aviso-cancelamento');
    // });

    // --- ADICIONE ESTES NOVOS LISTENERS PARA O MURAL ---
    document.getElementById('btn-novo-aviso').addEventListener('click', () => openAvisoModal(null));
    document.getElementById('aviso-modal-close').addEventListener('click', closeAvisoModal);
    document.getElementById('aviso-modal-cancel').addEventListener('click', closeAvisoModal);
    document.getElementById('aviso-modal-delete').addEventListener('click', deleteAviso);
    avisoForm.addEventListener('submit', saveAviso);

    // Listener para botões "Editar" na lista de avisos
    document.getElementById('avisos-lista-container').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-edit-aviso')) {
            const avisoId = event.target.dataset.id;
            openAvisoModal(avisoId);
        }
    });

    document.getElementById('form-add-bloqueio').addEventListener('submit', saveDiaBloqueado);
    
    document.getElementById('lista-dias-bloqueados').addEventListener('click', function(event) {
        if (event.target.classList.contains('btn-delete-bloqueio')) {
            deleteDiaBloqueado(event.target.dataset.id);
        }
    });

    // Ação do botão "Desfazer"
    revertLogoBtn = document.getElementById('btn-revert-logo');
    if (revertLogoBtn) {
        revertLogoBtn.addEventListener('click', () => {
            croppedLogoBlob = null; // 1. Descarta o novo corte
            document.getElementById('logo-preview').src = originalLogoUrl; // 2. Restaura o preview original
            revertLogoBtn.style.display = 'none'; // 3. Esconde o botão "Desfazer"
            logoInput.value = null; // 4. Limpa o input file
            showToast({ message: 'Alteração desfeita.', type: 'info' });
        });
    }
    
    // Lógica das Abas (copiado do financeiro.html)
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const tab = this.dataset.tab;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
            this.classList.add('active');
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            // --- ADICIONE ESTA LINHA ---
            // Carrega os horários quando a aba é clicada
            if (tab === 'horarios') {
                loadHorarios();
                loadDiasBloqueados();
            }
            if (tab === 'configuracoes') { loadConfiguracoes(); }
            if (tab === 'avisos') { loadAvisos(); }
            // --- NOVA ADIÇÃO ---
            if (tab === 'categorias') {
                loadCategorias(); // Carrega a tabela de categorias
            }
            // --- FIM DA ADIÇÃO ---
        });
    });

    // --- Carregamento Inicial ---
    async function init() {
        await loadConfiguracoes();
        await loadEquipe();
        await loadCategorias('servico-categoria'); // Carrega categorias PRIMEIRO
        await loadServicos();
        setupLogoCropper(); // Inicializa a lógica do editor de logo
        setupServiceCropper(); // Inicializa a lógica do editor de SERVIÇO
        if (window.Coloris) {
        Coloris({
            el: '[data-coloris]', // O seletor que ativa o picker
            themeMode: 'light', // Tema claro
            alpha: false, // Não precisa de transparência
            format: 'hex', // Salva como #RRGGBB
            swatches: [ // Paleta de cores sugeridas
                '#0D99FF', // Azul (dashboard)
                '#FF5A5F', // Vermelho (erro)
                '#FF9500', // Laranja (aviso)
                '#38A169', // Verde (sucesso)
                '#5CCFAC', // Verde Menta (padrão)
                '#FFD1DC', // Rosa (padrão)
                '#8E44AD', // Roxo
                '#34495E', // Grafite
            ],
            // Tradução para Português
            clear: 'Limpar',
            select: 'Definir',
            hue: 'Matiz',
            saturation: 'Saturação',
            lightness: 'Luminosidade'
        });
    }
    }
    
    init();
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\professional.js

// static/js/professional.js

/**
 * Helper para formatar duração (copiado do calendar.js)
 */
function formatarDuracao(minutos) {
  const horas = Math.floor(minutos / 60);
  const mins = minutos % 60;

  if (horas > 0) {
    return mins > 0 ? `${horas}h ${mins}min` : `${horas}h`;
  }
  return `${mins} min`;
}

/**
 * Carrega os profissionais que executam o serviço selecionado
 */
async function loadProfessionals() {
    const professionalList = document.getElementById('professional-list');
    const serviceInfo = document.getElementById('selected-service-info-pro');
    
    // 1. Verifica se um serviço E as informações do tier foram selecionados
    if (!selectedService || !selectedTierInfo) {
        professionalList.innerHTML = '<p class="error-state">Erro: Nenhuma opção de serviço selecionada. Volte e tente novamente.</p>';
        return;
    }
    
    // 2. Atualiza o card de informação do serviço (CORRIGIDO)
    
    // Usa os dados do tier selecionado (preço e duração)
    const duracao = formatarDuracao(selectedTierInfo.duracao);
    const preco = selectedTierInfo.preco.toFixed(2).replace('.', ',');

    // Exibe o adiantamento (se houver)
    let adiantamentoHTML = '';
    if (selectedTierInfo.valor_adiantamento > 0) {
        const adiantamento = selectedTierInfo.valor_adiantamento.toFixed(2).replace('.', ',');
        adiantamentoHTML = `<span class="service-price-signal">Adiantamento: R$ ${adiantamento}</span>`;
    }

    // Prepara a imagem
    let imagemHTML = '';
    if (selectedService.image_url) {
        imagemHTML = `<img src="${selectedService.image_url}" alt="${selectedService.name}" class="service-info-img">`;
    } else {
        imagemHTML = `<div class="service-icon">${selectedService.icon || '✨'}</div>`;
    }
    
    // Define o nome correto (Serviço ou Manutenção)
    let nomeExibido = selectedService.name;
    if (selectedTierInfo.tierId) {
        const tier = selectedService.tiers_manutencao.find(t => t.id === selectedTierInfo.tierId);
        if (tier) {
            nomeExibido = tier.nome_tier;
        }
    }

    // Monta o HTML do card (agora com os dados corretos)
    serviceInfo.innerHTML = `
        <div class="service-info-card">
            ${imagemHTML}
            <div class="service-details">
                <h3>${nomeExibido}</h3>
                <div class="service-meta">
                    <span class="service-duration">${duracao}</span>
                    <span class="service-price">Total: R$ ${preco}</span>
                    ${adiantamentoHTML}
                </div>
            </div>
        </div>
    `;

    // 3. Mostra o loading e busca os profissionais
    professionalList.innerHTML = '<div class="loading-indicator"><div class="loading-spinner"></div></div>';
    try {
        const response = await fetch(`/${empreendedorSlug}/api/servico/${selectedService.id}/profissionais/`);
        if (!response.ok) {
            throw new Error('Falha ao buscar profissionais.');
        }
        
        const profissionais = await response.json();
        
        if (profissionais.length === 0) {
            professionalList.innerHTML = '<p class="empty-state">Nenhum profissional disponível para este serviço no momento.</p>';
            return;
        }

        // --- LÓGICA DE AUTO-SELEÇÃO ---
        // Se SÓ houver UM profissional, seleciona ele automaticamente e pula a tela
        if (profissionais.length === 1) {
            const prof = profissionais[0];
            selectProfessional(prof.id, prof.nome);
            return; // Pula a renderização da lista
        }
        // --- FIM DA LÓGICA ---

        
        // 4. Renderiza a lista de profissionais (se houver mais de um)
        professionalList.innerHTML = '';
        profissionais.forEach(prof => {
            const card = document.createElement('div');
            card.className = 'professional-card';
            
            // --- INÍCIO DA CORREÇÃO (Avatar) ---
            let avatarHTML = '';
            if (prof.foto_url) {
                 avatarHTML = `<img src="${prof.foto_url}" alt="${prof.nome}" class="professional-avatar-img">`;
            } else {
                // Se não tiver foto, usa a letra
                const avatarLetter = prof.nome.charAt(0).toUpperCase();
                avatarHTML = `<div class="professional-avatar-default">${avatarLetter}</div>`;
            }
             // --- FIM DA CORREÇÃO ---
            
            card.innerHTML = `
                <div class="professional-avatar">
                    ${avatarHTML}
                </div>
                 <h4 class="professional-name">${prof.nome}</h4>
            `;
            
            card.onclick = () => selectProfessional(prof.id, prof.nome);
            professionalList.appendChild(card);
        });
        
    } catch (error) {
        console.error('Erro ao carregar profissionais:', error);
        professionalList.innerHTML = '<p class="error-state">Erro ao carregar profissionais. Tente novamente.</p>';
    }
}

/**
 * Seleciona um profissional e avança para a tela de calendário
 * @param {number} id - ID do profissional
 * @param {string} nome - Nome do profissional
 */
window.selectProfessional = function(id, nome) {
    // 1. Salva o profissional no estado global
    selectedProfessional = { id: id, nome: nome };
    // 2. Avança para a tela do calendário
    showScreen('calendar-screen');
}
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\services.js

// static/js/services.js
// Sistema de serviços e gerenciamento de catálogo

// 'servicesData' é global, definido em auth.js

/**
 * Carrega os serviços do servidor
 */
async function loadServices() {
    const servicesList = document.getElementById('services-list');
    if (!servicesList) return;
    
    // Exibe estado de carregamento
    servicesList.innerHTML = `
        <div class="loading-services">
            <div class="loading-spinner"></div>
            <p>Carregando serviços...</p>
        </div>
    `;
    try {
        // A API AGORA RETORNA UM OBJETO, NÃO UMA LISTA
        const response = await fetch(`/${empreendedorSlug}/api/servicos/`);
        if (!response.ok) {
            throw new Error('Falha ao carregar serviços.');
        }
        
        const result = await response.json();
        servicesData = result.servicos;

        // Aplicar a cor personalizada
        // (Lógica de cor já está no app.js, não precisa aqui)
        
        // Limpa o container antes de adicionar os cards
        servicesList.innerHTML = '';
        // Verifica se há serviços
        if (servicesData.length === 0) {
            servicesList.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">💇‍♀️</div>
                    <p>Nenhum serviço disponível no momento.</p>
                    <p class="empty-subtitle">Por favor, tente novamente mais tarde.</p>
                </div>
            `;
            return;
        }
        
        // Renderiza cada serviço
        servicesData.forEach(service => {
            // Passa o objeto de serviço inteiro
            const serviceCard = createServiceCard(service); 
            servicesList.appendChild(serviceCard);
        });
    } catch (error) {
        console.error('Erro ao carregar serviços:', error);
        servicesList.innerHTML = `
            <div class="error-state">
                <div class="error-icon">⚠️</div>
                <p>Erro ao carregar os serviços.</p>
                <p class="error-subtitle">Por favor, tente novamente mais tarde.</p>
                <button class="btn btn--outline" onclick="loadServices()">Tentar Novamente</button>
            </div>
        `;
    }
}

/**
 * Cria um card para exibir um serviço
 * @param {Object} service - Dados do serviço
 * @returns {HTMLElement} - Elemento do card
 */
function createServiceCard(service) {
    const serviceCard = document.createElement('div');
    serviceCard.className = 'service-card';

    // --- INÍCIO DA LÓGICA DE PREÇO MODIFICADA ---
    
    const hasTiers = service.tiers_manutencao && service.tiers_manutencao.length > 0;
    // 1. Encontra os tiers que estão ATIVOS (disponíveis para o cliente agora)
    const activeTiers = hasTiers ?
        service.tiers_manutencao.filter(t => t.is_active) : [];

    let preco;
    let precoLabel;
    
    // Pega a duração do serviço principal (cheio)
    const duracao = service.duracao_formatada || `${service.duracao_minutos} min`;

    if (activeTiers.length > 0) {
        // --- CASO 1: HÁ MANUTENÇÕES ATIVAS ---
        // Encontra o tier com o menor preço entre os ativos
        const minPriceTier = activeTiers.reduce((min, tier) => 
            (tier.preco < min.preco ? tier : min), 
            activeTiers[0]
        );
        preco = minPriceTier.preco.toFixed(2).replace('.', ',');
        precoLabel = `A partir de R$ ${preco}`;
        // Ex: "A partir de R$ 76,90"

    } else if (hasTiers) {
        // --- CASO 2: HÁ MANUTENÇÕES, MAS NENHUMA ESTÁ ATIVA (EXPIRARAM) ---
        // Usa o preço cheio (serviço principal)
        preco = service.price.toFixed(2).replace('.', ',');
        precoLabel = `A partir de R$ ${preco}`; // Ex: "A partir de R$ 115,00"
        
    } else {
        // --- CASO 3: SERVIÇO SIMPLES, SEM MANUTENÇÕES ---
        // Mostra o preço normal, sem "A partir de"
        preco = service.price.toFixed(2).replace('.', ',');
        precoLabel = `R$ ${preco}`; // Ex: "R$ 115,00"
    }
    
    // --- FIM DA LÓGICA DE PREÇO MODIFICADA ---


    // Prepara a imagem
    let imagemHTML = '';
    if (service.image_url) {
        imagemHTML = `<img src="${service.image_url}" alt="${service.name}" class="service-image-tag">`;
    } else {
        imagemHTML = `<div class="service-image-default">${service.icon || '✨'}</div>`;
    }

    // Monta o HTML do card (agora usando 'precoLabel')
    serviceCard.innerHTML = `
        <div class="service-image">
            ${imagemHTML}
        </div>
        <div class="service-content">
            <h3 class="service-title">${service.name}</h3>
            <p class="service-description">${service.description}</p>
            <div class="service-details">
                <span class="service-duration">${duracao}</span>
                 <span class="service-price">${precoLabel}</span>
            </div>
            <button class="btn btn--primary service-button" data-service-id="${service.id}">
                ${hasTiers ? 'Ver Opções' : 'Agendar Serviço'}
            </button>
        </div>
    `;
    // Adiciona evento ao botão
    const button = serviceCard.querySelector('.service-button');
    button.addEventListener('click', () => {
        selectService(service.id);
    });
    // --- INÍCIO DA NOVA ADIÇÃO (Animação de entrada) ---
    // Adiciona a classe de animação para o Intersection Observer
    serviceCard.classList.add('service-card--animate');
    // --- FIM DA NOVA ADIÇÃO ---

    return serviceCard;
}

/**
 * Seleciona um serviço para agendamento
 * @param {number} serviceId - ID do serviço
 */
window.selectService = function(serviceId) {
    // Encontra o serviço pelo ID (agora do cache global 'servicesData')
    selectedService = servicesData.find(service => service.id === serviceId);
    if (!selectedService) {
        showToast({ message: 'Erro: Serviço não encontrado.', type: 'error' });
        return;
    }

    // --- NOVA LÓGICA DE DECISÃO ---
    const hasTiers = selectedService.tiers_manutencao && selectedService.tiers_manutencao.length > 0;
    if (hasTiers) {
        // Se tem tiers, NÃO vamos direto ao calendário.
        // Vamos mostrar um modal de seleção de tier.
        showTierSelectionModal(selectedService);
    } else {
        // Comportamento antigo: É um serviço simples.
        // Define o tier selecionado como nulo
        // e usa os dados do serviço principal.
        // --- INÍCIO DA MODIFICAÇÃO (Cálculo do Adiantamento) ---
        const precoFinal = selectedService.price;
        const duracaoFinal = selectedService.duracao_minutos;
        const percentual = selectedService.percentual_adiantamento || 0;
        const valorAdiantamento = (precoFinal * percentual) / 100;
        
        proceedToProfessionals(
            null, 
            precoFinal, 
            duracaoFinal,
            valorAdiantamento // <-- Passa o valor do adiantamento
        );
        // --- FIM DA MODIFICAÇÃO ---
    }
    // --- FIM DA NOVA LÓGICA ---
};
/**
 * NOVA FUNÇÃO: Exibe o modal de seleção de tier
 */
function showTierSelectionModal(service) {
    // Gerar o HTML para as opções
    let optionsHTML = '';
    
    // 1. Verificamos se existe algum tier de manutenção ATIVO.
    const hasActiveTiers = service.tiers_manutencao.some(tier => tier.is_active);
    
    // 2. SÓ mostramos a opção "Primeira vez ou Troca" se
    //    NENHUM tier de manutenção estiver ativo (ou seja, todos expiraram).
    if (!hasActiveTiers) {
        
        // --- INÍCIO DA MODIFICAÇÃO (Cálculo do Adiantamento) ---
        const precoFinal = service.price;
        const duracaoFinal = service.duracao_minutos;
        const percentual = service.percentual_adiantamento || 0;
        const valorAdiantamento = (precoFinal * percentual) / 100;
        // --- FIM DA MODIFICAÇÃO ---

        // Pega o motivo dinâmico vindo do backend
        const motivo = service.motivo_preco_cheio || "Primeira vez ou troca"; // "Primeira vez" é um fallback
        
        optionsHTML += `
            <div class="tier-option-card" 
                 onclick="proceedToProfessionals(null, ${precoFinal}, ${duracaoFinal}, ${valorAdiantamento})">
                <h4>${service.name} (${motivo})</h4> 
                <p>${service.description}</p>
                <div class="tier-details">
                     <span class="service-price">R$ ${precoFinal.toFixed(2).replace('.', ',')}</span>
                    <span class="service-duration">${service.duracao_formatada}</span>
                </div>
                ${valorAdiantamento > 0 ?
                    `<div class="tier-signal">Adiantamento: R$ ${valorAdiantamento.toFixed(2).replace('.', ',')}</div>` : 
                    '<div class="tier-signal-free">Sem adiantamento</div>'
                }
            </div>
        `;
    }
    
    // 3. Adiciona os tiers de manutenção
    service.tiers_manutencao.forEach(tier => {
        const isActive = tier.is_active;
        const disabledClass = !isActive ? 'disabled' : '';

        // --- INÍCIO DA MODIFICAÇÃO (Cálculo do Adiantamento) ---
        const precoFinal = tier.preco;
        const duracaoFinal = tier.duracao_minutos;
        const percentual = tier.percentual_adiantamento || 0;
        const valorAdiantamento = (precoFinal * percentual) / 100;
        // --- FIM DA MODIFICAÇÃO ---
        
        let onClickAction = '';
        if (isActive) {
            // Se estiver ativo, define a ação de prosseguir
            onClickAction = `onclick="proceedToProfessionals(${tier.id}, ${precoFinal}, ${duracaoFinal}, ${valorAdiantamento})"`;
        } else {
            // Se estiver inativo, pega a mensagem de aviso do backend
            const message = tier.inactivity_message || 'Este período não está disponível.';
            
            // "Escapa" a mensagem para que aspas não quebrem o HTML do onclick
            const safeMessage = message.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            onClickAction = `onclick="showToast({message: '${safeMessage}', type: 'warning'})"`;
        }

        optionsHTML += `
            <div class="tier-option-card ${disabledClass}" ${onClickAction}>
                <h4>${tier.nome_tier}</h4>
                 <p>${tier.dias_min}-${tier.dias_max} dias desde o último serviço.</p>
                <div class="tier-details">
                    <span class="service-price">R$ ${precoFinal.toFixed(2).replace('.', ',')}</span>
                    <span class="service-duration">${tier.duracao_formatada}</span>
                </div>
                ${valorAdiantamento > 0 ?
                    `<div class="tier-signal">Adiantamento: R$ ${valorAdiantamento.toFixed(2).replace('.', ',')}</div>` : 
                    '<div class="tier-signal-free">Sem adiantamento</div>'
                }
            </div>
        `;
    });

    // Exibe o modal genérico
    showModal({
        title: `Escolha uma opção para: ${service.name}`,
        message: `<div class="tier-selection-container">${optionsHTML}</div>`,
        showCancel: true,
        showConfirm: false, // Esconde o botão "Confirmar" padrão
        cancelText: 'Voltar'
    });
}

/**
 * NOVA FUNÇÃO: Prepara dados e avança para a tela de profissionais
 */
window.proceedToProfessionals = function(tierId, precoFinal, duracaoFinal, valorAdiantamento) {
    // 1. Armazena os dados selecionados globalmente
    // (O `selectedService` já está definido)
    
    // Usamos a variável global 'selectedTierInfo' definida em 'auth.js'
    selectedTierInfo = {
        tierId: tierId, // null se for o serviço principal
        preco: precoFinal,
        duracao: duracaoFinal,
        valor_adiantamento: valorAdiantamento // <-- NOVO
    };
    
    // 2. Fecha o modal se estiver aberto
    hideModal();
    
    // 3. Avança para a tela de profissionais
    // (Animar a tela de serviços)
    const servicesList = document.getElementById('services-list');
    if (servicesList) {
        servicesList.classList.add('fade-out');
        setTimeout(() => {
            showScreen('professional-screen');
            servicesList.classList.remove('fade-out');
        }, 300);
    } else {
        showScreen('professional-screen');
    }
}

// --- ESTILOS ADICIONAIS ---
document.addEventListener('DOMContentLoaded', function() {
    // Adiciona estilos para as animações e estados
    const style = document.createElement('style');
    style.textContent = `
        /* Animações para cards de serviço */
        .service-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .service-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.1);
        }
        
        /* Animação de fade */
        .fade-out {
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        /* Estilos para estados vazios */
        .empty-state, .error-state, .loading-services {
            text-align: center;
            padding: var(--space-32);
            background: var(--color-surface);
            border-radius: var(--radius-lg);
            border: 1px solid var(--color-border);
        }
        
        .empty-icon, .error-icon {
            font-size: 3rem;
            margin-bottom: var(--space-16);
        }
        
        .empty-subtitle, .error-subtitle {
            color: var(--color-text-secondary);
            margin-top: var(--space-8);
            margin-bottom: var(--space-16);
        }
        
        /* Melhorias no card de serviço */
        .service-info-card {
            display: flex;
            align-items: center;
            gap: var(--space-16);
            padding: var(--space-16);
            background: var(--color-white);
            border-radius: var(--radius-base);
            box-shadow: var(--shadow-sm);
        }
        
        .service-icon {
            font-size: 2rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 60px;
            height: 60px;
            background: rgba(var(--color-light-pink-rgb), 0.3);
            border-radius: var(--radius-full);
        }
        
        .service-details {
            flex: 1;
        }
        
        .service-meta {
            display: flex;
            flex-wrap: wrap; /* Permite quebrar linha */
            align-items: center;
            gap: var(--space-4) var(--space-12); /* 4px vertical, 12px horizontal */
            margin-top: var(--space-4);
        }
        
        .service-meta .service-duration {
            background: var(--color-primary-light);
            color: var(--color-primary-active);
            padding: var(--space-4) var(--space-8);
            border-radius: var(--radius-full);
            font-size: 12px;
            font-weight: 500;
        }
        
        .service-meta .service-price {
            font-weight: var(--font-weight-semibold);
            color: var(--color-primary);
        }

        .service-meta .service-price-signal {
            font-weight: var(--font-weight-medium);
            color: var(--color-text-secondary);
            font-size: 14px;
            width: 100%; /* Faz quebrar a linha */
            margin-top: 4px;
        }
        
        /* Loading spinner pequeno */
        .loading-spinner.small {
            width: 20px;
            height: 20px;
            border-width: 2px;
            margin-right: var(--space-8);
        }
        
        .loading-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: var(--space-16);
        }
        .tier-selection-container {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        .tier-option-card {
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative; /* Para o adiantamento */
            overflow: hidden; /* Para o adiantamento */
        }
        .tier-option-card:hover {
            border-color: var(--color-primary);
            box-shadow: var(--shadow-sm);
            transform: translateY(-2px);
        }
        .tier-option-card.disabled {
            background: var(--color-light-gray);
            opacity: 0.7;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .tier-option-card.disabled:hover {
            border-color: var(--color-border);
            box-shadow: none;
            transform: none;
        }
        .tier-option-card h4 {
            margin: 0 0 8px 0;
            color: var(--color-dark-gray);
        }
        .tier-option-card p {
            font-size: 14px;
            color: var(--color-text-secondary);
            margin: 0 0 12px 0;
        }
        .tier-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .tier-signal, .tier-signal-free {
            margin-top: 12px;
            padding-top: 8px;
            border-top: 1px dashed var(--color-medium-gray);
            font-size: 14px;
            font-weight: 500;
            color: var(--color-primary-active);
        }
        .tier-signal-free {
             color: var(--color-text-secondary);
        }
    `;
    document.head.appendChild(style);
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\static\js\ui.js

// static/js/ui.js
// Sistema de UI para gerenciar telas, modais e componentes de interface



// --- SISTEMA DE MODAIS ---
/**
 * Exibe um modal personalizado
 * @param {Object} options - Opções do modal
 * @param {string} options.title - Título do modal
 * @param {string} options.message - Mensagem do modal
 * @param {string} options.confirmText - Texto do botão de confirmação (opcional)
 * @param {string} options.cancelText - Texto do botão de cancelamento (opcional)
 * @param {Function} options.onConfirm - Função de callback para confirmação
 * @param {Function} options.onCancel - Função de callback para cancelamento (opcional)
 * @param {boolean} options.showCancel - Se deve mostrar o botão de cancelar (padrão: true)
 * @param {boolean} options.showConfirm - Se deve mostrar o botão de confirmar (padrão: true)
 */
window.showModal = function(options) {
    const modalContainer = document.getElementById('modal-container');
    const modalTitle = document.getElementById('modal-title');
    const modalBody = document.getElementById('modal-body');
    const modalConfirm = document.getElementById('modal-confirm');
    const modalCancel = document.getElementById('modal-cancel');
    const modalClose = document.getElementById('modal-close');

    const modalFooter = document.getElementById('modal-footer');
    // Define o conteúdo
    modalTitle.textContent = options.title || 'Aviso';
    modalBody.innerHTML = options.message || '';
    // Configura os botões
    modalConfirm.textContent = options.confirmText || 'Confirmar';
    modalCancel.textContent = options.cancelText || 'Cancelar';
    // Configura visibilidade do botão cancelar
    if (options.showCancel === false) {
        modalCancel.classList.add('hidden');
    } else {
        modalCancel.classList.remove('hidden');
    }

    // --- BLOCO MODIFICADO (Adiciona lógica para o "Confirmar" e centralização) ---
    if (options.showConfirm === false) {
        modalConfirm.classList.add('hidden');
        // <-- MUDANÇA (Esconde o botão)
        // Centraliza o footer quando SÓ o "cancelar" estiver visível
        if (modalFooter) modalFooter.style.justifyContent = 'center';
        // <-- MUDANÇA (Centraliza)
    } else {
        modalConfirm.classList.remove('hidden');
        // Restaura o padrão (flex-end)
        if (modalFooter) modalFooter.style.justifyContent = 'flex-end';
        // <-- MUDANÇA (Restaura)
    }
    // --- FIM DO BLOCO MODIFICADO ---
    
    // Configura os eventos
    const handleConfirm = () => {
        hideModal();
        if (typeof options.onConfirm === 'function') {
            options.onConfirm();
        }
    };
    
    const handleCancel = () => {
        hideModal();
        if (typeof options.onCancel === 'function') {
            options.onCancel();
        }
    };
    
    // Remove event listeners antigos
    modalConfirm.replaceWith(modalConfirm.cloneNode(true));
    modalCancel.replaceWith(modalCancel.cloneNode(true));
    modalClose.replaceWith(modalClose.cloneNode(true));
    // Adiciona novos event listeners
    document.getElementById('modal-confirm').addEventListener('click', handleConfirm);
    document.getElementById('modal-cancel').addEventListener('click', handleCancel);
    document.getElementById('modal-close').addEventListener('click', handleCancel);
    // Exibe o modal
    modalContainer.classList.remove('hidden');
    
    // Adiciona handler de tecla ESC
    const escHandler = (e) => {
        if (e.key === 'Escape') {
            handleCancel();
            document.removeEventListener('keydown', escHandler);
        }
    };
    document.addEventListener('keydown', escHandler);
};
/**
 * Oculta o modal
 */
window.hideModal = function() {
    const modalContainer = document.getElementById('modal-container');
    modalContainer.classList.add('hidden');
};
// --- TOAST NOTIFICATIONS ---
/**
 * Exibe uma notificação toast
 * @param {Object} options - Opções da notificação
 * @param {string} options.message - Mensagem da notificação
 * @param {string} options.type - Tipo da notificação (success, error, warning, info)
 * @param {number} options.duration - Duração em ms (padrão: 3000)
 */
window.showToast = function(options) {
    // Cria o elemento toast se não existir
    let toastContainer = document.getElementById('toast-container');
    if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toast-container';
        document.body.appendChild(toastContainer);
    }
    
    // Cria a notificação
    const toast = document.createElement('div');
    toast.className = `toast toast--${options.type || 'info'}`;
    toast.innerHTML = `
        <div class="toast-content">
            ${options.message}
        </div>
        <button class="toast-close">&times;</button>
    `;
    // Adiciona ao container
    toastContainer.appendChild(toast);
    
    // Configura animação de entrada
    setTimeout(() => {
        toast.classList.add('toast--visible');
    }, 10);
    // Configura o botão de fechar
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
        removeToast(toast);
    });
    // Configura auto-remoção
    const duration = options.duration || 3000;
    setTimeout(() => {
        removeToast(toast);
    }, duration);
};
/**
 * Remove uma notificação toast com animação
 * @param {HTMLElement} toast - Elemento toast a ser removido
 */
function removeToast(toast) {
    toast.classList.remove('toast--visible');
    toast.classList.add('toast--hiding');
    
    setTimeout(() => {
        toast.remove();
        
        // Remove o container se não houver mais toasts
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer && toastContainer.children.length === 0) {
            toastContainer.remove();
        }
    }, 300);
    // Duração da animação de saída
}

// --- FUNÇÕES DE LOADING ---
window.showLoading = function() {
    document.getElementById('loading-overlay').classList.remove('hidden');
};
window.hideLoading = function() {
    document.getElementById('loading-overlay').classList.add('hidden');
};

// --- UTILITÁRIOS DE FORMULÁRIO ---
/**
 * Limpa todos os campos de um formulário
 * @param {string} formId - ID do formulário a ser limpo
 */
window.clearForm = function(formId) {
    const form = document.getElementById(formId);
    if (!form) return;
    
    form.reset();
    
    // Limpa também campos personalizados se necessário
    form.querySelectorAll('input, textarea, select').forEach(field => {
        if (field.classList.contains('custom-field')) {
            // Tratamento para componentes personalizados
            field.value = '';
            // Dispara evento de mudança para atualizar estado
            field.dispatchEvent(new Event('change', { bubbles: true }));
         }
    });
};

///

window.showLoginForm = function(event) {
    event.preventDefault();
    const container = event.target.closest('.login-form-section');
    if (!container) return;

    const loginForm = container.querySelector('form[id*="login-form"]');
    const registerForm = container.querySelector('form[id*="register-form"]');

    if (loginForm) loginForm.classList.remove('hidden');
    if (registerForm) registerForm.classList.add('hidden');
    const toggleContainer = event.target.closest('.form-toggle');
    if (toggleContainer) {
        toggleContainer.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        toggleContainer.classList.remove('toggle-right');
    }
    event.target.classList.add('active');
};

window.showRegisterForm = function(event) {
    event.preventDefault();
    const container = event.target.closest('.login-form-section');
    if (!container) return;

    const loginForm = container.querySelector('form[id*="login-form"]');
    const registerForm = container.querySelector('form[id*="register-form"]');

    if (loginForm) loginForm.classList.add('hidden');
    if (registerForm) registerForm.classList.remove('hidden');
    const toggleContainer = event.target.closest('.form-toggle');
    if (toggleContainer) {
        toggleContainer.querySelectorAll('.toggle-btn').forEach(btn => btn.classList.remove('active'));
        toggleContainer.classList.add('toggle-right');
    }
    event.target.classList.add('active');
};
///

// --- INICIALIZAÇÃO ---
document.addEventListener('DOMContentLoaded', function() {
    // Configurações de UI global podem ser inicializadas aqui
    
    // Adiciona estilos para o sistema de toast via JavaScript (poderia estar no CSS)
    const style = document.createElement('style');
    style.textContent = `
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            min-width: 250px;
             padding: 12px 16px;
            border-radius: var(--radius-base);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            transform: translateX(100%);
             opacity: 0;
            transition: transform 0.3s, opacity 0.3s;
        }
        
        .toast--visible {
            transform: translateX(0);
            opacity: 1;
        }
        
        .toast--hiding {
            transform: translateX(100%);
            opacity: 0;
        }
        
        .toast--success {
            background-color: #e6f6f2;
            color: #54a88a;
            border-left: 4px solid #54a88a;
        }
        
        .toast--error {
            background-color: #ffebee;
            color: #e53935;
            border-left: 4px solid #e53935;
        }
        
        .toast--warning {
            background-color: #fff8e1;
            color: #f57c00;
            border-left: 4px solid #f57c00;
        }
        
        .toast--info {
            background-color: #e3f2fd;
            color: #1976d2;
            border-left: 4px solid #1976d2;
        }
        
        .toast-close {
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            margin-left: 10px;
            opacity: 0.6;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        /* Estilos adicionais para o modal */
        .modal-container {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .modal-content {
            background: var(--color-white);
            border-radius: var(--radius-lg);
            width: 90%;
            max-width: 500px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .modal-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            opacity: 0.6;
        }
        
        .modal-close:hover {
            opacity: 1;
        }
        
        .modal-body {
            padding: var(--space-24);
            max-height: 60vh;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: var(--space-16);
            border-top: 1px solid var(--color-border);
            display: flex;
            justify-content: flex-end;
            gap: var(--space-12);
        }
        
        /* Barra de usuário */
        .user-bar {
            background: var(--color-primary);
            color: var(--color-white);
            padding: var(--space-8) 0;
        }
        
        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-actions {
            display: flex;
            gap: var(--space-16);
        }
        
        .user-action {
            color: var(--color-white);
            text-decoration: none;
            opacity: 0.9;
            font-size: 14px;
        }
        
        .user-action:hover {
            opacity: 1;
            text-decoration: underline;
        }
    `;
    
    document.head.appendChild(style);

    // =================================================================
    // INÍCIO: Máscara de Telefone
    // =================================================================
    function formatPhoneInput(e) {
        // Remove tudo que não for dígito
        let value = e.target.value.replace(/\D/g, '');
        // Limita a 11 dígitos (DD + 9 do celular)
        value = value.substring(0, 11);
        // Aplica a máscara (XX) XXXXXXXXX
        if (value.length > 2) {
            value = `(${value.substring(0, 2)}) ${value.substring(2)}`;
        } else if (value.length > 0) {
            // Adiciona o parêntese inicial
            value = `(${value.substring(0, 2)}`;
        }
        
        // Define o valor formatado de volta no campo
        e.target.value = value;
    }

    // Lista de todos os IDs de campos de telefone que precisam da máscara
    const phoneInputIds = [
        'login-phone',          
        'register-phone',       
        'forced-login-phone',
        'forced-register-phone',
        'profile-phone',        
        'equipe-telefone',      
        'equipe-edit-telefone'  // (Do modal que criamos)
    ];

    phoneInputIds.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            // Adiciona o listener de "input" para formatar em tempo real
            input.addEventListener('input', formatPhoneInput);
        }
    });
    // =================================================================
    // FIM: Máscara de Telefone
    // =================================================================

    
    // =================================================================
    // INÍCIO: Ajuste do Campo de Data de Nascimento para Mobile
    // =================================================================

    /**
     * Formata o input de data como dd/mm/aaaa enquanto o usuário digita
     */
    function formatBirthdayInput(e) {
        let value = e.target.value.replace(/\D/g, '');
        // Remove tudo que não for dígito
        value = value.substring(0, 8);
        // Limita a 8 dígitos (ddmmyyyy)

        if (value.length > 4) {
            // Se tiver mais de 4 dígitos (ex: 2604200) -> 26/04/200
            value = `${value.substring(0, 2)}/${value.substring(2, 4)}/${value.substring(4)}`;
        } else if (value.length > 2) {
            // Se tiver mais de 2 dígitos (ex: 2604) -> 26/04
            value = `${value.substring(0, 2)}/${value.substring(2)}`;
        }
        
        e.target.value = value;
    }
    
    /**
     * Verifica se é um dispositivo com tela de toque (proxy para mobile)
     */
    function isMobileDevice() {
        return ('ontouchstart' in window) ||
        (navigator.maxTouchPoints > 0);
    }

    // Se for um dispositivo móvel...
    if (isMobileDevice()) {
        // Lista de todos os IDs de campos de DATA DE NASCIMENTO
        const birthdayInputIds = [
            'login-nascimento',
            'register-nascimento',
            'forced-login-nascimento',
            'forced-register-nascimento',
            'profile-nascimento'
        ];
        
        birthdayInputIds.forEach(id => {
            const input = document.getElementById(id);
            if (input) {
                input.type = 'text'; // Muda de "date" para "text"
                input.placeholder = 'dd/mm/aaaa'; // Adiciona o placeholder
                input.setAttribute('inputmode', 'numeric'); // Pede o teclado numérico
                 
                // --- 2. ADICIONE ESTA LINHA ---
                input.addEventListener('input', formatBirthdayInput); // Aplica a máscara
            }
        });
    }
    // =================================================================
    // FIM: Ajuste do Campo de Data de Nascimento
    // =================================================================
    // =================================================================
    // INÍCIO: Conversores de Data (dd/mm/aaaa <-> YYYY-MM-DD)
    // =================================================================

    /**
     * Converte data de dd/mm/aaaa para YYYY-MM-DD
     * @param {string} dateString - Data no formato dd/mm/aaaa
     * @returns {string|null} - Data no formato YYYY-MM-DD ou null se inválido
     */
    window.convertDateToISO = function(dateString) {
 
         if (!dateString) return null;
         // Se a data já estiver no formato ISO (do PC), retorna ela mesma
        if (dateString.includes('-') && dateString.length === 10) {
            return dateString;
        }

        // Se estiver no formato dd/mm/aaaa
        if (dateString.length !== 10) return null;
        // Garante que tem 10 caracteres
        
        const parts = dateString.split('/');
        if (parts.length !== 3) return null; // Formato inválido
        
        const day = parts[0];
        const month = parts[1];
        const year = parts[2];
        
        if (year.length !== 4) return null;
        // Ano inválido
        
        return `${year}-${month}-${day}`;
    }

    /**
     * Converte data de YYYY-MM-DD para dd/mm/aaaa
     * @param {string} isoString - Data no formato YYYY-MM-DD
     * @returns {string|null} - Data no formato dd/mm/aaaa ou null se inválido
     */
    window.convertISOToDate = function(isoString) {
        if (!isoString || !isoString.includes('-') || isoString.length !== 10) {
            return "";
            // Retorna vazio se a data for nula ou inválida
        }

        const parts = isoString.split('-');
        if (parts.length !== 3) return "";
        
        const year = parts[0];
        const month = parts[1];
        const day = parts[2];

        return `${day}/${month}/${year}`;
    }
    // =================================================================
    // FIM: Conversores de Data
    // =================================================================
});
_____________________________________

C:\Users\SV1830\Downloads\bella_designerV45\bella_designer\templates\base.html

{% load static %}
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Bella Designer - Agendamento Online{% endblock %}</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
    {% block extra_css %}{% endblock %}
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.css" />
</head>
<body>
    {% csrf_token %}
    
    {% if user_info.is_authenticated %}
    <div class="user-bar">
        <div class="container">
            <div class="user-info">
                <span>Olá, {{ user_info.name }}!</span>
                <div class="user-actions">
                    <a href="{% url 'index' %}" class="user-action">Início</a>
                    <a href="#" onclick="showScreen('client-area-screen')" class="user-action">Meus Agendamentos</a>
                    <a href="#" onclick="performLogout()" class="user-action">Sair</a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% block content %}{% endblock %}

    <div id="modal-container" class="modal-container hidden">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Título do Modal</h3>
                <button id="modal-close" class="modal-close">&times;</button>
            </div>
            <div id="modal-body" class="modal-body">
                Conteúdo do modal
            </div>
            <div id="modal-footer" class="modal-footer">
                <button id="modal-cancel" class="btn btn--outline">Cancelar</button>
                <button id="modal-confirm" class="btn btn--primary">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="loading-spinner"></div>
        <p>Processando...</p>
    </div>

    <div id="portfolio-modal-container" class="portfolio-modal-container hidden">
        <button id="portfolio-modal-close" class="portfolio-modal-close-btn">&times;</button>
        <div class="portfolio-modal-body">
            <div id="portfolio-loading" class="loading-overlay">
                <div class="loading-spinner"></div>
            </div>
            <iframe id="portfolio-iframe" src="about:blank" frameborder="0"></iframe>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/mdbassit/Coloris@latest/dist/coloris.min.js"></script>

    {% block extra_js %}
        <script src="{% static 'js/ui.js' %}"></script>
        <script src="{% static 'js/auth.js' %}"></script>
        <script src="{% static 'js/services.js' %}"></script>
        <script src="{% static 'js/professional.js' %}"></script>
        <script src="{% static 'js/calendar.js' %}"></script>
        <script src="{% static 'js/client.js' %}"></script>
        <script src="{% static 'js/admin.js' %}"></script>
        <script src="{% static 'js/app.js' %}"></script>
    {% endblock %}
</body>
</html>
_____________________________________

