<!-- templates/agendamentos/dashboard/financeiro.html -->
{% extends 'agendamentos/dashboard/base.html' %}

{% block dashboard_content %}
<h1>Gestão Financeira</h1>

<div class="dashboard-tabs">
    <button class="tab-btn active" data-tab="overview">Visão Geral</button>
    <button class="tab-btn" data-tab="income">Receitas</button>
    <button class="tab-btn" data-tab="expenses">Despesas</button>
</div>

<div class="tab-content" id="tab-overview">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Resumo Financeiro</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <div class="period-selector">
                    <label>Período:</label>
                    <select id="overview-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                
                <div id="custom-period" class="custom-period hidden">
                    <div class="form-row">
                        <input type="date" id="overview-start" class="form-control">
                        <span>até</span>
                        <input type="date" id="overview-end" class="form-control">
                        <button id="overview-apply" class="btn btn--primary btn--sm">Aplicar</button>
                    </div>
                </div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-title">Receita Total</div>
                    <div class="stat-value" id="total-income">R$ 0,00</div>
                    <div class="stat-description">Pagamentos recebidos</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Despesas</div>
                    <div class="stat-value" id="total-expenses">R$ 0,00</div>
                    <div class="stat-description">Total de gastos no período</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Lucro</div>
                    <div class="stat-value" id="total-profit">R$ 0,00</div>
                    <div class="stat-description">Receita - Despesas</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-title">Pendente</div>
                    <div class="stat-value" id="pending-income">R$ 0,00</div>
                    <div class="stat-description">Pagamentos a receber</div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="financial-overview-chart"></canvas>
            </div>
            
            <div class="summary-table">
                <h4>Resumo de Serviços</h4>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Serviço</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="services-summary">
                            <tr>
                                <td colspan="3">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-income">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Gestão de Receitas</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <div class="period-selector">
                    <label>Período:</label>
                    <select id="income-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                </div>
                
                <div id="income-custom-period" class="custom-period hidden">
                    <div class="form-row">
                        <input type="date" id="income-start" class="form-control">
                        <span>até</span>
                        <input type="date" id="income-end" class="form-control">
                        <button id="income-apply" class="btn btn--primary btn--sm">Aplicar</button>
                    </div>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="income-chart"></canvas>
            </div>
            
            <h4>Pagamentos Recebidos</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Valor</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="income-table">
                        <tr>
                            <td colspan="5">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <h4>Pagamentos Pendentes</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Cliente</th>
                            <th>Serviço</th>
                            <th>Valor</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="pending-table">
                        <tr>
                            <td colspan="5">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="tab-content hidden" id="tab-expenses">
    <div class="dashboard-card">
        <div class="dashboard-card-title">Gestão de Despesas</div>
        <div class="dashboard-card-body">
            <div class="action-bar">
                <button id="btn-add-expense" class="btn btn--primary">Nova Despesa</button>
                
                <div class="filters">
                    <select id="expense-period" class="form-control">
                        <option value="semana">Esta Semana</option>
                        <option value="mes" selected>Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="custom">Personalizado</option>
                    </select>
                    
                    <select id="expense-category" class="form-control">
                        <option value="">Todas as Categorias</option>
                        <option value="Aluguel">Aluguel</option>
                        <option value="Materiais">Materiais</option>
                        <option value="Serviços">Serviços</option>
                        <option value="Impostos">Impostos</option>
                        <option value="Salários">Salários</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
            </div>
            
            <div class="chart-container">
                <canvas id="expenses-chart"></canvas>
            </div>
            
            <div class="summary-table">
                <h4>Resumo por Categoria</h4>
                <div class="data-table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Categoria</th>
                                <th>Quantidade</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="expenses-summary">
                            <tr>
                                <td colspan="3">Carregando...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <h4>Lista de Despesas</h4>
            <div class="data-table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Descrição</th>
                            <th>Categoria</th>
                            <th>Valor</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="expenses-table">
                        <tr>
                            <td colspan="6">Carregando...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Adicionar Despesa -->
<div id="expense-modal" class="modal-container hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="expense-modal-title">Registrar Nova Despesa</h3>
            <button id="expense-modal-close" class="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <form id="expense-form">
                <div class="form-group">
                    <label class="form-label" for="expense-description">Descrição</label>
                    <input type="text" class="form-control" id="expense-description" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-amount">Valor (R$)</label>
                    <input type="number" class="form-control" id="expense-amount" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-date">Data</label>
                    <input type="date" class="form-control" id="expense-date" required>
                </div>
                <div class="form-group">
                    <label class="form-label" for="expense-category-select">Categoria</label>
                    <select class="form-control" id="expense-category-select" required>
                        <option value="">Selecione...</option>
                        <option value="Aluguel">Aluguel</option>
                        <option value="Materiais">Materiais</option>
                        <option value="Serviços">Serviços</option>
                        <option value="Impostos">Impostos</option>
                        <option value="Salários">Salários</option>
                        <option value="Outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox">
                        <input type="checkbox" id="expense-paid">
                        <label for="expense-paid">Despesa já paga</label>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button id="expense-modal-cancel" class="btn btn--outline">Cancelar</button>
            <button id="expense-modal-save" class="btn btn--primary">Salvar Despesa</button>
        </div>
    </div>
</div>
{% endblock %}

{% block dashboard_js %}
<style>
    /* Adiciona um estilo para o botão de excluir */
    .btn--danger-outline {
        color: var(--color-danger);
        border-color: var(--color-danger);
    }
    .btn--danger-outline:hover {
        background-color: var(--color-danger-light);
        color: var(--color-danger);
    }
</style>
<script>
    // =================================================================
    // INÍCIO: Conteúdo movido do static/js/financial.js 
    // =================================================================

    /**
     * Mark an expense as paid
     * @param {number} expenseId - The ID of the expense to mark as paid
     */
    window.markExpenseAsPaid = async function(expenseId) {
        
        try {
            const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    pago: true
                })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Despesa marcada como paga com sucesso!');
                // Recarrega os dados (agora as funções estão no escopo)
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao atualizar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao marcar despesa como paga:', error);
            alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
        }
    };

    /**
     * Edit an expense
     * @param {number} expenseId - The ID of the expense to edit
     */
    window.editExpense = async function(expenseId) {
        try {
            // Fetch expense details
            const response = await fetch(`/api/admin/despesa/${expenseId}/`);
            const expense = await response.json();
            
            if (!expense || expense.status === 'error') {
                throw new Error(expense.message || 'Não foi possível obter os detalhes da despesa.');
            }
            
            // Populate modal with expense data
            document.getElementById('expense-description').value = expense.descricao;
            document.getElementById('expense-amount').value = expense.valor;
            document.getElementById('expense-date').value = expense.data;
            document.getElementById('expense-category-select').value = expense.categoria;
            document.getElementById('expense-paid').checked = expense.pago;
            // Store expense ID in the form for reference
            document.getElementById('expense-form').dataset.expenseId = expenseId;
            document.getElementById('expense-modal-title').textContent = 'Editar Despesa';
            
            // Update save button to handle edit vs. new
            const saveButton = document.getElementById('expense-modal-save');
            saveButton.textContent = 'Atualizar Despesa';
            saveButton.onclick = updateExpense; // <--- APONTA PARA A FUNÇÃO DE ATUALIZAR
            
            // Show modal
            document.getElementById('expense-modal').classList.remove('hidden');
        } catch (error) {
            console.error('Erro ao carregar dados da despesa:', error);
            alert('Erro ao carregar dados da despesa. Verifique o console para mais detalhes.');
        }
    };

    // =================================================================
    // NOVA FUNÇÃO: DELETAR DESPESA
    // =================================================================
    /**
     * Deletes an expense
     * @param {number} expenseId - The ID of the expense to delete
     */
    window.deleteExpense = async function(expenseId) {
        
        try {
            const response = await fetch(`/api/admin/deletar-despesa/${expenseId}/`, {
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert(data.message); // 'Despesa excluída com sucesso'
                // Recarrega os dados
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao excluir despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao excluir despesa:', error);
            alert('Erro ao excluir despesa. Verifique o console para mais detalhes.');
        }
    };
    // =================================================================
    // FIM DA NOVA FUNÇÃO
    // =================================================================

    /**
     * Update an existing expense
     */
    async function updateExpense() {
        const expenseId = document.getElementById('expense-form').dataset.expenseId;
        if (!expenseId) return;

        const description = document.getElementById('expense-description').value;
        const amount = document.getElementById('expense-amount').value;
        const date = document.getElementById('expense-date').value;
        const category = document.getElementById('expense-category-select').value;
        const paid = document.getElementById('expense-paid').checked;

        if (!description || !amount || !date || !category) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        try {
            const response = await fetch(`/api/admin/atualizar-despesa/${expenseId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    descricao: description,
                    valor: parseFloat(amount),
                    data: date,
                    categoria: category,
                    pago: paid
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Despesa atualizada com sucesso!');
                document.getElementById('expense-modal').classList.add('hidden');
                
                // CORREÇÃO: Estas funções agora estão no mesmo escopo e serão encontradas
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao atualizar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao atualizar despesa:', error);
            // Este alerta não será mais chamado por ReferenceError
            alert('Erro ao atualizar despesa. Verifique o console para mais detalhes.');
        }
    }

    /**
     * Reset the expense form for a new expense
     */
    window.resetExpenseForm = function() {
        const form = document.getElementById('expense-form');
        form.reset();
        delete form.dataset.expenseId;
        
        document.getElementById('expense-date').valueAsDate = new Date();
        document.getElementById('expense-modal-title').textContent = 'Registrar Nova Despesa';
        
        const saveButton = document.getElementById('expense-modal-save');
        saveButton.textContent = 'Salvar Despesa';
        saveButton.onclick = saveNewExpense; // <--- APONTA PARA A FUNÇÃO DE SALVAR NOVO
        
        document.getElementById('expense-modal').classList.remove('hidden');
    };

    /**
     * Save a new expense
     */
    async function saveNewExpense() {
        const description = document.getElementById('expense-description').value;
        const amount = document.getElementById('expense-amount').value;
        const date = document.getElementById('expense-date').value;
        const category = document.getElementById('expense-category-select').value;
        const paid = document.getElementById('expense-paid').checked;

        if (!description || !amount || !date || !category) {
            alert('Por favor, preencha todos os campos obrigatórios.');
            return;
        }
        
        try {
            const response = await fetch('/api/admin/registrar-despesa/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    descricao: description,
                    valor: parseFloat(amount),
                    data: date,
                    categoria: category,
                    pago: paid
                })
            });
            
            const data = await response.json();
            if (data.status === 'success') {
                alert('Despesa registrada com sucesso!');
                document.getElementById('expense-modal').classList.add('hidden');
                loadExpensesData();
                loadFinancialOverview();
            } else {
                alert('Erro ao registrar despesa: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao registrar despesa:', error);
            alert('Erro ao registrar despesa. Verifique o console para mais detalhes.');
        }
    }

    /**
     * Generate payment status select with the appropriate status selected
     * @param {string} status - Current payment status
     * @returns {string} - HTML for the select element
     */
    function generatePaymentStatusSelect(status, id) {
        return `
            <select class="form-control payment-status-select" data-appointment-id="${id}">
                <option value="Aguardando Pagamento" ${status === 'Aguardando Pagamento' ? 'selected' : ''}>Aguardando Pagamento</option>
                <option value="Pendente" ${status === 'Pendente' ? 'selected' : ''}>Pendente</option>
                <option value="Adiantamento Realizado" ${status === 'Adiantamento Realizado' ? 'selected' : ''}>Adiantamento Realizado</option>
                <option value="Pago" ${status === 'Pago' ? 'selected' : ''}>Pago</option> <option value="Cancelado" ${status === 'Cancelado' ? 'selected' : ''}>Cancelado</option>
            </select>
        `;
    }

    /**
     * Update an appointment's payment status
     * @param {number} appointmentId - The appointment ID
     * @param {string} status - The new payment status
     */
    async function updateAppointmentPaymentStatus(appointmentId, status) {
        try {
            const response = await fetch(`/api/admin/atualizar-pagamento/${appointmentId}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                },
                body: JSON.stringify({
                    status_pagamento: status
                })
            });
            const data = await response.json();
            
            if (data.status === 'success') {
                alert('Status de pagamento atualizado com sucesso!');
                // Reload financial data
                if (typeof loadIncomeData === 'function') {
                    loadIncomeData();
                }
                if (typeof loadFinancialOverview === 'function') {
                    loadFinancialOverview();
                }
            } else {
                alert('Erro ao atualizar status de pagamento: ' + data.message);
            }
        } catch (error) {
            console.error('Erro ao atualizar status de pagamento:', error);
            alert('Erro ao atualizar status de pagamento. Verifique o console para mais detalhes.');
        }
    }
    
    // =================================================================
    // FIM: Conteúdo movido do static/js/financial.js
    // =================================================================


    // =================================================================
    // INÍCIO: Script original da página (financeiro.html) 
    // =================================================================
    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
            y: {
                beginAtZero: true,
                grid: { display: true, color: '#EDF2F7', drawBorder: false },
                ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
            },
            x: {
                grid: { display: false },
                ticks: { color: '#4A5568', font: { family: "'Inter', sans-serif" } }
            }
        },
        plugins: {
            legend: {
                display: false,
            },
            tooltip: {
                enabled: true,
                backgroundColor: '#1A202C',
                titleFont: { family: "'Inter', sans-serif", size: 14 },
                bodyFont: { family: "'Inter', sans-serif", size: 12 },
                padding: 12,
                cornerRadius: 8
            }
        }
    };

    // =================================================================
    // MUDANÇA AQUI: As definições das funções foram movidas para fora do DOMContentLoaded
    // =================================================================

    function loadFinancialOverview() {
        const period = document.getElementById('overview-period').value;
        let url = `/api/admin/resumo-financeiro/?periodo=${period}`;
        if (period === 'custom') {
            url += `&inicio=${document.getElementById('overview-start').value}&fim=${document.getElementById('overview-end').value}`;
        }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // (O conteúdo desta função permanece o mesmo)
                // Atualizar estatísticas
                document.getElementById('total-income').textContent = `R$ ${data.financeiro.faturamento.toFixed(2)}`;
                document.getElementById('total-expenses').textContent = `R$ ${data.financeiro.despesas.toFixed(2)}`;
                document.getElementById('total-profit').textContent = `R$ ${data.financeiro.lucro.toFixed(2)}`;
                document.getElementById('pending-income').textContent = `R$ ${data.financeiro.faturamento_pendente.toFixed(2)}`;
                
                const profitElement = document.getElementById('total-profit');
                profitElement.classList.toggle('stat-positive', data.financeiro.lucro >= 0);
                profitElement.classList.toggle('stat-negative', data.financeiro.lucro < 0);
                
                // --- Gráfico de Visão Geral (Estilizado) ---
                const ctx = document.getElementById('financial-overview-chart').getContext('2d');
                if (window.overviewChart) { window.overviewChart.destroy(); }
                
                const lucroValor = data.financeiro.lucro;
                const lucroBG = lucroValor >= 0 ? 'rgba(56, 161, 105, 0.7)' : 'rgba(255, 90, 95, 0.7)';
                const lucroBorder = lucroValor >= 0 ? '#38A169' : '#FF5A5F';
                
                window.overviewChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Receita', 'Despesas', 'Lucro'],
                        datasets: [{
                            label: 'Valores em R$',
                            data: [data.financeiro.faturamento, data.financeiro.despesas, lucroValor],
                            backgroundColor: [
                                'rgba(13, 153, 255, 0.7)', // Azul
                                'rgba(255, 90, 95, 0.7)', // Vermelho
                                lucroBG
                            ],
                            borderColor: [
                                '#0D99FF',
                                '#FF5A5F',
                                lucroBorder
                            ],
                            borderWidth: 2,
                            borderRadius: 5
                        }]
                    },
                    options: { ...chartOptions }
                });

                // Tabela de resumo de serviços
                const tableBody = document.getElementById('services-summary');
                if (data.servicos_populares && data.servicos_populares.length > 0) {
                    tableBody.innerHTML = data.servicos_populares.map(servico => `
                        <tr>
                            <td>${servico.servico__nome}</td>
                            <td>${servico.total}</td>
                            <td>R$ ${(servico.total * (servico.preco || 0)).toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    tableBody.innerHTML = '<tr><td colspan="3">Nenhum serviço no período.</td></tr>';
                }
            });
    }

    function loadIncomeData() {
        const period = document.getElementById('income-period').value;
        let baseUrl = `periodo=${period}`;
        if (period === 'custom') {
            baseUrl += `&inicio=${document.getElementById('income-start').value}&fim=${document.getElementById('income-end').value}`;
        }

        // (O conteúdo desta função permanece o mesmo)
        // --- Gráfico de Faturamento (Estilizado) ---
        fetch(`/api/admin/faturamento/?${baseUrl}&tipo=diario`)
            .then(response => response.json())
            .then(data => {
                const ctx = document.getElementById('income-chart').getContext('2d');
                if (window.incomeChart) { window.incomeChart.destroy(); }

                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(13, 153, 255, 0.5)');
                gradient.addColorStop(1, 'rgba(13, 153, 255, 0.05)');

                const labels = data.dados.map(item => new Date(item.data).toLocaleDateString('pt-BR'));
                const values = data.dados.map(item => item.total);

                window.incomeChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Faturamento Diário (R$)',
                            data: values,
                            backgroundColor: gradient,
                            borderColor: 'rgba(13, 153, 255, 1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4, // Linha curva
                            pointBackgroundColor: 'rgba(13, 153, 255, 1)',
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: { ...chartOptions }
                });
            });
        
        // --- Tabelas de Pagamentos (Lógica mantida) ---
        fetch(`/api/admin/agendamentos-pagamento/?${baseUrl}`)
            .then(response => response.json())
            .then(data => {
                const pendingTable = document.getElementById('pending-table');
                if (data.pendentes && data.pendentes.length > 0) {
                    pendingTable.innerHTML = data.pendentes.map(apt => `
                        <tr>
                            <td>${new Date(apt.data).toLocaleDateString('pt-BR')}</td>
                            <td>${apt.cliente}</td>
                            <td>${apt.servico}</td>
                            <td>R$ ${apt.valor.toFixed(2)}</td>
                            <td>${generatePaymentStatusSelect(apt.status_pagamento, apt.id)}</td>
                        </tr>
                    `).join('');
                } else {
                    pendingTable.innerHTML = '<tr><td colspan="5">Nenhum pagamento pendente.</td></tr>';
                }
                
                const incomeTable = document.getElementById('income-table');
                if (data.pagos && data.pagos.length > 0) {
                    incomeTable.innerHTML = data.pagos.map(apt => `
                        <tr>
                            <td>${new Date(apt.data).toLocaleDateString('pt-BR')}</td>
                            <td>${apt.cliente}</td>
                            <td>${apt.servico}</td>
                            <td>R$ ${apt.valor.toFixed(2)}</td>
                            <td><span class="status status--success">${apt.status}</span></td>
                        </tr>
                    `).join('');
                } else {
                    incomeTable.innerHTML = '<tr><td colspan="5">Nenhum pagamento recebido.</td></tr>';
                }
            });
    }

    function loadExpensesData() {
        const period = document.getElementById('expense-period').value;
        const category = document.getElementById('expense-category').value;
        let url = `/api/admin/despesas/?periodo=${period}`;
        if (category) { url += `&categoria=${category}`; }
        
        fetch(url)
            .then(response => response.json())
            .then(data => {
                // (O conteúdo desta função permanece o mesmo)
                // --- Gráfico de Despesas (Estilizado) ---
                const ctx = document.getElementById('expenses-chart').getContext('2d');
                if (window.expensesChart) { window.expensesChart.destroy(); }
                
                const sortedCategories = data.resumo_categorias.sort((a, b) => b.total - a.total);
                const labels = sortedCategories.map(item => item.categoria);
                const values = sortedCategories.map(item => item.total);

                window.expensesChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Despesas por Categoria (R$)',
                            data: values,
                            backgroundColor: [
                                'rgba(255, 90, 95, 0.7)',
                                'rgba(255, 149, 0, 0.7)',
                                'rgba(13, 153, 255, 0.7)',
                                'rgba(155, 89, 182, 0.7)',
                                'rgba(52, 152, 219, 0.7)',
                                'rgba(56, 161, 105, 0.7)'
                            ],
                            borderWidth: 0,
                            borderRadius: 5
                        }]
                    },
                    options: { 
                        ...chartOptions,
                        indexAxis: 'y', // <-- Gráfico de barras horizontal
                    }
                });
                
                // --- Tabelas de Despesas (Lógica mantida) ---
                const expensesSummary = document.getElementById('expenses-summary');
                if (sortedCategories.length > 0) {
                    expensesSummary.innerHTML = sortedCategories.map(cat => `
                        <tr>
                            <td>${cat.categoria}</td>
                            <td>${cat.quantidade}</td>
                            <td>R$ ${cat.total.toFixed(2)}</td>
                        </tr>
                    `).join('');
                } else {
                    expensesSummary.innerHTML = '<tr><td colspan="3">Sem despesas.</td></tr>';
                }

                const expensesTable = document.getElementById('expenses-table');
                if (data.despesas && data.despesas.length > 0) {
                    expensesTable.innerHTML = data.despesas.map(expense => `
                        <tr>
                            <td>${new Date(expense.data).toLocaleDateString('pt-BR')}</td>
                            <td>${expense.descricao}</td>
                            <td>${expense.categoria}</td>
                            <td>R$ ${expense.valor.toFixed(2)}</td>
                            <td><span class="status status--${expense.pago ? 'success' : 'warning'}">${expense.pago ? 'Pago' : 'Pendente'}</span></td>
                            
                            <td style="display: flex; gap: 8px;">
                                <button class="btn btn--sm btn--outline" onclick="editExpense(${expense.id})">Editar</button>
                                <button class="btn btn--sm btn--danger-outline" onclick="deleteExpense(${expense.id})">Excluir</button>
                            </td>
                            </tr>
                    `).join('');
                } else {
                    expensesTable.innerHTML = '<tr><td colspan="6">Nenhuma despesa no período.</td></tr>';
                }
            });
    }

    // =================================================================
    // FIM DA SEÇÃO MOVIDA
    // =================================================================


    document.addEventListener('DOMContentLoaded', function() {
        // --- Configurações Globais dos Gráficos ---

        // --- Tabs ---
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        tabBtns.forEach(btn => {
            btn.addEventListener('click', function() {
                const tab = this.dataset.tab;
                tabBtns.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.add('hidden'));
                this.classList.add('active');
                document.getElementById(`tab-${tab}`).classList.remove('hidden');
                
                if (tab === 'overview') { loadFinancialOverview(); }
                else if (tab === 'income') { loadIncomeData(); }
                else if (tab === 'expenses') { loadExpensesData(); }
            });
        });

        // --- Seletores de Período ---
        const periodSelectors = ['overview-period', 'income-period', 'expense-period'];
        periodSelectors.forEach(selector => {
            const el = document.getElementById(selector);
            if (el) {
                el.addEventListener('change', function() {
                    const customPeriodId = selector === 'overview-period' ? 'custom-period' : 
                                          selector === 'income-period' ? 'income-custom-period' : null;
                    
                    if (customPeriodId && this.value === 'custom') {
                        document.getElementById(customPeriodId).classList.remove('hidden');
                    } else if (customPeriodId) {
                        document.getElementById(customPeriodId).classList.add('hidden');
                        if (selector === 'overview-period') { loadFinancialOverview(); }
                        else if (selector === 'income-period') { loadIncomeData(); }
                        else if (selector === 'expense-period') { loadExpensesData(); }
                    }
                    // CORREÇÃO: Adicionamos o 'else' para recarregar quando não for 'custom'
                    else {
                        if (selector === 'overview-period') { loadFinancialOverview(); }
                        else if (selector === 'income-period') { loadIncomeData(); }
                        else if (selector === 'expense-period') { loadExpensesData(); }
                    }
                });
            }
        });
        document.getElementById('overview-apply')?.addEventListener('click', loadFinancialOverview);
        document.getElementById('income-apply')?.addEventListener('click', loadIncomeData);
        document.getElementById('expense-category')?.addEventListener('change', loadExpensesData);
        
        // --- Modal de Despesas ---
        document.getElementById('btn-add-expense')?.addEventListener('click', resetExpenseForm);
        document.getElementById('expense-modal-close')?.addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
        document.getElementById('expense-modal-cancel')?.addEventListener('click', () => document.getElementById('expense-modal').classList.add('hidden'));
        // CORREÇÃO: O botão salvar deve chamar 'saveNewExpense' por padrão
        document.getElementById('expense-modal-save').onclick = saveNewExpense;

        // --- Carregamento Inicial ---
        loadFinancialOverview();
        
        // --- Handlers de Eventos do financial.js (que agora estão aqui) ---
        document.addEventListener('change', function(e) {
            if (e.target.classList.contains('payment-status-select')) {
                updateAppointmentPaymentStatus(e.target.dataset.appointmentId, e.target.value);
            }
        });
    });
</script>
{% endblock %}